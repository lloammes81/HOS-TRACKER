<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="HOS Tracker" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#10b981" />
<title>HOS Tracker ğŸš›</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<style>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DESIGN TOKENS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  :root {
    --bg: #f0efe9;
    --surface: #ffffff;
    --surface2: #f8f8f5;
    --text: #0d0d0d;
    --muted: #6b7280;
    --accent: #10b981;
    --accent2: #059669;
    --danger: #ef4444;
    --blue: #3b82f6;
    --purple: #8b5cf6;
    --amber: #f59e0b;
    --border: #e2e0d8;
    --shadow: 0 1px 8px rgba(0,0,0,0.07), 0 4px 20px rgba(0,0,0,0.05);
    --shadow-lg: 0 8px 40px rgba(0,0,0,0.12);
    --radius: 18px;
    --radius-sm: 12px;
    /* Safe area insets for notch / home bar */
    --sat: env(safe-area-inset-top, 0px);
    --sab: env(safe-area-inset-bottom, 0px);
    --sal: env(safe-area-inset-left, 0px);
    --sar: env(safe-area-inset-right, 0px);
    --tab-h: calc(60px + var(--sab));
    --header-pt: calc(14px + var(--sat));
  }
  body.dark {
    --bg: #0a0f1e;
    --surface: #131929;
    --surface2: #1a2235;
    --text: #f0f4ff;
    --muted: #8896b0;
    --border: #1e2d45;
    --shadow: 0 1px 8px rgba(0,0,0,0.3), 0 4px 20px rgba(0,0,0,0.2);
    --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESET + BASE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { height: 100%; -webkit-text-size-adjust: 100%; }
  body {
    font-family: "DM Sans", -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100%;
    min-height: -webkit-fill-available;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition: background .25s, color .25s;
    /* Prevent overscroll bounce showing white bg */
    overscroll-behavior: none;
  }
  /* Remove tap highlight on mobile */
  * { -webkit-tap-highlight-color: transparent; }
  /* Smooth scrolling */
  .page { -webkit-overflow-scrolling: touch; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LAYOUT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .bg-icons {
    position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden;
  }
  .bg-icons span { position: absolute; user-select: none; }
  .App {
    position: relative; z-index: 1;
    padding-bottom: var(--tab-h);
  }
  .container {
    width: 100%;
    max-width: 520px;
    margin: 0 auto;
    padding: 0 16px 24px;
    padding-left: calc(16px + var(--sal));
    padding-right: calc(16px + var(--sar));
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB BAR â€” native app feel
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .tab-bar {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    height: var(--tab-h);
    padding-bottom: var(--sab);
    padding-left: var(--sal);
    padding-right: var(--sar);
    box-shadow: 0 -1px 0 var(--border), 0 -8px 24px rgba(0,0,0,0.06);
    /* glass effect on iOS */
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    background: rgba(255,255,255,0.88);
  }
  body.dark .tab-bar {
    background: rgba(19,25,41,0.92);
    border-top-color: var(--border);
  }
  .tab-btn {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 3px; border: none; background: none; color: var(--muted);
    font-family: "DM Sans", sans-serif; font-size: 10px; font-weight: 600;
    cursor: pointer; padding: 8px 0 4px;
    transition: color .18s;
    /* Minimum 44px touch target */
    min-height: 44px;
    position: relative;
  }
  .tab-btn::before {
    content: '';
    position: absolute; inset: 0;
    border-radius: 12px;
    background: var(--accent);
    opacity: 0;
    transform: scale(0.7);
    transition: opacity .18s, transform .18s;
  }
  .tab-btn:active::before { opacity: 0.08; transform: scale(1); }
  .tab-btn svg {
    width: 22px; height: 22px; fill: none; stroke: currentColor;
    stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round;
    transition: transform .2s;
  }
  .tab-btn.active { color: var(--accent); }
  .tab-btn.active svg { transform: translateY(-1px); }
  /* Active dot indicator */
  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: calc(var(--sab) + 4px);
    width: 4px; height: 4px;
    border-radius: 50%;
    background: var(--accent);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .page { display: none; }
  .page.active { display: block; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .header {
    padding-top: var(--header-pt);
    padding-bottom: 12px;
  }
  .logo {
    font-family: "Bebas Neue", sans-serif;
    font-size: 28px; letter-spacing: 1.5px;
    display: flex; align-items: center; gap: 8px;
    line-height: 1;
  }
  .subtitle {
    font-size: 11px; color: var(--muted);
    margin-top: 3px; font-weight: 600;
    letter-spacing: .8px; text-transform: uppercase;
  }
  .row { display: flex; align-items: center; gap: 8px; }
  .row.between { justify-content: space-between; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CARDS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FORM INPUTS â€” mobile optimized
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  label {
    display: block; font-size: 11px; font-weight: 700; color: var(--muted);
    margin-bottom: 5px; margin-top: 14px;
    text-transform: uppercase; letter-spacing: .6px;
  }
  label:first-child { margin-top: 0; }
  input, select {
    width: 100%;
    /* 44px min for touch targets */
    padding: 13px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: "DM Sans", sans-serif;
    font-size: 16px; /* 16px prevents iOS zoom */
    background: var(--surface2);
    color: var(--text);
    outline: none;
    transition: border .18s, box-shadow .18s;
    -webkit-appearance: none;
    appearance: none;
  }
  input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(16,185,129,0.15);
  }
  /* datetime-local fix */
  input[type="datetime-local"] { font-size: 14px; }
  /* number inputs: hide spinners */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
  input[type="number"] { -moz-appearance: textfield; }

  .inputwrap { position: relative; }
  .suggestions {
    position: absolute; top: calc(100% + 4px); left: 0; right: 0; z-index: 50;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-lg);
    max-height: 240px; overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .s-item {
    padding: 13px 14px; cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background .12s;
    /* min touch target */
    min-height: 52px; display: flex; flex-direction: column; justify-content: center;
  }
  .s-item:last-child { border-bottom: none; }
  .s-item:active { background: var(--surface2); }
  .s-name { font-weight: 700; font-size: 15px; }
  .s-detail { font-size: 12px; color: var(--muted); margin-top: 2px; }

  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
  .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .grid3 label { margin-top: 0; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BUTTONS â€” 44px+ touch targets
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .btn {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 15px 16px;
    border-radius: var(--radius-sm); border: none;
    font-family: "DM Sans", sans-serif; font-size: 15px; font-weight: 800;
    cursor: pointer; letter-spacing: .3px;
    transition: transform .12s, opacity .12s;
    min-height: 50px;
    -webkit-user-select: none; user-select: none;
  }
  .btn:active { transform: scale(0.97); opacity: 0.9; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-blue { background: var(--blue); color: #fff; }
  .btn-purple { background: var(--purple); color: #fff; }
  .btn-red { background: var(--danger); color: #fff; margin-top: 14px; }

  .iconbtn {
    width: 40px; height: 40px; border-radius: 50%;
    border: 1.5px solid var(--border);
    background: var(--surface);
    cursor: pointer; font-size: 17px;
    display: flex; align-items: center; justify-content: center;
    transition: background .15s, transform .12s;
    flex-shrink: 0;
  }
  .iconbtn:active { transform: scale(0.92); background: var(--surface2); }

  .smallbtn {
    font-size: 12px; font-weight: 700;
    padding: 8px 14px;
    border-radius: 8px;
    border: 1.5px solid var(--accent);
    color: var(--accent); background: none; cursor: pointer;
    font-family: "DM Sans", sans-serif;
    min-height: 36px;
    transition: background .15s;
  }
  .smallbtn:active { background: rgba(16,185,129,0.08); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INFO / ERROR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .info {
    background: #ecfdf5; border: 1px solid #a7f3d0;
    border-radius: 10px; padding: 10px 13px;
    font-size: 13px; color: #065f46; margin-bottom: 14px; font-weight: 600;
  }
  body.dark .info { background: #064e3b; border-color: #065f46; color: #a7f3d0; }
  .error {
    background: #fef2f2; border: 1px solid #fecaca;
    border-radius: 10px; padding: 10px 13px;
    font-size: 13px; color: var(--danger); margin-top: 10px; font-weight: 600;
  }
  .hint { font-size: 11px; color: var(--muted); margin-top: 4px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESULTS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pill {
    display: inline-flex; align-items: center;
    background: #ecfdf5; color: var(--accent);
    border-radius: 999px; padding: 5px 14px;
    font-size: 13px; font-weight: 800; margin-bottom: 10px;
    border: 1.5px solid #a7f3d0;
  }
  .pill.danger { background: #fef2f2; color: var(--danger); border-color: #fecaca; }
  .big {
    font-family: "Bebas Neue", sans-serif;
    font-size: 56px; line-height: 1; margin: 6px 0 14px;
    letter-spacing: 1px;
  }
  .kv { margin-bottom: 10px; }
  .k { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .6px; }
  .v { font-size: 15px; font-weight: 700; margin-top: 2px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCHEDULE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .schedule { margin-top: 16px; }
  .sched {
    border-left: 4px solid var(--accent);
    padding: 11px 14px; margin-bottom: 8px;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    background: var(--surface2);
  }
  .sched.rest { border-color: var(--blue); }
  .sched.reset { border-color: var(--purple); }
  .sched.break30 { border-color: var(--amber); }
  .sched .t { font-size: 13px; font-weight: 800; }
  .sched .d { font-size: 12px; color: var(--muted); margin-top: 3px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MINI MAP
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .mapbox {
    height: 190px; border-radius: var(--radius-sm);
    overflow: hidden; margin-top: 12px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MONITOR MODAL (legacy, hidden behind fullscreen)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .monitor-overlay {
    display: none; position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    align-items: flex-end; justify-content: center;
  }
  .monitor-overlay.open { display: flex; }
  .monitor-card {
    background: var(--surface); border-radius: 22px 22px 0 0; width: 100%;
    max-width: 520px; max-height: 90vh; overflow: hidden;
    display: flex; flex-direction: column;
    animation: slideUp .3s cubic-bezier(.16,1,.3,1);
    padding-bottom: var(--sab);
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-head {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 18px; border-bottom: 1px solid var(--border);
    font-weight: 800; font-size: 16px;
  }
  .modal-close {
    width: 32px; height: 32px; border-radius: 50%; border: none;
    background: var(--surface2); font-size: 18px; cursor: pointer; color: var(--text);
    display: flex; align-items: center; justify-content: center;
    font-family: "DM Sans", sans-serif;
  }
  .stack { display: flex; flex-direction: column; gap: 12px; }
  .bar { height: 8px; background: var(--border); border-radius: 999px; overflow: hidden; margin: 4px 0; }
  .bar > div { height: 100%; background: var(--accent); border-radius: 999px; transition: width .5s; }
  .muted { font-size: 12px; color: var(--muted); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DRIVES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .drives-tabs { display: flex; gap: 8px; margin-bottom: 14px; }
  .drives-tab {
    padding: 8px 16px; border-radius: 999px;
    border: 1.5px solid var(--accent);
    background: var(--accent); color: #fff;
    font-family: "DM Sans", sans-serif; font-size: 13px; font-weight: 700; cursor: pointer;
    min-height: 36px;
  }
  .drives-tab span {
    background: rgba(255,255,255,.25); border-radius: 999px;
    padding: 1px 7px; margin-left: 5px; font-size: 11px;
  }
  .drives-header { padding: 4px 0 10px; }
  .drive-item {
    display: flex; gap: 14px; padding: 14px 16px;
    background: var(--surface); border-radius: var(--radius-sm);
    margin-bottom: 10px; box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: transform .12s;
  }
  .drive-item:active { transform: scale(0.99); }
  .drive-thumb { font-size: 30px; display: flex; align-items: center; }
  .drive-info { flex: 1; min-width: 0; }
  .drive-route { font-weight: 800; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .drive-meta { font-size: 12px; color: var(--muted); margin-top: 3px; }
  .drive-amount { font-size: 17px; font-weight: 900; color: var(--accent); margin-top: 5px; }
  .no-drives { text-align: center; padding: 60px 20px; color: var(--muted); font-size: 15px; line-height: 2; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS â€” iOS-style list groups
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .sett-section { margin-bottom: 24px; }
  .sett-section-title {
    font-size: 11px; font-weight: 800; color: var(--muted);
    text-transform: uppercase; letter-spacing: 1px;
    padding: 0 4px; margin-bottom: 8px;
  }
  .sett-group {
    background: var(--surface); border-radius: var(--radius);
    overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border);
  }
  .sett-row {
    display: flex; align-items: center; gap: 14px;
    padding: 14px 16px; cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background .12s;
    min-height: 52px; /* 44px+ touch target */
  }
  .sett-row:last-child { border-bottom: none; }
  .sett-row:active { background: var(--surface2); }
  .sett-icon {
    width: 34px; height: 34px; border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 17px; flex-shrink: 0;
  }
  .sett-label { flex: 1; font-weight: 600; font-size: 16px; }
  .sett-value { font-size: 13px; color: var(--muted); font-weight: 500; }
  .sett-arrow { font-size: 22px; color: var(--muted); font-weight: 300; }
  .sett-check { font-size: 18px; color: var(--accent); font-weight: 900; }
  .sett-toggle {
    width: 51px; height: 31px; border-radius: 999px; border: none;
    background: var(--border); cursor: pointer; position: relative;
    transition: background .25s; flex-shrink: 0;
  }
  .sett-toggle::after {
    content: ""; position: absolute; top: 3px; left: 3px;
    width: 25px; height: 25px; border-radius: 50%; background: #fff;
    transition: left .22s cubic-bezier(.34,1.56,.64,1);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
  .sett-toggle.on { background: var(--accent); }
  .sett-toggle.on::after { left: 23px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MENU PANEL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .menu-wrap { position: relative; }
  .menu-panel {
    display: none; position: absolute; top: 48px; right: 0; width: 240px;
    background: var(--surface); border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.18);
    border: 1px solid var(--border); z-index: 99; padding: 14px;
  }
  .menu-panel.open { display: block; animation: fadeScale .18s ease; }
  @keyframes fadeScale { from { opacity:0; transform:scale(.95) translateY(-6px); } to { opacity:1; transform:scale(1) translateY(0); } }
  .menu-title { font-weight: 800; font-size: 15px; margin-bottom: 12px; }
  .menu-group { margin-bottom: 12px; }
  .menu-label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; display: block; }
  .menu-select {
    width: 100%; padding: 9px 12px; border-radius: 10px;
    border: 1.5px solid var(--border);
    font-family: "DM Sans", sans-serif; font-size: 14px;
    background: var(--surface2); color: var(--text);
  }
  .menu-row { display: flex; gap: 6px; }
  .chip-btn {
    flex: 1; padding: 8px; border-radius: 10px;
    border: 1.5px solid var(--border);
    font-family: "DM Sans", sans-serif; font-size: 13px; font-weight: 600;
    background: var(--surface2); color: var(--text); cursor: pointer;
    transition: all .18s; min-height: 36px;
  }
  .chip-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESPONSIVE BREAKPOINTS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /* Very small phones (SE, Galaxy A series) */
  @media (max-width: 375px) {
    .big { font-size: 46px; }
    .grid3 { grid-template-columns: 1fr 1fr; }
    .grid3 > :last-child { grid-column: 1 / -1; }
    .container { padding: 0 12px 20px; }
  }
  /* Larger phones / small tablets */
  @media (min-width: 428px) {
    .container { padding: 0 20px 24px; }
    .card { padding: 18px; }
    .big { font-size: 62px; }
  }
  /* Landscape mode: compress header */
  @media (orientation: landscape) and (max-height: 500px) {
    .header { padding-top: 8px; padding-bottom: 6px; }
    .logo { font-size: 22px; }
    .card { padding: 12px; margin-bottom: 8px; }
    .mapbox { height: 140px; }
    :root { --tab-h: calc(50px + var(--sab)); }
  }
  /* Keyboard open: shrink suggestions to avoid overlap */
  @media (max-height: 500px) {
    .suggestions { max-height: 140px; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SAFETY FEATURES â€” shared alert styles
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* Full-screen danger flash overlay */
  .danger-flash {
    position: fixed; inset: 0; z-index: 9999;
    pointer-events: none;
    animation: dangerFlash .5s ease-in-out infinite;
  }
  @keyframes dangerFlash {
    0%,100% { background: rgba(239,68,68,0); }
    50%      { background: rgba(239,68,68,0.22); }
  }

  /* Toast alert banner */
  .safety-toast {
    position: fixed; top: calc(14px + env(safe-area-inset-top,0px));
    left: 14px; right: 14px; z-index: 9000;
    border-radius: 16px; padding: 14px 16px;
    display: flex; align-items: flex-start; gap: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.35);
    transform: translateY(-120px); opacity: 0;
    transition: transform .35s cubic-bezier(.16,1,.3,1), opacity .35s;
    pointer-events: all;
    max-width: 520px; margin: 0 auto;
  }
  .safety-toast.show { transform: translateY(0); opacity: 1; }
  .safety-toast.danger  { background: #1a0505; border: 1.5px solid #ef4444; }
  .safety-toast.warning { background: #1a1005; border: 1.5px solid #f59e0b; }
  .safety-toast.info    { background: #05101a; border: 1.5px solid #3b82f6; }
  .toast-icon { font-size: 28px; flex-shrink: 0; line-height: 1; margin-top: 2px; }
  .toast-body { flex: 1; }
  .toast-title { font-size: 14px; font-weight: 800; color: #fff; margin-bottom: 3px; }
  .toast-msg   { font-size: 12px; color: rgba(255,255,255,.75); line-height: 1.4; }
  .toast-close {
    width: 28px; height: 28px; border-radius: 50%; border: none;
    background: rgba(255,255,255,.12); color: #fff;
    font-size: 16px; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-family: "DM Sans",sans-serif;
  }

  /* â”€â”€ FATIGUE DETECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #fatigueOverlay {
    position: fixed; inset: 0; z-index: 8000;
    display: none; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(0,0,0,0.92);
    gap: 20px; padding: 24px;
  }
  #fatigueOverlay.active { display: flex; }
  #fatigueVideo {
    width: 120px; height: 120px; border-radius: 50%;
    object-fit: cover; border: 3px solid #ef4444;
    transform: scaleX(-1); /* mirror */
  }
  .fatigue-status-ring {
    width: 140px; height: 140px; border-radius: 50%;
    position: absolute;
    border: 4px solid #ef4444;
    animation: ringPulse 1s infinite;
  }
  @keyframes ringPulse {
    0%,100% { transform: scale(1); opacity: 1; }
    50%      { transform: scale(1.15); opacity: .4; }
  }
  #fatigueAlert {
    position: fixed; inset: 0; z-index: 9500;
    display: none; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(180,0,0,0.97);
    gap: 16px; padding: 32px; text-align: center;
  }
  #fatigueAlert.show { display: flex; animation: dangerFlash .4s ease-in-out 3; }
  #fatigueAlert .alert-emoji { font-size: 80px; animation: shake .3s infinite; }
  #fatigueAlert .alert-title { font-family:"Bebas Neue",sans-serif; font-size:52px; color:#fff; letter-spacing:2px; line-height:1; }
  #fatigueAlert .alert-sub { font-size:18px; color:rgba(255,255,255,.85); font-weight:700; }
  #fatigueAlert .alert-dismiss {
    margin-top:16px; padding:16px 40px; border-radius:14px; border:none;
    background:#fff; color:#ef4444; font-family:"DM Sans",sans-serif;
    font-size:16px; font-weight:900; cursor:pointer;
  }
  @keyframes shake {
    0%,100%{ transform:rotate(-8deg); }
    50%    { transform:rotate(8deg); }
  }

  /* â”€â”€ WEATHER WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #weatherWidget {
    position: fixed;
    bottom: calc(var(--tab-h) + 12px);
    right: 14px; right: calc(14px + env(safe-area-inset-right,0px));
    z-index: 500;
    background: rgba(15,23,42,0.88);
    backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
    border-radius: 16px; padding: 10px 14px;
    border: 1px solid rgba(255,255,255,.1);
    box-shadow: 0 4px 24px rgba(0,0,0,.4);
    color: #f1f5f9;
    min-width: 120px;
    display: none;
    cursor: pointer;
    transition: transform .2s;
  }
  #weatherWidget:active { transform: scale(.96); }
  #weatherWidget.visible { display: block; animation: fadeIn .3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .wx-row { display: flex; align-items: center; gap: 8px; }
  .wx-icon { font-size: 26px; line-height: 1; }
  .wx-temp { font-family:"Bebas Neue",sans-serif; font-size: 28px; line-height:1; }
  .wx-desc { font-size: 10px; color: rgba(255,255,255,.6); font-weight:600; text-transform:uppercase; letter-spacing:.4px; margin-top:2px; }
  .wx-danger { color: #ef4444 !important; animation: blink 1s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }

  /* â”€â”€ BRIDGE DETECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bridgeInput {
    position: fixed;
    bottom: calc(var(--tab-h) + 12px);
    left: 14px; left: calc(14px + env(safe-area-inset-left,0px));
    z-index: 500;
    background: rgba(15,23,42,0.88);
    backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
    border-radius: 16px; padding: 10px 14px;
    border: 1px solid rgba(255,255,255,.1);
    box-shadow: 0 4px 24px rgba(0,0,0,.4);
    color: #f1f5f9; display: none;
    min-width: 150px;
  }
  #bridgeInput.visible { display: block; animation: fadeIn .3s ease; }
  .bridge-label { font-size: 9px; color:rgba(255,255,255,.5); text-transform:uppercase; letter-spacing:.5px; margin-bottom:5px; font-weight:700; }
  .bridge-row { display:flex; align-items:center; gap:6px; }
  .bridge-val { font-family:"Bebas Neue",sans-serif; font-size:26px; color:#f59e0b; line-height:1; }
  .bridge-ft  { font-size:11px; color:rgba(255,255,255,.5); font-weight:600; }
  .bridge-btns { display:flex; gap:4px; margin-top:6px; }
  .bridge-btn {
    flex:1; padding:5px; border-radius:8px; border:none;
    font-family:"DM Sans",sans-serif; font-size:13px; font-weight:700;
    cursor:pointer; background:rgba(255,255,255,.1); color:#fff;
  }
  .bridge-btn:active { background:rgba(255,255,255,.2); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAP POI POPUPS & REPORT SYSTEM
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /* POI legend bar on fullscreen map */
  #poiLegend {
    position:absolute; top:calc(76px + env(safe-area-inset-top,0px));
    left: calc(14px + env(safe-area-inset-left,0px));
    right: calc(14px + env(safe-area-inset-right,0px));
    z-index:10; display:none;
    gap:6px; flex-wrap:wrap;
    pointer-events:none;
  }
  #poiLegend.visible { display:flex; }
  .poi-chip {
    display:flex; align-items:center; gap:4px;
    background:rgba(15,23,42,0.85); backdrop-filter:blur(8px);
    border-radius:999px; padding:5px 10px;
    font-size:11px; font-weight:700; color:#f1f5f9;
    border:1px solid rgba(255,255,255,.1);
    pointer-events:all; cursor:pointer;
    transition:background .15s;
  }
  .poi-chip:active { background:rgba(255,255,255,.15); }
  .poi-chip.off { opacity:.45; }

  /* Report button (Waze-style FAB on map) */
  #reportFab {
    position:absolute;
    right: calc(14px + env(safe-area-inset-right,0px));
    bottom: 300px;
    z-index:10;
    width:52px; height:52px; border-radius:50%; border:none;
    background:#f59e0b; color:#fff;
    font-size:22px; cursor:pointer;
    box-shadow:0 4px 16px rgba(245,158,11,.5);
    display:none; align-items:center; justify-content:center;
    transition:transform .15s;
  }
  #reportFab.visible { display:flex; }
  #reportFab:active { transform:scale(.92); }

  /* â”€â”€ ACTIVE INCIDENT MINI ICON (settings) â”€â”€â”€â”€â”€ */
  .inc-mini-icon {
    width: 36px; height: 36px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border: 2px solid var(--border);
    animation: iconPop .3s cubic-bezier(.34,1.56,.64,1);
    cursor: default;
    position: relative;
  }
  @keyframes iconPop {
    from { transform: scale(0); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
  }

  /* Keep report panel CSS but hide the FAB */
  #reportFab { display: none !important; }

  /* Report panel */
  #reportPanel {
    position:absolute; bottom:0; left:0; right:0; z-index:20;
    background:rgba(10,16,30,0.97); backdrop-filter:blur(20px);
    border-radius:22px 22px 0 0;
    padding:20px 16px calc(24px + env(safe-area-inset-bottom,0px));
    transform:translateY(100%);
    transition:transform .35s cubic-bezier(.16,1,.3,1);
    border-top:1px solid rgba(255,255,255,.08);
  }
  #reportPanel.open { transform:translateY(0); }
  .report-handle { width:36px;height:4px;background:rgba(255,255,255,.2);border-radius:999px;margin:0 auto 16px; }
  .report-title { font-family:"Bebas Neue",sans-serif;font-size:22px;color:#fff;letter-spacing:1px;margin-bottom:14px;text-align:center; }
  .report-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:14px; }
  .report-type {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:6px; padding:14px 8px; border-radius:14px;
    border:1.5px solid rgba(255,255,255,.1); background:rgba(255,255,255,.05);
    cursor:pointer; color:#f1f5f9; font-size:11px; font-weight:700;
    text-align:center; transition:all .15s; min-height:72px;
  }
  .report-type:active { background:rgba(255,255,255,.15); transform:scale(.97); }
  .report-type .rt-icon { font-size:26px; line-height:1; }
  .report-cancel {
    width:100%; padding:13px; border-radius:12px; border:1px solid rgba(255,255,255,.15);
    background:rgba(255,255,255,.08); color:#f1f5f9;
    font-family:"DM Sans",sans-serif; font-size:15px; font-weight:700; cursor:pointer;
  }

  /* Community alert banner on map */
  .map-alert-banner {
    position:absolute; z-index:15;
    left: calc(14px + env(safe-area-inset-left,0px));
    right: calc(14px + env(safe-area-inset-right,0px));
    top:calc(140px + env(safe-area-inset-top,0px));
    background:rgba(245,158,11,0.95); border-radius:14px; padding:10px 14px;
    display:flex; align-items:center; gap:10px;
    color:#000; font-weight:700; font-size:13px;
    animation:slideDown .3s ease;
    pointer-events:none;
  }
  @keyframes slideDown { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
  .map-alert-banner .ban-icon { font-size:22px; flex-shrink:0; }
  .map-alert-banner .ban-txt { flex:1; line-height:1.3; }
  .map-alert-banner .ban-dist { font-size:11px; opacity:.7; }

  /* Zoom controls replacement â€” right side */
  .fm-zoom-btns {
    position:absolute;
    right: calc(14px + env(safe-area-inset-right,0px));
    top: 50%; transform:translateY(-50%);
    z-index:10; display:flex; flex-direction:column; gap:6px;
  }
  .fm-zoom-btn {
    width:40px; height:40px; border-radius:12px; border:none;
    background:rgba(15,23,42,0.85); backdrop-filter:blur(8px);
    color:#fff; font-size:20px; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 2px 8px rgba(0,0,0,.3); transition:transform .12s;
  }
  .fm-zoom-btn:active { transform:scale(.92); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CIRCULAR SPEEDOMETER WIDGET
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #speedometerWidget {
    position: fixed;
    bottom: calc(var(--tab-h) + 16px);
    left: 50%;
    transform: translateX(-50%);
    z-index: 600;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
  }
  #speedometerWidget.visible { display: flex; }
  .speedo-ring {
    width: 110px; height: 110px;
    border-radius: 50%;
    background: rgba(10,16,30,0.95);
    border: 3px solid #10b981;
    box-shadow: 0 0 0 2px rgba(16,185,129,0.15), 0 0 24px rgba(16,185,129,0.25), 0 8px 32px rgba(0,0,0,0.6);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative;
    backdrop-filter: blur(16px);
  }
  .speedo-ring.moving {
    border-color: #10b981;
    box-shadow: 0 0 0 2px rgba(16,185,129,0.3), 0 0 30px rgba(16,185,129,0.4), 0 8px 32px rgba(0,0,0,0.6);
  }
  .speedo-ring.stopped {
    border-color: #6b7280;
    box-shadow: 0 0 0 2px rgba(107,114,128,0.15), 0 8px 32px rgba(0,0,0,0.6);
  }
  .speedo-svg {
    position: absolute; top: -5px; left: -5px;
    width: 120px; height: 120px;
    pointer-events: none;
  }
  .speedo-num {
    font-family: "Bebas Neue", sans-serif;
    font-size: 42px; line-height: 1;
    color: #10b981;
    letter-spacing: 1px;
    z-index: 1;
  }
  .speedo-num.stopped { color: #6b7280; }
  .speedo-unit {
    font-size: 10px; font-weight: 800;
    color: rgba(255,255,255,0.45);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    z-index: 1;
    margin-top: -4px;
  }
  .speedo-label {
    font-size: 9px; font-weight: 700;
    color: rgba(255,255,255,0.3);
    letter-spacing: .8px;
    margin-top: 3px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INCIDENT BUBBLES PANEL (left side, stacked)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #incidentPanel {
    position: fixed;
    left: calc(10px + env(safe-area-inset-left, 0px));
    top: 50%;
    transform: translateY(-50%);
    z-index: 700;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: none;
  }
  .incident-bubble {
    width: 64px; height: 64px;
    border-radius: 50%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 1px;
    pointer-events: all;
    cursor: pointer;
    border: 2.5px solid #fff;
    box-shadow: 0 3px 14px rgba(0,0,0,0.55);
    animation: bubbleIn .3s cubic-bezier(.34,1.56,.64,1);
    position: relative;
    transition: transform .15s;
  }
  .incident-bubble:active { transform: scale(0.93); }
  @keyframes bubbleIn {
    from { opacity: 0; transform: scale(0.4) translateX(-20px); }
    to   { opacity: 1; transform: scale(1) translateX(0); }
  }
  .incident-bubble.police   { background: #1d3a8a; border-color: #93c5fd; }
  .incident-bubble.accident { background: #7f1d1d; border-color: #fca5a5; }
  .incident-bubble.traffic  { background: #78350f; border-color: #fcd34d; }
  .incident-bubble.hazard   { background: #7c2d12; border-color: #fdba74; }
  .incident-bubble.construction { background: #713f12; border-color: #fde68a; }
  .incident-bubble.closure  { background: #450a0a; border-color: #f87171; }
  .ib-emoji { font-size: 24px; line-height: 1; }
  .ib-dist  { font-size: 9px; font-weight: 800; color: rgba(255,255,255,0.9); letter-spacing: .4px; }
  .ib-label { font-size: 7px; font-weight: 700; color: rgba(255,255,255,0.6); letter-spacing: .3px; text-align: center; line-height: 1.2; max-width: 52px; }
  /* dismiss X on bubble */
  .ib-close {
    position: absolute; top: -3px; right: -3px;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: rgba(0,0,0,0.7);
    border: 1.5px solid rgba(255,255,255,0.5);
    color: #fff; font-size: 10px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 900;
  }
  /* Toggle button for incident panel */
  #incidentToggleBtn {
    position: fixed;
    left: calc(10px + env(safe-area-inset-left, 0px));
    top: calc(var(--header-pt) + 60px);
    z-index: 701;
    width: 44px; height: 44px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.2);
    background: rgba(10,16,30,0.88);
    backdrop-filter: blur(12px);
    color: #fff; font-size: 18px;
    display: none;
    align-items: center; justify-content: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.4);
    cursor: pointer;
    transition: background .2s;
  }
  #incidentToggleBtn.visible { display: flex; }
  #incidentToggleBtn.has-incidents {
    background: rgba(239,68,68,0.85);
    border-color: rgba(255,255,255,0.4);
    animation: incidentBtnPulse 2s ease-in-out infinite;
  }
  @keyframes incidentBtnPulse {
    0%,100% { box-shadow: 0 2px 12px rgba(0,0,0,0.4); }
    50% { box-shadow: 0 0 0 6px rgba(239,68,68,0.25), 0 2px 12px rgba(0,0,0,0.4); }
  }
  .incident-badge {
    position: absolute; top: -4px; right: -4px;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: #ef4444; color: #fff;
    font-size: 10px; font-weight: 900;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid #fff;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FULL-SCREEN ALERT â€” only for HOS/weather/bridge
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #fullscreenAlertOverlay {
    position: fixed; inset: 0; z-index: 19000;
    display: none;
    flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center;
    padding: 24px;
    animation: alertPulse .6s ease-in-out infinite alternate;
  }
  #fullscreenAlertOverlay.show { display: flex; }
  #fullscreenAlertOverlay.police {
    background: rgba(30,40,80,0.98);
    border: 4px solid #3b82f6;
  }
  #fullscreenAlertOverlay.danger-alert {
    background: rgba(80,10,10,0.98);
    border: 4px solid #ef4444;
  }
  #fullscreenAlertOverlay.warning-alert {
    background: rgba(50,35,10,0.98);
    border: 4px solid #f59e0b;
  }
  @keyframes alertPulse {
    from { box-shadow: inset 0 0 0px rgba(255,255,255,0); }
    to   { box-shadow: inset 0 0 60px rgba(255,255,255,0.04); }
  }
  .fs-alert-emoji {
    font-size: 100px; line-height: 1;
    filter: drop-shadow(0 0 20px rgba(255,255,255,0.3));
    animation: alertBounce 0.5s ease-in-out infinite alternate;
  }
  @keyframes alertBounce {
    from { transform: scale(1); }
    to   { transform: scale(1.1); }
  }
  .fs-alert-title {
    font-family: "Bebas Neue", sans-serif;
    font-size: 64px; color: #fff;
    letter-spacing: 3px; line-height: 1;
    margin-top: 16px;
    text-shadow: 0 0 30px rgba(255,255,255,0.3);
  }
  .fs-alert-sub {
    font-size: 20px; color: rgba(255,255,255,0.85);
    font-weight: 700; margin-top: 10px;
    line-height: 1.4; max-width: 320px;
  }
  .fs-alert-dist {
    font-size: 16px; color: rgba(255,255,255,0.55);
    margin-top: 8px; font-weight: 600;
  }
  .fs-alert-dismiss {
    margin-top: 32px;
    padding: 18px 48px;
    border-radius: 16px; border: none;
    font-family: "DM Sans", sans-serif;
    font-size: 18px; font-weight: 900;
    cursor: pointer;
    min-width: 260px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    transition: transform .12s;
  }
  .fs-alert-dismiss:active { transform: scale(0.96); }
  .fs-alert-dismiss.police-btn { background: #3b82f6; color: #fff; }
  .fs-alert-dismiss.danger-btn { background: #ef4444; color: #fff; }
  .fs-alert-dismiss.warning-btn { background: #f59e0b; color: #000; }
  /* Flashing light bar for police */
  .police-lightbar {
    display: none;
    width: 100%;
    height: 18px;
    position: absolute; top: 0; left: 0;
    border-radius: 0;
    overflow: hidden;
  }
  .fs-alert-overlay.police .police-lightbar { display: block; }
  #fullscreenAlertOverlay.police .police-lightbar { display: flex; }
  .police-lightbar-inner {
    flex: 1;
    animation: lightbarFlash 0.35s linear infinite alternate;
  }
  .police-lightbar-inner:nth-child(odd) {
    background: #3b82f6;
    animation-direction: alternate;
  }
  .police-lightbar-inner:nth-child(even) {
    background: #ef4444;
    animation-direction: alternate-reverse;
  }
  @keyframes lightbarFlash {
    from { opacity: 1; }
    to { opacity: 0.15; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     REST ALARM OVERLAY
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #restAlarmOverlay {
    position: fixed; inset: 0; z-index: 18000;
    display: none;
    flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center;
    padding: 24px;
    background: rgba(5,30,50,0.97);
    border: 4px solid #3b82f6;
  }
  #restAlarmOverlay.show { display: flex; }
  .rest-alarm-emoji { font-size: 90px; animation: restPulse 1s ease-in-out infinite; }
  @keyframes restPulse {
    0%,100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }
  .rest-alarm-title {
    font-family: "Bebas Neue", sans-serif;
    font-size: 58px; color: #3b82f6;
    letter-spacing: 2px; margin-top: 14px;
  }
  .rest-alarm-sub {
    font-size: 18px; color: rgba(255,255,255,0.8);
    font-weight: 700; margin-top: 8px; max-width: 300px;
  }
  .rest-alarm-timer {
    font-family: "Bebas Neue", sans-serif;
    font-size: 80px; color: #f59e0b;
    letter-spacing: 2px; margin-top: 10px;
    line-height: 1;
  }
  .rest-alarm-dismiss {
    margin-top: 28px; padding: 18px 48px;
    border-radius: 16px; border: none;
    background: #3b82f6; color: #fff;
    font-family: "DM Sans", sans-serif;
    font-size: 18px; font-weight: 900; cursor: pointer;
    min-width: 260px;
    box-shadow: 0 4px 20px rgba(59,130,246,0.5);
  }

  /* Auto-follow toggle button */
  #fmFollowBtn {
    position:absolute;
    right: calc(14px + env(safe-area-inset-right,0px));
    bottom: 360px; z-index:10;
    width:44px; height:44px; border-radius:50%; border:none;
    background:rgba(15,23,42,0.88); backdrop-filter:blur(8px);
    color:#fff; font-size:20px; cursor:pointer;
    box-shadow:0 2px 12px rgba(0,0,0,.4);
    display:none; align-items:center; justify-content:center;
    transition:background .2s;
  }
  #fmFollowBtn.active { background:#10b981; box-shadow:0 2px 12px rgba(16,185,129,.5); }
  #fmFollowBtn.visible { display:flex; }
</style>
</head>

<body>
<div class="bg-icons" aria-hidden="true">
  <span style="top:4%;left:3%;font-size:58px;opacity:.10">ğŸš›</span>
  <span style="top:12%;right:8%;font-size:44px;opacity:.08">â°</span>
  <span style="top:24%;left:10%;font-size:36px;opacity:.08">ğŸ•</span>
  <span style="top:28%;right:14%;font-size:62px;opacity:.07">ğŸšš</span>
  <span style="top:42%;left:4%;font-size:46px;opacity:.07">â±ï¸</span>
  <span style="top:54%;right:4%;font-size:64px;opacity:.08">ğŸš›</span>
  <span style="top:66%;left:14%;font-size:42px;opacity:.07">ğŸ•’</span>
  <span style="top:78%;right:12%;font-size:38px;opacity:.08">â°</span>
  <span style="top:84%;left:6%;font-size:60px;opacity:.09">ğŸšš</span>
  <span style="top:88%;right:24%;font-size:34px;opacity:.07">ğŸ•™</span>
</div>

<div class="App" data-scroll>
  <!-- TAB BAR -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="plan">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span id="tabLblPlan">Plan Route</span>
    </button>
    <button class="tab-btn" data-tab="drives">
      <svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13" rx="2"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
      <span id="tabLblDrives">All Drives</span>
    </button>
    <button class="tab-btn" data-tab="summary">
      <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      <span id="tabLblSummary">Summaries</span>
    </button>
    <button class="tab-btn" data-tab="settings">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      <span id="tabLblSettings">Settings</span>
    </button>
  </div>

  <!-- PLAN PAGE -->
  <div class="page active" id="page-plan">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">ğŸš› <span>HOS Tracker</span></div>
          <div class="row">
            <button class="iconbtn" id="themeToggle" title="Theme">ğŸŒ™</button>
            <button class="iconbtn" id="gpsBtn" title="GPS" style="font-size:16px">ğŸ“</button>
            <div class="menu-wrap">
              <button class="iconbtn" id="menuBtn">âš™ï¸</button>
              <div class="menu-panel" id="menuPanel">
                <div class="menu-title" id="menuTitle">Settings</div>
                <div class="menu-group">
                  <label class="menu-label" id="menuLangLbl">Language</label>
                  <select class="menu-select" id="langSelect">
                    <option value="en">English</option>
                    <option value="es">EspaÃ±ol</option>
                  </select>
                </div>
                <div class="menu-group">
                  <label class="menu-label" id="menuThemeLbl">Theme</label>
                  <div class="menu-row">
                    <button class="chip-btn active" id="lightBtn">â˜€ï¸ Light</button>
                    <button class="chip-btn" id="darkBtn">ğŸŒ™ Dark</button>
                  </div>
                </div>
                <div class="menu-group">
                  <label class="menu-label" id="menuCountryLbl">Country</label>
                  <select class="menu-select" id="countrySelectMenu"></select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="subtitle" id="subtitleTxt">DOT Hours of Service Planner</div>
        <div style="font-size:9px;color:var(--muted);font-weight:600;letter-spacing:1px;margin-top:2px">by <span style="font-family:'Bebas Neue',sans-serif;font-size:11px;letter-spacing:1.5px;color:var(--accent)">fab-visualâ„¢</span></div>
      </div>

      <!-- MINI MAP -->
      <div class="card" id="miniMapCard" style="display:none">
        <div class="row between">
          <div style="font-weight:800">ğŸ—ºï¸ <span id="routeMapLbl">Route Map</span></div>
          <button class="smallbtn" id="fullMapBtn">View Full Map</button>
        </div>
        <div class="hint" id="roadHintTxt">Real road route when available</div>
        <div class="hint" id="routeSourceTxt"></div>
        <div class="mapbox" id="miniMap"></div>
      </div>

      <!-- FORM -->
      <div class="card">
        <div class="info" id="infoTxt">ğŸ’¡ Type city name to search globally</div>

        <label id="lblFrom">ğŸ“ Origin</label>
        <div class="inputwrap">
          <input id="originInput" placeholder="Miami, FL" autocomplete="off" />
          <div class="suggestions" id="originSugg" style="display:none"></div>
        </div>

        <label id="lblTo">ğŸ¯ Destination</label>
        <div class="inputwrap">
          <input id="destInput" placeholder="Dallas, TX" autocomplete="off" />
          <div class="suggestions" id="destSugg" style="display:none"></div>
        </div>

        <div class="grid3" style="margin-top:10px">
          <div>
            <label id="lblTime">ğŸ• Departure</label>
            <input type="datetime-local" id="departureInput" />
          </div>
          <div>
            <label id="lblHours">â±ï¸ Hours Left</label>
            <input type="number" id="hoursInput" min="1" max="70" value="70" />
          </div>
          <div>
            <label id="lblSpeed">ğŸš€ Speed (mph)</label>
            <input type="number" id="speedInput" min="1" value="60" />
          </div>
        </div>

        <div class="error" id="errorBox" style="display:none"></div>

        <button class="btn btn-primary" id="calcBtn" style="margin-top:12px">ğŸš› Calculate Route</button>

        <div class="grid2" id="shareTrackBtns" style="display:none;margin-top:10px">
          <button class="btn btn-blue" id="shareBtn">ğŸ“¤ Share Route</button>
          <button class="btn btn-purple" id="trackBtn">ğŸ“ Start Live Tracking</button>
        </div>
      </div>

      <!-- RESULTS -->
      <div class="card results" id="resultsCard" style="display:none">
        <div class="pill" id="timeVsHours"></div>
        <div class="big" id="distanceBig"></div>
        <div class="grid2">
          <div class="kv"><div class="k" id="fromLbl">FROM</div><div class="v" id="fromVal"></div></div>
          <div class="kv"><div class="k" id="toLbl">TO</div><div class="v" id="toVal"></div></div>
        </div>
        <div class="grid2">
          <div class="kv"><div class="k" id="departureLbl">DEPARTURE</div><div class="v" id="departureVal"></div></div>
          <div class="kv"><div class="k" id="arrivalLbl">ARRIVAL</div><div class="v" id="arrivalVal"></div></div>
        </div>
        <div class="kv"><div class="k" id="totalTimeLbl">TOTAL TIME</div><div class="v" id="totalTimeVal"></div></div>
        <div class="schedule" id="scheduleList"></div>
        <button class="btn btn-red" id="resetBtn">ğŸ”„ New Route</button>
      </div>
    </div>
  </div>

  <!-- DRIVES PAGE -->
  <div class="page" id="page-drives">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">ğŸš› <span id="drivesTitleTxt">All Drives</span></div>
        </div>
      </div>
      <div class="drives-tabs">
        <button class="drives-tab" id="drivesTabBtn">Business <span id="drivesCount">0</span></button>
      </div>
      <div id="drivesList"></div>
    </div>
  </div>

  <!-- SUMMARY PAGE -->
  <div class="page" id="page-summary">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">ğŸš› <span id="summaryTitleTxt">Summaries</span></div>
        </div>
      </div>
      <div class="card" style="text-align:center">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px">
          <div>
            <div style="font-size:28px;font-weight:900" id="sumDrives">0</div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="sumDrivesLbl">Drives</div>
          </div>
          <div>
            <div style="font-size:28px;font-weight:900;color:var(--muted)" id="sumMiles">0</div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="sumMilesLbl">Miles</div>
          </div>
          <div>
            <div style="font-size:28px;font-weight:900;color:var(--accent)" id="sumValue">$0</div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="sumValueLbl">Logged</div>
          </div>
        </div>
        <div style="font-size:48px;margin:16px 0">ğŸš›</div>
        <div style="font-size:16px;font-weight:700;margin-bottom:8px" id="sumStatus">No routes yet</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:16px" id="sumDesc">Plan a route to see your summary here.</div>
        <button class="btn btn-primary" id="sendReportBtn" style="display:none">ğŸ“¤ Send Report</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS PAGE -->
  <div class="page" id="page-settings">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">âš™ï¸ <span id="settTitleTxt">Settings</span></div>
        </div>
      </div>

      <div class="sett-section">
        <div class="sett-section-title" id="settSecGeneral">General</div>
        <div class="sett-group">
          <div class="sett-row" id="langRow">
            <div class="sett-icon" style="background:#dbeafe">ğŸ—£ï¸</div>
            <div class="sett-label" id="settLangRow">Language</div>
            <div class="sett-value" id="langVal">English</div>
            <span class="sett-arrow">â€º</span>
          </div>
          <div class="sett-row" id="countryRow">
            <div class="sett-icon" style="background:#d1fae5">ğŸŒ</div>
            <div class="sett-label" id="settCountryRow">Country Filter</div>
            <div class="sett-value" id="countryVal">All</div>
            <span class="sett-arrow">â€º</span>
          </div>
        </div>
      </div>

      <div class="sett-section" id="langPanel" style="display:none">
        <div class="sett-section-title">Language / Idioma</div>
        <div class="sett-group">
          <div class="sett-row" id="setLangEn">
            <div class="sett-icon">ğŸ‡ºğŸ‡¸</div>
            <div class="sett-label">English</div>
            <span class="sett-check" id="checkEn">âœ“</span>
          </div>
          <div class="sett-row" id="setLangEs">
            <div class="sett-icon">ğŸ‡ªğŸ‡¸</div>
            <div class="sett-label">EspaÃ±ol</div>
            <span class="sett-check" id="checkEs" style="opacity:0">âœ“</span>
          </div>
        </div>
      </div>

      <div class="sett-section" id="countryPanel" style="display:none">
        <div class="sett-section-title" id="settCountryRowTitle">Country Filter</div>
        <div class="sett-group" style="margin:0 14px">
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#d1fae5">ğŸŒ</div>
            <select id="countrySelectSettings" style="flex:1;border:none;background:transparent;font-size:15px;color:var(--text);outline:none;cursor:pointer;padding:4px 0;font-family:'DM Sans',sans-serif"></select>
          </div>
        </div>
      </div>

      <div class="sett-section">
        <div class="sett-section-title" id="settSecAppear">Appearance</div>
        <div class="sett-group">
          <div class="sett-row" id="lightModeRow">
            <div class="sett-icon" style="background:#fef9c3">â˜€ï¸</div>
            <div class="sett-label" id="settLightRow">Light Mode</div>
            <span class="sett-check" id="checkLight">âœ“</span>
          </div>
          <div class="sett-row" id="darkModeRow">
            <div class="sett-icon" style="background:#1e293b">ğŸŒ™</div>
            <div class="sett-label" id="settDarkRow">Dark Mode</div>
            <span class="sett-check" id="checkDark" style="opacity:0">âœ“</span>
          </div>
        </div>
      </div>

      <div class="sett-section">
        <div class="sett-section-title" id="settSecHOS">HOS Rules</div>
        <div class="sett-group">
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#fee2e2">ğŸš¦</div>
            <div class="sett-label" id="settSpeedLimitRow">Default Speed Limit</div>
            <div style="display:flex;align-items:center;gap:6px">
              <input type="number" id="defaultSpeedInput" min="20" max="85" value="60" style="width:64px;padding:5px 8px;font-size:14px;font-weight:700;text-align:center;border-radius:8px;border:1.5px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif" />
              <span style="font-size:12px;color:var(--muted);font-weight:600">mph</span>
            </div>
          </div>
          <div class="sett-row">
            <div class="sett-icon" style="background:#fef3c7">â˜•</div>
            <div class="sett-label" id="settBreakRow">30-min Break Rule</div>
            <button class="sett-toggle on" id="breakToggle"></button>
          </div>
          <div class="sett-row">
            <div class="sett-icon" style="background:#d1fae5">â±ï¸</div>
            <div class="sett-label" id="settCycleRow">Cycle Hours</div>
            <div class="sett-value">70 hrs DOT</div>
          </div>
          <div class="sett-row">
            <div class="sett-icon" style="background:#dbeafe">ğŸ˜´</div>
            <div class="sett-label" id="settRestRow">Rest Requirement</div>
            <div class="sett-value">10 hrs DOT</div>
          </div>
        </div>
      </div>

      <!-- SAFETY FEATURES SECTION -->
      <div class="sett-section">
        <div class="sett-section-title">ğŸ›¡ï¸ Safety Features</div>
        <div class="sett-group">

          <!-- Fatigue Detector -->
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#fce7f3">ğŸ˜´</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">Fatigue Detector</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px" id="fatigueStatusTxt">Camera off</div>
            </div>
            <button class="sett-toggle" id="fatigueToggle"></button>
          </div>

          <!-- Weather Alerts -->
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#e0f2fe">â›ˆï¸</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">Weather Alerts</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px" id="weatherStatusTxt">Off</div>
            </div>
            <button class="sett-toggle" id="weatherToggle"></button>
          </div>

          <!-- Bridge Detector -->
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#fef3c7">ğŸŒ‰</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">Low Bridge Detector</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px" id="bridgeStatusTxt">Off â€” set trailer height</div>
            </div>
            <button class="sett-toggle" id="bridgeToggle"></button>
          </div>

          <!-- Trailer height input (visible when bridge toggle is ON) -->
          <div id="trailerHeightRow" class="sett-row" style="cursor:default;display:none;background:var(--surface2)">
            <div class="sett-icon" style="background:#fef3c7">ğŸ“</div>
            <div class="sett-label" style="font-size:14px">Trailer Height</div>
            <div style="display:flex;align-items:center;gap:6px">
              <input type="number" id="trailerHeightInput" min="8" max="18" step="0.1" value="13.6"
                style="width:70px;padding:6px 8px;font-size:15px;font-weight:700;text-align:center;
                       border-radius:8px;border:1.5px solid var(--border);background:var(--bg);
                       color:var(--text);font-family:'DM Sans',sans-serif" />
              <span style="font-size:12px;color:var(--muted);font-weight:700">ft</span>
            </div>
          </div>

          <!-- â”€â”€â”€ INCIDENT REPORTS (inside same Safety group) â”€â”€â”€ -->
          <div style="padding:12px 16px 6px;border-top:1px solid var(--border)">
            <div style="font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">ğŸš¨ Reportar Incidentes</div>
            <div style="font-size:11px;color:var(--muted);font-weight:600;margin-bottom:12px;line-height:1.4">
              Activa el tipo de incidente que quieras reportar. Aparece como Ã­cono en el mapa al activarlo.
            </div>

            <!-- Incident toggles grid -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">

              <!-- Police -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#dbeafe;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸš”</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">PolicÃ­a</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incPoliceStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incPoliceToggle" onclick="toggleIncidentType('police',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Accident -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#fee2e2;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸ’¥</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">Accidente</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incAccidentStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incAccidentToggle" onclick="toggleIncidentType('accident',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Traffic -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#fef3c7;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸš¦</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">TrÃ¡fico</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incTrafficStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incTrafficToggle" onclick="toggleIncidentType('traffic',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Hazard -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#ffedd5;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">âš ï¸</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">Peligro</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incHazardStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incHazardToggle" onclick="toggleIncidentType('hazard',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Construction -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#fef9c3;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸš§</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">ConstrucciÃ³n</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incConstructionStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incConstructionToggle" onclick="toggleIncidentType('construction',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Closure -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#fee2e2;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸ›‘</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">VÃ­a Cerrada</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incClosureStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incClosureToggle" onclick="toggleIncidentType('closure',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

            </div>

            <!-- Active incident mini icons -->
            <div id="activeIncidentIcons" style="display:none;padding:8px 0 4px">
              <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Activos:</div>
              <div id="activeIconsRow" style="display:flex;gap:6px;flex-wrap:wrap"></div>
            </div>

          </div>

        </div><!-- end sett-group -->
      </div><!-- end safety sett-section -->

      <div class="sett-section">
        <div class="sett-section-title" id="settSecAbout">About</div>
        <div class="sett-group">
          <div class="sett-row">
            <div class="sett-icon" style="background:#d1fae5">ğŸš›</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">HOS Tracker</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px">DOT Hours of Service Planner</div>
            </div>
            <div class="sett-value">v6.0</div>
          </div>
          <div class="sett-row" id="shareAppRow">
            <div class="sett-icon" style="background:#dbeafe">ğŸ“¤</div>
            <div class="sett-label" id="settShareRow">Share App</div>
            <span class="sett-arrow">â€º</span>
          </div>
        </div>
      </div>

      <!-- fab-visual trademark footer -->
      <div style="text-align:center;padding:12px 0 4px">
        <div style="font-size:10px;color:var(--muted);font-weight:600;letter-spacing:.8px;text-transform:uppercase">Powered by</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--accent);margin-top:2px">fab-visualâ„¢</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px;font-weight:500">Â© 2025 fab-visual. All rights reserved.</div>
      </div>

      <div style="height:20px"></div>
    </div>
  </div>
</div>

<!-- ============================================================
     FULLSCREEN MAP VIEW  (Google Maps style)
     ============================================================ -->
<div id="fullMapScreen" style="
  display:none; position:fixed; inset:0; z-index:500;
  background:#000; flex-direction:column;
">
  <!-- MAP fills entire screen -->
  <div id="fullMap" style="position:absolute;inset:0;z-index:1"></div>

  <!-- TOP BAR: close + live dot -->
  <div style="
    position:absolute;top:0;left:0;right:0;z-index:10;
    display:flex;align-items:center;justify-content:space-between;
    padding-top:calc(14px + env(safe-area-inset-top, 0px));
    padding-left:calc(14px + env(safe-area-inset-left, 0px));
    padding-right:calc(14px + env(safe-area-inset-right, 0px));
    padding-bottom:0;
    pointer-events:none;
  ">

  <!-- POI Filter chips -->
  <div id="poiLegend">
    <div class="poi-chip" id="chipScale"    onclick="togglePOI('scale')">âš–ï¸ Scales</div>
    <div class="poi-chip" id="chipTruck"    onclick="togglePOI('truck')">ğŸš› Truck Stops</div>
    <div class="poi-chip" id="chipRest"     onclick="togglePOI('rest')">ğŸ˜´ Rest Areas</div>
    <div class="poi-chip" id="chipReport"   onclick="togglePOI('reports')">ğŸš¨ Reports</div>
  </div>

  <!-- Auto-follow button -->
  <button id="fmFollowBtn" class="visible active" title="Auto-follow truck" onclick="toggleFollow()">ğŸ¯</button>

  <!-- Custom zoom buttons -->
  <div class="fm-zoom-btns">
    <button class="fm-zoom-btn" onclick="fmMapInst && fmMapInst.zoomIn()">+</button>
    <button class="fm-zoom-btn" onclick="fmMapInst && fmMapInst.zoomOut()">âˆ’</button>
  </div>


    <!-- Left: close btn -->
    <button id="closeFullMap" style="
      pointer-events:all;
      width:44px;height:44px;border-radius:50%;border:none;
      background:rgba(15,23,42,0.85);backdrop-filter:blur(8px);
      color:#fff;font-size:22px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 2px 12px rgba(0,0,0,0.4);
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    ">â†</button>

    <!-- Center: date/time pill -->
    <div style="
      pointer-events:none;
      background:rgba(15,23,42,0.85);backdrop-filter:blur(8px);
      border-radius:999px;padding:6px 14px;
      display:flex;align-items:center;gap:8px;
      box-shadow:0 2px 12px rgba(0,0,0,0.3);
    ">
      <div id="fmLiveDot" style="width:7px;height:7px;border-radius:50%;background:#6b7280;flex-shrink:0"></div>
      <span id="fmClockTxt" style="font-size:13px;font-weight:700;color:#f1f5f9;white-space:nowrap">--:-- --</span>
      <span style="color:rgba(255,255,255,0.3)">Â·</span>
      <span id="fmDateTxt" style="font-size:11px;color:rgba(255,255,255,0.6);white-space:nowrap">---</span>
    </div>

    <!-- Right: speed badge -->
    <div style="
      pointer-events:none;
      background:rgba(15,23,42,0.85);backdrop-filter:blur(8px);
      border-radius:12px;padding:6px 12px;text-align:center;
      box-shadow:0 2px 12px rgba(0,0,0,0.3);min-width:56px;
    ">
      <div id="fmSpeedVal" style="font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1;color:#10b981">0</div>
      <div style="font-size:9px;color:rgba(255,255,255,0.5);font-weight:700;letter-spacing:.5px">MPH</div>
    </div>
  </div>

  <!-- CONFIRM TRACKING BANNER (shows when map opens, before tracking starts) -->
  <div id="fmTrackBanner" style="
    position:absolute;
    top:calc(80px + env(safe-area-inset-top, 0px));
    left:calc(14px + env(safe-area-inset-left, 0px));
    right:calc(14px + env(safe-area-inset-right, 0px));
    z-index:10;
    background:rgba(15,23,42,0.92);backdrop-filter:blur(12px);
    border-radius:16px;padding:14px 16px;
    border:1px solid rgba(16,185,129,0.3);
    box-shadow:0 4px 20px rgba(0,0,0,0.5);
  ">
    <div style="font-size:13px;color:rgba(255,255,255,0.8);font-weight:600;margin-bottom:10px;text-align:center" id="fmBannerDesc">
      ğŸ“¡ Â¿Activar seguimiento GPS en vivo?
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button id="fmNoTrack" style="
        padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);
        background:rgba(255,255,255,0.08);color:#f1f5f9;font-family:'DM Sans',sans-serif;
        font-size:13px;font-weight:700;cursor:pointer;
      ">ğŸ—ºï¸ Solo mapa</button>
      <button id="fmYesTrack" style="
        padding:10px;border-radius:10px;border:none;
        background:#10b981;color:#fff;font-family:'DM Sans',sans-serif;
        font-size:13px;font-weight:800;cursor:pointer;
      ">ğŸ“¡ Dar seguimiento</button>
    </div>
  </div>

  <!-- BOTTOM HUD PANEL -->
  <div id="fmHud" data-scroll style="
    position:absolute;bottom:0;left:0;right:0;z-index:10;
    background:rgba(10,16,30,0.92);
    backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border-radius:20px 20px 0 0;
    border-top:1px solid rgba(255,255,255,0.08);
    padding:14px 16px calc(20px + env(safe-area-inset-bottom, 0px));
    color:#f1f5f9;
    box-shadow:0 -4px 30px rgba(0,0,0,0.5);
    transform:translateY(100%);
    transition:transform .4s cubic-bezier(.16,1,.3,1);
  ">
    <!-- Handle -->
    <div style="width:36px;height:4px;background:rgba(255,255,255,0.2);border-radius:999px;margin:0 auto 14px"></div>

    <!-- Route header -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div style="flex:1;min-width:0">
        <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px" id="fmLocLbl">UBICACIÃ“N ACTUAL</div>
        <div style="font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="fmLocVal">Localizando...</div>
      </div>
      <div id="fmStatusChip" style="
        margin-left:10px;padding:4px 10px;border-radius:999px;flex-shrink:0;
        font-size:11px;font-weight:800;
        background:rgba(107,114,128,0.25);color:#9ca3af;
      ">â¸ Detenido</div>
    </div>

    <!-- Progress bar + pct -->
    <div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.4px" id="fmProgLbl">PROGRESO DE RUTA</span>
        <span style="font-size:11px;font-weight:800;color:#10b981" id="fmPct">0%</span>
      </div>
      <div style="height:6px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden">
        <div id="fmBar" style="height:100%;background:linear-gradient(90deg,#10b981,#3b82f6);border-radius:999px;width:0%;transition:width .6s ease"></div>
      </div>
    </div>

    <!-- 4 stats -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:12px">
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fmEtaLbl">LLEGADA</div>
        <div style="font-size:15px;font-weight:900;color:#f59e0b;line-height:1" id="fmEta">--</div>
      </div>
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fmRemLbl">RESTANTE</div>
        <div style="font-size:15px;font-weight:900;color:#3b82f6;line-height:1" id="fmRem">--</div>
      </div>
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fmDriveLbl">MANEJO</div>
        <div style="font-size:15px;font-weight:900;color:#10b981;line-height:1" id="fmDriveLeft">11h</div>
      </div>
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fm70Lbl">70 HRS</div>
        <div style="font-size:15px;font-weight:900;color:#8b5cf6;line-height:1" id="fm70Left">70h</div>
      </div>
    </div>

    <!-- Route from â†’ to -->
    <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:12px">
      <div style="flex:1;min-width:0">
        <div style="font-size:9px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:.4px">DESDE</div>
        <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="fmFrom">--</div>
      </div>
      <div style="font-size:18px;color:rgba(255,255,255,0.25);flex-shrink:0">â†’</div>
      <div style="flex:1;min-width:0;text-align:right">
        <div style="font-size:9px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:.4px">HASTA</div>
        <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;direction:rtl" id="fmTo">--</div>
      </div>
    </div>

    <!-- Stop button (only when tracking) -->
    <button id="fmStopBtn" onclick="fmStopTracking()" style="
      display:none;width:100%;margin-top:12px;padding:14px;
      background:#ef4444;color:#fff;border:none;border-radius:12px;
      font-family:'DM Sans',sans-serif;font-size:16px;font-weight:800;cursor:pointer;
      touch-action:manipulation;-webkit-tap-highlight-color:transparent;
      box-shadow:0 4px 16px rgba(239,68,68,0.4);
    ">ğŸ›‘ Detener Seguimiento</button>
  </div>
</div>

<style>
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }
@keyframes liveblink { 0%,100%{opacity:1} 50%{opacity:.3} }
@keyframes reportPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.25)} }
</style>


<div class="monitor-overlay" id="monitorOverlay">
  <div class="monitor-card">
    <div class="modal-head">
      <div>ğŸ“ <span id="monitorTitle">LIVE TRACKING</span></div>
      <button class="modal-close" id="closeMonitor">Ã—</button>
    </div>
    <div style="padding:12px;overflow:auto" class="stack">
      <div class="kv"><div class="k" id="currentLocLbl">CURRENT LOCATION</div><div class="v" id="currentLocVal">-</div></div>
      <div class="kv">
        <div class="k" id="currentSpeedLbl">CURRENT SPEED</div>
        <div class="v"><span style="font-size:40px;font-weight:900" id="speedVal">0</span> <span class="muted">mph</span></div>
        <div class="muted" id="statusVal">Ready</div>
      </div>
      <div class="kv">
        <div class="k" id="progressLbl">TRIP PROGRESS</div>
        <div class="bar"><div id="progressBar" style="width:0%"></div></div>
        <div class="v" id="progressPct">0%</div>
      </div>
      <div class="grid2">
        <div class="kv"><div class="k" id="traveledLbl">TRAVELED</div><div class="v" id="traveledVal">0 mi</div></div>
        <div class="kv"><div class="k" id="remainingLbl">REMAINING</div><div class="v" id="remainingVal">0 mi</div></div>
      </div>
      <div class="grid2">
        <div class="kv"><div class="k" id="elapsedLbl">ELAPSED</div><div class="v" id="elapsedVal">0h</div></div>
        <div class="kv"><div class="k" id="etaLbl">ETA</div><div class="v" id="etaVal">0h</div></div>
      </div>
      <button class="btn btn-red" id="stopTrackBtn">ğŸ›‘ Stop Tracking</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SAFETY OVERLAYS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Toast notification (shared) -->
<div class="safety-toast" id="safetyToast">
  <div class="toast-icon" id="toastIcon">âš ï¸</div>
  <div class="toast-body">
    <div class="toast-title" id="toastTitle">Alert</div>
    <div class="toast-msg" id="toastMsg"></div>
  </div>
  <button class="toast-close" onclick="hideToast()">Ã—</button>
</div>

<!-- Screen flash -->
<div class="danger-flash" id="dangerFlash" style="display:none"></div>

<!-- â”€â”€ FATIGUE DETECTOR overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="fatigueOverlay">
  <div style="position:relative;display:flex;align-items:center;justify-content:center">
    <div class="fatigue-status-ring" id="fatigueRing" style="display:none"></div>
    <video id="fatigueVideo" autoplay muted playsinline></video>
  </div>
  <div style="text-align:center;color:#fff">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;color:#10b981">FATIGUE MONITOR</div>
    <div style="font-size:12px;color:rgba(255,255,255,.6);margin-top:4px" id="fatigueStateTxt">Initializing camera...</div>
  </div>
  <button onclick="toggleFatigueOverlay()" style="
    padding:13px 32px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
    background:rgba(255,255,255,.08);color:#fff;font-family:'DM Sans',sans-serif;
    font-size:14px;font-weight:700;cursor:pointer">
    â† Close Monitor
  </button>
</div>

<!-- â”€â”€ FATIGUE ALERT full screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="fatigueAlert">
  <div class="alert-emoji">ğŸ˜´</div>
  <div class="alert-title">Â¡WAKE UP!</div>
  <div class="alert-sub">Fatigue detected â€” Pull over safely now</div>
  <button class="alert-dismiss" onclick="dismissFatigueAlert()">âœ… I'M AWAKE â€” DISMISS</button>
</div>

<!-- â”€â”€ WEATHER WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="weatherWidget" onclick="showWeatherDetail()">
  <div class="wx-row">
    <div class="wx-icon" id="wxIcon">ğŸŒ¤ï¸</div>
    <div>
      <div class="wx-temp" id="wxTemp">--Â°</div>
    </div>
  </div>
  <div class="wx-desc" id="wxDesc">Loading...</div>
  <div style="font-size:9px;color:rgba(255,255,255,.4);margin-top:4px" id="wxWind"></div>
</div>

<!-- â”€â”€ BRIDGE WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="bridgeInput">
  <div class="bridge-label">ğŸŒ‰ TRAILER HEIGHT</div>
  <div class="bridge-row">
    <div class="bridge-val" id="bridgeDisplayVal">13.6</div>
    <div class="bridge-ft">ft</div>
  </div>
  <div style="font-size:10px;color:rgba(255,255,255,.5);margin-top:3px;line-height:1.3" id="bridgeNextTxt">Monitoring route...</div>
  <div class="bridge-btns">
    <button class="bridge-btn" onclick="adjustHeight(-0.1)">â–¼</button>
    <button class="bridge-btn" onclick="adjustHeight(+0.1)">â–²</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CIRCULAR SPEEDOMETER WIDGET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="speedometerWidget">
  <div class="speedo-ring stopped" id="speedoRing">
    <svg class="speedo-svg" id="speedoSvg" viewBox="0 0 120 120">
      <circle cx="60" cy="60" r="55" fill="none" stroke="rgba(255,255,255,0.07)" stroke-width="6"/>
      <circle cx="60" cy="60" r="55" fill="none" stroke="#10b981" stroke-width="6"
              stroke-linecap="round" stroke-dasharray="0 345" id="speedoArc"
              transform="rotate(-220 60 60)" style="transition:stroke-dasharray .5s ease"/>
    </svg>
    <div class="speedo-num stopped" id="speedoNum">0</div>
    <div class="speedo-unit">MPH</div>
  </div>
  <div class="speedo-label" id="speedoLabel">GPS SPEED</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INCIDENT BUBBLES PANEL (left side)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="incidentPanel"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FULL-SCREEN ALERT (Police / Danger / Warning)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="fullscreenAlertOverlay">
  <div class="police-lightbar" id="policeLightbar">
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
  </div>
  <div class="fs-alert-emoji" id="fsAlertEmoji">ğŸš”</div>
  <div class="fs-alert-title" id="fsAlertTitle">POLICÃA ADELANTE</div>
  <div class="fs-alert-sub" id="fsAlertSub">Reportado por conductor en la ruta</div>
  <div class="fs-alert-dist" id="fsAlertDist"></div>
  <button class="fs-alert-dismiss police-btn" id="fsAlertDismissBtn" onclick="dismissFullscreenAlert()">
    âœ… ENTENDIDO â€” CONTINUAR
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     REST ALARM OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="restAlarmOverlay">
  <div class="rest-alarm-emoji" id="restAlarmEmoji">ğŸ˜´</div>
  <div class="rest-alarm-title" id="restAlarmTitle">Â¡HORA DE DESCANSAR!</div>
  <div class="rest-alarm-sub" id="restAlarmSub">Has manejado 8 horas. DOT requiere descanso de 10 horas.</div>
  <div class="rest-alarm-timer" id="restAlarmTimer">10:00</div>
  <button class="rest-alarm-dismiss" onclick="dismissRestAlarm()">
    ğŸ˜´ INICIAR DESCANSO
  </button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const T = {
  en: {
    subtitle:'DOT Hours of Service Planner',info:'Type city name to search globally',lblFrom:'ğŸ“ Origin',lblTo:'ğŸ¯ Destination',
    lblTime:'ğŸ• Departure',lblHours:'â±ï¸ Hours Left',lblSpeed:'ğŸš€ Speed (mph)',btnCalc:'ğŸš› Calculate Route',
    shareText:'ğŸ“¤ Share Route',monitorText:'ğŸ“ Start Live Tracking',stopText:'ğŸ›‘ Stop Tracking',monitorTitle:'LIVE TRACKING',
    errSel:'Select origin and destination',err70:'Max 70 hours',errSpeed:'Invalid speed',day:'Day',drive:'Driving',rest:'Rest',
    reset:'34H RESET',from:'FROM',to:'TO',departure:'DEPARTURE',arrival:'ARRIVAL',totalTime:'TOTAL TIME',
    routeMap:'Route Map',fullMap:'View Full Map',roadHint:'Real road route when available',
    currentLoc:'CURRENT LOCATION',currentSpeed:'CURRENT SPEED',progress:'TRIP PROGRESS',traveled:'TRAVELED',
    remaining:'REMAINING',elapsed:'ELAPSED',eta:'ETA',copied:'Route copied!',locating:'Locating...',ready:'Ready',
    driving:'Driving',stopped:'Stopped',gpsDenied:'Allow location access in your browser',arrived:'ğŸ‰ Arrived!',
    sourceRoad:'Road route source',sourceOsrm:'OSRM',sourceFallback:'Direct line fallback',
    menuTitle:'Settings',menuLang:'Language',menuTheme:'Theme',menuCountry:'Country search',light:'Light',dark:'Dark',
    tabLblPlan:'Plan Route',tabLblDrives:'All Drives',tabLblSummary:'Summaries',tabLblSettings:'Settings',
    drivesTitle:'All Drives',summaryTitle:'Summaries',settingsPageTitle:'Settings',settSecGeneral:'General',
    settSecAppear:'Appearance',settSecHOS:'HOS Rules',settSecAbout:'About',settLangRow:'Language',
    settCountryRow:'Country Filter',settLightRow:'Light Mode',settDarkRow:'Dark Mode',settBreakRow:'30-min Break Rule',
    settCycleRow:'Cycle Hours',settRestRow:'Rest Requirement',settShareRow:'Share App',sendReportText:'Send Report',
    noDrives:'No drives recorded yet.',calcFirst:'Calculate your first route.',noRoutes:'No routes yet',
    planRoute:'Plan a route to see your summary here.',allLogged:'Great job, all routes logged!',status100:'100% logged',
    sumDrivesLbl:'Drives',sumMilesLbl:'Miles',sumValueLbl:'Logged',business:'Business',
    settSpeedLimitRow:'Default Speed Limit',
    confirmTrackTitle:'Full Map View',confirmTrackDesc:'Do you want to activate live route tracking?',
    confirmNoTxt:'Map only',confirmYesTxt:'Yes, track me',
    hud70Lbl:'70 HRS',hudDriveLbl:'DRIVE TIME',hudProgLbl:'PROGRESS'
  },
  es: {
    subtitle:'Planificador de Horas DOT',info:'Escribe nombre de ciudad para buscar',lblFrom:'ğŸ“ Origen',lblTo:'ğŸ¯ Destino',
    lblTime:'ğŸ• Salida',lblHours:'â±ï¸ Horas Restantes',lblSpeed:'ğŸš€ Velocidad (mph)',btnCalc:'ğŸš› Calcular Ruta',
    shareText:'ğŸ“¤ Compartir Ruta',monitorText:'ğŸ“ Iniciar Rastreo',stopText:'ğŸ›‘ Detener Rastreo',monitorTitle:'RASTREO EN VIVO',
    errSel:'Selecciona origen y destino',err70:'MÃ¡ximo 70 horas',errSpeed:'Velocidad invÃ¡lida',day:'DÃ­a',drive:'Manejo',rest:'Descanso',
    reset:'RESET 34H',from:'DESDE',to:'HASTA',departure:'SALIDA',arrival:'LLEGADA',totalTime:'TIEMPO TOTAL',
    routeMap:'Mapa de Ruta',fullMap:'Ver Mapa Completo',roadHint:'Ruta terrestre real si estÃ¡ disponible',
    currentLoc:'UBICACIÃ“N ACTUAL',currentSpeed:'VELOCIDAD ACTUAL',progress:'PROGRESO DEL VIAJE',traveled:'RECORRIDO',
    remaining:'RESTANTE',elapsed:'TRANSCURRIDO',eta:'ETA',copied:'Â¡Ruta copiada!',locating:'Localizando...',ready:'Listo',
    driving:'Manejando',stopped:'Detenido',gpsDenied:'Permite el acceso a ubicaciÃ³n en tu navegador',arrived:'ğŸ‰ Â¡Llegaste!',
    sourceRoad:'Fuente de ruta',sourceOsrm:'OSRM',sourceFallback:'LÃ­nea directa (respaldo)',
    menuTitle:'Ajustes',menuLang:'Idioma',menuTheme:'Tema',menuCountry:'PaÃ­s de bÃºsqueda',light:'Claro',dark:'Oscuro',
    tabLblPlan:'Planear Ruta',tabLblDrives:'Todos los Viajes',tabLblSummary:'ResÃºmenes',tabLblSettings:'Ajustes',
    drivesTitle:'Todos los Viajes',summaryTitle:'ResÃºmenes',settingsPageTitle:'Ajustes',settSecGeneral:'General',
    settSecAppear:'Apariencia',settSecHOS:'Reglas HOS',settSecAbout:'Acerca de',settLangRow:'Idioma',
    settCountryRow:'Filtro de PaÃ­s',settLightRow:'Modo Claro',settDarkRow:'Modo Oscuro',settBreakRow:'Regla de Pausa 30 min',
    settCycleRow:'Horas de Ciclo',settRestRow:'Requisito de Descanso',settShareRow:'Compartir App',sendReportText:'Enviar Reporte',
    noDrives:'Sin viajes registrados aÃºn.',calcFirst:'Calcula tu primera ruta.',noRoutes:'Sin rutas aÃºn',
    planRoute:'Planifica una ruta para ver el resumen.',allLogged:'Â¡Excelente trabajo!',status100:'100% registrado',
    sumDrivesLbl:'Viajes',sumMilesLbl:'Millas',sumValueLbl:'Registrado',business:'Negocio',
    settSpeedLimitRow:'LÃ­mite de Velocidad por Defecto',
    confirmTrackTitle:'Ver Mapa Completo',confirmTrackDesc:'Â¿Deseas activar el seguimiento en vivo de tu ruta?',
    confirmNoTxt:'Solo ver mapa',confirmYesTxt:'SÃ­, dar seguimiento',
    hud70Lbl:'70 HRS',hudDriveLbl:'T. MANEJO',hudProgLbl:'PROGRESO'
  }
};

const COUNTRIES = [
  {code:'',en:'All countries',es:'Todos los paÃ­ses'},
  {code:'US',en:'United States',es:'Estados Unidos'},
  {code:'MX',en:'Mexico',es:'MÃ©xico'},
  {code:'CA',en:'Canada',es:'CanadÃ¡'},
  {code:'DO',en:'Dominican Republic',es:'RepÃºblica Dominicana'},
  {code:'ES',en:'Spain',es:'EspaÃ±a'},
  {code:'FR',en:'France',es:'Francia'},
  {code:'DE',en:'Germany',es:'Alemania'},
  {code:'IT',en:'Italy',es:'Italia'},
  {code:'GB',en:'United Kingdom',es:'Reino Unido'},
  {code:'BR',en:'Brazil',es:'Brasil'},
  {code:'AR',en:'Argentina',es:'Argentina'},
  {code:'CO',en:'Colombia',es:'Colombia'}
];

let lang = localStorage.getItem('hos_lang') || 'en';
let isDark = localStorage.getItem('hos_theme') === 'dark';
let use30min = localStorage.getItem('hos_30min') !== 'false';
let selectedCountry = localStorage.getItem('hos_country') || '';
let savedDrives = JSON.parse(localStorage.getItem('hos_drives') || '[]');
let defaultSpeed = parseInt(localStorage.getItem('hos_speed') || '60');
let currentTab = 'plan';

let origin = null, destination = null;
let routeDistance = 0, schedule = [], arrivalTime = null, totalTime = 0;
let roadGeometry = null, routeSource = null;

let miniMap = null, fullMapInst = null;
let miniLayer = null, fullLayer = null;
let miniMarkersList = [], fullMarkersList = [];

let watchId = null;
let tripStart = null;

/* â”€â”€ Safety feature states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let fatigueActive   = localStorage.getItem('hos_fatigue')  !== 'false' ? false : false;
let weatherActive   = localStorage.getItem('hos_weather')  === 'true';
let bridgeActive    = localStorage.getItem('hos_bridge')   === 'true';
let trailerHeight   = parseFloat(localStorage.getItem('hos_trailer') || '13.6');

// Fatigue internals
let fatigueStream   = null;
let fatigueInterval = null;
let fatigueEyeHistory = [];   // rolling window of "eyes open?" booleans
let fatigueAlertActive = false;

// Weather internals
let weatherInterval = null;
let lastWeatherLat  = null;
let lastWeatherLon  = null;

// Bridge internals
let bridgeInterval  = null;
let lastBridgeLat   = null;
let lastBridgeLon   = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED TOAST SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer = null;
function showToast(type, icon, title, msg, autoDismiss = 6000) {
  const el = document.getElementById('safetyToast');
  el.className = `safety-toast ${type}`;
  document.getElementById('toastIcon').textContent  = icon;
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastMsg').textContent   = msg;
  // Force reflow so transition plays
  void el.offsetWidth;
  el.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  if (autoDismiss) toastTimer = setTimeout(hideToast, autoDismiss);
  if (navigator.vibrate) navigator.vibrate(type === 'danger' ? [200,80,200,80,400] : [100,50,100]);
}
function hideToast() {
  document.getElementById('safetyToast').classList.remove('show');
}

function flashDanger(ms = 2000) {
  const f = document.getElementById('dangerFlash');
  f.style.display = 'block';
  setTimeout(() => f.style.display = 'none', ms);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ˜´  FATIGUE DETECTOR
   Uses MediaPipe FaceMesh via @mediapipe/face_mesh CDN
   to measure Eye Aspect Ratio (EAR). Falls back to a
   simple blink-rate heuristic if MediaPipe is unavailable.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let faceMesh = null;
let faceMeshReady = false;

async function initFaceMesh() {
  if (faceMeshReady) return;
  try {
    // Dynamically load MediaPipe FaceMesh
    await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js');
    faceMesh = new window.FaceMesh({
      locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
    });
    faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    faceMesh.onResults(onFaceMeshResults);
    await faceMesh.initialize();
    faceMeshReady = true;
  } catch(e) {
    // MediaPipe unavailable â†’ use heuristic fallback
    faceMeshReady = false;
  }
}

function loadScript(src) {
  return new Promise((res, rej) => {
    if (document.querySelector(`script[src="${src}"]`)) { res(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });
}

// Eye Aspect Ratio from MediaPipe landmarks
// Left eye: 33,160,158,133,153,144 | Right eye: 362,385,387,263,373,380
function calcEAR(landmarks, pts) {
  const p = i => landmarks[i];
  const dist = (a,b) => Math.hypot(a.x-b.x, a.y-b.y);
  const vert1 = dist(p(pts[1]), p(pts[5]));
  const vert2 = dist(p(pts[2]), p(pts[4]));
  const horiz = dist(p(pts[0]), p(pts[3]));
  return (vert1 + vert2) / (2 * horiz);
}

const EAR_THRESHOLD = 0.21;   // below = eyes closed
const EAR_FRAMES    = 20;     // ~2s at 10fps closed = alert

let closedFrameCount = 0;

function onFaceMeshResults(results) {
  if (fatigueAlertActive) return;
  if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
    // No face detected
    document.getElementById('fatigueStateTxt').textContent = 'âš ï¸ No face detected â€” look at camera';
    return;
  }
  const lm = results.multiFaceLandmarks[0];
  const earL = calcEAR(lm, [33,160,158,133,153,144]);
  const earR = calcEAR(lm, [362,385,387,263,373,380]);
  const ear  = (earL + earR) / 2;
  const closed = ear < EAR_THRESHOLD;

  if (closed) {
    closedFrameCount++;
    document.getElementById('fatigueRing').style.display = 'block';
    document.getElementById('fatigueStateTxt').textContent = `ğŸ˜´ Eyes closing... (${closedFrameCount}/${EAR_FRAMES})`;
  } else {
    closedFrameCount = 0;
    document.getElementById('fatigueRing').style.display = 'none';
    document.getElementById('fatigueStateTxt').textContent = 'âœ… Eyes open â€” monitoring';
  }

  if (closedFrameCount >= EAR_FRAMES) triggerFatigueAlert();
}

// Heuristic fallback (no MediaPipe): detect head tilt via
// DeviceOrientation â€” if phone tilts forward >25Â° for 3s = drowsy
let headTiltTimer = null;
function startHeuristicFatigue() {
  document.getElementById('fatigueStateTxt').textContent = 'ğŸ“± Tilt detection active (mount phone upright)';
  window.addEventListener('deviceorientation', onDeviceOrientation);
}
function stopHeuristicFatigue() {
  window.removeEventListener('deviceorientation', onDeviceOrientation);
  if (headTiltTimer) { clearTimeout(headTiltTimer); headTiltTimer = null; }
}
function onDeviceOrientation(e) {
  if (fatigueAlertActive) return;
  const beta = Math.abs(e.beta || 0); // forward/backward tilt
  // If phone tilts significantly (head drooping â‰ˆ phone falls forward)
  if (beta > 40) {
    if (!headTiltTimer) {
      headTiltTimer = setTimeout(() => {
        triggerFatigueAlert();
        headTiltTimer = null;
      }, 3000);
      document.getElementById('fatigueStateTxt').textContent = 'âš ï¸ Head drooping detected...';
    }
  } else {
    if (headTiltTimer) { clearTimeout(headTiltTimer); headTiltTimer = null; }
    document.getElementById('fatigueStateTxt').textContent = 'âœ… Head position OK';
  }
}

async function startFatigueDetector() {
  document.getElementById('fatigueStatusTxt').textContent = lang === 'es' ? 'Iniciando cÃ¡mara...' : 'Starting camera...';
  try {
    fatigueStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width:320, height:240 }, audio: false });
    const video = document.getElementById('fatigueVideo');
    video.srcObject = fatigueStream;
    await video.play();

    await initFaceMesh();

    if (faceMeshReady) {
      // Send frames to MediaPipe every 100ms
      fatigueInterval = setInterval(async () => {
        if (!fatigueActive || !faceMesh) return;
        try { await faceMesh.send({ image: video }); } catch {}
      }, 100);
      document.getElementById('fatigueStateTxt').textContent = 'âœ… AI eye tracking active';
    } else {
      startHeuristicFatigue();
    }
    document.getElementById('fatigueStatusTxt').textContent = lang === 'es' ? 'ğŸŸ¢ Activo' : 'ğŸŸ¢ Active';
  } catch(e) {
    document.getElementById('fatigueStatusTxt').textContent = lang === 'es' ? 'âŒ Sin acceso a cÃ¡mara' : 'âŒ Camera access denied';
    fatigueActive = false;
    document.getElementById('fatigueToggle').classList.remove('on');
    showToast('warning','ğŸ“·', 'Camera Required', 'Allow camera access to use Fatigue Detector.');
  }
}

function stopFatigueDetector() {
  if (fatigueInterval)  { clearInterval(fatigueInterval); fatigueInterval = null; }
  stopHeuristicFatigue();
  if (fatigueStream) {
    fatigueStream.getTracks().forEach(t => t.stop());
    fatigueStream = null;
  }
  const video = document.getElementById('fatigueVideo');
  video.srcObject = null;
  closedFrameCount = 0;
  document.getElementById('fatigueStatusTxt').textContent = lang === 'es' ? 'CÃ¡mara apagada' : 'Camera off';
  document.getElementById('fatigueStateTxt').textContent  = lang === 'es' ? 'Apagado' : 'Off';
  document.getElementById('fatigueRing').style.display = 'none';
  document.getElementById('fatigueOverlay').classList.remove('active');
}

function toggleFatigueDetector() {
  fatigueActive = !fatigueActive;
  localStorage.setItem('hos_fatigue', fatigueActive);
  document.getElementById('fatigueToggle').classList.toggle('on', fatigueActive);
  if (fatigueActive) {
    startFatigueDetector();
    toggleFatigueOverlay(true);
  } else {
    stopFatigueDetector();
  }
}

function toggleFatigueOverlay(forceOpen) {
  const ov = document.getElementById('fatigueOverlay');
  if (forceOpen === true) { ov.classList.add('active'); return; }
  ov.classList.toggle('active');
}

function triggerFatigueAlert() {
  if (fatigueAlertActive) return;
  fatigueAlertActive = true;
  flashDanger(4000);
  // Sound alert using Web Audio API
  playAlertSound();
  if (navigator.vibrate) navigator.vibrate([500,200,500,200,500,200,800]);
  document.getElementById('fatigueAlert').classList.add('show');
  // Also show on map HUD
  showToast('danger','ğŸ˜´','âš ï¸ FATIGUE ALERT','Eyes closed too long â€” Pull over immediately!', 0);
}

function dismissFatigueAlert() {
  fatigueAlertActive = false;
  closedFrameCount = 0;
  document.getElementById('fatigueAlert').classList.remove('show');
  hideToast();
  document.getElementById('fatigueRing').style.display = 'none';
  document.getElementById('fatigueStateTxt').textContent = 'âœ… Monitoring resumed';
}

function playAlertSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const playBeep = (freq, start, dur) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'square';
      gain.gain.setValueAtTime(0.4, ctx.currentTime + start);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + start + dur);
      osc.start(ctx.currentTime + start);
      osc.stop(ctx.currentTime + start + dur);
    };
    // SOS pattern
    [0,.35,.7,1.1,1.5,1.9].forEach((t,i) => playBeep(i%2===0?880:660, t, .28));
  } catch {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â›ˆï¸  WEATHER ALERTS
   Uses Open-Meteo (free, no API key needed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WX_DANGER_CODES = new Set([
  // thunderstorm, heavy snow, freezing rain, heavy rain, blizzard, tornado, etc.
  95,96,99,71,73,75,77,85,86,66,67,82
]);
const WX_WARNING_CODES = new Set([55,65,61,63,56,57,80,81,51,53]);

const WX_DESC = {
  0:'Clear sky', 1:'Mainly clear', 2:'Partly cloudy', 3:'Overcast',
  45:'Fog', 48:'Icy fog', 51:'Light drizzle', 53:'Moderate drizzle', 55:'Heavy drizzle',
  56:'Freezing drizzle', 57:'Heavy freezing drizzle',
  61:'Light rain', 63:'Moderate rain', 65:'Heavy rain',
  66:'Freezing rain', 67:'Heavy freezing rain',
  71:'Light snow', 73:'Moderate snow', 75:'Heavy snow', 77:'Snow grains',
  80:'Light showers', 81:'Moderate showers', 82:'Violent showers',
  85:'Snow showers', 86:'Heavy snow showers',
  95:'âš¡ Thunderstorm', 96:'Thunderstorm+hail', 99:'Heavy thunderstorm+hail'
};

const WX_ICONS = {
  0:'â˜€ï¸', 1:'ğŸŒ¤ï¸', 2:'â›…', 3:'â˜ï¸',
  45:'ğŸŒ«ï¸', 48:'ğŸŒ«ï¸â„ï¸', 51:'ğŸŒ¦ï¸', 53:'ğŸŒ§ï¸', 55:'ğŸŒ§ï¸',
  56:'ğŸŒ¨ï¸', 57:'ğŸŒ¨ï¸', 61:'ğŸŒ§ï¸', 63:'ğŸŒ§ï¸', 65:'ğŸŒ§ï¸ğŸŒ§ï¸',
  66:'ğŸŒ§ï¸â„ï¸', 67:'ğŸŒ§ï¸â„ï¸', 71:'â„ï¸', 73:'â„ï¸â„ï¸', 75:'â„ï¸â„ï¸â„ï¸', 77:'ğŸŒ¨ï¸',
  80:'ğŸŒ¦ï¸', 81:'ğŸŒ§ï¸', 82:'â›ˆï¸', 85:'ğŸŒ¨ï¸', 86:'ğŸŒ¨ï¸â„ï¸',
  95:'â›ˆï¸', 96:'â›ˆï¸ğŸŒ©ï¸', 99:'â›ˆï¸ğŸŒ©ï¸â„ï¸'
};

async function fetchWeather(lat, lon) {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&current=temperature_2m,weathercode,windspeed_10m,precipitation&wind_speed_unit=mph` +
      `&temperature_unit=fahrenheit&timezone=auto`;
    const r = await fetch(url);
    const d = await r.json();
    const c = d.current;
    return {
      code  : c.weathercode,
      temp  : Math.round(c.temperature_2m),
      wind  : Math.round(c.windspeed_10m),
      precip: c.precipitation,
      desc  : WX_DESC[c.weathercode] || 'Unknown'
    };
  } catch { return null; }
}

function updateWeatherWidget(wx) {
  if (!wx) return;
  const isDanger  = WX_DANGER_CODES.has(wx.code);
  const isWarning = WX_WARNING_CODES.has(wx.code);
  document.getElementById('wxIcon').textContent = WX_ICONS[wx.code] || 'ğŸŒ¡ï¸';
  document.getElementById('wxTemp').textContent = `${wx.temp}Â°F`;
  document.getElementById('wxDesc').textContent = wx.desc;
  document.getElementById('wxWind').textContent = wx.wind > 0 ? `ğŸ’¨ ${wx.wind} mph` : '';
  // Color the temp red if danger
  document.getElementById('wxTemp').className = 'wx-temp' + (isDanger ? ' wx-danger' : '');
  document.getElementById('wxDesc').className = 'wx-desc' + (isDanger ? ' wx-danger' : '');

  if (isDanger) {
    showToast('danger','â›ˆï¸','âš ï¸ DANGEROUS WEATHER',
      `${wx.desc} â€” ${wx.temp}Â°F, winds ${wx.wind}mph. Consider pulling over.`, 0);
    flashDanger(3000);
    if (navigator.vibrate) navigator.vibrate([300,100,300,100,300]);
    // Also show full-screen
    showFullscreenAlert('danger', 'â›ˆï¸', 'Â¡CLIMA PELIGROSO!',
      `${wx.desc} â€” ${wx.temp}Â°F, vientos ${wx.wind}mph. Considera detenerte.`, '', 15000);
  } else if (isWarning) {
    showToast('warning','ğŸŒ§ï¸','Weather Alert',
      `${wx.desc} â€” ${wx.temp}Â°F, winds ${wx.wind}mph. Drive with caution.`, 8000);
  }
  // Wind warning independent
  if (wx.wind >= 40 && !isDanger) {
    showToast('warning','ğŸ’¨','High Wind Warning',
      `${wx.wind}mph winds â€” Risk of rollover for high-profile trucks!`, 8000);
  }
  document.getElementById('weatherStatusTxt').textContent =
    `${WX_ICONS[wx.code]||'ğŸŒ¡ï¸'} ${wx.temp}Â°F Â· ${wx.desc}`;
}

async function startWeatherMonitor() {
  document.getElementById('weatherWidget').classList.add('visible');
  document.getElementById('weatherStatusTxt').textContent = 'Fetching weather...';
  document.getElementById('wxDesc').textContent = 'Loading...';

  const updateNow = async () => {
    if (!weatherActive) return;
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(async pos => {
      const { latitude: lat, longitude: lon } = pos.coords;
      // Don't re-fetch if barely moved (<5 miles)
      if (lastWeatherLat && haversine(lat,lon,lastWeatherLat,lastWeatherLon) < 5) return;
      lastWeatherLat = lat; lastWeatherLon = lon;
      const wx = await fetchWeather(lat, lon);
      updateWeatherWidget(wx);
    }, () => {}, { enableHighAccuracy: false, timeout: 10000 });
  };

  await updateNow();
  weatherInterval = setInterval(updateNow, 10 * 60 * 1000); // every 10 min
  document.getElementById('weatherToggle').classList.add('on');
}

function stopWeatherMonitor() {
  if (weatherInterval) { clearInterval(weatherInterval); weatherInterval = null; }
  document.getElementById('weatherWidget').classList.remove('visible');
  document.getElementById('weatherStatusTxt').textContent = 'Off';
  document.getElementById('weatherToggle').classList.remove('on');
  lastWeatherLat = null; lastWeatherLon = null;
}

function toggleWeatherMonitor() {
  weatherActive = !weatherActive;
  localStorage.setItem('hos_weather', weatherActive);
  document.getElementById('weatherToggle').classList.toggle('on', weatherActive);
  if (weatherActive) startWeatherMonitor();
  else stopWeatherMonitor();
}

function showWeatherDetail() {
  if (!weatherActive) return;
  const desc = document.getElementById('wxDesc').textContent;
  const temp = document.getElementById('wxTemp').textContent;
  const wind = document.getElementById('wxWind').textContent;
  showToast('info','ğŸŒ¡ï¸', `Weather Update`, `${desc} Â· ${temp} ${wind}`, 6000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸŒ‰  LOW BRIDGE DETECTOR
   Uses Overpass API to find bridges with maxheight tags
   within 30 miles ahead on the route
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchNearbyBridges(lat, lon, radiusMeters = 8000) {
  try {
    const query = `
      [out:json][timeout:10];
      (
        way["maxheight"](around:${radiusMeters},${lat},${lon});
        node["maxheight"](around:${radiusMeters},${lat},${lon});
      );
      out body; >; out skel qt;
    `;
    const r = await fetch('https://overpass-api.de/api/interpreter', {
      method:'POST', body: 'data=' + encodeURIComponent(query)
    });
    const data = await r.json();
    return (data.elements || []).map(el => {
      const h = el.tags?.maxheight || '';
      // Parse "13'6\"" or "4.1" or "4.1 m"
      let feet = parseFloat(h);
      if (h.includes("'")) {
        const m = h.match(/(\d+)'?\s*(\d*)/);
        if (m) feet = parseInt(m[1]) + (parseInt(m[2]||0)/12);
      } else if (h.includes('m') || (!h.includes("'") && feet < 8)) {
        feet = feet * 3.28084; // convert meters to feet
      }
      return { feet: isNaN(feet) ? null : Math.round(feet * 10)/10, raw: h, lat: el.lat, lon: el.lon };
    }).filter(b => b.feet !== null);
  } catch { return []; }
}

async function checkBridges() {
  if (!bridgeActive) return;
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude: lat, longitude: lon } = pos.coords;
    if (lastBridgeLat && haversine(lat,lon,lastBridgeLat,lastBridgeLon) < 1) return;
    lastBridgeLat = lat; lastBridgeLon = lon;

    const bridges = await fetchNearbyBridges(lat, lon);
    if (!bridges.length) {
      document.getElementById('bridgeNextTxt').textContent = 'No low bridges nearby';
      return;
    }

    // Find lowest bridge ahead
    const lowest = bridges.reduce((a,b) => (a.feet < b.feet ? a : b));
    const clearance = lowest.feet;
    const needed    = trailerHeight;
    const margin    = clearance - needed;

    document.getElementById('bridgeNextTxt').textContent =
      `Nearest: ${clearance}ft clearance`;

    if (margin < 0) {
      // CANNOT PASS
      showToast('danger','ğŸš¨','âš ï¸ LOW BRIDGE AHEAD!',
        `Bridge clearance: ${clearance}ft â€” Your trailer: ${needed}ft. DO NOT ENTER!`, 0);
      flashDanger(4000);
      if (navigator.vibrate) navigator.vibrate([400,100,400,100,800]);
      document.getElementById('bridgeNextTxt').textContent = `ğŸš¨ TOO LOW: ${clearance}ft`;
      document.getElementById('bridgeNextTxt').style.color = '#ef4444';
      showFullscreenAlert('danger', 'ğŸŒ‰', 'Â¡PUENTE MUY BAJO!',
        `Clearance: ${clearance}ft â€” Tu trÃ¡iler: ${needed}ft. Â¡NO ENTRES!`, '', 20000);
    } else if (margin < 1.5) {
      // TIGHT â€” warn
      showToast('warning','âš ï¸','Bridge Warning',
        `Low clearance: ${clearance}ft â€” Your trailer: ${needed}ft. Only ${margin.toFixed(1)}ft margin. Proceed carefully.`, 8000);
      document.getElementById('bridgeNextTxt').textContent = `âš ï¸ Tight: ${clearance}ft`;
      document.getElementById('bridgeNextTxt').style.color = '#f59e0b';
    } else {
      document.getElementById('bridgeNextTxt').style.color = 'rgba(255,255,255,.5)';
    }
    document.getElementById('bridgeStatusTxt').textContent =
      `Active Â· ${needed}ft trailer Â· nearest ${clearance}ft`;
  }, () => {}, { enableHighAccuracy: false, timeout: 10000 });
}

function startBridgeDetector() {
  document.getElementById('bridgeInput').classList.add('visible');
  document.getElementById('bridgeDisplayVal').textContent = trailerHeight.toFixed(1);
  document.getElementById('bridgeStatusTxt').textContent = `Active Â· ${trailerHeight}ft trailer`;
  document.getElementById('trailerHeightRow').style.display = 'flex';
  checkBridges(); // immediate check
  bridgeInterval = setInterval(checkBridges, 3 * 60 * 1000); // every 3 min
}

function stopBridgeDetector() {
  if (bridgeInterval) { clearInterval(bridgeInterval); bridgeInterval = null; }
  document.getElementById('bridgeInput').classList.remove('visible');
  document.getElementById('bridgeStatusTxt').textContent = 'Off â€” set trailer height';
  document.getElementById('trailerHeightRow').style.display = 'none';
  lastBridgeLat = null; lastBridgeLon = null;
}

function toggleBridgeDetector() {
  bridgeActive = !bridgeActive;
  localStorage.setItem('hos_bridge', bridgeActive);
  document.getElementById('bridgeToggle').classList.toggle('on', bridgeActive);
  if (bridgeActive) startBridgeDetector();
  else stopBridgeDetector();
}

function adjustHeight(delta) {
  trailerHeight = Math.max(8, Math.min(18, Math.round((trailerHeight + delta) * 10) / 10));
  localStorage.setItem('hos_trailer', trailerHeight);
  document.getElementById('bridgeDisplayVal').textContent = trailerHeight.toFixed(1);
  document.getElementById('trailerHeightInput').value = trailerHeight;
  document.getElementById('bridgeStatusTxt').textContent = `Active Â· ${trailerHeight}ft trailer`;
  checkBridges(); // recheck with new height
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš€  CIRCULAR SPEEDOMETER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let speedoVisible = false;

function showSpeedometer() {
  document.getElementById('speedometerWidget').classList.add('visible');
  speedoVisible = true;
}

function hideSpeedometer() {
  document.getElementById('speedometerWidget').classList.remove('visible');
  speedoVisible = false;
}

function updateSpeedometer(mph) {
  if (!speedoVisible) return;
  const num = document.getElementById('speedoNum');
  const ring = document.getElementById('speedoRing');
  const arc = document.getElementById('speedoArc');
  const label = document.getElementById('speedoLabel');

  num.textContent = Math.round(mph);
  const moving = mph > 3;

  if (moving) {
    num.className = 'speedo-num';
    ring.className = 'speedo-ring moving';
    arc.style.stroke = mph > 75 ? '#ef4444' : mph > 55 ? '#f59e0b' : '#10b981';
    label.textContent = 'GPS SPEED';
  } else {
    num.className = 'speedo-num stopped';
    ring.className = 'speedo-ring stopped';
    arc.style.stroke = '#6b7280';
    label.textContent = 'DETENIDO';
  }

  // Arc: max speed = 100mph = full circle (345 dasharray units)
  const maxSpeed = 100;
  const pct = Math.min(1, mph / maxSpeed);
  const dashLen = pct * 295; // ~295 is ~85% of the circumference for the arc
  arc.setAttribute('stroke-dasharray', `${dashLen} 345`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš¨  FULL-SCREEN ALERT (Police / Danger / Warning)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let fsAlertActive = false;
let fsAlertTimeout = null;

function showFullscreenAlert(type, emoji, title, sub, distText, autoDismissMs) {
  // type: 'police' | 'danger' | 'warning'
  const overlay = document.getElementById('fullscreenAlertOverlay');
  overlay.className = '';
  overlay.classList.add('show', type === 'police' ? 'police' : type === 'danger' ? 'danger-alert' : 'warning-alert');

  document.getElementById('fsAlertEmoji').textContent = emoji;
  document.getElementById('fsAlertTitle').textContent = title;
  document.getElementById('fsAlertSub').textContent = sub;
  document.getElementById('fsAlertDist').textContent = distText || '';

  const dismissBtn = document.getElementById('fsAlertDismissBtn');
  dismissBtn.className = 'fs-alert-dismiss ' + (type === 'police' ? 'police-btn' : type === 'danger' ? 'danger-btn' : 'warning-btn');
  dismissBtn.textContent = 'âœ… ENTENDIDO â€” CONTINUAR';

  // Police lightbar
  document.getElementById('policeLightbar').style.display = type === 'police' ? 'flex' : 'none';

  fsAlertActive = true;
  playAlertSound();
  if (navigator.vibrate) {
    if (type === 'police') navigator.vibrate([200,100,200,100,400,100,200,100,200]);
    else navigator.vibrate([400,150,400,150,800]);
  }

  // Auto-dismiss
  if (fsAlertTimeout) clearTimeout(fsAlertTimeout);
  if (autoDismissMs && autoDismissMs > 0) {
    fsAlertTimeout = setTimeout(dismissFullscreenAlert, autoDismissMs);
  }
}

function dismissFullscreenAlert() {
  fsAlertActive = false;
  if (fsAlertTimeout) { clearTimeout(fsAlertTimeout); fsAlertTimeout = null; }
  const overlay = document.getElementById('fullscreenAlertOverlay');
  overlay.classList.remove('show', 'police', 'danger-alert', 'warning-alert');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ˜´  REST ALARMS (HOS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let hosRestTimers = [];
let hosRestCountdown = null;
let hosRestSecondsLeft = 0;
let hosRestActive = false;
let hosRestEndAlarmFired = false;

// Called when a route is calculated â€” schedules alarms for each rest segment
function scheduleRestAlarms(scheduleData, departureTime) {
  // Clear any existing alarms
  hosRestTimers.forEach(t => clearTimeout(t));
  hosRestTimers = [];

  const now = Date.now();
  scheduleData.forEach(seg => {
    if (seg.type !== 'rest' && seg.type !== 'break30' && seg.type !== 'reset') return;

    const startMs = new Date(seg.start).getTime() - now;
    const endMs   = new Date(seg.end).getTime() - now;

    // Alarm when rest starts
    if (startMs > 0) {
      const t1 = setTimeout(() => {
        triggerRestStartAlarm(seg);
      }, startMs);
      hosRestTimers.push(t1);

      // Warn 15 min before rest
      const warn15 = startMs - 15 * 60 * 1000;
      if (warn15 > 0) {
        const tw = setTimeout(() => {
          showToast('warning', 'â°', '15 min para descansar',
            `En 15 min deberÃ¡s detenerte a descansar (${seg.type === 'break30' ? '30 min' : '10 horas'})`, 8000);
          if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        }, warn15);
        hosRestTimers.push(tw);
      }
    }

    // Alarm when rest ends
    if (endMs > 0) {
      const t2 = setTimeout(() => {
        triggerRestEndAlarm(seg);
      }, endMs);
      hosRestTimers.push(t2);
    }
  });
}

function triggerRestStartAlarm(seg) {
  if (hosRestActive) return;
  hosRestActive = true;
  hosRestEndAlarmFired = false;

  const isShort = seg.type === 'break30';
  const isReset = seg.type === 'reset';
  const totalSecs = isShort ? 30 * 60 : isReset ? 34 * 3600 : 10 * 3600;
  hosRestSecondsLeft = totalSecs;

  const overlay = document.getElementById('restAlarmOverlay');
  document.getElementById('restAlarmEmoji').textContent = isReset ? 'ğŸ”„' : 'ğŸ˜´';
  document.getElementById('restAlarmTitle').textContent = isShort ? 'Â¡PAUSA 30 MIN!' : isReset ? 'Â¡RESET 34 HORAS!' : 'Â¡HORA DE DESCANSAR!';
  document.getElementById('restAlarmSub').textContent = isShort
    ? 'Pausa obligatoria de 30 min (DOT HOS)'
    : isReset
    ? 'Reset de 34 horas para recuperar ciclo'
    : 'Descanso obligatorio de 10 horas (DOT HOS)';

  overlay.classList.add('show');
  playAlertSound();
  if (navigator.vibrate) navigator.vibrate([500,200,500,200,500,500,500]);

  // Start countdown
  if (hosRestCountdown) clearInterval(hosRestCountdown);
  updateRestTimer(hosRestSecondsLeft);
  hosRestCountdown = setInterval(() => {
    hosRestSecondsLeft--;
    updateRestTimer(hosRestSecondsLeft);
    if (hosRestSecondsLeft <= 0) {
      clearInterval(hosRestCountdown);
      hosRestCountdown = null;
    }
  }, 1000);
}

function triggerRestEndAlarm(seg) {
  if (hosRestEndAlarmFired) return;
  hosRestEndAlarmFired = true;
  hosRestActive = false;

  // Dismiss the rest overlay if showing
  document.getElementById('restAlarmOverlay').classList.remove('show');

  const isShort = seg.type === 'break30';
  const isReset = seg.type === 'reset';

  showFullscreenAlert(
    'warning',
    isReset ? 'ğŸ”„' : 'âœ…',
    isReset ? 'Â¡RESET COMPLETADO!' : isShort ? 'Â¡PAUSA TERMINADA!' : 'Â¡DESCANSO COMPLETADO!',
    isShort ? 'Ya puedes continuar manejando.' : isReset ? 'Tu ciclo de 70 horas fue renovado.' : 'Ya puedes continuar tu ruta.',
    '',
    10000
  );
  playAlertSound();
  if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
}

function updateRestTimer(secs) {
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  const s = secs % 60;
  let txt = '';
  if (h > 0) txt = `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  else txt = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  document.getElementById('restAlarmTimer').textContent = txt;
}

function dismissRestAlarm() {
  document.getElementById('restAlarmOverlay').classList.remove('show');
  hosRestActive = false;
  if (hosRestCountdown) { clearInterval(hosRestCountdown); hosRestCountdown = null; }
}

function init() {
  applyTheme();
  populateCountrySelects();
  applyLang();
  setDepartureNow();
  bindEvents();
  renderDrives();
  renderSummary();
  updateSettingsChecks();
  // Apply default speed
  document.getElementById('speedInput').value = defaultSpeed;
  document.getElementById('defaultSpeedInput').value = defaultSpeed;

  // Apply saved safety feature states
  document.getElementById('fatigueToggle').classList.toggle('on', fatigueActive);
  document.getElementById('weatherToggle').classList.toggle('on', weatherActive);
  document.getElementById('bridgeToggle').classList.toggle('on', bridgeActive);
  document.getElementById('trailerHeightInput').value = trailerHeight;
  document.getElementById('trailerHeightRow').style.display = bridgeActive ? 'flex' : 'none';

  if (weatherActive) startWeatherMonitor();
  if (bridgeActive)  startBridgeDetector();
  // Note: fatigue NOT auto-started on load (requires explicit toggle)
  initIncidentToggles();
}

function applyTheme() {
  document.body.classList.toggle('dark', isDark);
  document.getElementById('themeToggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  document.getElementById('lightBtn').classList.toggle('active', !isDark);
  document.getElementById('darkBtn').classList.toggle('active', isDark);
  if (isDark) {
    document.getElementById('checkLight').style.opacity = '0';
    document.getElementById('checkDark').style.opacity = '1';
  } else {
    document.getElementById('checkLight').style.opacity = '1';
    document.getElementById('checkDark').style.opacity = '0';
  }
}

function setDepartureNow() {
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
  document.getElementById('departureInput').value = local;
}

function populateCountrySelects() {
  ['countrySelectMenu','countrySelectSettings'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    COUNTRIES.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.code;
      opt.textContent = lang === 'es' ? c.es : c.en;
      if (c.code === selectedCountry) opt.selected = true;
      sel.appendChild(opt);
    });
  });
}

function t(key) { return T[lang][key] || key; }

function applyLang() {
  const ids = {
    subtitleTxt:'subtitle', lblFrom:'lblFrom', lblTo:'lblTo',
    lblTime:'lblTime', lblHours:'lblHours', lblSpeed:'lblSpeed',
    calcBtn:'btnCalc', shareBtn:'shareText', trackBtn:'monitorText',
    stopTrackBtn:'stopText', monitorTitle:'monitorTitle',
    routeMapLbl:'routeMap', fullMapBtn:'fullMap', roadHintTxt:'roadHint',
    currentLocLbl:'currentLoc', currentSpeedLbl:'currentSpeed', progressLbl:'progress',
    traveledLbl:'traveled', remainingLbl:'remaining', elapsedLbl:'elapsed', etaLbl:'eta',
    drivesTitleTxt:'drivesTitle', summaryTitleTxt:'summaryTitle', settTitleTxt:'settingsPageTitle',
    settSecGeneral:'settSecGeneral', settSecAppear:'settSecAppear', settSecHOS:'settSecHOS',
    settSecAbout:'settSecAbout', settLangRow:'settLangRow', settCountryRow:'settCountryRow',
    settCountryRowTitle:'settCountryRow', settLightRow:'settLightRow', settDarkRow:'settDarkRow',
    settBreakRow:'settBreakRow', settCycleRow:'settCycleRow', settRestRow:'settRestRow',
    settShareRow:'settShareRow', menuTitle:'menuTitle', menuLangLbl:'menuLang',
    menuThemeLbl:'menuTheme', menuCountryLbl:'menuCountry',
    fromLbl:'from', toLbl:'to', departureLbl:'departure', arrivalLbl:'arrival', totalTimeLbl:'totalTime',
    tabLblPlan:'tabLblPlan', tabLblDrives:'tabLblDrives', tabLblSummary:'tabLblSummary', tabLblSettings:'tabLblSettings',
    sumDrivesLbl:'sumDrivesLbl', sumMilesLbl:'sumMilesLbl', sumValueLbl:'sumValueLbl',
    sendReportBtn:'sendReportText', fullMapTitle:'routeMap',
    settSpeedLimitRow:'settSpeedLimitRow',
    confirmTrackTitle:'confirmTrackTitle', confirmTrackDesc:'confirmTrackDesc',
    confirmNoTxt:'confirmNoTxt', confirmYesTxt:'confirmYesTxt'
  };
  Object.entries(ids).forEach(([id, key]) => {
    const el = document.getElementById(id);
    if (el && key) el.textContent = t(key);
  });
  document.getElementById('infoTxt').textContent = 'ğŸ’¡ ' + t('info');
  document.getElementById('lightBtn').textContent = 'â˜€ï¸ ' + t('light');
  document.getElementById('darkBtn').textContent = 'ğŸŒ™ ' + t('dark');
  document.getElementById('drivesTabBtn').innerHTML = `${t('business')} <span id="drivesCount">${savedDrives.length}</span>`;
  document.getElementById('langVal').textContent = lang === 'en' ? 'English' : 'EspaÃ±ol';
  const country = COUNTRIES.find(c => c.code === selectedCountry);
  document.getElementById('countryVal').textContent = country ? (lang === 'es' ? country.es : country.en) : (lang === 'en' ? 'All' : 'Todos');
  populateCountrySelects();
  renderDrives();
  renderSummary();
}

function updateSettingsChecks() {
  document.getElementById('checkEn').style.opacity = lang === 'en' ? '1' : '0';
  document.getElementById('checkEs').style.opacity = lang === 'es' ? '1' : '0';
  document.getElementById('breakToggle').classList.toggle('on', use30min);
}

let originDebounce, destDebounce;

async function fetchAutocomplete(q) {
  const countryObj = COUNTRIES.find(c => c.code === selectedCountry);
  const query = selectedCountry && countryObj ? `${q}, ${countryObj.en}` : q;
  const r = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=8`);
  const data = await r.json();
  let items = (data.features || []).map(f => ({
    name: [f.properties.name, f.properties.city, f.properties.state, f.properties.country]
      .filter(Boolean).filter((v,i,a) => a.indexOf(v) === i).join(', '),
    lat: f.geometry.coordinates[1],
    lon: f.geometry.coordinates[0],
    country_code: (f.properties.countrycode || '').toUpperCase()
  })).filter(x => x.name);
  if (selectedCountry) items = items.filter(x => x.country_code === selectedCountry);
  const seen = new Set();
  items = items.filter(it => {
    const k = `${it.name}|${it.lat.toFixed(4)}|${it.lon.toFixed(4)}`;
    if (seen.has(k)) return false; seen.add(k); return true;
  });
  return items.slice(0, 5);
}

function showSuggestions(containerId, items, onSelect) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  if (!items.length) { el.style.display = 'none'; return; }
  items.forEach(it => {
    const div = document.createElement('div');
    div.className = 's-item';
    div.innerHTML = `<div class="s-name">${it.name.split(',')[0]}</div><div class="s-detail">${it.name.split(',').slice(1).join(',')}</div>`;
    div.onclick = () => { onSelect(it); el.style.display = 'none'; };
    el.appendChild(div);
  });
  el.style.display = 'block';
}

function initMap(containerId) {
  const map = L.map(containerId, { zoomControl: true }).setView([39.5, -98.35], 4);
  const tile = isDark
    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
    : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  L.tileLayer(tile, { maxZoom: 19 }).addTo(map);
  return map;
}

function drawRoute(map, coords, markersRef, layerRef) {
  if (!map) return;
  if (layerRef.layer) map.removeLayer(layerRef.layer);
  markersRef.list.forEach(m => map.removeLayer(m));
  markersRef.list = [];

  const shadow = L.polyline(coords, { color: '#065f46', weight: 9, opacity: 0.22 }).addTo(map);
  shadow.bringToBack();
  const layer = L.polyline(coords, { color: '#10b981', weight: 5, opacity: 0.95 }).addTo(map);
  layerRef.layer = layer;

  const o = L.marker([origin.lat, origin.lon]).addTo(map).bindPopup('Origin: ' + origin.name);
  const d = L.marker([destination.lat, destination.lon]).addTo(map).bindPopup('Dest: ' + destination.name);
  const mid = coords[Math.floor(coords.length / 2)] || [(origin.lat + destination.lat)/2, (origin.lon + destination.lon)/2];
  const truck = L.marker(mid, { icon: L.divIcon({ className: '', html: '<div style="font-size:24px">ğŸš›</div>' }) }).addTo(map);

  markersRef.list = [shadow, o, d, truck];
  map.fitBounds(layer.getBounds(), { padding: [25, 25] });
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 3959, r = x => x * Math.PI / 180;
  const dLat = r(lat2-lat1), dLon = r(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(r(lat1))*Math.cos(r(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

async function fetchRoadRoute(orig, dest) {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${orig.lon},${orig.lat};${dest.lon},${dest.lat}?overview=full&geometries=geojson`;
    const r = await fetch(url);
    const data = await r.json();
    const route = data.routes?.[0];
    if (!route) throw new Error('no route');
    return {
      coords: (route.geometry.coordinates || []).map(([lon,lat]) => [lat,lon]),
      miles: Math.round((route.distance || 0) / 1609.344),
      source: 'OSRM'
    };
  } catch {
    const straight = haversine(orig.lat, orig.lon, dest.lat, dest.lon);
    return {
      coords: [[orig.lat, orig.lon], [dest.lat, dest.lon]],
      miles: Math.round(straight * 1.3),
      source: 'Fallback'
    };
  }
}

function calculateSchedule(start, distance, speed, cycle) {
  const sched = [];
  let current = new Date(start), rem = distance, hours = cycle, day = 1, safety = 0;
  while (rem > 0 && safety++ < 500) {
    const available = Math.min(11, hours);
    if (available <= 0) {
      const end = new Date(current.getTime() + 34*3600000);
      sched.push({ type:'reset', day, start:new Date(current), end, hours:34 });
      current = end; hours = 70; continue;
    }
    const s1h = Math.min(8, available), s1d = Math.min(rem, speed*s1h), s1t = s1d/speed;
    const s1end = new Date(current.getTime() + s1t*3600000);
    sched.push({ type:'drive', day, start:new Date(current), end:s1end, hours:s1t, distance:s1d });
    rem -= s1d; hours -= s1t; current = s1end;
    if (rem <= 0) break;
    if (use30min && s1t >= 7.5) {
      const be = new Date(current.getTime() + 0.5*3600000);
      sched.push({ type:'break30', day, start:new Date(current), end:be, hours:0.5 });
      current = be;
    }
    const s2h = Math.min(available - s1t, 3);
    if (s2h > 0 && rem > 0) {
      const s2d = Math.min(rem, speed*s2h), s2t = s2d/speed;
      const s2end = new Date(current.getTime() + s2t*3600000);
      sched.push({ type:'drive', day, start:new Date(current), end:s2end, hours:s2t, distance:s2d });
      rem -= s2d; hours -= s2t; current = s2end;
    }
    if (rem > 0) {
      const re = new Date(current.getTime() + 10*3600000);
      sched.push({ type:'rest', day, start:new Date(current), end:re, hours:10 });
      current = re; day++;
    }
  }
  return sched;
}

function fmtH(h) {
  const m = Math.round(h*60), hr = Math.floor(m/60), mn = m%60;
  if (hr===0) return `${mn}m`; if (mn===0) return `${hr}h`; return `${hr}h ${mn}m`;
}
function fmtTime(d) {
  const dt = new Date(d); let h = dt.getHours(); const m = dt.getMinutes();
  const ap = h >= 12 ? 'PM' : 'AM'; h = h%12 || 12;
  return `${h}:${String(m).padStart(2,'0')} ${ap}`;
}
function fmtDateTime(d) {
  const dt = new Date(d);
  return dt.toLocaleDateString(lang==='es'?'es-ES':'en-US',{month:'short',day:'numeric'}) + ' ' + fmtTime(dt);
}

async function calculateRoute() {
  hideError();
  if (!origin || !destination) { showError(t('errSel')); return; }
  const hours = parseFloat(document.getElementById('hoursInput').value);
  const speed = parseFloat(document.getElementById('speedInput').value);
  if (isNaN(hours)||hours<=0||hours>70) { showError(t('err70')); return; }
  if (isNaN(speed)||speed<=0) { showError(t('errSpeed')); return; }

  const calcBtn = document.getElementById('calcBtn');
  calcBtn.textContent = 'â³ Calculating...';
  calcBtn.disabled = true;

  const depart = new Date(document.getElementById('departureInput').value || new Date());
  const road = await fetchRoadRoute(origin, destination);
  roadGeometry = road.coords;
  routeSource = road.source;
  routeDistance = road.miles;

  schedule = calculateSchedule(depart, routeDistance, speed, hours);
  arrivalTime = schedule.at(-1)?.end || depart;
  totalTime = schedule.reduce((a,s) => a + (s.type==='drive'||s.type==='rest' ? s.hours : 0), 0);

  // Schedule HOS rest alarms
  scheduleRestAlarms(schedule, depart);

  const drive = {
    id: Date.now(),
    origin: origin.name, destination: destination.name,
    distance: routeDistance,
    value: (routeDistance * 0.73).toFixed(2),
    date: new Date().toISOString()
  };
  savedDrives.push(drive);
  localStorage.setItem('hos_drives', JSON.stringify(savedDrives));

  renderResults(hours, speed, depart);

  document.getElementById('miniMapCard').style.display = 'block';
  if (!miniMap) miniMap = initMap('miniMap');
  setTimeout(() => {
    miniMap.invalidateSize();
    const mRef = { list: miniMarkersList };
    const lRef = { layer: miniLayer };
    drawRoute(miniMap, roadGeometry, mRef, lRef);
    miniMarkersList = mRef.list;
    miniLayer = lRef.layer;
  }, 100);

  document.getElementById('routeSourceTxt').textContent =
    `ğŸ›£ï¸ ${t('sourceRoad')}: ${routeSource === 'Fallback' ? t('sourceFallback') : t('sourceOsrm')}`;

  calcBtn.textContent = t('btnCalc');
  calcBtn.disabled = false;

  renderDrives();
  renderSummary();

  setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 150);
}

function renderResults(hours, speed, depart) {
  document.getElementById('resultsCard').style.display = 'block';
  document.getElementById('shareTrackBtns').style.display = 'grid';

  const driveHours = routeDistance / speed;
  const pill = document.getElementById('timeVsHours');
  pill.textContent = `${fmtH(driveHours)} / ${hours} hrs`;
  pill.className = 'pill' + (driveHours > hours ? ' danger' : '');

  document.getElementById('distanceBig').textContent = routeDistance.toLocaleString() + ' mi';
  document.getElementById('fromVal').textContent = origin.name;
  document.getElementById('toVal').textContent = destination.name;
  document.getElementById('departureVal').textContent = fmtDateTime(depart);
  document.getElementById('arrivalVal').textContent = fmtDateTime(arrivalTime);
  document.getElementById('totalTimeVal').textContent = fmtH(totalTime);

  const sl = document.getElementById('scheduleList');
  sl.innerHTML = '';
  schedule.forEach(s => {
    const div = document.createElement('div');
    if (s.type === 'break30') {
      div.className = 'sched break30';
      div.innerHTML = `<div class="t">â˜• ${lang==='es'?'Pausa 30 min obligatoria':'Mandatory 30-min Break'}</div><div class="d">â¸ï¸ ${fmtTime(s.start)} â†’ ${fmtTime(s.end)}</div>`;
    } else {
      div.className = 'sched' + (s.type==='rest'?' rest':s.type==='reset'?' reset':'');
      const title = s.type==='reset' ? `ğŸ”„ ${t('reset')}` : `${t('day')} ${s.day} - ${s.type==='drive'?t('drive'):t('rest')}`;
      const detail = s.type==='drive'
        ? `ğŸš› ${fmtTime(s.start)} â†’ ${fmtTime(s.end)}\n${fmtH(s.hours)} | ${Math.round(s.distance||0)} mi`
        : s.type==='rest' ? `ğŸ˜´ 10 hours DOT` : `Recover 70 hrs`;
      div.innerHTML = `<div class="t">${title}</div><div class="d" style="white-space:pre-line">${detail}</div>`;
    }
    sl.appendChild(div);
  });
}

function renderDrives() {
  const el = document.getElementById('drivesList');
  const countEl = document.getElementById('drivesCount');
  if (countEl) countEl.textContent = savedDrives.length;

  if (!savedDrives.length) {
    el.innerHTML = `<div class="no-drives">ğŸš›<br><br>${t('noDrives')}<br>${t('calcFirst')}</div>`;
    return;
  }
  const total = savedDrives.reduce((a,d) => a + parseFloat(d.value||0), 0);
  let html = `<div class="drives-header"><div style="font-size:13px;color:var(--muted)">${lang==='es'?'Valor total':'Classified value'}: $${total.toFixed(2)}</div></div>`;
  [...savedDrives].reverse().forEach(d => {
    const dt = new Date(d.date);
    const dateStr = dt.toLocaleDateString(lang==='es'?'es-ES':'en-US',{weekday:'long',day:'numeric',month:'long'});
    html += `<div><div style="padding:6px 14px 2px;font-size:13px;font-weight:700">${dateStr}</div>
    <div class="drive-item">
      <div class="drive-thumb">ğŸ—ºï¸</div>
      <div class="drive-info">
        <div class="drive-route">${d.origin.split(',')[0]} â†’ ${d.destination.split(',')[0]}</div>
        <div class="drive-meta">${d.distance.toLocaleString()} mi Â· ${fmtDateTime(d.date)}</div>
        <div class="drive-amount">$${d.value}</div>
      </div>
    </div></div>`;
  });
  el.innerHTML = html;
}

function renderSummary() {
  const miles = savedDrives.reduce((a,d) => a+(d.distance||0), 0);
  const val = savedDrives.reduce((a,d) => a+parseFloat(d.value||0), 0);
  document.getElementById('sumDrives').textContent = savedDrives.length;
  document.getElementById('sumMiles').textContent = miles.toLocaleString();
  document.getElementById('sumValue').textContent = '$' + val.toFixed(0);
  document.getElementById('sumStatus').textContent = savedDrives.length ? t('status100') : t('noRoutes');
  document.getElementById('sumDesc').textContent = savedDrives.length ? t('allLogged') : t('planRoute');
  document.getElementById('sendReportBtn').style.display = savedDrives.length ? 'flex' : 'none';
}

function useGPS() {
  if (!navigator.geolocation) { alert('GPS not supported'); return; }
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    try {
      const r = await fetch(`https://photon.komoot.io/reverse?lat=${latitude}&lon=${longitude}`);
      const data = await r.json();
      const feat = data.features?.[0];
      const p = feat?.properties || {};
      const name = [p.name, p.city, p.state, p.country].filter(Boolean).join(', ') || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
      origin = { name, lat: latitude, lon: longitude };
      document.getElementById('originInput').value = name;
    } catch {
      origin = { name: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`, lat: latitude, lon: longitude };
      document.getElementById('originInput').value = origin.name;
    }
  }, () => alert(t('gpsDenied')), { enableHighAccuracy: true, timeout: 10000 });
}

async function shareRoute() {
  if (!origin || !destination) return;
  const msg = `ğŸš› HOS Tracker\n\nğŸ“ ${origin.name}\nğŸ¯ ${destination.name}\nğŸ“ ${routeDistance.toLocaleString()} mi\nâ±ï¸ ${fmtH(totalTime)}\n\nby fab-visualâ„¢`;
  if (navigator.share) { try { await navigator.share({ title: 'HOS Route', text: msg }); return; } catch {} }
  if (navigator.clipboard) await navigator.clipboard.writeText(msg);
  alert(t('copied'));
}

/* ============================================================
   FULLSCREEN MAP + LIVE TRACKING  (Google Maps style)
   ============================================================ */
let fmMapInst    = null;
let fmMarkers    = [];
let fmLayer      = null;
let fmGpsMarker  = null;  // the animated truck
let fmAccMarker  = null;  // accuracy circle
let fmWatchId    = null;
let fmTripStart  = null;
let fmClockTimer = null;
let fmIsTracking = false;

// Auto-follow & zoom
let fmFollowing     = true;   // whether map auto-follows truck
let fmUserDragged   = false;  // user manually moved map
let fmCurrentZoom   = 15;     // zoom level when following
let fmLastHeading   = null;   // last GPS heading for truck rotation
let fmPrevLat       = null;   // for calculating heading when GPS doesn't provide it
let fmPrevLon       = null;

// POI layers
const fmPoiLayers = { scale: [], truck: [], rest: [], reports: [] };
const fmPoiActive = { scale: true, truck: true, rest: true, reports: true };
let   fmPoiLoaded = { scale: false, truck: false, rest: false };

// Community reports (stored in localStorage, shared within session)
let communityReports = JSON.parse(localStorage.getItem('hos_reports') || '[]');
// Remove reports older than 2 hours
communityReports = communityReports.filter(r => Date.now() - r.ts < 7200000);
localStorage.setItem('hos_reports', JSON.stringify(communityReports));

function openFullMapScreen() {
  const screen = document.getElementById('fullMapScreen');
  screen.style.display = 'flex';
  screen.style.flexDirection = 'column';

  document.getElementById('fmTrackBanner').style.display = 'block';
  document.getElementById('fmStopBtn').style.display = 'none';
  document.getElementById('poiLegend').classList.add('visible');
  document.getElementById('fmFollowBtn').classList.add('visible');

  if (origin) document.getElementById('fmFrom').textContent = origin.name.split(',')[0];
  if (destination) document.getElementById('fmTo').textContent = destination.name.split(',')[0];

  if (!fmMapInst) {
    fmMapInst = L.map('fullMap', {
      zoomControl: false,
      attributionControl: false,
      zoomAnimation: true,
      fadeAnimation: true
    }).setView([39.5, -98.35], 4);

    const tile = isDark
      ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
      : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
    L.tileLayer(tile, { maxZoom: 19 }).addTo(fmMapInst);

    // Detect when user drags map â€” pause auto-follow
    fmMapInst.on('dragstart', () => {
      fmUserDragged = true;
      fmFollowing = false;
      document.getElementById('fmFollowBtn').classList.remove('active');
    });
  }

  setTimeout(() => {
    fmMapInst.invalidateSize();
    if (origin && destination) {
      fmRedrawRoute();
      // Reset chip labels to show loading
      document.getElementById('chipScale').innerHTML = 'âš–ï¸ Scales <span style="opacity:.5;font-size:10px">â€¢â€¢â€¢</span>';
      document.getElementById('chipTruck').innerHTML = 'ğŸš› Truck Stops <span style="opacity:.5;font-size:10px">â€¢â€¢â€¢</span>';
      document.getElementById('chipRest').innerHTML  = 'ğŸ˜´ Rest Areas <span style="opacity:.5;font-size:10px">â€¢â€¢â€¢</span>';
      // Start loading POIs after route is drawn
      setTimeout(() => loadAllPOIs(), 500);
    }
    document.getElementById('fmHud').style.transform = 'translateY(0)';
  }, 200);

  fmTickClock();
  fmClockTimer = setInterval(fmTickClock, 1000);
}

// Draw/redraw the green route polyline + origin/destination markers
function fmRedrawRoute(coords) {
  const routeCoords = coords || roadGeometry || [
    [origin.lat, origin.lon],
    [destination.lat, destination.lon]
  ];

  // Remove only route + endpoint markers (keep POIs and truck)
  fmMarkers.forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
  fmMarkers = [];
  if (fmLayer) { try { fmMapInst.removeLayer(fmLayer); } catch {} fmLayer = null; }

  const shadow = L.polyline(routeCoords, { color: '#065f46', weight: 12, opacity: 0.15 }).addTo(fmMapInst);
  fmLayer = L.polyline(routeCoords, { color: '#10b981', weight: 5, opacity: 0.9 }).addTo(fmMapInst);

  const oIcon = L.divIcon({
    className: '',
    html: `<div style="width:16px;height:16px;background:#10b981;border:3px solid #fff;border-radius:50%;box-shadow:0 0 0 4px rgba(16,185,129,.25),0 2px 8px rgba(0,0,0,.5)"></div>`,
    iconAnchor: [8, 8]
  });
  const dIcon = L.divIcon({
    className: '',
    html: `<div style="font-size:30px;line-height:1;filter:drop-shadow(0 2px 6px rgba(0,0,0,.6))">ğŸ“</div>`,
    iconAnchor: [15, 30]
  });

  const oMark = L.marker([origin.lat, origin.lon], { icon: oIcon }).addTo(fmMapInst)
    .bindPopup(`<b>Origin</b><br>${origin.name}`);
  const dMark = L.marker([destination.lat, destination.lon], { icon: dIcon }).addTo(fmMapInst)
    .bindPopup(`<b>Destination</b><br>${destination.name}`);

  fmMarkers = [shadow, oMark, dMark];
  fmMapInst.fitBounds(fmLayer.getBounds(), { padding: [70, 70] });
}

// Make/update the truck marker with rotation based on heading
function fmUpdateTruckMarker(lat, lon, heading) {
  const rotation = heading != null ? heading : 0;
  const truckHtml = `
    <div style="
      width:36px;height:36px;position:relative;
      transform:rotate(${rotation}deg);
      filter:drop-shadow(0 3px 8px rgba(0,0,0,.5));
      transition:transform 0.8s ease;
    ">
      <div style="
        position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
        font-size:28px;line-height:1;
      ">ğŸš›</div>
      <!-- Direction arrow -->
      <div style="
        position:absolute;top:-8px;left:50%;transform:translateX(-50%);
        width:0;height:0;
        border-left:5px solid transparent;
        border-right:5px solid transparent;
        border-bottom:10px solid #10b981;
        filter:drop-shadow(0 1px 3px rgba(0,0,0,.4));
      "></div>
    </div>
  `;
  const icon = L.divIcon({ className: '', html: truckHtml, iconAnchor: [18, 18] });

  if (!fmGpsMarker) {
    fmGpsMarker = L.marker([lat, lon], { icon, zIndexOffset: 1000 }).addTo(fmMapInst);
  } else {
    fmGpsMarker.setLatLng([lat, lon]);
    fmGpsMarker.setIcon(icon);
  }
}

// Calculate compass heading from two GPS points
function calcHeading(lat1, lon1, lat2, lon2) {
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
  const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180)
           - Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
  return ((Math.atan2(y, x) * 180 / Math.PI) + 360) % 360;
}

function fmTickClock() {
  const now = new Date();
  document.getElementById('fmClockTxt').textContent = now.toLocaleTimeString(lang==='es'?'es-US':'en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
  document.getElementById('fmDateTxt').textContent = now.toLocaleDateString(lang==='es'?'es-ES':'en-US',{weekday:'short',month:'short',day:'numeric'});
}

function closeFullMapScreen() {
  fmStopTracking();
  clearAllPOIs();
  document.getElementById('fullMapScreen').style.display = 'none';
  document.getElementById('fmHud').style.transform = 'translateY(100%)';
  document.getElementById('poiLegend').classList.remove('visible');
  document.getElementById('fmFollowBtn').classList.remove('visible');
  if (fmClockTimer) { clearInterval(fmClockTimer); fmClockTimer = null; }
}

function toggleFollow() {
  fmFollowing = !fmFollowing;
  fmUserDragged = !fmFollowing;
  const btn = document.getElementById('fmFollowBtn');
  btn.classList.toggle('active', fmFollowing);
  // If re-enabling follow, snap to truck immediately
  if (fmFollowing && fmGpsMarker) {
    fmMapInst.setView(fmGpsMarker.getLatLng(), fmCurrentZoom, { animate: true, duration: 0.8 });
  }
}

async function fmStartTracking() {
  if (!navigator.geolocation) { alert(lang==='es'?'GPS no soportado':'GPS not supported'); return; }

  document.getElementById('fmTrackBanner').style.display = 'none';
  document.getElementById('fmLiveDot').style.background = '#f59e0b';
  document.getElementById('fmLiveDot').style.boxShadow = '0 0 6px #f59e0b';
  document.getElementById('fmLiveDot').style.animation = 'liveblink 1s infinite';
  document.getElementById('fmLocVal').textContent = lang==='es' ? 'ğŸ“¡ Obteniendo ubicaciÃ³n real...' : 'ğŸ“¡ Getting real location...';
  document.getElementById('fmStatusChip').textContent = 'ğŸ“¡ Locating...';

  // â”€â”€ STEP 1: Get precise GPS fix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let realLat, realLon, realAccuracy;
  try {
    const pos = await new Promise((res, rej) =>
      navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 15000 })
    );
    realLat = pos.coords.latitude;
    realLon = pos.coords.longitude;
    realAccuracy = pos.coords.accuracy;
  } catch {
    document.getElementById('fmLocVal').textContent = 'âŒ GPS error â€” check permissions';
    document.getElementById('fmLiveDot').style.background = '#ef4444';
    return;
  }

  // â”€â”€ STEP 2: Reverse geocode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let realLocName = `${realLat.toFixed(5)}, ${realLon.toFixed(5)}`;
  try {
    const r = await fetch(`https://photon.komoot.io/reverse?lat=${realLat}&lon=${realLon}`);
    const d = await r.json();
    const p = d.features?.[0]?.properties || {};
    realLocName = [p.name, p.city, p.state].filter(Boolean).join(', ') || realLocName;
  } catch {}

  document.getElementById('fmLocVal').textContent = 'ğŸ”„ Recalculating route...';

  // â”€â”€ STEP 3: Recalculate route from real GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const realOrigin = { lat: realLat, lon: realLon, name: realLocName };
  const road = await fetchRoadRoute(realOrigin, destination);
  routeDistance = road.miles;
  roadGeometry  = road.coords;
  origin = realOrigin;

  document.getElementById('fmFrom').textContent = realLocName.split(',')[0];
  document.getElementById('fmLocVal').textContent = realLocName;

  // â”€â”€ STEP 4: Redraw route + place truck â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (fmMapInst) {
    fmRedrawRoute(roadGeometry);

    // Accuracy circle
    if (fmAccMarker) { try { fmMapInst.removeLayer(fmAccMarker); } catch {} }
    fmAccMarker = L.circle([realLat, realLon], {
      radius: realAccuracy || 20,
      color: '#3b82f6', fillColor: '#3b82f6',
      fillOpacity: 0.08, weight: 1.5, opacity: 0.5
    }).addTo(fmMapInst);

    fmUpdateTruckMarker(realLat, realLon, null);
    fmPrevLat = realLat; fmPrevLon = realLon;

    // AUTO-ZOOM: zoom in on truck at driving zoom level
    fmFollowing = true;
    document.getElementById('fmFollowBtn').classList.add('active');
    fmCurrentZoom = 15;
    fmMapInst.setView([realLat, realLon], fmCurrentZoom, { animate: true, duration: 1.2 });

    // Reload POIs centered on new real position
    setTimeout(() => loadAllPOIs(realLat, realLon), 800);
  }

  // â”€â”€ STEP 5: Live tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fmIsTracking  = true;
  fmTripStart   = new Date();
  fmLastGeocode = 0;
  document.getElementById('fmStopBtn').style.display = 'block';
  showSpeedometer();
  // Show incident toggle button
  
  document.getElementById('fmLiveDot').style.background = '#10b981';
  document.getElementById('fmLiveDot').style.boxShadow  = '0 0 8px #10b981';
  document.getElementById('fmLiveDot').style.animation  = 'liveblink 1.5s infinite';
  document.getElementById('fmPct').textContent  = '0%';
  document.getElementById('fmBar').style.width  = '0%';
  document.getElementById('fmRem').textContent  = routeDistance + ' mi';

  fmWatchId = navigator.geolocation.watchPosition(async pos => {
    const lat  = pos.coords.latitude;
    const lon  = pos.coords.longitude;
    const acc  = pos.coords.accuracy || 20;
    const rawSpeed = pos.coords.speed;
    const gpsSpeed = rawSpeed != null && rawSpeed >= 0 ? Math.round(rawSpeed * 2.237) : 0;
    const isMoving = gpsSpeed > 3;

    // â”€â”€ Heading: prefer GPS bearing, else calculate from movement â”€â”€
    let heading = pos.coords.heading;
    if ((!heading || heading < 0) && fmPrevLat != null && isMoving) {
      heading = calcHeading(fmPrevLat, fmPrevLon, lat, lon);
    }
    if (isMoving) { fmPrevLat = lat; fmPrevLon = lon; }
    fmLastHeading = heading;

    // â”€â”€ Update accuracy circle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (fmAccMarker) fmAccMarker.setLatLng([lat, lon]).setRadius(acc);

    // â”€â”€ Update truck marker with rotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    fmUpdateTruckMarker(lat, lon, heading);

    // â”€â”€ AUTO-ZOOM & FOLLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (fmFollowing && fmMapInst) {
      // Dynamic zoom: zoom in more when fast, a bit out when slow/stopped
      if (isMoving) {
        fmCurrentZoom = gpsSpeed > 50 ? 13 : gpsSpeed > 25 ? 14 : 15;
      } else {
        fmCurrentZoom = 16; // zoom in close when stopped
      }
      fmMapInst.setView([lat, lon], fmCurrentZoom, { animate: true, duration: 0.8, noMoveStart: true });
    }

    // â”€â”€ HUD stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const remaining = haversine(lat, lon, destination.lat, destination.lon);
    const traveled  = Math.max(0, routeDistance - remaining);
    const pct       = Math.min(100, Math.round(traveled / Math.max(1, routeDistance) * 100));
    const elapsed   = (Date.now() - fmTripStart.getTime()) / 3600000;
    const avgSpeed  = parseFloat(document.getElementById('speedInput').value) || defaultSpeed;
    const etaH      = remaining / Math.max(1, isMoving ? gpsSpeed : avgSpeed);

    document.getElementById('fmSpeedVal').textContent = gpsSpeed;
    document.getElementById('fmSpeedVal').style.color = isMoving ? '#10b981' : '#9ca3af';
    updateSpeedometer(gpsSpeed);

    const chip = document.getElementById('fmStatusChip');
    chip.textContent  = isMoving ? 'ğŸš› ' + (lang==='es'?'Manejando':'Driving') : 'â¸ ' + (lang==='es'?'Detenido':'Stopped');
    chip.style.background = isMoving ? 'rgba(16,185,129,0.2)' : 'rgba(107,114,128,0.2)';
    chip.style.color      = isMoving ? '#10b981' : '#9ca3af';

    document.getElementById('fmPct').textContent = pct + '%';
    document.getElementById('fmBar').style.width = pct + '%';
    document.getElementById('fmEta').textContent = fmtH(etaH);
    document.getElementById('fmRem').textContent = remaining.toFixed(1) + ' mi';

    const driveLeft = Math.max(0, 11 - elapsed);
    const driveEl = document.getElementById('fmDriveLeft');
    driveEl.textContent = fmtH(driveLeft);
    driveEl.style.color = driveLeft < 2 ? '#ef4444' : driveLeft < 4 ? '#f59e0b' : '#10b981';

    const cycleLeft = Math.max(0, parseFloat(document.getElementById('hoursInput').value) - elapsed);
    const cyEl = document.getElementById('fm70Left');
    cyEl.textContent = fmtH(cycleLeft);
    cyEl.style.color = cycleLeft < 10 ? '#ef4444' : cycleLeft < 20 ? '#f59e0b' : '#8b5cf6';

    // â”€â”€ Location name throttled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const now = Date.now();
    if (now - fmLastGeocode > 12000) {
      fmLastGeocode = now;
      try {
        const r = await fetch(`https://photon.komoot.io/reverse?lat=${lat}&lon=${lon}`);
        const d = await r.json();
        const p = d.features?.[0]?.properties || {};
        document.getElementById('fmLocVal').textContent =
          [p.name, p.city, p.state].filter(Boolean).join(', ') || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      } catch { document.getElementById('fmLocVal').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`; }
    }

    // â”€â”€ Check nearby community reports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    checkNearbyReports(lat, lon);

    // â”€â”€ Arrival â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (remaining <= 3) { alert(t('arrived')); fmStopTracking(); }

  }, () => {
    document.getElementById('fmLocVal').textContent = 'âš ï¸ Weak GPS signal';
  }, { enableHighAccuracy: true, maximumAge: 1500, timeout: 15000 });
}

let fmLastGeocode = 0;

function fmStopTracking() {
  if (fmWatchId != null) { navigator.geolocation.clearWatch(fmWatchId); fmWatchId = null; }
  fmIsTracking = false;
  fmPrevLat = null; fmPrevLon = null;
  hideSpeedometer();
  // Hide incident panel
  
  document.getElementById('incidentPanel').innerHTML = '';
  Object.keys(activeIncidentBubbles).forEach(id => delete activeIncidentBubbles[id]);
  updateIncidentBadge();
  document.getElementById('fmStopBtn').style.display = 'none';
  document.getElementById('fmLiveDot').style.background = '#6b7280';
  document.getElementById('fmLiveDot').style.boxShadow = 'none';
  document.getElementById('fmLiveDot').style.animation = 'none';
  if (fmAccMarker) { try { fmMapInst.removeLayer(fmAccMarker); } catch {} fmAccMarker = null; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ—ºï¸  POI SYSTEM â€” Weigh Stations, Truck Stops, Rest Areas
   Uses Overpass API (OpenStreetMap)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const POI_ICONS = {
  scale: { emoji:'âš–ï¸', color:'#ef4444', label:'Weigh Station' },
  truck: { emoji:'ğŸš›', color:'#3b82f6', label:'Truck Stop' },
  rest:  { emoji:'ğŸ˜´', color:'#8b5cf6', label:'Rest Area' },
};

// Overpass queries for each POI type
const OVERPASS_QUERIES = {
  scale: (lat, lon, r) => `
    [out:json][timeout:20];
    (
      node["amenity"="weigh_station"](around:${r},${lat},${lon});
      node["highway"="weigh_station"](around:${r},${lat},${lon});
      node["name"~"weigh",i](around:${r},${lat},${lon});
    );
    out body;`,

  truck: (lat, lon, r) => `
    [out:json][timeout:20];
    (
      node["amenity"="fuel"]["hgv"="yes"](around:${r},${lat},${lon});
      node["amenity"="truck_stop"](around:${r},${lat},${lon});
      node["name"~"Flying J|Pilot|Love's|TA Travel|Petro|Sapp Bros|Kwik Trip",i](around:${r},${lat},${lon});
    );
    out body;`,

  rest: (lat, lon, r) => `
    [out:json][timeout:20];
    (
      node["highway"="rest_area"](around:${r},${lat},${lon});
      node["amenity"="rest_area"](around:${r},${lat},${lon});
      node["tourism"="picnic_site"]["highway"](around:${r},${lat},${lon});
    );
    out body;`,
};

async function loadPOI(type, lat, lon) {
  if (!fmMapInst) return;
  const radius = 80000; // 50 miles in meters
  const centerLat = lat || (origin ? (origin.lat + destination.lat) / 2 : 39.5);
  const centerLon = lon || (origin ? (origin.lon + destination.lon) / 2 : -98.35);

  try {
    const query = OVERPASS_QUERIES[type](centerLat, centerLon, radius);
    const r = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      body: 'data=' + encodeURIComponent(query)
    });
    const data = await r.json();
    const elements = data.elements || [];

    // Clear existing markers for this type
    fmPoiLayers[type].forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
    fmPoiLayers[type] = [];

    const cfg = POI_ICONS[type];
    elements.forEach(el => {
      if (!el.lat || !el.lon) return;

      // Calculate distance from current truck/origin position
      const truckLat = fmGpsMarker ? fmGpsMarker.getLatLng().lat : (origin?.lat || centerLat);
      const truckLon = fmGpsMarker ? fmGpsMarker.getLatLng().lng : (origin?.lon || centerLon);
      const dist = haversine(truckLat, truckLon, el.lat, el.lon).toFixed(1);

      const name = el.tags?.name || el.tags?.['name:en'] || cfg.label;
      const amenity = el.tags?.amenity || el.tags?.highway || '';

      // Build popup content
      let popupHtml = `
        <div style="font-family:'DM Sans',sans-serif;min-width:160px;max-width:220px">
          <div style="font-size:20px;margin-bottom:4px">${cfg.emoji}</div>
          <div style="font-weight:800;font-size:14px;margin-bottom:4px">${name}</div>
          <div style="color:#6b7280;font-size:12px;margin-bottom:6px">${cfg.label}</div>
          <div style="background:#f0fdf4;border-radius:8px;padding:6px 10px;font-size:13px;font-weight:700;color:#065f46">
            ğŸ“ ${dist} mi away
          </div>
      `;
      if (el.tags?.opening_hours) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:4px">ğŸ• ${el.tags.opening_hours}</div>`;
      if (el.tags?.phone) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:2px">ğŸ“ ${el.tags.phone}</div>`;
      if (el.tags?.['addr:city']) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:2px">ğŸ“ ${el.tags['addr:city']}</div>`;
      popupHtml += '</div>';

      const icon = L.divIcon({
        className: '',
        html: `
          <div style="
            background:${cfg.color};
            border:2.5px solid #fff;
            border-radius:50%;
            width:28px; height:28px;
            display:flex; align-items:center; justify-content:center;
            font-size:13px; line-height:1;
            box-shadow:0 2px 8px rgba(0,0,0,0.4);
            cursor:pointer;
          ">${cfg.emoji}</div>
          <div style="
            position:absolute; bottom:-18px; left:50%;
            transform:translateX(-50%);
            background:rgba(0,0,0,0.75); color:#fff;
            font-size:9px; font-weight:700;
            padding:2px 5px; border-radius:4px;
            white-space:nowrap; font-family:'DM Sans',sans-serif;
          ">${dist}mi</div>
        `,
        iconAnchor: [14, 14],
        popupAnchor: [0, -16]
      });

      const marker = L.marker([el.lat, el.lon], { icon })
        .addTo(fmMapInst)
        .bindPopup(popupHtml, { maxWidth: 240 });

      if (fmPoiActive[type]) marker.addTo(fmMapInst);
      fmPoiLayers[type].push(marker);
    });

    fmPoiLoaded[type] = true;
    console.log(`âœ… POI ${type}: loaded ${elements.length} items`);
  } catch (e) {
    console.warn(`POI ${type} load failed:`, e);
  }
}

async function loadAllPOIs(lat, lon) {
  if (!origin || !destination) return;

  // Build waypoints: sample the route geometry every ~40 miles + origin + midpoint + destination
  let waypoints = [];
  if (roadGeometry && roadGeometry.length > 2) {
    const step = Math.max(1, Math.floor(roadGeometry.length / 6));
    for (let i = 0; i < roadGeometry.length; i += step) {
      waypoints.push({ lat: roadGeometry[i][0], lon: roadGeometry[i][1] });
    }
    // Always include destination
    const last = roadGeometry[roadGeometry.length - 1];
    waypoints.push({ lat: last[0], lon: last[1] });
  } else {
    // Fallback: origin, midpoint, destination
    waypoints = [
      { lat: origin.lat, lon: origin.lon },
      { lat: (origin.lat + destination.lat) / 2, lon: (origin.lon + destination.lon) / 2 },
      { lat: destination.lat, lon: destination.lon }
    ];
  }

  // Remove duplicates that are too close (<30 miles apart)
  const filtered = [waypoints[0]];
  for (let i = 1; i < waypoints.length; i++) {
    const prev = filtered[filtered.length - 1];
    if (haversine(prev.lat, prev.lon, waypoints[i].lat, waypoints[i].lon) > 30) {
      filtered.push(waypoints[i]);
    }
  }

  // Show loading indicator on chips
  ['chipScale','chipTruck','chipRest'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.opacity = '0.5';
  });

  // Load POIs from each waypoint (radius 25 miles = 40km)
  const loadFromWaypoints = async (type) => {
    if (!fmMapInst) return;
    // Clear existing
    fmPoiLayers[type].forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
    fmPoiLayers[type] = [];

    const seen = new Set(); // deduplicate by id
    const radius = 40000; // 25 miles in meters
    const cfg = POI_ICONS[type];

    for (const wp of filtered) {
      try {
        const query = OVERPASS_QUERIES[type](wp.lat, wp.lon, radius);
        const r = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: 'data=' + encodeURIComponent(query)
        });
        const data = await r.json();
        const elements = data.elements || [];

        elements.forEach(el => {
          if (!el.lat || !el.lon) return;
          if (seen.has(el.id)) return;
          seen.add(el.id);

          const truckLat = fmGpsMarker ? fmGpsMarker.getLatLng().lat : origin.lat;
          const truckLon = fmGpsMarker ? fmGpsMarker.getLatLng().lng : origin.lon;
          const dist = haversine(truckLat, truckLon, el.lat, el.lon);
          const distStr = dist < 1000 ? dist.toFixed(0) + ' mi' : '999+ mi';
          const name = el.tags?.name || el.tags?.['name:en'] || cfg.label;

          let popupHtml = `
            <div style="font-family:'DM Sans',sans-serif;min-width:170px;max-width:230px;padding:4px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <div style="width:36px;height:36px;border-radius:50%;background:${cfg.color}22;border:2px solid ${cfg.color};display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">${cfg.emoji}</div>
                <div>
                  <div style="font-weight:800;font-size:14px;line-height:1.2">${name}</div>
                  <div style="color:#6b7280;font-size:11px;font-weight:600">${cfg.label}</div>
                </div>
              </div>
              <div style="background:${cfg.color}15;border:1px solid ${cfg.color}40;border-radius:8px;padding:6px 10px;font-size:13px;font-weight:700;color:${cfg.color}">
                ğŸ“ ${distStr} from start
              </div>`;
          if (el.tags?.opening_hours) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:6px">ğŸ• ${el.tags.opening_hours}</div>`;
          if (el.tags?.phone) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:3px">ğŸ“ ${el.tags.phone}</div>`;
          if (el.tags?.['addr:city']) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:3px">ğŸ“ ${el.tags['addr:city']}</div>`;
          popupHtml += '</div>';

          const icon = L.divIcon({
            className: '',
            html: `
              <div style="position:relative">
                <div style="
                  background:${cfg.color};
                  border:2.5px solid #fff;
                  border-radius:50%;
                  width:30px; height:30px;
                  display:flex; align-items:center; justify-content:center;
                  font-size:15px; line-height:1;
                  box-shadow:0 3px 10px rgba(0,0,0,0.45);
                  cursor:pointer;
                ">${cfg.emoji}</div>
                <div style="
                  position:absolute; bottom:-16px; left:50%;
                  transform:translateX(-50%);
                  background:${cfg.color}; color:#fff;
                  font-size:8px; font-weight:800;
                  padding:2px 5px; border-radius:4px;
                  white-space:nowrap; font-family:'DM Sans',sans-serif;
                  box-shadow:0 1px 4px rgba(0,0,0,.3);
                ">${dist < 1000 ? dist.toFixed(0)+'mi' : '~'}</div>
              </div>`,
            iconAnchor: [15, 15],
            popupAnchor: [0, -18]
          });

          const marker = L.marker([el.lat, el.lon], { icon })
            .bindPopup(popupHtml, { maxWidth: 260 });
          if (fmPoiActive[type]) marker.addTo(fmMapInst);
          fmPoiLayers[type].push(marker);
        });
      } catch(e) { console.warn(`POI ${type} from waypoint failed`, e); }
    }

    fmPoiLoaded[type] = true;
    const chipId = type === 'scale' ? 'chipScale' : type === 'truck' ? 'chipTruck' : 'chipRest';
    const chip = document.getElementById(chipId);
    if (chip) {
      chip.style.opacity = '1';
      const count = fmPoiLayers[type].length;
      chip.innerHTML = `${cfg.emoji} ${type === 'scale' ? 'Scales' : type === 'truck' ? 'Truck Stops' : 'Rest Areas'} <span style="background:rgba(255,255,255,.25);border-radius:999px;padding:1px 6px;font-size:10px;margin-left:3px">${count}</span>`;
    }
    console.log(`âœ… POI ${type}: ${fmPoiLayers[type].length} total along route`);
  };

  // Load all in parallel
  await Promise.all([
    loadFromWaypoints('scale'),
    loadFromWaypoints('truck'),
    loadFromWaypoints('rest'),
  ]);
  renderCommunityReports();
}

function clearAllPOIs() {
  ['scale','truck','rest','reports'].forEach(type => {
    fmPoiLayers[type].forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
    fmPoiLayers[type] = [];
  });
  Object.keys(fmPoiLoaded).forEach(k => fmPoiLoaded[k] = false);
}

function togglePOI(type) {
  fmPoiActive[type] = !fmPoiActive[type];
  const chip = document.getElementById(
    type === 'scale'   ? 'chipScale'  :
    type === 'truck'   ? 'chipTruck'  :
    type === 'rest'    ? 'chipRest'   : 'chipReport'
  );
  chip.classList.toggle('off', !fmPoiActive[type]);

  fmPoiLayers[type].forEach(m => {
    if (fmPoiActive[type]) { try { m.addTo(fmMapInst); } catch {} }
    else { try { fmMapInst.removeLayer(m); } catch {} }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš¨  COMMUNITY REPORTS â€” Police / Accidents / Hazards
   Stored in localStorage, shared across browser sessions
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const REPORT_ICONS = {
  police:       { emoji:'ğŸš”', color:'#3b82f6', label:'Police',        warn: true },
  accident:     { emoji:'ğŸ’¥', color:'#ef4444', label:'Accident',      warn: true },
  traffic:      { emoji:'ğŸš¦', color:'#f59e0b', label:'Heavy Traffic', warn: false },
  hazard:       { emoji:'âš ï¸', color:'#f97316', label:'Road Hazard',   warn: true },
  construction: { emoji:'ğŸš§', color:'#f59e0b', label:'Construction',  warn: false },
  closure:      { emoji:'ğŸ›‘', color:'#ef4444', label:'Road Closed',   warn: true },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš¨  INCIDENT TYPE TOGGLES (Settings-driven)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const INCIDENT_TYPES = {
  police:       { emoji:'ğŸš”', label:'PolicÃ­a',        bg:'#1d3a8a', statusOn:'Activado â€” se reportarÃ¡ en el mapa' },
  accident:     { emoji:'ğŸ’¥', label:'Accidente',      bg:'#7f1d1d', statusOn:'Activado â€” se reportarÃ¡ en el mapa' },
  traffic:      { emoji:'ğŸš¦', label:'TrÃ¡fico Pesado', bg:'#78350f', statusOn:'Activado â€” se reportarÃ¡ en el mapa' },
  hazard:       { emoji:'âš ï¸', label:'Peligro en Ruta',bg:'#7c2d12', statusOn:'Activado â€” se reportarÃ¡ en el mapa' },
  construction: { emoji:'ğŸš§', label:'ConstrucciÃ³n',   bg:'#713f12', statusOn:'Activado â€” se reportarÃ¡ en el mapa' },
  closure:      { emoji:'ğŸ›‘', label:'VÃ­a Cerrada',    bg:'#450a0a', statusOn:'Activado â€” se reportarÃ¡ en el mapa' },
};

// Load saved incident type states
let activeIncidentTypes = JSON.parse(localStorage.getItem('hos_inc_types') || '{}');

function toggleIncidentType(type, btn) {
  activeIncidentTypes[type] = !activeIncidentTypes[type];
  localStorage.setItem('hos_inc_types', JSON.stringify(activeIncidentTypes));

  btn.classList.toggle('on', activeIncidentTypes[type]);
  const statusEl = document.getElementById(`inc${type.charAt(0).toUpperCase()+type.slice(1)}Status`);
  if (statusEl) {
    statusEl.textContent = activeIncidentTypes[type]
      ? INCIDENT_TYPES[type].statusOn
      : 'Desactivado';
  }

  // When activated â€” immediately submit a report at current position (if tracking)
  if (activeIncidentTypes[type] && fmIsTracking) {
    const cfg = INCIDENT_TYPES[type];
    submitIncident(type, cfg.emoji, cfg.label);
  }

  updateActiveIncidentIcons();
}

function updateActiveIncidentIcons() {
  const row = document.getElementById('activeIconsRow');
  const container = document.getElementById('activeIncidentIcons');
  if (!row || !container) return;

  row.innerHTML = '';
  const active = Object.keys(activeIncidentTypes).filter(k => activeIncidentTypes[k]);

  if (active.length === 0) {
    container.style.display = 'none';
    return;
  }
  container.style.display = 'flex';

  active.forEach(type => {
    const cfg = INCIDENT_TYPES[type];
    const icon = document.createElement('div');
    icon.className = 'inc-mini-icon';
    icon.style.background = cfg.bg + '22';
    icon.style.borderColor = cfg.bg + '55';
    icon.title = cfg.label;
    icon.textContent = cfg.emoji;
    row.appendChild(icon);
  });
}

function initIncidentToggles() {
  Object.keys(INCIDENT_TYPES).forEach(type => {
    const togId = `inc${type.charAt(0).toUpperCase()+type.slice(1)}Toggle`;
    const tog = document.getElementById(togId);
    if (!tog) return;
    const isOn = !!activeIncidentTypes[type];
    tog.classList.toggle('on', isOn);
    const statusEl = document.getElementById(`inc${type.charAt(0).toUpperCase()+type.slice(1)}Status`);
    if (statusEl) statusEl.textContent = isOn ? INCIDENT_TYPES[type].statusOn : 'Desactivado';
  });
  updateActiveIncidentIcons();
}

function submitIncident(type, emoji, label) {
  if (!fmMapInst) return;
  let lat, lon;
  if (fmGpsMarker) {
    const ll = fmGpsMarker.getLatLng();
    lat = ll.lat; lon = ll.lng;
  } else {
    const c = fmMapInst.getCenter();
    lat = c.lat; lon = c.lng;
  }
  const report = { id: Date.now(), type, emoji, label, lat, lon, ts: Date.now() };
  communityReports.push(report);
  communityReports = communityReports.filter(r => Date.now() - r.ts < 7200000);
  localStorage.setItem('hos_reports', JSON.stringify(communityReports));
  addReportMarker(report);
  addIncidentBubble(report);
  
  showToast('warning', emoji, `${label} Reportado`,
    'Visible en el mapa de la ruta.', 4000);
  if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
}

// Legacy stubs (FAB removed but referenced in old bind)
function openReportPanel() {}
function closeReportPanel() {}
function submitReport(type, emoji, label) { submitIncident(type, emoji, label); }

function addReportMarker(report) {
  if (!fmMapInst) return;
  const cfg = REPORT_ICONS[report.type] || { emoji:'âš ï¸', color:'#f59e0b', label: report.label };
  const age = Math.round((Date.now() - report.ts) / 60000);
  const ageStr = age < 1 ? 'Just now' : age === 1 ? '1 min ago' : `${age} min ago`;

  const icon = L.divIcon({
    className: '',
    html: `
      <div style="
        background:${cfg.color};
        border:2.5px solid #fff;
        border-radius:10px;
        width:32px; height:32px;
        display:flex; align-items:center; justify-content:center;
        font-size:16px; line-height:1;
        box-shadow:0 3px 12px rgba(0,0,0,.5);
        animation:reportPulse 2s ease-in-out 3;
        cursor:pointer;
      ">${cfg.emoji}</div>
      <div style="
        position:absolute; bottom:-18px; left:50%;
        transform:translateX(-50%);
        background:${cfg.color}; color:#fff;
        font-size:9px; font-weight:800;
        padding:2px 6px; border-radius:4px;
        white-space:nowrap; font-family:'DM Sans',sans-serif;
      ">${ageStr}</div>
    `,
    iconAnchor: [16, 16],
    popupAnchor: [0, -20]
  });

  const popupHtml = `
    <div style="font-family:'DM Sans',sans-serif;min-width:160px">
      <div style="font-size:24px;margin-bottom:6px;text-align:center">${cfg.emoji}</div>
      <div style="font-weight:800;font-size:14px;text-align:center;margin-bottom:4px">${cfg.label}</div>
      <div style="color:#6b7280;font-size:11px;text-align:center">Reported ${ageStr}</div>
      <div style="color:#ef4444;font-size:11px;font-weight:700;text-align:center;margin-top:6px">
        âš ï¸ Use caution in this area
      </div>
    </div>`;

  const marker = L.marker([report.lat, report.lon], { icon })
    .addTo(fmMapInst)
    .bindPopup(popupHtml);

  fmPoiLayers.reports.push(marker);
}

function renderCommunityReports() {
  // Clear old report markers
  fmPoiLayers.reports.forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
  fmPoiLayers.reports = [];
  // Re-add all valid reports
  communityReports.forEach(r => addReportMarker(r));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš¨  INCIDENT BUBBLE PANEL
   Small circular bubbles on the left â€” activatable/deactivatable
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let incidentPanelVisible = true;
let activeIncidentBubbles = {}; // id -> bubble element

function addIncidentBubble(report) {
  const panel = document.getElementById('incidentPanel');
  if (!panel) return;
  const cfg = REPORT_ICONS[report.type] || { emoji:'âš ï¸', color:'#f59e0b', label:'Alert' };
  const dist = (fmGpsMarker
    ? haversine(fmGpsMarker.getLatLng().lat, fmGpsMarker.getLatLng().lng, report.lat, report.lon)
    : 0).toFixed(1);

  const bubble = document.createElement('div');
  bubble.className = `incident-bubble ${report.type}`;
  bubble.id = `ib-${report.id}`;
  bubble.title = cfg.label;
  bubble.innerHTML = `
    <div class="ib-emoji">${cfg.emoji}</div>
    <div class="ib-dist">${dist}mi</div>
    <div class="ib-label">${cfg.label}</div>
    <div class="ib-close" onclick="removeIncidentBubble('${report.id}',event)">âœ•</div>
  `;
  bubble.addEventListener('click', () => showIncidentDetail(report, dist));

  panel.appendChild(bubble);
  activeIncidentBubbles[report.id] = bubble;

  // Auto-remove after 30 min
  setTimeout(() => removeIncidentBubble(report.id), 30 * 60 * 1000);
}

function removeIncidentBubble(id, e) {
  if (e) e.stopPropagation();
  const bubble = activeIncidentBubbles[id];
  if (bubble) {
    bubble.style.transition = 'opacity .2s, transform .2s';
    bubble.style.opacity = '0';
    bubble.style.transform = 'scale(0.3)';
    setTimeout(() => { bubble.remove(); }, 200);
    delete activeIncidentBubbles[id];
  }
}

function updateIncidentBadge() {
  // No-op â€” badge removed with toggle button
}

function showIncidentDetail(report, dist) {
  const cfg = REPORT_ICONS[report.type] || { emoji:'âš ï¸', label:'Alert' };
  const age = Math.round((Date.now() - report.ts) / 60000);
  const ageStr = age < 1 ? 'Ahora mismo' : `Hace ${age} min`;
  showToast(
    cfg.warn ? 'danger' : 'warning',
    cfg.emoji,
    `${cfg.label} â€” ${dist}mi`,
    `Reportado ${ageStr} Â· Maneja con precauciÃ³n`,
    6000
  );
}

// Check if any reports are within 3 miles â€” show bubble (NOT fullscreen)
let lastReportAlertId = null;
function checkNearbyReports(lat, lon) {
  communityReports.forEach(r => {
    const dist = haversine(lat, lon, r.lat, r.lon);
    if (dist < 5 && !activeIncidentBubbles[r.id]) {
      // Show incident bubble on left panel
      addIncidentBubble(r);
      // Show toggle button if not visible
      
      // Small vibration for warning
      const cfg = REPORT_ICONS[r.type] || {};
      if (navigator.vibrate && cfg.warn) navigator.vibrate([100, 50, 100]);
      // Show a small toast (not fullscreen)
      showToast(
        cfg.warn ? 'danger' : 'warning',
        cfg.emoji || 'âš ï¸',
        `${cfg.label || r.label} â€” ${dist.toFixed(1)}mi`,
        'Ver panel izquierdo para detalles',
        5000
      );
    }
    // Update distance on existing bubble
    if (activeIncidentBubbles[r.id]) {
      const distEl = activeIncidentBubbles[r.id].querySelector('.ib-dist');
      if (distEl) distEl.textContent = dist.toFixed(1) + 'mi';
    }
  });
}

// Legacy startTracking/stopTracking still used by old monitor modal
function startTracking() {
  if (!origin || !destination) { alert(t('errSel')); return; }
  openFullMapScreen();
}

function stopTracking() {
  fmStopTracking();
  document.getElementById('monitorOverlay').classList.remove('open');
}

function resetForm() {
  origin = null; destination = null;
  routeDistance = 0; schedule = []; arrivalTime = null; totalTime = 0;
  roadGeometry = null; routeSource = null;
  document.getElementById('originInput').value = '';
  document.getElementById('destInput').value = '';
  document.getElementById('hoursInput').value = '70';
  document.getElementById('speedInput').value = defaultSpeed;
  document.getElementById('resultsCard').style.display = 'none';
  document.getElementById('shareTrackBtns').style.display = 'none';
  document.getElementById('miniMapCard').style.display = 'none';
  hideError();
}

function showError(msg) {
  const el = document.getElementById('errorBox');
  el.textContent = 'âŒ ' + msg;
  el.style.display = 'block';
}
function hideError() {
  document.getElementById('errorBox').style.display = 'none';
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
}

function bindEvents() {
  document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));

  document.getElementById('themeToggle').addEventListener('click', () => { isDark = !isDark; localStorage.setItem('hos_theme', isDark ? 'dark' : 'light'); applyTheme(); });
  document.getElementById('lightBtn').addEventListener('click', () => { isDark = false; localStorage.setItem('hos_theme', 'light'); applyTheme(); });
  document.getElementById('darkBtn').addEventListener('click', () => { isDark = true; localStorage.setItem('hos_theme', 'dark'); applyTheme(); });
  document.getElementById('lightModeRow').addEventListener('click', () => { isDark = false; localStorage.setItem('hos_theme', 'light'); applyTheme(); });
  document.getElementById('darkModeRow').addEventListener('click', () => { isDark = true; localStorage.setItem('hos_theme', 'dark'); applyTheme(); });

  document.getElementById('langSelect').value = lang;
  document.getElementById('langSelect').addEventListener('change', e => { lang = e.target.value; localStorage.setItem('hos_lang', lang); applyLang(); updateSettingsChecks(); });

  document.getElementById('langRow').addEventListener('click', () => {
    document.getElementById('langPanel').style.display = document.getElementById('langPanel').style.display === 'none' ? 'block' : 'none';
    document.getElementById('countryPanel').style.display = 'none';
  });
  document.getElementById('setLangEn').addEventListener('click', () => { lang = 'en'; localStorage.setItem('hos_lang', lang); applyLang(); updateSettingsChecks(); document.getElementById('langPanel').style.display = 'none'; });
  document.getElementById('setLangEs').addEventListener('click', () => { lang = 'es'; localStorage.setItem('hos_lang', lang); applyLang(); updateSettingsChecks(); document.getElementById('langPanel').style.display = 'none'; });

  ['countrySelectMenu','countrySelectSettings'].forEach(id => {
    document.getElementById(id).addEventListener('change', e => {
      selectedCountry = e.target.value;
      localStorage.setItem('hos_country', selectedCountry);
      document.getElementById('countrySelectMenu').value = selectedCountry;
      document.getElementById('countrySelectSettings').value = selectedCountry;
      const c = COUNTRIES.find(x => x.code === selectedCountry);
      document.getElementById('countryVal').textContent = c ? (lang==='es'?c.es:c.en) : (lang==='en'?'All':'Todos');
      document.getElementById('countryPanel').style.display = 'none';
    });
  });

  document.getElementById('countryRow').addEventListener('click', () => {
    document.getElementById('countryPanel').style.display = document.getElementById('countryPanel').style.display === 'none' ? 'block' : 'none';
    document.getElementById('langPanel').style.display = 'none';
  });

  document.getElementById('menuBtn').addEventListener('click', e => { e.stopPropagation(); document.getElementById('menuPanel').classList.toggle('open'); });
  document.addEventListener('click', () => document.getElementById('menuPanel').classList.remove('open'));

  document.getElementById('breakToggle').addEventListener('click', e => { e.stopPropagation(); use30min = !use30min; localStorage.setItem('hos_30min', use30min); document.getElementById('breakToggle').classList.toggle('on', use30min); });

  document.getElementById('gpsBtn').addEventListener('click', useGPS);

  document.getElementById('originInput').addEventListener('input', e => {
    clearTimeout(originDebounce);
    const v = e.target.value;
    if (v.length < 2) { document.getElementById('originSugg').style.display = 'none'; return; }
    originDebounce = setTimeout(async () => {
      const items = await fetchAutocomplete(v).catch(() => []);
      showSuggestions('originSugg', items, it => { origin = it; document.getElementById('originInput').value = it.name; });
    }, 300);
  });

  document.getElementById('destInput').addEventListener('input', e => {
    clearTimeout(destDebounce);
    const v = e.target.value;
    if (v.length < 2) { document.getElementById('destSugg').style.display = 'none'; return; }
    destDebounce = setTimeout(async () => {
      const items = await fetchAutocomplete(v).catch(() => []);
      showSuggestions('destSugg', items, it => { destination = it; document.getElementById('destInput').value = it.name; });
    }, 300);
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('#originInput') && !e.target.closest('#originSugg')) document.getElementById('originSugg').style.display = 'none';
    if (!e.target.closest('#destInput') && !e.target.closest('#destSugg')) document.getElementById('destSugg').style.display = 'none';
  });

  document.getElementById('calcBtn').addEventListener('click', calculateRoute);

  document.getElementById('shareBtn').addEventListener('click', shareRoute);
  document.getElementById('trackBtn').addEventListener('click', () => {
    if (!origin || !destination) { alert(t('errSel')); return; }
    openFullMapScreen();
  });
  document.getElementById('stopTrackBtn').addEventListener('click', stopTracking);
  document.getElementById('sendReportBtn').addEventListener('click', shareRoute);
  document.getElementById('shareAppRow').addEventListener('click', shareRoute);

  document.getElementById('resetBtn').addEventListener('click', resetForm);

  document.getElementById('fullMapBtn').addEventListener('click', () => {
    if (origin && destination) openFullMapScreen();
  });

  document.getElementById('closeFullMap').addEventListener('click', closeFullMapScreen);
  document.getElementById('fmNoTrack').addEventListener('click', () => {
    document.getElementById('fmTrackBanner').style.display = 'none';
  });
  document.getElementById('fmYesTrack').addEventListener('click', () => {
    document.getElementById('fmTrackBanner').style.display = 'none';
    fmStartTracking();
  });
  document.getElementById('fmStopBtn').addEventListener('click', fmStopTracking);

  // Default speed limit setting
  document.getElementById('defaultSpeedInput').addEventListener('change', e => {
    const val = parseInt(e.target.value);
    if (!isNaN(val) && val >= 20 && val <= 85) {
      defaultSpeed = val;
      localStorage.setItem('hos_speed', val);
      document.getElementById('speedInput').value = val;
    }
  });

  // Safety feature toggles
  document.getElementById('fatigueToggle').addEventListener('click', e => { e.stopPropagation(); toggleFatigueDetector(); });
  document.getElementById('weatherToggle').addEventListener('click', e => { e.stopPropagation(); toggleWeatherMonitor(); });
  document.getElementById('bridgeToggle').addEventListener('click',  e => { e.stopPropagation(); toggleBridgeDetector(); });
  document.getElementById('trailerHeightInput').addEventListener('change', e => {
    const v = parseFloat(e.target.value);
    if (!isNaN(v) && v >= 8 && v <= 18) {
      trailerHeight = v;
      localStorage.setItem('hos_trailer', v);
      document.getElementById('bridgeDisplayVal').textContent = v.toFixed(1);
      document.getElementById('bridgeStatusTxt').textContent = `Active Â· ${v}ft trailer`;
      checkBridges();
    }
  });
  document.getElementById('closeMonitor').addEventListener('click', stopTracking);
  document.getElementById('monitorOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) stopTracking(); });
}

init();

/* â”€â”€ Mobile enhancements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Prevent double-tap zoom on buttons
document.querySelectorAll('button, .btn, .sett-row, .s-item, .tab-btn').forEach(el => {
  el.style.touchAction = 'manipulation';
});

// Haptic feedback helper (iOS / Android)
function vibrate(ms) {
  if (navigator.vibrate) navigator.vibrate(ms);
}

// Add haptic on all buttons
document.addEventListener('click', e => {
  if (e.target.closest('button, .tab-btn')) vibrate(6);
});

// Prevent rubber-band scroll on the root but allow inside scrollable areas
document.body.addEventListener('touchmove', e => {
  if (!e.target.closest('.suggestions, .page, [data-scroll]')) e.preventDefault();
}, { passive: false });

// Lock orientation is not strictly needed but add a viewport meta refresh on resize
// so Leaflet maps resize properly when keyboard closes
window.addEventListener('resize', () => {
  if (miniMap) setTimeout(() => miniMap.invalidateSize(), 200);
  if (fmMapInst) setTimeout(() => fmMapInst.invalidateSize(), 200);
});
</script>
</body>
</html>
