<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="HOS Tracker" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#10b981" />
<title>HOS Tracker ğŸš›</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<style>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DESIGN TOKENS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  :root {
    --bg: #f0efe9;
    --surface: #ffffff;
    --surface2: #f8f8f5;
    --text: #0d0d0d;
    --muted: #6b7280;
    --accent: #10b981;
    --accent2: #059669;
    --danger: #ef4444;
    --blue: #3b82f6;
    --purple: #8b5cf6;
    --amber: #f59e0b;
    --border: #e2e0d8;
    --shadow: 0 1px 8px rgba(0,0,0,0.07), 0 4px 20px rgba(0,0,0,0.05);
    --shadow-lg: 0 8px 40px rgba(0,0,0,0.12);
    --radius: 18px;
    --radius-sm: 12px;
    /* Safe area insets for notch / home bar */
    --sat: env(safe-area-inset-top, 0px);
    --sab: env(safe-area-inset-bottom, 0px);
    --sal: env(safe-area-inset-left, 0px);
    --sar: env(safe-area-inset-right, 0px);
    --tab-h: calc(60px + var(--sab));
    --header-pt: calc(14px + var(--sat));
  }
  body.dark {
    --bg: #0a0f1e;
    --surface: #131929;
    --surface2: #1a2235;
    --text: #f0f4ff;
    --muted: #8896b0;
    --border: #1e2d45;
    --shadow: 0 1px 8px rgba(0,0,0,0.3), 0 4px 20px rgba(0,0,0,0.2);
    --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESET + BASE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { height: 100%; -webkit-text-size-adjust: 100%; }
  body {
    font-family: "DM Sans", -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100%;
    min-height: -webkit-fill-available;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition: background .25s, color .25s;
    /* Prevent overscroll bounce showing white bg */
    overscroll-behavior: none;
  }
  /* Remove tap highlight on mobile */
  * { -webkit-tap-highlight-color: transparent; }
  /* Smooth scrolling */
  .page { -webkit-overflow-scrolling: touch; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LAYOUT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .bg-icons {
    position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden;
  }
  .bg-icons span { position: absolute; user-select: none; }
  .App {
    position: relative; z-index: 1;
    padding-bottom: var(--tab-h);
  }
  .container {
    width: 100%;
    max-width: 520px;
    margin: 0 auto;
    padding: 0 16px 24px;
    padding-left: calc(16px + var(--sal));
    padding-right: calc(16px + var(--sar));
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB BAR â€” native app feel
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .tab-bar {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    height: var(--tab-h);
    padding-bottom: var(--sab);
    padding-left: var(--sal);
    padding-right: var(--sar);
    box-shadow: 0 -1px 0 var(--border), 0 -8px 24px rgba(0,0,0,0.06);
    /* glass effect on iOS */
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    background: rgba(255,255,255,0.88);
  }
  body.dark .tab-bar {
    background: rgba(19,25,41,0.92);
    border-top-color: var(--border);
  }
  .tab-btn {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 3px; border: none; background: none; color: var(--muted);
    font-family: "DM Sans", sans-serif; font-size: 10px; font-weight: 600;
    cursor: pointer; padding: 8px 0 4px;
    transition: color .18s;
    /* Minimum 44px touch target */
    min-height: 44px;
    position: relative;
  }
  .tab-btn::before {
    content: '';
    position: absolute; inset: 0;
    border-radius: 12px;
    background: var(--accent);
    opacity: 0;
    transform: scale(0.7);
    transition: opacity .18s, transform .18s;
  }
  .tab-btn:active::before { opacity: 0.08; transform: scale(1); }
  .tab-btn svg {
    width: 22px; height: 22px; fill: none; stroke: currentColor;
    stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round;
    transition: transform .2s;
  }
  .tab-btn.active { color: var(--accent); }
  .tab-btn.active svg { transform: translateY(-1px); }
  /* Active dot indicator */
  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: calc(var(--sab) + 4px);
    width: 4px; height: 4px;
    border-radius: 50%;
    background: var(--accent);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .page { display: none; }
  .page.active { display: block; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .header {
    padding-top: var(--header-pt);
    padding-bottom: 12px;
  }
  .logo {
    font-family: "Bebas Neue", sans-serif;
    font-size: 28px; letter-spacing: 1.5px;
    display: flex; align-items: center; gap: 8px;
    line-height: 1;
  }
  .subtitle {
    font-size: 11px; color: var(--muted);
    margin-top: 3px; font-weight: 600;
    letter-spacing: .8px; text-transform: uppercase;
  }
  .row { display: flex; align-items: center; gap: 8px; }
  .row.between { justify-content: space-between; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CARDS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FORM INPUTS â€” mobile optimized
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  label {
    display: block; font-size: 11px; font-weight: 700; color: var(--muted);
    margin-bottom: 5px; margin-top: 14px;
    text-transform: uppercase; letter-spacing: .6px;
  }
  label:first-child { margin-top: 0; }
  input, select {
    width: 100%;
    /* 44px min for touch targets */
    padding: 13px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: "DM Sans", sans-serif;
    font-size: 16px; /* 16px prevents iOS zoom */
    background: var(--surface2);
    color: var(--text);
    outline: none;
    transition: border .18s, box-shadow .18s;
    -webkit-appearance: none;
    appearance: none;
  }
  input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(16,185,129,0.15);
  }
  /* datetime-local fix */
  input[type="datetime-local"] { font-size: 14px; }
  /* number inputs: hide spinners */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
  input[type="number"] { -moz-appearance: textfield; }

  .inputwrap { position: relative; }
  .suggestions {
    position: absolute; top: calc(100% + 4px); left: 0; right: 0; z-index: 50;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-lg);
    max-height: 240px; overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .s-item {
    padding: 13px 14px; cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background .12s;
    /* min touch target */
    min-height: 52px; display: flex; flex-direction: column; justify-content: center;
  }
  .s-item:last-child { border-bottom: none; }
  .s-item:active { background: var(--surface2); }
  .s-name { font-weight: 700; font-size: 15px; }
  .s-detail { font-size: 12px; color: var(--muted); margin-top: 2px; }

  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
  .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .grid3 label { margin-top: 0; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BUTTONS â€” 44px+ touch targets
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .btn {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 15px 16px;
    border-radius: var(--radius-sm); border: none;
    font-family: "DM Sans", sans-serif; font-size: 15px; font-weight: 800;
    cursor: pointer; letter-spacing: .3px;
    transition: transform .12s, opacity .12s;
    min-height: 50px;
    -webkit-user-select: none; user-select: none;
  }
  .btn:active { transform: scale(0.97); opacity: 0.9; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-blue { background: var(--blue); color: #fff; }
  .btn-purple { background: var(--purple); color: #fff; }
  .btn-red { background: var(--danger); color: #fff; margin-top: 14px; }

  .iconbtn {
    width: 40px; height: 40px; border-radius: 50%;
    border: 1.5px solid var(--border);
    background: var(--surface);
    cursor: pointer; font-size: 17px;
    display: flex; align-items: center; justify-content: center;
    transition: background .15s, transform .12s;
    flex-shrink: 0;
  }
  .iconbtn:active { transform: scale(0.92); background: var(--surface2); }

  .smallbtn {
    font-size: 12px; font-weight: 700;
    padding: 8px 14px;
    border-radius: 8px;
    border: 1.5px solid var(--accent);
    color: var(--accent); background: none; cursor: pointer;
    font-family: "DM Sans", sans-serif;
    min-height: 36px;
    transition: background .15s;
  }
  .smallbtn:active { background: rgba(16,185,129,0.08); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INFO / ERROR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .info {
    background: #ecfdf5; border: 1px solid #a7f3d0;
    border-radius: 10px; padding: 10px 13px;
    font-size: 13px; color: #065f46; margin-bottom: 14px; font-weight: 600;
  }
  body.dark .info { background: #064e3b; border-color: #065f46; color: #a7f3d0; }
  .error {
    background: #fef2f2; border: 1px solid #fecaca;
    border-radius: 10px; padding: 10px 13px;
    font-size: 13px; color: var(--danger); margin-top: 10px; font-weight: 600;
  }
  .hint { font-size: 11px; color: var(--muted); margin-top: 4px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESULTS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pill {
    display: inline-flex; align-items: center;
    background: #ecfdf5; color: var(--accent);
    border-radius: 999px; padding: 5px 14px;
    font-size: 13px; font-weight: 800; margin-bottom: 10px;
    border: 1.5px solid #a7f3d0;
  }
  .pill.danger { background: #fef2f2; color: var(--danger); border-color: #fecaca; }
  .big {
    font-family: "Bebas Neue", sans-serif;
    font-size: 56px; line-height: 1; margin: 6px 0 14px;
    letter-spacing: 1px;
  }
  .kv { margin-bottom: 10px; }
  .k { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .6px; }
  .v { font-size: 15px; font-weight: 700; margin-top: 2px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCHEDULE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .schedule { margin-top: 16px; }
  .sched {
    border-left: 4px solid var(--accent);
    padding: 11px 14px; margin-bottom: 8px;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    background: var(--surface2);
  }
  .sched.rest { border-color: var(--blue); }
  .sched.reset { border-color: var(--purple); }
  .sched.break30 { border-color: var(--amber); }
  .sched .t { font-size: 13px; font-weight: 800; }
  .sched .d { font-size: 12px; color: var(--muted); margin-top: 3px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MINI MAP
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .mapbox {
    height: 240px; border-radius: var(--radius-sm);
    overflow: hidden; margin-top: 12px;
  }
  .poi-legend-bar {
    display: flex; gap: 6px; flex-wrap: wrap;
    margin-top: 8px;
  }
  .poi-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 5px 10px; border-radius: 999px;
    font-size: 11px; font-weight: 700;
    border: 1.5px solid transparent;
    transition: opacity .2s, transform .15s;
    cursor: pointer; user-select: none;
  }
  .poi-badge:active { transform: scale(.95); }
  .poi-badge.truck { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
  .poi-badge.rest  { background: #f5f3ff; color: #6d28d9; border-color: #ddd6fe; }
  .poi-badge.restrict { background: #fff1f2; color: #be123c; border-color: #fecdd3; }
  .poi-badge.off   { opacity: .4; }
  body.dark .poi-badge.truck { background: #1e3a5f; color: #93c5fd; border-color: #1d4ed8; }
  body.dark .poi-badge.rest  { background: #2e1a4a; color: #c4b5fd; border-color: #6d28d9; }
  body.dark .poi-badge.restrict { background: #4c0519; color: #fda4af; border-color: #be123c; }
  .poi-badge .poi-cnt {
    background: currentColor; color: #fff;
    border-radius: 999px; padding: 1px 6px;
    font-size: 10px; min-width: 18px; text-align: center;
    opacity: .85;
  }
  .poi-loading { animation: poi-pulse 1s ease-in-out infinite; }
  @keyframes poi-pulse { 0%,100%{opacity:.6} 50%{opacity:1} }

  /* â”€â”€ NEARBY SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .nearby-chip {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 7px 12px; border-radius: 999px;
    font-size: 12px; font-weight: 700;
    background: var(--surface2); color: var(--text);
    border: 1.5px solid var(--border);
    cursor: pointer; user-select: none;
    transition: background .15s, border-color .15s;
  }
  .nearby-chip input[type=checkbox] { display: none; }
  .nearby-chip:has(input:checked) {
    background: #d1fae5; border-color: #10b981; color: #065f46;
  }
  body.dark .nearby-chip:has(input:checked) {
    background: #064e3b; border-color: #10b981; color: #6ee7b7;
  }
  .nearby-result-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-radius: 12px;
    background: var(--surface2); margin-bottom: 6px;
    border: 1px solid var(--border);
    cursor: pointer; transition: transform .1s;
    touch-action: manipulation;
  }
  .nearby-result-item:active { transform: scale(.98); }
  .nearby-result-icon {
    width: 38px; height: 38px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  .nearby-result-name { font-size: 13px; font-weight: 800; line-height: 1.2; }
  .nearby-result-sub  { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .nearby-dist-badge {
    margin-left: auto; flex-shrink: 0;
    background: var(--bg); border: 1.5px solid var(--border);
    border-radius: 999px; padding: 3px 9px;
    font-size: 11px; font-weight: 800; color: var(--text);
    white-space: nowrap;
  }
  .nearby-add-btn {
    width: 30px; height: 30px; flex-shrink: 0;
    border-radius: 50%; border: 2px solid #10b981;
    background: rgba(16,185,129,0.12);
    color: #10b981; font-size: 20px; font-weight: 900; line-height: 1;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; touch-action: manipulation;
    transition: background .15s, transform .12s;
  }
  .nearby-add-btn:active { transform: scale(.85); background: rgba(16,185,129,.3); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MONITOR MODAL (legacy, hidden behind fullscreen)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .monitor-overlay {
    display: none; position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    align-items: flex-end; justify-content: center;
  }
  .monitor-overlay.open { display: flex; }
  .monitor-card {
    background: var(--surface); border-radius: 22px 22px 0 0; width: 100%;
    max-width: 520px; max-height: 90vh; overflow: hidden;
    display: flex; flex-direction: column;
    animation: slideUp .3s cubic-bezier(.16,1,.3,1);
    padding-bottom: var(--sab);
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-head {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 18px; border-bottom: 1px solid var(--border);
    font-weight: 800; font-size: 16px;
  }
  .modal-close {
    width: 32px; height: 32px; border-radius: 50%; border: none;
    background: var(--surface2); font-size: 18px; cursor: pointer; color: var(--text);
    display: flex; align-items: center; justify-content: center;
    font-family: "DM Sans", sans-serif;
  }
  .stack { display: flex; flex-direction: column; gap: 12px; }
  .bar { height: 8px; background: var(--border); border-radius: 999px; overflow: hidden; margin: 4px 0; }
  .bar > div { height: 100%; background: var(--accent); border-radius: 999px; transition: width .5s; }
  .muted { font-size: 12px; color: var(--muted); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DRIVES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .drives-tabs { display: flex; gap: 8px; margin-bottom: 14px; }
  .drives-tab {
    padding: 8px 16px; border-radius: 999px;
    border: 1.5px solid var(--accent);
    background: var(--accent); color: #fff;
    font-family: "DM Sans", sans-serif; font-size: 13px; font-weight: 700; cursor: pointer;
    min-height: 36px;
  }
  .drives-tab span {
    background: rgba(255,255,255,.25); border-radius: 999px;
    padding: 1px 7px; margin-left: 5px; font-size: 11px;
  }
  .drives-header { padding: 4px 0 10px; }
  .drive-item {
    display: flex; gap: 14px; padding: 14px 16px;
    background: var(--surface); border-radius: var(--radius-sm);
    margin-bottom: 10px; box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: transform .12s;
  }
  .drive-item:active { transform: scale(0.99); }
  .drive-thumb { font-size: 30px; display: flex; align-items: center; }
  .drive-info { flex: 1; min-width: 0; }
  .drive-route { font-weight: 800; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .drive-meta { font-size: 12px; color: var(--muted); margin-top: 3px; }
  .drive-amount { font-size: 17px; font-weight: 900; color: var(--accent); margin-top: 5px; }
  .no-drives { text-align: center; padding: 60px 20px; color: var(--muted); font-size: 15px; line-height: 2; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS â€” iOS-style list groups
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .sett-section { margin-bottom: 24px; }
  .sett-section-title {
    font-size: 11px; font-weight: 800; color: var(--muted);
    text-transform: uppercase; letter-spacing: 1px;
    padding: 0 4px; margin-bottom: 8px;
  }
  .sett-group {
    background: var(--surface); border-radius: var(--radius);
    overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border);
  }
  .sett-row {
    display: flex; align-items: center; gap: 14px;
    padding: 14px 16px; cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background .12s;
    min-height: 52px; /* 44px+ touch target */
  }
  .sett-row:last-child { border-bottom: none; }
  .sett-row:active { background: var(--surface2); }
  .sett-icon {
    width: 34px; height: 34px; border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 17px; flex-shrink: 0;
  }
  .sett-label { flex: 1; font-weight: 600; font-size: 16px; }
  .sett-value { font-size: 13px; color: var(--muted); font-weight: 500; }
  .sett-arrow { font-size: 22px; color: var(--muted); font-weight: 300; }
  .sett-check { font-size: 18px; color: var(--accent); font-weight: 900; }
  .sett-toggle {
    width: 51px; height: 31px; border-radius: 999px; border: none;
    background: var(--border); cursor: pointer; position: relative;
    transition: background .25s; flex-shrink: 0;
  }
  .sett-toggle::after {
    content: ""; position: absolute; top: 3px; left: 3px;
    width: 25px; height: 25px; border-radius: 50%; background: #fff;
    transition: left .22s cubic-bezier(.34,1.56,.64,1);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
  .sett-toggle.on { background: var(--accent); }
  .sett-toggle.on::after { left: 23px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MENU PANEL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .menu-wrap { position: relative; }
  .menu-panel {
    display: none; position: absolute; top: 48px; right: 0; width: 240px;
    background: var(--surface); border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.18);
    border: 1px solid var(--border); z-index: 99; padding: 14px;
  }
  .menu-panel.open { display: block; animation: fadeScale .18s ease; }
  @keyframes fadeScale { from { opacity:0; transform:scale(.95) translateY(-6px); } to { opacity:1; transform:scale(1) translateY(0); } }
  .menu-title { font-weight: 800; font-size: 15px; margin-bottom: 12px; }
  .menu-group { margin-bottom: 12px; }
  .menu-label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; display: block; }
  .menu-select {
    width: 100%; padding: 9px 12px; border-radius: 10px;
    border: 1.5px solid var(--border);
    font-family: "DM Sans", sans-serif; font-size: 14px;
    background: var(--surface2); color: var(--text);
  }
  .menu-row { display: flex; gap: 6px; }
  .chip-btn {
    flex: 1; padding: 8px; border-radius: 10px;
    border: 1.5px solid var(--border);
    font-family: "DM Sans", sans-serif; font-size: 13px; font-weight: 600;
    background: var(--surface2); color: var(--text); cursor: pointer;
    transition: all .18s; min-height: 36px;
  }
  .chip-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESPONSIVE BREAKPOINTS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /* Very small phones (SE, Galaxy A series) */
  @media (max-width: 375px) {
    .big { font-size: 46px; }
    .grid3 { grid-template-columns: 1fr 1fr; }
    .grid3 > :last-child { grid-column: 1 / -1; }
    .container { padding: 0 12px 20px; }
  }
  /* Larger phones / small tablets */
  @media (min-width: 428px) {
    .container { padding: 0 20px 24px; }
    .card { padding: 18px; }
    .big { font-size: 62px; }
  }
  /* Landscape mode: compress header */
  @media (orientation: landscape) and (max-height: 500px) {
    .header { padding-top: 8px; padding-bottom: 6px; }
    .logo { font-size: 22px; }
    .card { padding: 12px; margin-bottom: 8px; }
    .mapbox { height: 140px; }
    :root { --tab-h: calc(50px + var(--sab)); }
  }
  /* Keyboard open: shrink suggestions to avoid overlap */
  @media (max-height: 500px) {
    .suggestions { max-height: 140px; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SAFETY FEATURES â€” shared alert styles
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* Full-screen danger flash overlay */
  .danger-flash {
    position: fixed; inset: 0; z-index: 9999;
    pointer-events: none;
    animation: dangerFlash .5s ease-in-out infinite;
  }
  @keyframes dangerFlash {
    0%,100% { background: rgba(239,68,68,0); }
    50%      { background: rgba(239,68,68,0.22); }
  }

  /* Toast alert banner */
  .safety-toast {
    position: fixed; top: calc(14px + env(safe-area-inset-top,0px));
    left: 14px; right: 14px; z-index: 9000;
    border-radius: 16px; padding: 14px 16px;
    display: flex; align-items: flex-start; gap: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.35);
    transform: translateY(-120px); opacity: 0;
    transition: transform .35s cubic-bezier(.16,1,.3,1), opacity .35s;
    pointer-events: all;
    max-width: 520px; margin: 0 auto;
  }
  .safety-toast.show { transform: translateY(0); opacity: 1; }
  .safety-toast.danger  { background: #1a0505; border: 1.5px solid #ef4444; }
  .safety-toast.warning { background: #1a1005; border: 1.5px solid #f59e0b; }
  .safety-toast.info    { background: #05101a; border: 1.5px solid #3b82f6; }
  .toast-icon { font-size: 28px; flex-shrink: 0; line-height: 1; margin-top: 2px; }
  .toast-body { flex: 1; }
  .toast-title { font-size: 14px; font-weight: 800; color: #fff; margin-bottom: 3px; }
  .toast-msg   { font-size: 12px; color: rgba(255,255,255,.75); line-height: 1.4; }
  .toast-close {
    width: 28px; height: 28px; border-radius: 50%; border: none;
    background: rgba(255,255,255,.12); color: #fff;
    font-size: 16px; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-family: "DM Sans",sans-serif;
  }

  /* â”€â”€ FATIGUE DETECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #fatigueOverlay {
    position: fixed; inset: 0; z-index: 8000;
    display: none; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(0,0,0,0.92);
    gap: 20px; padding: 24px;
  }
  #fatigueOverlay.active { display: flex; }
  #fatigueVideo {
    width: 120px; height: 120px; border-radius: 50%;
    object-fit: cover; border: 3px solid #ef4444;
    transform: scaleX(-1); /* mirror */
  }
  .fatigue-status-ring {
    width: 140px; height: 140px; border-radius: 50%;
    position: absolute;
    border: 4px solid #ef4444;
    animation: ringPulse 1s infinite;
  }
  @keyframes ringPulse {
    0%,100% { transform: scale(1); opacity: 1; }
    50%      { transform: scale(1.15); opacity: .4; }
  }
  #fatigueAlert {
    position: fixed; inset: 0; z-index: 9500;
    display: none; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(180,0,0,0.97);
    gap: 16px; padding: 32px; text-align: center;
  }
  #fatigueAlert.show { display: flex; animation: dangerFlash .4s ease-in-out 3; }
  #fatigueAlert .alert-emoji { font-size: 80px; animation: shake .3s infinite; }
  #fatigueAlert .alert-title { font-family:"Bebas Neue",sans-serif; font-size:52px; color:#fff; letter-spacing:2px; line-height:1; }
  #fatigueAlert .alert-sub { font-size:18px; color:rgba(255,255,255,.85); font-weight:700; }
  #fatigueAlert .alert-dismiss {
    margin-top:16px; padding:16px 40px; border-radius:14px; border:none;
    background:#fff; color:#ef4444; font-family:"DM Sans",sans-serif;
    font-size:16px; font-weight:900; cursor:pointer;
  }
  @keyframes shake {
    0%,100%{ transform:rotate(-8deg); }
    50%    { transform:rotate(8deg); }
  }

  /* â”€â”€ WEATHER WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /* Weather widget â€” compact card top-left of fullscreen map */
  #weatherWidget {
    background: rgba(15,23,42,0.87);
    backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
    border-radius: 10px; padding: 6px 10px;
    border: 1px solid rgba(255,255,255,.1);
    box-shadow: 0 3px 14px rgba(0,0,0,.4);
    color: #f1f5f9;
    display: none;
    cursor: pointer;
    transition: transform .15s;
    pointer-events: all;
    min-width: 80px;
  }
  #weatherWidget:active { transform: scale(.95); }
  #weatherWidget.visible { display: block; animation: fadeIn .3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .wx-row { display: flex; align-items: center; gap: 5px; }
  .wx-icon { font-size: 18px; line-height: 1; }
  .wx-temp { font-family:"Bebas Neue",sans-serif; font-size: 20px; line-height:1; }
  .wx-desc { font-size: 9px; color: rgba(255,255,255,.55); font-weight:600; text-transform:uppercase; letter-spacing:.3px; margin-top:1px; }
  .wx-danger { color: #ef4444 !important; animation: blink 1s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }

  /* â”€â”€ BRIDGE DETECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bridgeInput {
    position: fixed;
    bottom: calc(var(--tab-h) + 12px);
    left: 14px; left: calc(14px + env(safe-area-inset-left,0px));
    z-index: 500;
    background: rgba(15,23,42,0.88);
    backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
    border-radius: 16px; padding: 10px 14px;
    border: 1px solid rgba(255,255,255,.1);
    box-shadow: 0 4px 24px rgba(0,0,0,.4);
    color: #f1f5f9; display: none;
    min-width: 150px;
  }
  #bridgeInput.visible { display: block; animation: fadeIn .3s ease; }

  /* â”€â”€ BRIDGE MODE: hide all overlays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #fullMapScreen.bridge-mode #fmHud,
  #fullMapScreen.bridge-mode #fmTrackBanner,
  #fullMapScreen.bridge-mode #speedometerWidget,
  #fullMapScreen.bridge-mode #driveHoursWidget,
  #fullMapScreen.bridge-mode #speedLimitWidget,
  #fullMapScreen.bridge-mode #mapSpeedSign,
  #fullMapScreen.bridge-mode #sosFab,
  #fullMapScreen.bridge-mode #weatherWidget,
  #fullMapScreen.bridge-mode #fuelWidget,
  #fullMapScreen.bridge-mode #fmFollowBtn,
  #fullMapScreen.bridge-mode .fm-zoom-btns,
  #fullMapScreen.bridge-mode #reportFab,
  #fullMapScreen.bridge-mode #reportSheet,
  #fullMapScreen.bridge-mode #incidentPanel {
    opacity: 0 !important;
    pointer-events: none !important;
  }
  /* Keep bridge widget and close button always visible */
  #fullMapScreen.bridge-mode #bridgeInput,
  #fullMapScreen.bridge-mode #closeFullMap { opacity: 1 !important; pointer-events: auto !important; }
  /* Smooth transition */
  #fullMapScreen #fmHud,
  #fullMapScreen #speedometerWidget,
  #fullMapScreen #driveHoursWidget,
  #fullMapScreen #mapSpeedSign { transition: opacity .4s ease; }
  .bridge-label { font-size: 9px; color:rgba(255,255,255,.5); text-transform:uppercase; letter-spacing:.5px; margin-bottom:5px; font-weight:700; }
  .bridge-row { display:flex; align-items:center; gap:6px; }
  .bridge-val { font-family:"Bebas Neue",sans-serif; font-size:26px; color:#f59e0b; line-height:1; }
  .bridge-ft  { font-size:11px; color:rgba(255,255,255,.5); font-weight:600; }
  .bridge-btns { display:flex; gap:4px; margin-top:6px; }
  .bridge-btn {
    flex:1; padding:5px; border-radius:8px; border:none;
    font-family:"DM Sans",sans-serif; font-size:13px; font-weight:700;
    cursor:pointer; background:rgba(255,255,255,.1); color:#fff;
  }
  .bridge-btn:active { background:rgba(255,255,255,.2); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAP POI POPUPS & REPORT SYSTEM
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /* POI legend bar on fullscreen map */
  #poiLegend {
    position:absolute; top:calc(76px + env(safe-area-inset-top,0px));
    left: calc(14px + env(safe-area-inset-left,0px));
    right: calc(14px + env(safe-area-inset-right,0px));
    z-index:10; display:none;
    gap:6px; flex-wrap:wrap;
    pointer-events:none;
  }
  #poiLegend.visible { display:flex; }
  .poi-chip {
    display:flex; align-items:center; gap:4px;
    background:rgba(15,23,42,0.85); backdrop-filter:blur(8px);
    border-radius:999px; padding:5px 10px;
    font-size:11px; font-weight:700; color:#f1f5f9;
    border:1px solid rgba(255,255,255,.1);
    pointer-events:all; cursor:pointer;
    transition:background .15s;
  }
  .poi-chip:active { background:rgba(255,255,255,.15); }
  .poi-chip.off { opacity:.45; }

  /* Report button (Waze-style FAB on map) */
  #reportFab {
    position:absolute;
    right: calc(14px + env(safe-area-inset-right,0px));
    bottom: 300px;
    z-index:10;
    width:52px; height:52px; border-radius:50%; border:none;
    background:#f59e0b; color:#fff;
    font-size:22px; cursor:pointer;
    box-shadow:0 4px 16px rgba(245,158,11,.5);
    display:none; align-items:center; justify-content:center;
    transition:transform .15s;
  }
  #reportFab.visible { display:flex; }
  #reportFab:active { transform:scale(.92); }

  /* â”€â”€ ACTIVE INCIDENT MINI ICON (settings) â”€â”€â”€â”€â”€ */
  .inc-mini-icon {
    width: 36px; height: 36px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border: 2px solid var(--border);
    animation: iconPop .3s cubic-bezier(.34,1.56,.64,1);
    cursor: default;
    position: relative;
  }
  @keyframes iconPop {
    from { transform: scale(0); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
  }

  /* Keep report panel CSS but hide the FAB */
  #reportFab { display: none !important; }

  /* Report panel */
  #reportPanel {
    position:absolute; bottom:0; left:0; right:0; z-index:20;
    background:rgba(10,16,30,0.97); backdrop-filter:blur(20px);
    border-radius:22px 22px 0 0;
    padding:20px 16px calc(24px + env(safe-area-inset-bottom,0px));
    transform:translateY(100%);
    transition:transform .35s cubic-bezier(.16,1,.3,1);
    border-top:1px solid rgba(255,255,255,.08);
  }
  #reportPanel.open { transform:translateY(0); }
  .report-handle { width:36px;height:4px;background:rgba(255,255,255,.2);border-radius:999px;margin:0 auto 16px; }
  .report-title { font-family:"Bebas Neue",sans-serif;font-size:22px;color:#fff;letter-spacing:1px;margin-bottom:14px;text-align:center; }
  .report-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:14px; }
  .report-type {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:6px; padding:14px 8px; border-radius:14px;
    border:1.5px solid rgba(255,255,255,.1); background:rgba(255,255,255,.05);
    cursor:pointer; color:#f1f5f9; font-size:11px; font-weight:700;
    text-align:center; transition:all .15s; min-height:72px;
  }
  .report-type:active { background:rgba(255,255,255,.15); transform:scale(.97); }
  .report-type .rt-icon { font-size:26px; line-height:1; }
  .report-cancel {
    width:100%; padding:13px; border-radius:12px; border:1px solid rgba(255,255,255,.15);
    background:rgba(255,255,255,.08); color:#f1f5f9;
    font-family:"DM Sans",sans-serif; font-size:15px; font-weight:700; cursor:pointer;
  }

  /* Community alert banner on map */
  .map-alert-banner {
    position:absolute; z-index:15;
    left: calc(14px + env(safe-area-inset-left,0px));
    right: calc(14px + env(safe-area-inset-right,0px));
    top:calc(140px + env(safe-area-inset-top,0px));
    background:rgba(245,158,11,0.95); border-radius:14px; padding:10px 14px;
    display:flex; align-items:center; gap:10px;
    color:#000; font-weight:700; font-size:13px;
    animation:slideDown .3s ease;
    pointer-events:none;
  }
  @keyframes slideDown { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
  .map-alert-banner .ban-icon { font-size:22px; flex-shrink:0; }
  .map-alert-banner .ban-txt { flex:1; line-height:1.3; }
  .map-alert-banner .ban-dist { font-size:11px; opacity:.7; }

  /* Zoom controls replacement â€” right side */
  .fm-zoom-btns {
    position:absolute;
    right: calc(14px + env(safe-area-inset-right,0px));
    top: 50%; transform:translateY(-50%);
    z-index:10; display:flex; flex-direction:column; gap:6px;
  }
  .fm-zoom-btn {
    width:40px; height:40px; border-radius:12px; border:none;
    background:rgba(15,23,42,0.85); backdrop-filter:blur(8px);
    color:#fff; font-size:20px; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 2px 8px rgba(0,0,0,.3); transition:transform .12s;
  }
  .fm-zoom-btn:active { transform:scale(.92); }

  /* â”€â”€ QUICK REPORT FAB + SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #reportFab {
    position: absolute;
    bottom: calc(80px + env(safe-area-inset-bottom, 0px));
    right: calc(14px + env(safe-area-inset-right, 0px));
    z-index: 710;
    width: 52px; height: 52px;
    border-radius: 50%; border: 2.5px solid #fff;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: #fff; font-size: 22px;
    display: none; align-items: center; justify-content: center;
    box-shadow: 0 4px 20px rgba(239,68,68,.55);
    cursor: pointer;
    touch-action: manipulation;
    transition: transform .15s, box-shadow .15s;
    -webkit-tap-highlight-color: transparent;
  }
  #reportFab.visible { display: flex; }
  #reportFab:active  { transform: scale(.92); }
  #reportFab.spinning { animation: reportFabSpin .3s ease; }
  @keyframes reportFabSpin {
    from { transform: rotate(0deg) scale(1); }
    50%  { transform: rotate(180deg) scale(.85); }
    to   { transform: rotate(360deg) scale(1); }
  }

  #reportSheet {
    position: absolute;
    bottom: calc(148px + env(safe-area-inset-bottom, 0px));
    right: calc(14px + env(safe-area-inset-right, 0px));
    z-index: 709;
    display: none;
    flex-direction: column;
    gap: 8px;
    align-items: flex-end;
  }
  #reportSheet.open { display: flex; animation: sheetSlideIn .25s cubic-bezier(.34,1.56,.64,1); }
  @keyframes sheetSlideIn {
    from { opacity: 0; transform: translateY(24px) scale(.85); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }
  .rs-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 9px 14px 9px 10px;
    border-radius: 999px; border: none;
    background: rgba(10,16,30,.93);
    backdrop-filter: blur(14px);
    color: #fff; cursor: pointer;
    touch-action: manipulation;
    box-shadow: 0 4px 16px rgba(0,0,0,.45);
    transition: transform .12s;
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
  }
  .rs-btn:active { transform: scale(.95); }
  .rs-icon {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .rs-label { font-size: 13px; font-weight: 800; letter-spacing: .2px; }

  /* â”€â”€ TOP BAR ROUND REPORT BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .top-rpt-btn {
    width: 36px; height: 36px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,.8);
    color: #fff; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(0,0,0,.5);
    transition: transform .12s, box-shadow .12s;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    animation: topRptIn .3s cubic-bezier(.34,1.56,.64,1) both;
  }
  .top-rpt-btn:active { transform: scale(.88); }
  .top-rpt-btn:nth-child(1) { animation-delay: .00s; }
  .top-rpt-btn:nth-child(2) { animation-delay: .04s; }
  .top-rpt-btn:nth-child(3) { animation-delay: .08s; }
  .top-rpt-btn:nth-child(4) { animation-delay: .12s; }
  .top-rpt-btn:nth-child(5) { animation-delay: .16s; }
  .top-rpt-btn:nth-child(6) { animation-delay: .20s; }
  @keyframes topRptIn {
    from { opacity:0; transform:scale(.4) translateY(-8px); }
    to   { opacity:1; transform:scale(1) translateY(0); }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SPEED LIMIT WIDGET (map, top-right)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #speedLimitWidget {
    left: 12px;
    position: absolute;
    top: calc(var(--header-pt) + 8px);
    z-index: 650;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: auto;
    opacity: .78;
    cursor: grab;
    touch-action: none;
  }
  #speedLimitWidget.visible { display: flex; }
  #speedLimitWidget.dragging { cursor: grabbing; }
  .sl-sign {
    opacity: .92;
    width: 64px; height: 72px;
    background: #fff;
    border: 4px solid #000;
    border-radius: 6px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    box-shadow: 0 3px 14px rgba(0,0,0,.5);
    position: relative;
  }
  .sl-sign::before {
    content: 'SPEED\nLIMIT';
    white-space: pre;
    font-size: 8px; font-weight: 900;
    letter-spacing: .5px;
    text-align: center;
    line-height: 1.1;
    color: #000;
    margin-bottom: 2px;
  }
  .sl-num {
    font-family: "Bebas Neue", sans-serif;
    font-size: 30px; line-height: 1;
    color: #000;
    letter-spacing: 1px;
  }
  .sl-sign.over-limit { border-color: #ef4444; background: #fef2f2; }
  .sl-sign.over-limit .sl-num { color: #ef4444; }
  .sl-state {
    font-size: 9px; font-weight: 800;
    color: rgba(255,255,255,.7);
    letter-spacing: .8px;
    margin-top: 3px;
    text-shadow: 0 1px 3px rgba(0,0,0,.5);
  }

  /* â”€â”€ MAP SPEED LIMIT SIGN (always on map, not draggable) â”€â”€ */
  #mapSpeedSign {
    position: absolute;
    top: calc(70px + env(safe-area-inset-top, 0px));
    right: calc(12px + env(safe-area-inset-right, 0px));
    bottom: auto; left: auto;
    z-index: 650;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: none;
    filter: drop-shadow(0 3px 10px rgba(0,0,0,.5));
  }
  #mapSpeedSign.visible { display: flex; }
  .mss-post {
    width: 4px; height: 12px;
    background: #6b7280;
    border-radius: 0 0 2px 2px;
  }
  .mss-sign {
    width: 52px; height: 60px;
    background: #fff;
    border: 4px solid #000;
    border-radius: 5px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative;
    transition: border-color .3s, background .3s;
  }
  .mss-sign.warn  { border-color: #ef4444; background: #fff5f5; }
  .mss-sign.new   { animation: signPop .4s cubic-bezier(.34,1.56,.64,1); }
  @keyframes signPop {
    from { transform: scale(.7); opacity: .3; }
    to   { transform: scale(1); opacity: 1; }
  }
  .mss-top {
    font-size: 6px; font-weight: 900;
    letter-spacing: .5px; line-height: 1.15;
    text-align: center; color: #000;
    white-space: pre;
  }
  .mss-num {
    font-family: "Bebas Neue", sans-serif;
    font-size: 26px; line-height: .95;
    color: #000; letter-spacing: 1px;
    transition: color .3s;
  }
  .mss-sign.warn .mss-num { color: #ef4444; }
  .mss-truck-label {
    font-size: 6px; font-weight: 900;
    color: #6b7280; letter-spacing: .3px;
    margin-top: 1px;
  }
  .mss-state-badge {
    background: rgba(10,16,30,.82);
    backdrop-filter: blur(6px);
    color: #f1f5f9;
    font-size: 8px; font-weight: 800;
    letter-spacing: .6px;
    padding: 2px 7px;
    border-radius: 999px;
    margin-top: 4px;
    white-space: nowrap;
  }
  .mss-diff {
    font-size: 7px; font-weight: 700;
    color: rgba(241,245,249,.5);
    margin-top: 1px;
    white-space: nowrap;
  }

  /* â”€â”€ SMOOTH TRUCK WRAPPER (CSS rotation transition) â”€â”€â”€â”€â”€â”€â”€ */
  .truck-smooth-wrapper {
    width: 60px; height: 60px;
    position: relative;
    /* rotation handled by JS inline style for smooth GPU transition */
  }
  .truck-smooth-wrapper .truck-glow {
    position: absolute; inset: -8px; border-radius: 50%;
    background: radial-gradient(circle, rgba(16,185,129,.4) 0%, transparent 68%);
    animation: truckGlow 2s ease-in-out infinite;
    pointer-events: none;
  }
  .truck-smooth-wrapper.stopped .truck-glow {
    background: radial-gradient(circle, rgba(107,114,128,.25) 0%, transparent 68%);
  }
  /* Pulse ring under the truck when moving */
  .truck-smooth-wrapper .truck-pulse {
    position: absolute; inset: -2px; border-radius: 50%;
    border: 2px solid rgba(16,185,129,.5);
    animation: truckPulse 1.5s ease-out infinite;
  }
  .truck-smooth-wrapper.stopped .truck-pulse { display: none; }
  @keyframes truckPulse {
    0%   { transform: scale(1); opacity: .6; }
    100% { transform: scale(1.9); opacity: 0; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FUEL STATIONS WIDGET (bottom left on map)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #fuelWidget {
    position: fixed;
    bottom: calc(var(--tab-h) + 16px);
    right: calc(14px + env(safe-area-inset-right,0px));
    z-index: 650;
    display: none;
    background: rgba(10,16,30,0.94);
    backdrop-filter: blur(14px);
    border-radius: 16px;
    padding: 10px 13px;
    border: 1px solid rgba(255,255,255,.1);
    box-shadow: 0 4px 24px rgba(0,0,0,.5);
    color: #f1f5f9;
    min-width: 140px;
    cursor: pointer;
    transition: transform .15s;
  }
  #fuelWidget.visible { display: block; animation: fadeIn .3s ease; }
  #fuelWidget:active { transform: scale(.96); }
  .fuel-label { font-size: 9px; color: rgba(255,255,255,.4); text-transform: uppercase; letter-spacing: .6px; font-weight: 700; margin-bottom: 4px; }
  .fuel-price { font-family: "Bebas Neue", sans-serif; font-size: 30px; color: #10b981; line-height: 1; }
  .fuel-name { font-size: 10px; color: rgba(255,255,255,.6); font-weight: 600; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 130px; }
  .fuel-dist { font-size: 9px; color: rgba(255,255,255,.4); font-weight: 600; margin-top: 1px; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SOS EMERGENCY OVERLAY
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #sosOverlay {
    position: fixed; inset: 0; z-index: 20000;
    display: none; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(100,0,0,0.97);
    padding: 32px; text-align: center;
    animation: sosPulse .6s ease-in-out infinite alternate;
  }
  #sosOverlay.show { display: flex; }
  @keyframes sosPulse {
    from { background: rgba(100,0,0,.97); }
    to   { background: rgba(180,0,0,.97); }
  }
  .sos-emoji { font-size: 80px; animation: shake .4s infinite; }
  .sos-title { font-family: "Bebas Neue", sans-serif; font-size: 64px; color: #fff; letter-spacing: 3px; margin-top: 12px; }
  .sos-coords { font-size: 13px; color: rgba(255,255,255,.7); font-weight: 600; margin-top: 8px; font-family: monospace; }
  .sos-contact-name { font-size: 22px; font-weight: 900; color: #fff; margin-top: 14px; }
  .sos-contact-phone { font-size: 18px; color: rgba(255,255,255,.8); margin-top: 4px; }
  .sos-call-btn {
    margin-top: 20px; padding: 18px 40px;
    background: #fff; color: #ef4444;
    border: none; border-radius: 16px;
    font-size: 20px; font-weight: 900;
    font-family: "DM Sans", sans-serif;
    cursor: pointer; width: 100%; max-width: 320px;
    box-shadow: 0 4px 20px rgba(0,0,0,.3);
    display: flex; align-items: center; justify-content: center; gap: 10px;
  }
  .sos-sms-btn {
    margin-top: 10px; padding: 14px 40px;
    background: rgba(255,255,255,.15); color: #fff;
    border: 2px solid rgba(255,255,255,.3); border-radius: 16px;
    font-size: 16px; font-weight: 700;
    font-family: "DM Sans", sans-serif;
    cursor: pointer; width: 100%; max-width: 320px;
  }
  .sos-dismiss {
    margin-top: 16px; padding: 12px 40px;
    background: transparent; color: rgba(255,255,255,.5);
    border: 1px solid rgba(255,255,255,.2); border-radius: 12px;
    font-size: 14px; font-weight: 600;
    font-family: "DM Sans", sans-serif;
    cursor: pointer; width: 100%; max-width: 320px;
  }

  /* SOS button (visible on map) */
  #sosFab {
    width: 44px; height: 44px;
    border-radius: 50%; border: 2.5px solid #fff;
    background: #ef4444;
    color: #fff; font-size: 10px; font-weight: 900;
    font-family: "DM Sans", sans-serif;
    display: none; align-items: center; justify-content: center;
    box-shadow: 0 4px 16px rgba(239,68,68,.6);
    cursor: pointer; letter-spacing: .5px;
    animation: sosFabPulse 2s ease-in-out infinite;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  #sosFab.visible { display: flex; }
  @keyframes sosFabPulse {
    0%,100% { box-shadow: 0 4px 16px rgba(239,68,68,.5); }
    50% { box-shadow: 0 0 0 6px rgba(239,68,68,.2), 0 4px 16px rgba(239,68,68,.5); }
  }

  /* Speed limit exceedance toast */
  .speed-toast {
    position: fixed;
    top: calc(var(--header-pt) + 80px);
    left: 50%; transform: translateX(-50%);
    z-index: 800;
    background: #ef4444;
    color: #fff; border-radius: 12px;
    padding: 10px 20px;
    font-size: 14px; font-weight: 800;
    white-space: nowrap;
    box-shadow: 0 4px 20px rgba(239,68,68,.5);
    display: none;
    animation: fadeIn .2s ease;
  }
  .speed-toast.show { display: block; }
  #speedometerWidget {
    position: fixed;
    bottom: calc(var(--tab-h) + 16px);
    right: calc(16px + env(safe-area-inset-right, 0px));
    left: auto;
    top: auto;
    transform: none;
    z-index: 600;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: auto;
    opacity: .75;
    cursor: grab;
    touch-action: none;
  }
  #speedometerWidget.visible { display: flex; }
  #speedometerWidget.dragging { cursor: grabbing; }

  /* â”€â”€ DRIVING HOURS WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #driveHoursWidget {
    position: fixed;
    bottom: calc(var(--tab-h) + 120px);
    left: calc(14px + env(safe-area-inset-left, 0px));
    right: auto; top: auto; transform: none;
    z-index: 600;
    display: none;
    flex-direction: column;
    align-items: center;
    pointer-events: auto;
    opacity: .88;
    cursor: grab;
    touch-action: none;
    user-select: none;
  }
  #driveHoursWidget.visible  { display: flex; }
  #driveHoursWidget.dragging { cursor: grabbing; opacity: 1; }

  .dh-ring {
    width: 64px; height: 64px;
    border-radius: 50%;
    background: rgba(10,16,30,0.95);
    border: 2.5px solid #10b981;
    box-shadow: 0 0 0 1px rgba(16,185,129,.15), 0 0 14px rgba(16,185,129,.22), 0 4px 16px rgba(0,0,0,.6);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative;
    backdrop-filter: blur(16px);
    transition: border-color .3s, box-shadow .3s;
  }
  .dh-ring.warn {
    border-color: #f59e0b;
    box-shadow: 0 0 0 1px rgba(245,158,11,.3), 0 0 16px rgba(245,158,11,.35), 0 4px 16px rgba(0,0,0,.6);
  }
  .dh-ring.critical {
    border-color: #ef4444;
    box-shadow: 0 0 0 1px rgba(239,68,68,.35), 0 0 16px rgba(239,68,68,.45), 0 4px 16px rgba(0,0,0,.6);
    animation: dhPulse 1.4s ease-in-out infinite;
  }
  @keyframes dhPulse {
    0%,100% { box-shadow: 0 0 0 1px rgba(239,68,68,.35), 0 0 16px rgba(239,68,68,.45), 0 4px 16px rgba(0,0,0,.6); }
    50%      { box-shadow: 0 0 0 3px rgba(239,68,68,.15), 0 0 26px rgba(239,68,68,.6),  0 4px 16px rgba(0,0,0,.6); }
  }
  .dh-svg {
    position: absolute; top: -3px; left: -3px;
    width: 70px; height: 70px;
    pointer-events: none;
  }
  .dh-hrs {
    font-family: "Bebas Neue", sans-serif;
    font-size: 22px; line-height: 1;
    color: #10b981; letter-spacing: .5px;
    z-index: 1;
    transition: color .3s;
  }
  .dh-hrs.warn     { color: #f59e0b; }
  .dh-hrs.critical { color: #ef4444; }
  .dh-unit {
    font-size: 7px; font-weight: 800;
    color: rgba(255,255,255,.4); letter-spacing: 1px;
    text-transform: uppercase; z-index: 1; margin-top: -1px;
  }
  .dh-label {
    font-size: 8px; font-weight: 700;
    color: rgba(255,255,255,.3); letter-spacing: .5px;
    margin-top: 3px; text-align: center;
    white-space: nowrap;
  }
  .speedo-ring {
    width: 110px; height: 110px;
    border-radius: 50%;
    background: rgba(10,16,30,0.95);
    border: 3px solid #10b981;
    box-shadow: 0 0 0 2px rgba(16,185,129,0.15), 0 0 24px rgba(16,185,129,0.25), 0 8px 32px rgba(0,0,0,0.6);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative;
    backdrop-filter: blur(16px);
  }
  .speedo-ring.moving {
    border-color: #10b981;
    box-shadow: 0 0 0 2px rgba(16,185,129,0.3), 0 0 30px rgba(16,185,129,0.4), 0 8px 32px rgba(0,0,0,0.6);
  }
  .speedo-ring.stopped {
    border-color: #6b7280;
    box-shadow: 0 0 0 2px rgba(107,114,128,0.15), 0 8px 32px rgba(0,0,0,0.6);
  }
  .speedo-svg {
    position: absolute; top: -5px; left: -5px;
    width: 120px; height: 120px;
    pointer-events: none;
  }
  .speedo-num {
    font-family: "Bebas Neue", sans-serif;
    font-size: 42px; line-height: 1;
    color: #10b981;
    letter-spacing: 1px;
    z-index: 1;
  }
  .speedo-num.stopped { color: #6b7280; }
  .speedo-unit {
    font-size: 10px; font-weight: 800;
    color: rgba(255,255,255,0.45);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    z-index: 1;
    margin-top: -4px;
  }
  .speedo-label {
    font-size: 9px; font-weight: 700;
    color: rgba(255,255,255,0.3);
    letter-spacing: .8px;
    margin-top: 3px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INCIDENT BUBBLES PANEL (left side, stacked)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #incidentPanel {
    position: fixed;
    left: calc(10px + env(safe-area-inset-left, 0px));
    top: 50%;
    transform: translateY(-50%);
    z-index: 700;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: none;
  }
  .incident-bubble {
    width: 64px; height: 64px;
    border-radius: 50%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 1px;
    pointer-events: all;
    cursor: pointer;
    border: 2.5px solid #fff;
    box-shadow: 0 3px 14px rgba(0,0,0,0.55);
    animation: bubbleIn .3s cubic-bezier(.34,1.56,.64,1);
    position: relative;
    transition: transform .15s;
  }
  .incident-bubble:active { transform: scale(0.93); }
  @keyframes bubbleIn {
    from { opacity: 0; transform: scale(0.4) translateX(-20px); }
    to   { opacity: 1; transform: scale(1) translateX(0); }
  }
  .incident-bubble.police   { background: #1d3a8a; border-color: #93c5fd; }
  .incident-bubble.accident { background: #7f1d1d; border-color: #fca5a5; }
  .incident-bubble.traffic  { background: #78350f; border-color: #fcd34d; }
  .incident-bubble.hazard   { background: #7c2d12; border-color: #fdba74; }
  .incident-bubble.construction { background: #713f12; border-color: #fde68a; }
  .incident-bubble.closure  { background: #450a0a; border-color: #f87171; }
  .ib-emoji { font-size: 24px; line-height: 1; }
  .ib-dist  { font-size: 9px; font-weight: 800; color: rgba(255,255,255,0.9); letter-spacing: .4px; }
  .ib-label { font-size: 7px; font-weight: 700; color: rgba(255,255,255,0.6); letter-spacing: .3px; text-align: center; line-height: 1.2; max-width: 52px; }
  /* dismiss X on bubble */
  .ib-close {
    position: absolute; top: -3px; right: -3px;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: rgba(0,0,0,0.7);
    border: 1.5px solid rgba(255,255,255,0.5);
    color: #fff; font-size: 10px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 900;
  }
  /* Toggle button for incident panel */
  #incidentToggleBtn {
    position: fixed;
    left: calc(10px + env(safe-area-inset-left, 0px));
    top: calc(var(--header-pt) + 60px);
    z-index: 701;
    width: 44px; height: 44px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.2);
    background: rgba(10,16,30,0.88);
    backdrop-filter: blur(12px);
    color: #fff; font-size: 18px;
    display: none;
    align-items: center; justify-content: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.4);
    cursor: pointer;
    transition: background .2s;
  }
  #incidentToggleBtn.visible { display: flex; }
  #incidentToggleBtn.has-incidents {
    background: rgba(239,68,68,0.85);
    border-color: rgba(255,255,255,0.4);
    animation: incidentBtnPulse 2s ease-in-out infinite;
  }
  @keyframes incidentBtnPulse {
    0%,100% { box-shadow: 0 2px 12px rgba(0,0,0,0.4); }
    50% { box-shadow: 0 0 0 6px rgba(239,68,68,0.25), 0 2px 12px rgba(0,0,0,0.4); }
  }
  .incident-badge {
    position: absolute; top: -4px; right: -4px;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: #ef4444; color: #fff;
    font-size: 10px; font-weight: 900;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid #fff;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FULL-SCREEN ALERT â€” only for HOS/weather/bridge
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #fullscreenAlertOverlay {
    position: fixed; inset: 0; z-index: 19000;
    display: none;
    flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center;
    padding: 24px;
    animation: alertPulse .6s ease-in-out infinite alternate;
  }
  #fullscreenAlertOverlay.show { display: flex; }
  #fullscreenAlertOverlay.police {
    background: rgba(30,40,80,0.98);
    border: 4px solid #3b82f6;
  }
  #fullscreenAlertOverlay.danger-alert {
    background: rgba(80,10,10,0.98);
    border: 4px solid #ef4444;
  }
  #fullscreenAlertOverlay.warning-alert {
    background: rgba(50,35,10,0.98);
    border: 4px solid #f59e0b;
  }
  @keyframes alertPulse {
    from { box-shadow: inset 0 0 0px rgba(255,255,255,0); }
    to   { box-shadow: inset 0 0 60px rgba(255,255,255,0.04); }
  }
  .fs-alert-emoji {
    font-size: 100px; line-height: 1;
    filter: drop-shadow(0 0 20px rgba(255,255,255,0.3));
    animation: alertBounce 0.5s ease-in-out infinite alternate;
  }
  @keyframes alertBounce {
    from { transform: scale(1); }
    to   { transform: scale(1.1); }
  }
  .fs-alert-title {
    font-family: "Bebas Neue", sans-serif;
    font-size: 64px; color: #fff;
    letter-spacing: 3px; line-height: 1;
    margin-top: 16px;
    text-shadow: 0 0 30px rgba(255,255,255,0.3);
  }
  .fs-alert-sub {
    font-size: 20px; color: rgba(255,255,255,0.85);
    font-weight: 700; margin-top: 10px;
    line-height: 1.4; max-width: 320px;
  }
  .fs-alert-dist {
    font-size: 16px; color: rgba(255,255,255,0.55);
    margin-top: 8px; font-weight: 600;
  }
  .fs-alert-dismiss {
    margin-top: 32px;
    padding: 18px 48px;
    border-radius: 16px; border: none;
    font-family: "DM Sans", sans-serif;
    font-size: 18px; font-weight: 900;
    cursor: pointer;
    min-width: 260px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    transition: transform .12s;
  }
  .fs-alert-dismiss:active { transform: scale(0.96); }
  .fs-alert-dismiss.police-btn { background: #3b82f6; color: #fff; }
  .fs-alert-dismiss.danger-btn { background: #ef4444; color: #fff; }
  .fs-alert-dismiss.warning-btn { background: #f59e0b; color: #000; }
  /* Flashing light bar for police */
  .police-lightbar {
    display: none;
    width: 100%;
    height: 18px;
    position: absolute; top: 0; left: 0;
    border-radius: 0;
    overflow: hidden;
  }
  .fs-alert-overlay.police .police-lightbar { display: block; }
  #fullscreenAlertOverlay.police .police-lightbar { display: flex; }
  .police-lightbar-inner {
    flex: 1;
    animation: lightbarFlash 0.35s linear infinite alternate;
  }
  .police-lightbar-inner:nth-child(odd) {
    background: #3b82f6;
    animation-direction: alternate;
  }
  .police-lightbar-inner:nth-child(even) {
    background: #ef4444;
    animation-direction: alternate-reverse;
  }
  @keyframes lightbarFlash {
    from { opacity: 1; }
    to { opacity: 0.15; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     REST ALARM OVERLAY
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #restAlarmOverlay {
    position: fixed; inset: 0; z-index: 18000;
    display: none;
    flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center;
    padding: 24px;
    background: rgba(5,30,50,0.97);
    border: 4px solid #3b82f6;
  }
  #restAlarmOverlay.show { display: flex; }
  .rest-alarm-emoji { font-size: 90px; animation: restPulse 1s ease-in-out infinite; }
  @keyframes restPulse {
    0%,100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }
  .rest-alarm-title {
    font-family: "Bebas Neue", sans-serif;
    font-size: 58px; color: #3b82f6;
    letter-spacing: 2px; margin-top: 14px;
  }
  .rest-alarm-sub {
    font-size: 18px; color: rgba(255,255,255,0.8);
    font-weight: 700; margin-top: 8px; max-width: 300px;
  }
  .rest-alarm-timer {
    font-family: "Bebas Neue", sans-serif;
    font-size: 80px; color: #f59e0b;
    letter-spacing: 2px; margin-top: 10px;
    line-height: 1;
  }
  .rest-alarm-dismiss {
    margin-top: 28px; padding: 18px 48px;
    border-radius: 16px; border: none;
    background: #3b82f6; color: #fff;
    font-family: "DM Sans", sans-serif;
    font-size: 18px; font-weight: 900; cursor: pointer;
    min-width: 260px;
    box-shadow: 0 4px 20px rgba(59,130,246,0.5);
  }

  /* Auto-follow toggle button */
  #fmFollowBtn {
    position:absolute;
    right: calc(14px + env(safe-area-inset-right,0px));
    bottom: 360px; z-index:10;
    width:44px; height:44px; border-radius:50%; border:none;
    background:rgba(15,23,42,0.88); backdrop-filter:blur(8px);
    color:#fff; font-size:20px; cursor:pointer;
    box-shadow:0 2px 12px rgba(0,0,0,.4);
    display:none; align-items:center; justify-content:center;
    transition:background .2s;
  }
  #fmFollowBtn.active { background:#10b981; box-shadow:0 2px 12px rgba(16,185,129,.5); }
  #fmFollowBtn.visible { display:flex; }
</style>

<style id="fmHudCompactStyles">
  /* Compact HUD: only keep the 4 round stats */
  #fmHud.compact{
    background: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    border-top: none !important;
    box-shadow: none !important;
    padding: 10px 10px calc(16px + env(safe-area-inset-bottom, 0px)) !important;
  }
  #fmHud.compact .fm-hide{ display:none !important; }

  #fmHud.compact .fm-stats-row{
    display:flex !important;
    gap: 10px !important;
    justify-content: space-between !important;
    margin: 0 !important;
  }

  #fmHud.compact .fm-stat{
    width: 76px !important;
    height: 76px !important;
    border-radius: 999px !important;
    padding: 10px !important;
    background: rgba(10,16,30,0.92) !important;
    border: 1px solid rgba(255,255,255,0.10) !important;
    box-shadow: 0 6px 22px rgba(0,0,0,0.55) !important;
    display:flex !important;
    flex-direction:column !important;
    align-items:center !important;
    justify-content:center !important;
    text-align:center !important;
    transform: translateZ(0);
    transition: transform .16s cubic-bezier(.34,1.56,.64,1), filter .16s;
    touch-action: manipulation;
    user-select:none;
    cursor:pointer;
  }
  #fmHud.compact .fm-stat:active{
    transform: scale(1.22);
    filter: brightness(1.08);
  }
  #fmHud.compact .fm-stat.fm-pop{
    animation: fmPop .22s cubic-bezier(.34,1.56,.64,1);
  }
  @keyframes fmPop{
    0%{transform:scale(1)}
    60%{transform:scale(1.25)}
    100%{transform:scale(1)}
  }
  #fmHud.compact .fm-stat > div:first-child{
    font-size: 9px !important;
    margin-bottom: 4px !important;
  }
  #fmHud.compact .fm-stat > div:last-child{
    font-size: 18px !important;
  }
</style>

</head>

<body>
<div class="bg-icons" aria-hidden="true">
  <span style="top:4%;left:3%;font-size:58px;opacity:.10">ğŸš›</span>
  <span style="top:12%;right:8%;font-size:44px;opacity:.08">â°</span>
  <span style="top:24%;left:10%;font-size:36px;opacity:.08">ğŸ•</span>
  <span style="top:28%;right:14%;font-size:62px;opacity:.07">ğŸšš</span>
  <span style="top:42%;left:4%;font-size:46px;opacity:.07">â±ï¸</span>
  <span style="top:54%;right:4%;font-size:64px;opacity:.08">ğŸš›</span>
  <span style="top:66%;left:14%;font-size:42px;opacity:.07">ğŸ•’</span>
  <span style="top:78%;right:12%;font-size:38px;opacity:.08">â°</span>
  <span style="top:84%;left:6%;font-size:60px;opacity:.09">ğŸšš</span>
  <span style="top:88%;right:24%;font-size:34px;opacity:.07">ğŸ•™</span>
</div>

<div class="App" data-scroll>
  <!-- TAB BAR -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="plan">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span id="tabLblPlan">Plan Route</span>
    </button>
    <button class="tab-btn" data-tab="drives">
      <svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13" rx="2"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
      <span id="tabLblDrives">All Drives</span>
    </button>
    <button class="tab-btn" data-tab="summary">
      <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      <span id="tabLblSummary">Summaries</span>
    </button>
    <button class="tab-btn" data-tab="settings">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      <span id="tabLblSettings">Settings</span>
    </button>
  </div>

  <!-- PLAN PAGE -->
  <div class="page active" id="page-plan">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">ğŸš› <span>HOS Tracker</span></div>
          <div class="row">
            <button class="iconbtn" id="themeToggle" title="Theme">ğŸŒ™</button>
            <button class="iconbtn" id="gpsBtn" title="GPS" style="font-size:16px">ğŸ“</button>
            <div class="menu-wrap">
              <button class="iconbtn" id="menuBtn">âš™ï¸</button>
              <div class="menu-panel" id="menuPanel">
                <div class="menu-title" id="menuTitle">Settings</div>
                <div class="menu-group">
                  <label class="menu-label" id="menuLangLbl">Language</label>
                  <select class="menu-select" id="langSelect">
                    <option value="en">English</option>
                    <option value="es">EspaÃ±ol</option>
                  </select>
                </div>
                <div class="menu-group">
                  <label class="menu-label" id="menuThemeLbl">Theme</label>
                  <div class="menu-row">
                    <button class="chip-btn active" id="lightBtn">â˜€ï¸ Light</button>
                    <button class="chip-btn" id="darkBtn">ğŸŒ™ Dark</button>
                  </div>
                </div>
                <div class="menu-group">
                  <label class="menu-label" id="menuCountryLbl">Country</label>
                  <select class="menu-select" id="countrySelectMenu"></select>
                </div>
              </div>
</div>
          </div>
        </div>
        <div class="subtitle" id="subtitleTxt">DOT Hours of Service Planner</div>
        <div style="font-size:9px;color:var(--muted);font-weight:600;letter-spacing:1px;margin-top:2px">by <span style="font-family:'Bebas Neue',sans-serif;font-size:11px;letter-spacing:1.5px;color:var(--accent)">fab-visualâ„¢</span></div>
      </div>

      <!-- MINI MAP -->
      <div class="card" id="miniMapCard" style="display:none">
        <div class="row between">
          <div style="font-weight:800">ğŸ—ºï¸ <span id="routeMapLbl">Route Map</span></div>
          <button class="smallbtn" id="fullMapBtn">View Full Map</button>
        </div>
        <div class="hint" id="roadHintTxt">Real road route when available</div>
        <div class="hint" id="routeSourceTxt"></div>
        <div class="mapbox" id="miniMap"></div>
        <!-- POI legend under mini-map -->
        <div class="poi-legend-bar" id="miniPoiLegend" style="display:none">
          <div class="poi-badge truck poi-loading" id="miniBadgeTruck" onclick="toggleMiniPOI('truck')">
            ğŸš› Truck Stops <span class="poi-cnt" id="miniTruckCnt">â€¦</span>
          </div>
          <div class="poi-badge rest poi-loading" id="miniBadgeRest" onclick="toggleMiniPOI('rest')">
            ğŸ˜´ Rest Areas <span class="poi-cnt" id="miniRestCnt">â€¦</span>
          </div>
          <div class="poi-badge restrict poi-loading" id="miniBadgeRestrict" onclick="toggleMiniPOI('restrict')">
            ğŸš« Restricciones <span class="poi-cnt" id="miniRestrictCnt">â€¦</span>
          </div>
        </div>
      </div>

      <!-- FORM -->
      <div class="card">
        <div class="info" id="infoTxt">ğŸ’¡ Type city name to search globally</div>

        <label id="lblFrom">ğŸ“ Origin</label>
        <div class="inputwrap">
          <input id="originInput" placeholder="Miami, FL" autocomplete="off" />
          <div class="suggestions" id="originSugg" style="display:none"></div>
        </div>

        <label id="lblTo">ğŸ¯ Destination</label>
        <div class="inputwrap">
          <input id="destInput" placeholder="Dallas, TX" autocomplete="off" />
          <div class="suggestions" id="destSugg" style="display:none"></div>
        </div>

        <div class="grid3" style="margin-top:10px">
          <div>
            <label id="lblTime">ğŸ• Departure</label>
            <input type="datetime-local" id="departureInput" />
          </div>
          <div>
            <label id="lblHours">â±ï¸ Hours Left</label>
            <input type="number" id="hoursInput" min="1" max="70" value="70" />
          </div>
          <div>
            <label id="lblSpeed">ğŸš€ Speed (mph)</label>
            <input type="number" id="speedInput" min="1" value="60" />
          </div>
        </div>

        <div class="error" id="errorBox" style="display:none"></div>

        <button class="btn btn-primary" id="calcBtn" style="margin-top:12px">ğŸš› Calculate Route</button>

        <div class="grid2" id="shareTrackBtns" style="display:none;margin-top:10px">
          <button class="btn btn-blue" id="shareBtn">ğŸ“¤ Share Route</button>
          <button class="btn btn-purple" id="trackBtn">ğŸ“ Start Live Tracking</button>
        </div>
      </div>

      <!-- RESULTS -->
      <div class="card results" id="resultsCard" style="display:none">
        <div class="pill" id="timeVsHours"></div>
        <div class="big" id="distanceBig"></div>
        <div class="grid2">
          <div class="kv"><div class="k" id="fromLbl">FROM</div><div class="v" id="fromVal"></div></div>
          <div class="kv"><div class="k" id="toLbl">TO</div><div class="v" id="toVal"></div></div>
        </div>
        <div class="grid2">
          <div class="kv"><div class="k" id="departureLbl">DEPARTURE</div><div class="v" id="departureVal"></div></div>
          <div class="kv"><div class="k" id="arrivalLbl">ARRIVAL</div><div class="v" id="arrivalVal"></div></div>
        </div>
        <div class="kv"><div class="k" id="totalTimeLbl">TOTAL TIME</div><div class="v" id="totalTimeVal"></div></div>
        <div class="schedule" id="scheduleList"></div>
        <button class="btn btn-red" id="resetBtn">ğŸ”„ New Route</button>
      </div>
    </div>
  </div>

  <!-- DRIVES PAGE -->
  <div class="page" id="page-drives">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">ğŸš› <span id="drivesTitleTxt">All Drives</span></div>
        </div>
      </div>
      <div class="drives-tabs">
        <button class="drives-tab" id="drivesTabBtn">Business <span id="drivesCount">0</span></button>
      </div>
      <div id="drivesList"></div>
    </div>
  </div>

  <!-- SUMMARY PAGE -->
  <div class="page" id="page-summary">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">ğŸš› <span id="summaryTitleTxt">Summaries</span></div>
        </div>
      </div>
      <div class="card" style="text-align:center">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px">
          <div>
            <div style="font-size:28px;font-weight:900" id="sumDrives">0</div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="sumDrivesLbl">Drives</div>
          </div>
          <div>
            <div style="font-size:28px;font-weight:900;color:var(--muted)" id="sumMiles">0</div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="sumMilesLbl">Miles</div>
          </div>
          <div>
            <div style="font-size:28px;font-weight:900;color:var(--accent)" id="sumValue">$0</div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="sumValueLbl">Logged</div>
          </div>
        </div>
        <div style="font-size:48px;margin:16px 0">ğŸš›</div>
        <div style="font-size:16px;font-weight:700;margin-bottom:8px" id="sumStatus">No routes yet</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:16px" id="sumDesc">Plan a route to see your summary here.</div>
        <button class="btn btn-primary" id="sendReportBtn" style="display:none">ğŸ“¤ Send Report</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS PAGE -->
  <div class="page" id="page-settings">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">âš™ï¸ <span id="settTitleTxt">Settings</span></div>
        </div>
      </div>

      <div class="sett-section">
        <div class="sett-section-title" id="settSecGeneral">General</div>
        <div class="sett-group">
          <div class="sett-row" id="langRow">
            <div class="sett-icon" style="background:#dbeafe">ğŸ—£ï¸</div>
            <div class="sett-label" id="settLangRow">Language</div>
            <div class="sett-value" id="langVal">English</div>
            <span class="sett-arrow">â€º</span>
          </div>
          <div class="sett-row" id="countryRow">
            <div class="sett-icon" style="background:#d1fae5">ğŸŒ</div>
            <div class="sett-label" id="settCountryRow">Country Filter</div>
            <div class="sett-value" id="countryVal">All</div>
            <span class="sett-arrow">â€º</span>
          </div>
        </div>
      </div>

      <div class="sett-section" id="langPanel" style="display:none">
        <div class="sett-section-title">Language / Idioma</div>
        <div class="sett-group">
          <div class="sett-row" id="setLangEn">
            <div class="sett-icon">ğŸ‡ºğŸ‡¸</div>
            <div class="sett-label">English</div>
            <span class="sett-check" id="checkEn">âœ“</span>
          </div>
          <div class="sett-row" id="setLangEs">
            <div class="sett-icon">ğŸ‡ªğŸ‡¸</div>
            <div class="sett-label">EspaÃ±ol</div>
            <span class="sett-check" id="checkEs" style="opacity:0">âœ“</span>
          </div>
        </div>
      </div>

      <div class="sett-section" id="countryPanel" style="display:none">
        <div class="sett-section-title" id="settCountryRowTitle">Country Filter</div>
        <div class="sett-group" style="margin:0 14px">
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#d1fae5">ğŸŒ</div>
            <select id="countrySelectSettings" style="flex:1;border:none;background:transparent;font-size:15px;color:var(--text);outline:none;cursor:pointer;padding:4px 0;font-family:'DM Sans',sans-serif"></select>
          </div>
        </div>
      </div>
  <div class="sett-section">
    <div class="sett-section-title" id="settSecTruckIcon">Truck Icon</div>
    <div class="sett-group" style="padding:14px 14px 10px">
      <div style="font-weight:900;font-size:14px;margin-bottom:6px" id="truckIconTitle">Truck marker icon</div>
      <div style="font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:10px" id="truckIconDesc">
        Choose an icon or upload your own photo. This changes the truck marker on the route map.
      </div>

      <label style="margin-top:0" id="truckPickerLbl">Choose</label>
      <select class="menu-select" id="truckIconSelect" style="width:100%;margin-top:6px">
        <option value="emoji:ğŸš›">ğŸš› Classic</option>
        <option value="emoji:ğŸšš">ğŸšš Delivery</option>
        <option value="emoji:ğŸ›»">ğŸ›» Pickup</option>
        <option value="emoji:ğŸš">ğŸš Van</option>
        <option value="emoji:ğŸš’">ğŸš’ Fire</option>
        <option value="emoji:ğŸšŒ">ğŸšŒ Bus</option>
        <option value="img:https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f69b.png">ğŸ–¼ï¸ Truck image</option>
      </select>

      <label id="truckUploadLbl">Upload photo</label>
      <input type="file" id="truckUpload" accept="image/*"
        style="margin-top:6px;width:100%;padding:10px;border:1.5px dashed var(--border);border-radius:10px;background:var(--bg);color:var(--text)"
      />

      <div style="margin-top:10px;display:flex;align-items:center;gap:10px">
        <div style="font-weight:800;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="truckPreviewLbl">Preview</div>
        <div id="truckPreview" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:12px;border:1px solid var(--border);background:var(--surface)"></div>
        <button class="chip-btn" id="truckResetBtn" style="padding:10px 10px">Reset</button>
      </div>
    </div>
  </div>



      <div class="sett-section">
        <div class="sett-section-title" id="settSecAppear">Appearance</div>
        <div class="sett-group">
          <div class="sett-row" id="lightModeRow">
            <div class="sett-icon" style="background:#fef9c3">â˜€ï¸</div>
            <div class="sett-label" id="settLightRow">Light Mode</div>
            <span class="sett-check" id="checkLight">âœ“</span>
          </div>
          <div class="sett-row" id="darkModeRow">
            <div class="sett-icon" style="background:#1e293b">ğŸŒ™</div>
            <div class="sett-label" id="settDarkRow">Dark Mode</div>
            <span class="sett-check" id="checkDark" style="opacity:0">âœ“</span>
          </div>
        </div>
      </div>

      <div class="sett-section">
        <div class="sett-section-title" id="settSecHOS">HOS Rules</div>
        <div class="sett-group">
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#fee2e2">ğŸš¦</div>
            <div class="sett-label" id="settSpeedLimitRow">Default Speed Limit</div>
            <div style="display:flex;align-items:center;gap:6px">
              <input type="number" id="defaultSpeedInput" min="20" max="85" value="60" style="width:64px;padding:5px 8px;font-size:14px;font-weight:700;text-align:center;border-radius:8px;border:1.5px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif" />
              <span style="font-size:12px;color:var(--muted);font-weight:600">mph</span>
            </div>
          </div>
          <div class="sett-row">
            <div class="sett-icon" style="background:#fef3c7">â˜•</div>
            <div class="sett-label" id="settBreakRow">30-min Break Rule</div>
            <button class="sett-toggle on" id="breakToggle"></button>
          </div>
          <div class="sett-row">
            <div class="sett-icon" style="background:#d1fae5">â±ï¸</div>
            <div class="sett-label" id="settCycleRow">Cycle Hours</div>
            <div class="sett-value">70 hrs DOT</div>
          </div>
          <div class="sett-row">
            <div class="sett-icon" style="background:#dbeafe">ğŸ˜´</div>
            <div class="sett-label" id="settRestRow">Rest Requirement</div>
            <div class="sett-value">10 hrs DOT</div>
          </div>
        </div>
      </div>

      <!-- SAFETY FEATURES SECTION -->
      <div class="sett-section">
        <div class="sett-section-title">ğŸ›¡ï¸ Safety Features</div>
        <div class="sett-group">

          <!-- Fatigue Detector -->
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#fce7f3">ğŸ˜´</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">Fatigue Detector</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px" id="fatigueStatusTxt">Camera off</div>
            </div>
            <button class="sett-toggle" id="fatigueToggle"></button>
          </div>

          <!-- Weather Alerts -->
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#e0f2fe">â›ˆï¸</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">Weather Alerts</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px" id="weatherStatusTxt">Off</div>
            </div>
            <button class="sett-toggle" id="weatherToggle"></button>
          </div>

          <!-- Bridge Detector -->
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#fef3c7">ğŸŒ‰</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">Low Bridge Detector</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px" id="bridgeStatusTxt">Off â€” set trailer height</div>
            </div>
            <button class="sett-toggle" id="bridgeToggle"></button>
          </div>

          <!-- Trailer height input (visible when bridge toggle is ON) -->
          <div id="trailerHeightRow" class="sett-row" style="cursor:default;display:none;background:var(--surface2)">
            <div class="sett-icon" style="background:#fef3c7">ğŸ“</div>
            <div class="sett-label" style="font-size:14px">Trailer Height</div>
            <div style="display:flex;align-items:center;gap:6px">
              <input type="number" id="trailerHeightInput" min="8" max="18" step="0.1" value="13.6"
                style="width:70px;padding:6px 8px;font-size:15px;font-weight:700;text-align:center;
                       border-radius:8px;border:1.5px solid var(--border);background:var(--bg);
                       color:var(--text);font-family:'DM Sans',sans-serif" />
              <span style="font-size:12px;color:var(--muted);font-weight:700">ft</span>
            </div>
          </div>

          <!-- â”€â”€â”€ INCIDENT REPORTS (inside same Safety group) â”€â”€â”€ -->
          <div style="padding:12px 16px 6px;border-top:1px solid var(--border)">
            <div style="font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">ğŸš¨ Reportar Incidentes</div>
            <div style="font-size:11px;color:var(--muted);font-weight:600;margin-bottom:12px;line-height:1.4">
              Activa el tipo de incidente que quieras reportar. Aparece como Ã­cono en el mapa al activarlo.
            </div>

            <!-- Incident toggles grid -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">

              <!-- Police -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#dbeafe;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸš”</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">PolicÃ­a</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incPoliceStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incPoliceToggle" onclick="toggleIncidentType('police',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Accident -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#fee2e2;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸ’¥</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">Accidente</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incAccidentStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incAccidentToggle" onclick="toggleIncidentType('accident',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Traffic -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#fef3c7;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸš¦</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">TrÃ¡fico</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incTrafficStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incTrafficToggle" onclick="toggleIncidentType('traffic',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Hazard -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#ffedd5;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">âš ï¸</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">Peligro</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incHazardStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incHazardToggle" onclick="toggleIncidentType('hazard',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Construction -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#fef9c3;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸš§</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">ConstrucciÃ³n</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incConstructionStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incConstructionToggle" onclick="toggleIncidentType('construction',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

              <!-- Closure -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
                <div style="width:32px;height:32px;border-radius:50%;background:#fee2e2;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸ›‘</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:700;color:var(--text)">VÃ­a Cerrada</div>
                  <div style="font-size:9px;color:var(--muted);font-weight:600;margin-top:1px" id="incClosureStatus">Off</div>
                </div>
                <button class="sett-toggle" id="incClosureToggle" onclick="toggleIncidentType('closure',this)" style="transform:scale(0.85);flex-shrink:0"></button>
              </div>

            </div>

            <!-- Active incident mini icons -->
            <div id="activeIncidentIcons" style="display:none;padding:8px 0 4px">
              <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Activos:</div>
              <div id="activeIconsRow" style="display:flex;gap:6px;flex-wrap:wrap"></div>
            </div>

          </div>

        </div><!-- end sett-group -->
      </div><!-- end safety sett-section -->

      <!-- EMERGENCY CONTACT SECTION -->
      <div class="sett-section">
        <div class="sett-section-title">ğŸ†˜ Contacto de Emergencia</div>
        <div class="sett-group">
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#fee2e2">ğŸ‘¤</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">Nombre</div>
              <input id="sosContactInput" type="text" placeholder="Ej: Maria GarcÃ­a"
                style="margin-top:4px;width:100%;padding:8px 10px;font-size:14px;
                       border-radius:8px;border:1.5px solid var(--border);
                       background:var(--surface2);color:var(--text);
                       font-family:'DM Sans',sans-serif;font-weight:600"
                oninput="saveSosContact()" />
            </div>
          </div>
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#fee2e2">ğŸ“</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">TelÃ©fono</div>
              <input id="sosPhoneInput" type="tel" placeholder="Ej: +1 305 555 0123"
                style="margin-top:4px;width:100%;padding:8px 10px;font-size:14px;
                       border-radius:8px;border:1.5px solid var(--border);
                       background:var(--surface2);color:var(--text);
                       font-family:'DM Sans',sans-serif;font-weight:600"
                oninput="saveSosContact()" />
            </div>
          </div>
          <div class="sett-row" style="cursor:default;background:rgba(239,68,68,.05)">
            <div class="sett-icon" style="background:#fee2e2">ğŸ†˜</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0;color:#ef4444">BotÃ³n SOS</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px">Aparece en el mapa al rastrear</div>
            </div>
            <button class="sett-toggle on" id="sosToggle" onclick="toggleSosBtn(this)"></button>
          </div>
        </div>
      </div>

      <!-- FUEL FINDER SECTION -->
      <div class="sett-section">
        <div class="sett-section-title">â›½ Gasolina Barata en Ruta</div>
        <div class="sett-group">
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#d1fae5">â›½</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">Buscar Diesel Barato</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px" id="fuelStatusTxt">Activo durante rastreo</div>
            </div>
            <button class="sett-toggle on" id="fuelToggle" onclick="toggleFuelFinder(this)"></button>
          </div>
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#d1fae5">ğŸ›£ï¸</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">LÃ­mite de Velocidad</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px" id="speedLimitStatusTxt">Muestra lÃ­mite por estado</div>
            </div>
            <button class="sett-toggle on" id="speedLimitToggle" onclick="toggleSpeedLimit(this)"></button>
          </div>
        </div>
      </div>

      
  <div class="sett-section">
    <div class="sett-section-title" id="settSecSpeedWidget">Speed Widget</div>
    <div class="sett-group" style="padding:14px 14px 10px">
      <div style="font-weight:900;font-size:14px;margin-bottom:6px" id="speedWidgetTitle">Speed Limit Widget</div>
      <div style="font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:10px" id="speedWidgetDesc">
        Drag the speed widget to place it. This is saved automatically.
      </div>

      <div id="speedWidgetStage" style="
        position:relative;
        height:190px;
        border:1.5px dashed var(--border);
        border-radius:14px;
        background:var(--bg);
        overflow:hidden;
      ">
        <div id="speedLimitWidget" class="visible">
          <div class="sl-sign" id="slSign">
            <div class="sl-num" id="slNum">65</div>
          </div>
          <div class="sl-state" id="slState">--</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="chip-btn" id="speedWidgetResetBtn" style="flex:1">Reset Position</button>
        <button class="chip-btn" id="speedWidgetCenterBtn" style="flex:1">Center</button>
      </div>
    </div>
  </div>


<div class="sett-section">
  <div class="sett-section-title">ğŸ“ BÃºsqueda Cercana</div>
  <div class="sett-group" style="padding:14px 16px">
    <!-- Filter checkboxes -->
    <div style="font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:10px">Buscar cerca de mi ubicaciÃ³n</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px" id="nearbyFilterRow">
      <label class="nearby-chip" id="nearbyChipTruck">
        <input type="checkbox" id="nearbyTruck" checked onchange="runNearbySearch()"> ğŸš› Truck Stops
      </label>
      <label class="nearby-chip" id="nearbyChipRest">
        <input type="checkbox" id="nearbyRest" checked onchange="runNearbySearch()"> ğŸ˜´ Rest Areas
      </label>
      <label class="nearby-chip" id="nearbyChipScale">
        <input type="checkbox" id="nearbyScale" onchange="runNearbySearch()"> âš–ï¸ Scales
      </label>
    </div>

    <!-- Search button -->
    <button onclick="runNearbySearch()" id="nearbySearchBtn" style="
      width:100%;padding:12px;border-radius:12px;border:none;
      background:linear-gradient(135deg,#10b981,#3b82f6);
      color:#fff;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:800;
      cursor:pointer;margin-bottom:14px;
      box-shadow:0 4px 16px rgba(16,185,129,0.3);
      touch-action:manipulation;
    ">ğŸ” Buscar Ahora</button>

    <!-- Results list -->
    <div id="nearbyResultsList" style="display:none">
      <div style="font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:8px" id="nearbyResultsTitle">Resultados cercanos</div>
      <div id="nearbyResultsItems"></div>
    </div>

    <!-- Loading / status -->
    <div id="nearbyStatus" style="text-align:center;color:var(--muted);font-size:12px;padding:8px 0;display:none">
      ğŸ“¡ Obteniendo ubicaciÃ³n...
    </div>
  </div>
</div>

<div class="sett-section">
  <div class="sett-section-title">â­ SuscripciÃ³n</div>
  <div class="sett-group" style="padding:0">

    <!-- Current plan badge -->
    <div style="
      margin:14px 16px 10px;
      background:linear-gradient(135deg,#1e3a5f,#0f172a);
      border-radius:14px;padding:16px;
      border:1px solid rgba(99,179,237,.3);
      position:relative;overflow:hidden;
    ">
      <div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:.07">ğŸš›</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div style="font-size:26px">ğŸ†“</div>
        <div>
          <div style="font-size:14px;font-weight:900;color:#f1f5f9">Plan Gratuito</div>
          <div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:1px">Funciones bÃ¡sicas activas</div>
        </div>
        <div style="
          margin-left:auto;
          background:rgba(16,185,129,.2);
          border:1px solid rgba(16,185,129,.4);
          color:#10b981;font-size:10px;font-weight:900;
          padding:3px 9px;border-radius:999px;letter-spacing:.4px;
        ">ACTIVO</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:4px">
        <div style="background:rgba(255,255,255,.05);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.7)">âœ… PlanificaciÃ³n HOS</div>
        <div style="background:rgba(255,255,255,.05);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.7)">âœ… Mapa GPS</div>
        <div style="background:rgba(255,255,255,.05);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.7)">âœ… Alertas bÃ¡sicas</div>
        <div style="background:rgba(255,255,255,.05);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.5)">ğŸ”’ Sin anuncios</div>
      </div>
    </div>

    <!-- Pro plan -->
    <div style="
      margin:0 16px 14px;
      background:linear-gradient(135deg,#7c3aed,#4f46e5);
      border-radius:14px;padding:16px;
      border:1px solid rgba(167,139,250,.4);
      position:relative;overflow:hidden;cursor:pointer;
    " onclick="showSubscribeModal()">
      <div style="position:absolute;top:-15px;right:-15px;font-size:70px;opacity:.1">â­</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <div style="font-size:26px">â­</div>
        <div>
          <div style="font-size:15px;font-weight:900;color:#fff">HOS Tracker Pro</div>
          <div style="font-size:11px;color:rgba(255,255,255,.6);margin-top:1px">Todo lo que necesitas en ruta</div>
        </div>
        <div style="
          margin-left:auto;
          background:rgba(255,255,255,.15);
          color:#fff;font-size:12px;font-weight:900;
          padding:4px 12px;border-radius:999px;
        ">$9.99/mes</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px">
        <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.9)">â­ Sin anuncios</div>
        <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.9)">â­ Rutas ilimitadas</div>
        <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.9)">â­ Alertas avanzadas</div>
        <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.9)">â­ Soporte 24/7</div>
        <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.9)">â­ Historial 90 dÃ­as</div>
        <div style="background:rgba(255,255,255,.1);border-radius:8px;padding:7px 10px;font-size:11px;color:rgba(255,255,255,.9)">â­ Clima en tiempo real</div>
      </div>
      <button onclick="showSubscribeModal()" style="
        width:100%;padding:11px;border-radius:10px;border:none;
        background:rgba(255,255,255,.95);
        color:#4f46e5;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:900;
        cursor:pointer;letter-spacing:.2px;
        box-shadow:0 4px 14px rgba(0,0,0,.25);
      ">ğŸš€ Suscribirse a Pro</button>
      <div style="text-align:center;font-size:10px;color:rgba(255,255,255,.5);margin-top:8px">Cancela cuando quieras â€¢ Sin compromisos</div>
    </div>

  </div>
</div>

<div class="sett-section">
        <div class="sett-section-title" id="settSecAbout">About</div>
        <div class="sett-group">
          <div class="sett-row">
            <div class="sett-icon" style="background:#d1fae5">ğŸš›</div>
            <div style="flex:1">
              <div class="sett-label" style="margin:0">HOS Tracker</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px">DOT Hours of Service Planner</div>
            </div>
            <div class="sett-value">v6.0</div>
          </div>
          <div class="sett-row" id="shareAppRow">
            <div class="sett-icon" style="background:#dbeafe">ğŸ“¤</div>
            <div class="sett-label" id="settShareRow">Share App</div>
            <span class="sett-arrow">â€º</span>
          </div>
        </div>
      </div>

      <!-- fab-visual trademark footer -->
      <div style="text-align:center;padding:12px 0 4px">
        <div style="font-size:10px;color:var(--muted);font-weight:600;letter-spacing:.8px;text-transform:uppercase">Powered by</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--accent);margin-top:2px">fab-visualâ„¢</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px;font-weight:500">Â© 2025 fab-visual. All rights reserved.</div>
      </div>

      <div style="height:20px"></div>
    </div>
  </div>
</div>

<!-- ============================================================
     FULLSCREEN MAP VIEW  (Google Maps style)
     ============================================================ -->
<div id="fullMapScreen" style="
  display:none; position:fixed; inset:0; z-index:500;
  background:#000; flex-direction:column;
">
  <!-- MAP fills entire screen -->
  <div id="fullMap" style="position:absolute;inset:0;z-index:1"></div>

  <!-- MAP SPEED LIMIT SIGN -->
  <div id="mapSpeedSign">

  <!-- QUICK REPORT FAB -->
  <button id="reportFab" onclick="toggleReportSheet()" title="Reportar incidente">âš ï¸</button>

  <!-- QUICK REPORT ACTION SHEET -->
  <div id="reportSheet">
    <button class="rs-btn" onclick="quickReport('police','ğŸš”','PolicÃ­a')">
      <div class="rs-icon" style="background:#1d3a8a">ğŸš”</div>
      <span class="rs-label">PolicÃ­a</span>
    </button>
    <button class="rs-btn" onclick="quickReport('accident','ğŸš—','Accidente')">
      <div class="rs-icon" style="background:#7f1d1d">ğŸ’¥</div>
      <span class="rs-label">Accidente</span>
    </button>
    <button class="rs-btn" onclick="quickReport('hazard','âš ï¸','Peligro en vÃ­a')">
      <div class="rs-icon" style="background:#7c2d12">âš ï¸</div>
      <span class="rs-label">Peligro en vÃ­a</span>
    </button>
    <button class="rs-btn" onclick="quickReport('traffic','ğŸš¦','TrÃ¡fico lento')">
      <div class="rs-icon" style="background:#78350f">ğŸš¦</div>
      <span class="rs-label">TrÃ¡fico lento</span>
    </button>
    <button class="rs-btn" onclick="quickReport('construction','ğŸš§','ConstrucciÃ³n')">
      <div class="rs-icon" style="background:#713f12">ğŸš§</div>
      <span class="rs-label">ConstrucciÃ³n</span>
    </button>
    <button class="rs-btn" onclick="quickReport('closure','ğŸš«','VÃ­a cerrada')">
      <div class="rs-icon" style="background:#450a0a">ğŸš«</div>
      <span class="rs-label">VÃ­a cerrada</span>
    </button>
  </div>
    <div class="mss-sign" id="mssSign">
      <div class="mss-top">SPEED&#10;LIMIT</div>
      <div class="mss-num" id="mssNum">65</div>
      <div class="mss-truck-label">TRUCKS</div>
    </div>
    <div class="mss-post"></div>
    <div class="mss-state-badge" id="mssState">-- STATE</div>
    <div class="mss-diff" id="mssDiff"></div>
  </div>

  <!-- TOP BAR -->
  <div style="
    position:absolute;top:0;left:0;right:0;z-index:10;
    padding-top:calc(10px + env(safe-area-inset-top, 0px));
    padding-left:calc(10px + env(safe-area-inset-left, 0px));
    padding-right:calc(10px + env(safe-area-inset-right, 0px));
    pointer-events:none;
    display:flex; align-items:flex-start; justify-content:space-between;
  ">

  <!-- POI Filter chips - hidden, POIs load automatically by default -->
  <div id="poiLegend" style="display:none!important">
    <div class="poi-chip" id="chipScale"    onclick="togglePOI('scale')">âš–ï¸ Scales</div>
    <div class="poi-chip" id="chipTruck"    onclick="togglePOI('truck')">ğŸš› Truck Stops</div>
    <div class="poi-chip" id="chipRest"     onclick="togglePOI('rest')">ğŸ˜´ Rest Areas</div>
    <div class="poi-chip" id="chipReport"   onclick="togglePOI('reports')">ğŸš¨ Reports</div>
    <div class="poi-chip" id="chipRestrict" onclick="togglePOI('restrict')">ğŸš« Restrictions</div>
  </div>

  <!-- Auto-follow button -->
  <button id="fmFollowBtn" class="visible active" title="Auto-follow truck" onclick="toggleFollow()">ğŸ¯</button>

  <!-- Custom zoom buttons -->
  <div class="fm-zoom-btns">
    <button class="fm-zoom-btn" onclick="fmMapInst && fmMapInst.zoomIn()">+</button>
    <button class="fm-zoom-btn" onclick="fmMapInst && fmMapInst.zoomOut()">âˆ’</button>
  </div>

    <!-- LEFT: close + weather + SOS -->
    <div style="display:flex;flex-direction:column;align-items:flex-start;gap:7px;pointer-events:all">

      <!-- Close button -->
      <button id="closeFullMap" style="
        width:40px;height:40px;border-radius:50%;border:none;
        background:rgba(15,23,42,0.85);backdrop-filter:blur(8px);
        color:#fff;font-size:20px;cursor:pointer;
        display:flex;align-items:center;justify-content:center;
        box-shadow:0 2px 12px rgba(0,0,0,0.4);
        -webkit-tap-highlight-color:transparent;
        touch-action:manipulation;
      ">â†</button>

      <!-- Weather compact card -->
      <div id="weatherWidget" onclick="showWeatherDetail()">
        <div class="wx-row">
          <div class="wx-icon" id="wxIcon">ğŸŒ¤ï¸</div>
          <div class="wx-temp" id="wxTemp">--Â°</div>
        </div>
        <div class="wx-desc" id="wxDesc">Clima</div>
      </div>

      <!-- SOS button â€” below weather -->
      <button id="sosFab" onclick="triggerSOS()" style="pointer-events:all">SOS</button>
    </div>

    <!-- CENTER: clock + report buttons row -->
    <div style="
      pointer-events:none;
      display:flex;flex-direction:column;align-items:center;gap:6px;
      margin-top:2px;
    ">

      <!-- Clock pill -->
      <div style="
        background:rgba(15,23,42,0.85);backdrop-filter:blur(8px);
        border-radius:10px;padding:6px 12px;
        display:flex;flex-direction:column;align-items:center;
        box-shadow:0 2px 10px rgba(0,0,0,0.3);
      ">
        <div style="display:flex;align-items:center;gap:5px">
          <div id="fmLiveDot" style="width:6px;height:6px;border-radius:50%;background:#6b7280;flex-shrink:0"></div>
          <span id="fmClockTxt" style="font-size:13px;font-weight:700;color:#f1f5f9;white-space:nowrap">--:-- --</span>
        </div>
        <span id="fmDateTxt" style="font-size:10px;color:rgba(255,255,255,0.45);white-space:nowrap;margin-top:1px">---</span>
      </div>

      <!-- Quick report round buttons â€” 3 types -->
      <div id="topReportBtns" style="
        display:none;
        align-items:center;gap:8px;
        pointer-events:all;
      ">
        <button class="top-rpt-btn" style="background:#1d3a8a" onclick="quickReport('police','ğŸš”','PolicÃ­a')"       title="PolicÃ­a">ğŸš”</button>
        <button class="top-rpt-btn" style="background:#7f1d1d" onclick="quickReport('accident','ğŸ’¥','Accidente')"   title="Accidente">ğŸ’¥</button>
        <button class="top-rpt-btn" style="background:#4b5320" onclick="quickReport('inspection','ğŸ”','InspecciÃ³n')" title="InspecciÃ³n">ğŸ”</button>
      </div>

    </div>

    <!-- RIGHT: spacer (speed sign is absolute top-right via CSS) -->
    <div style="width:40px"></div>
  </div>

  <!-- CONFIRM TRACKING BANNER (shows when map opens, before tracking starts) -->
  <div id="fmTrackBanner" style="
    position:absolute;
    top:calc(80px + env(safe-area-inset-top, 0px));
    left:calc(14px + env(safe-area-inset-left, 0px));
    right:calc(14px + env(safe-area-inset-right, 0px));
    z-index:10;
    background:rgba(15,23,42,0.92);backdrop-filter:blur(12px);
    border-radius:16px;padding:14px 16px;
    border:1px solid rgba(16,185,129,0.3);
    box-shadow:0 4px 20px rgba(0,0,0,0.5);
  ">
    <div style="font-size:13px;color:rgba(255,255,255,0.8);font-weight:600;margin-bottom:10px;text-align:center" id="fmBannerDesc">
      ğŸ“¡ Â¿Activar seguimiento GPS en vivo?
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button id="fmNoTrack" style="
        padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);
        background:rgba(255,255,255,0.08);color:#f1f5f9;font-family:'DM Sans',sans-serif;
        font-size:13px;font-weight:700;cursor:pointer;
      ">ğŸ—ºï¸ Solo mapa</button>
      <button id="fmYesTrack" style="
        padding:10px;border-radius:10px;border:none;
        background:#10b981;color:#fff;font-family:'DM Sans',sans-serif;
        font-size:13px;font-weight:800;cursor:pointer;
      ">ğŸ“¡ Dar seguimiento</button>
    </div>
  </div>

  <!-- BOTTOM HUD PANEL -->
  <div id="fmHud" data-scroll style="
    position:absolute;bottom:0;left:0;right:0;z-index:10;
    background:rgba(10,16,30,0.92);
    backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border-radius:20px 20px 0 0;
    border-top:1px solid rgba(255,255,255,0.08);
    padding:14px 16px calc(20px + env(safe-area-inset-bottom, 0px));
    color:#f1f5f9;
    box-shadow:0 -4px 30px rgba(0,0,0,0.5);
    transform:translateY(100%);
    transition:transform .4s cubic-bezier(.16,1,.3,1);
  ">
    <!-- Handle -->
    <div style="width:36px;height:4px;background:rgba(255,255,255,0.2);border-radius:999px;margin:0 auto 14px"></div>

    <!-- Route header -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div style="flex:1;min-width:0">
        <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px" id="fmLocLbl">UBICACIÃ“N ACTUAL</div>
        <div style="font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="fmLocVal">Localizando...</div>
      </div>
      <div id="fmStatusChip" style="
        margin-left:10px;padding:4px 10px;border-radius:999px;flex-shrink:0;
        font-size:11px;font-weight:800;
        background:rgba(107,114,128,0.25);color:#9ca3af;
      ">â¸ Detenido</div>
    </div>

    <!-- Progress bar + pct -->
    <div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.4px" id="fmProgLbl">PROGRESO DE RUTA</span>
        <span style="font-size:11px;font-weight:800;color:#10b981" id="fmPct">0%</span>
      </div>
      <div style="height:6px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden">
        <div id="fmBar" style="height:100%;background:linear-gradient(90deg,#10b981,#3b82f6);border-radius:999px;width:0%;transition:width .6s ease"></div>
      </div>
    </div>

    <!-- 4 stats -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:12px">
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fmEtaLbl">LLEGADA</div>
        <div style="font-size:15px;font-weight:900;color:#f59e0b;line-height:1" id="fmEta">--</div>
      </div>
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fmRemLbl">RESTANTE</div>
        <div style="font-size:15px;font-weight:900;color:#3b82f6;line-height:1" id="fmRem">--</div>
      </div>
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fmDriveLbl">MANEJO</div>
        <div style="font-size:15px;font-weight:900;color:#10b981;line-height:1" id="fmDriveLeft">11h</div>
      </div>
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fm70Lbl">70 HRS</div>
        <div style="font-size:15px;font-weight:900;color:#8b5cf6;line-height:1" id="fm70Left">70h</div>
      </div>
    </div>

    <!-- Route from â†’ to -->
    <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:12px">
      <div style="flex:1;min-width:0">
        <div style="font-size:9px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:.4px">DESDE</div>
        <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="fmFrom">--</div>
      </div>
      <div style="font-size:18px;color:rgba(255,255,255,0.25);flex-shrink:0">â†’</div>
      <div style="flex:1;min-width:0;text-align:right">
        <div style="font-size:9px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:.4px">HASTA</div>
        <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;direction:rtl" id="fmTo">--</div>
      </div>
    </div>

    <!-- Stop button (only when tracking) -->
    <button id="fmStopBtn" onclick="fmStopTracking()" style="
      display:none;width:100%;margin-top:12px;padding:14px;
      background:#ef4444;color:#fff;border:none;border-radius:12px;
      font-family:'DM Sans',sans-serif;font-size:16px;font-weight:800;cursor:pointer;
      touch-action:manipulation;-webkit-tap-highlight-color:transparent;
      box-shadow:0 4px 16px rgba(239,68,68,0.4);
    ">ğŸ›‘ Detener Seguimiento</button>
  </div>
</div>

<style>
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }
@keyframes liveblink { 0%,100%{opacity:1} 50%{opacity:.3} }
@keyframes reportPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.25)} }
@keyframes truckGlow { 0%,100%{opacity:.6;transform:scale(1)} 50%{opacity:1;transform:scale(1.15)} }
</style>


<div class="monitor-overlay" id="monitorOverlay">
  <div class="monitor-card">
    <div class="modal-head">
      <div>ğŸ“ <span id="monitorTitle">LIVE TRACKING</span></div>
      <button class="modal-close" id="closeMonitor">Ã—</button>
    </div>
    <div style="padding:12px;overflow:auto" class="stack">
      <div class="kv"><div class="k" id="currentLocLbl">CURRENT LOCATION</div><div class="v" id="currentLocVal">-</div></div>
      <div class="kv">
        <div class="k" id="currentSpeedLbl">CURRENT SPEED</div>
        <div class="v"><span style="font-size:40px;font-weight:900" id="speedVal">0</span> <span class="muted">mph</span></div>
        <div class="muted" id="statusVal">Ready</div>
      </div>
      <div class="kv">
        <div class="k" id="progressLbl">TRIP PROGRESS</div>
        <div class="bar"><div id="progressBar" style="width:0%"></div></div>
        <div class="v" id="progressPct">0%</div>
      </div>
      <div class="grid2">
        <div class="kv"><div class="k" id="traveledLbl">TRAVELED</div><div class="v" id="traveledVal">0 mi</div></div>
        <div class="kv"><div class="k" id="remainingLbl">REMAINING</div><div class="v" id="remainingVal">0 mi</div></div>
      </div>
      <div class="grid2">
        <div class="kv"><div class="k" id="elapsedLbl">ELAPSED</div><div class="v" id="elapsedVal">0h</div></div>
        <div class="kv"><div class="k" id="etaLbl">ETA</div><div class="v" id="etaVal">0h</div></div>
      </div>
      <button class="btn btn-red" id="stopTrackBtn">ğŸ›‘ Stop Tracking</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SAFETY OVERLAYS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Toast notification (shared) -->
<div class="safety-toast" id="safetyToast">
  <div class="toast-icon" id="toastIcon">âš ï¸</div>
  <div class="toast-body">
    <div class="toast-title" id="toastTitle">Alert</div>
    <div class="toast-msg" id="toastMsg"></div>
  </div>
  <button class="toast-close" onclick="hideToast()">Ã—</button>
</div>

<!-- Screen flash -->
<div class="danger-flash" id="dangerFlash" style="display:none"></div>

<!-- â”€â”€ FATIGUE DETECTOR overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="fatigueOverlay">
  <div style="position:relative;display:flex;align-items:center;justify-content:center">
    <div class="fatigue-status-ring" id="fatigueRing" style="display:none"></div>
    <video id="fatigueVideo" autoplay muted playsinline></video>
  </div>
  <div style="text-align:center;color:#fff">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;color:#10b981">FATIGUE MONITOR</div>
    <div style="font-size:12px;color:rgba(255,255,255,.6);margin-top:4px" id="fatigueStateTxt">Initializing camera...</div>
  </div>
  <button onclick="toggleFatigueOverlay()" style="
    padding:13px 32px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
    background:rgba(255,255,255,.08);color:#fff;font-family:'DM Sans',sans-serif;
    font-size:14px;font-weight:700;cursor:pointer">
    â† Close Monitor
  </button>
</div>

<!-- â”€â”€ FATIGUE ALERT full screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="fatigueAlert">
  <div class="alert-emoji">ğŸ˜´</div>
  <div class="alert-title">Â¡WAKE UP!</div>
  <div class="alert-sub">Fatigue detected â€” Pull over safely now</div>
  <button class="alert-dismiss" onclick="dismissFatigueAlert()">âœ… I'M AWAKE â€” DISMISS</button>
</div>

<!-- â”€â”€ WEATHER WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- â”€â”€ BRIDGE WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="bridgeInput">
  <div class="bridge-label">ğŸŒ‰ TRAILER HEIGHT</div>
  <div class="bridge-row">
    <div class="bridge-val" id="bridgeDisplayVal">13.6</div>
    <div class="bridge-ft">ft</div>
  </div>
  <div style="font-size:10px;color:rgba(255,255,255,.5);margin-top:3px;line-height:1.3" id="bridgeNextTxt">Monitoring route...</div>
  <div class="bridge-btns">
    <button class="bridge-btn" onclick="adjustHeight(-0.1)">â–¼</button>
    <button class="bridge-btn" onclick="adjustHeight(+0.1)">â–²</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DRIVING HOURS WIDGET (left side)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="driveHoursWidget">
  <div class="dh-ring" id="dhRing">
    <!-- Arc SVG â€” full circle track + colored arc -->
    <svg class="dh-svg" viewBox="0 0 70 70">
      <!-- Track -->
      <circle cx="35" cy="35" r="30" fill="none"
              stroke="rgba(255,255,255,0.07)" stroke-width="4"/>
      <!-- Colored arc â€” starts at top, goes clockwise -->
      <circle cx="35" cy="35" r="30" fill="none"
              stroke="#10b981" stroke-width="4"
              stroke-linecap="round"
              stroke-dasharray="0 188"
              id="dhArc"
              transform="rotate(-220 35 35)"
              style="transition:stroke-dasharray .6s ease, stroke .4s"/>
    </svg>
    <div class="dh-hrs" id="dhHrs">11h</div>
    <div class="dh-unit">HRS</div>
  </div>
  <div class="dh-label" id="dhLabel">DRIVING LEFT</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CIRCULAR SPEEDOMETER WIDGET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="speedometerWidget">
  <div class="speedo-ring stopped" id="speedoRing">
    <svg class="speedo-svg" id="speedoSvg" viewBox="0 0 120 120">
      <circle cx="60" cy="60" r="55" fill="none" stroke="rgba(255,255,255,0.07)" stroke-width="6"/>
      <circle cx="60" cy="60" r="55" fill="none" stroke="#10b981" stroke-width="6"
              stroke-linecap="round" stroke-dasharray="0 345" id="speedoArc"
              transform="rotate(-220 60 60)" style="transition:stroke-dasharray .5s ease"/>
    </svg>
    <div class="speedo-num stopped" id="speedoNum">0</div>
    <div class="speedo-unit">MPH</div>
  </div>
  <div class="speedo-label" id="speedoLabel">GPS SPEED</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SOS FAB BUTTON (on map)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- sosFab is now inside the left top column -->
<span id="fmSpeedVal" style="display:none">0</span>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FUEL STATIONS WIDGET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="fuelWidget" onclick="showFuelList()">
  <div class="fuel-label">â›½ DIESEL MÃS BARATO</div>
  <div class="fuel-price" id="fuelBestPrice">--</div>
  <div class="fuel-name" id="fuelBestName">Buscando...</div>
  <div class="fuel-dist" id="fuelBestDist"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SPEED EXCEEDANCE TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="speed-toast" id="speedToast">ğŸš¨ Â¡REDUCIR VELOCIDAD!</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SOS EMERGENCY OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="sosOverlay">
  <div class="sos-emoji">ğŸ†˜</div>
  <div class="sos-title">EMERGENCIA SOS</div>
  <div class="sos-coords" id="sosCoordsText">Obteniendo ubicaciÃ³n...</div>
  <div class="sos-contact-name" id="sosContactName">Sin contacto configurado</div>
  <div class="sos-contact-phone" id="sosContactPhone"></div>
  <button class="sos-call-btn" id="sosCallBtn">ğŸ“ LLAMAR AHORA</button>
  <button class="sos-sms-btn" id="sosSmsBtn">ğŸ’¬ ENVIAR UBICACIÃ“N POR SMS</button>
  <button class="sos-dismiss" onclick="dismissSOS()">âœ• Cancelar emergencia</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INCIDENT BUBBLES PANEL (left side)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="incidentPanel"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FULL-SCREEN ALERT (Police / Danger / Warning)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="fullscreenAlertOverlay">
  <div class="police-lightbar" id="policeLightbar">
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
    <div class="police-lightbar-inner"></div>
  </div>
  <div class="fs-alert-emoji" id="fsAlertEmoji">ğŸš”</div>
  <div class="fs-alert-title" id="fsAlertTitle">POLICÃA ADELANTE</div>
  <div class="fs-alert-sub" id="fsAlertSub">Reportado por conductor en la ruta</div>
  <div class="fs-alert-dist" id="fsAlertDist"></div>
  <button class="fs-alert-dismiss police-btn" id="fsAlertDismissBtn" onclick="dismissFullscreenAlert()">
    âœ… ENTENDIDO â€” CONTINUAR
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     REST ALARM OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="restAlarmOverlay">
  <div class="rest-alarm-emoji" id="restAlarmEmoji">ğŸ˜´</div>
  <div class="rest-alarm-title" id="restAlarmTitle">Â¡HORA DE DESCANSAR!</div>
  <div class="rest-alarm-sub" id="restAlarmSub">Has manejado 8 horas. DOT requiere descanso de 10 horas.</div>
  <div class="rest-alarm-timer" id="restAlarmTimer">10:00</div>
  <button class="rest-alarm-dismiss" onclick="dismissRestAlarm()">
    ğŸ˜´ INICIAR DESCANSO
  </button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const T = {
  en: {
    subtitle:'DOT Hours of Service Planner',info:'Type city name to search globally',lblFrom:'ğŸ“ Origin',lblTo:'ğŸ¯ Destination',
    lblTime:'ğŸ• Departure',lblHours:'â±ï¸ Hours Left',lblSpeed:'ğŸš€ Speed (mph)',btnCalc:'ğŸš› Calculate Route',
    shareText:'ğŸ“¤ Share Route',monitorText:'ğŸ“ Start Live Tracking',stopText:'ğŸ›‘ Stop Tracking',monitorTitle:'LIVE TRACKING',
    errSel:'Select origin and destination',err70:'Max 70 hours',errSpeed:'Invalid speed',day:'Day',drive:'Driving',rest:'Rest',
    reset:'34H RESET',from:'FROM',to:'TO',departure:'DEPARTURE',arrival:'ARRIVAL',totalTime:'TOTAL TIME',
    routeMap:'Route Map',fullMap:'View Full Map',roadHint:'Real road route when available',
    currentLoc:'CURRENT LOCATION',currentSpeed:'CURRENT SPEED',progress:'TRIP PROGRESS',traveled:'TRAVELED',
    remaining:'REMAINING',elapsed:'ELAPSED',eta:'ETA',copied:'Route copied!',locating:'Locating...',ready:'Ready',
    driving:'Driving',stopped:'Stopped',gpsDenied:'Allow location access in your browser',arrived:'ğŸ‰ Arrived!',
    sourceRoad:'Road route source',sourceOsrm:'OSRM',sourceFallback:'Direct line fallback',
    menuTitle:'Settings',menuLang:'Language',menuTheme:'Theme',menuCountry:'Country search',light:'Light',dark:'Dark',
    tabLblPlan:'Plan Route',tabLblDrives:'All Drives',tabLblSummary:'Summaries',tabLblSettings:'Settings',
    drivesTitle:'All Drives',summaryTitle:'Summaries',settingsPageTitle:'Settings',settSecGeneral:'General',
    settSecAppear:'Appearance',settSecHOS:'HOS Rules',settSecAbout:'About',settLangRow:'Language',
    settCountryRow:'Country Filter',settLightRow:'Light Mode',settDarkRow:'Dark Mode',settBreakRow:'30-min Break Rule',
    settCycleRow:'Cycle Hours',settRestRow:'Rest Requirement',settShareRow:'Share App',sendReportText:'Send Report',
    noDrives:'No drives recorded yet.',calcFirst:'Calculate your first route.',noRoutes:'No routes yet',
    planRoute:'Plan a route to see your summary here.',allLogged:'Great job, all routes logged!',status100:'100% logged',
    sumDrivesLbl:'Drives',sumMilesLbl:'Miles',sumValueLbl:'Logged',business:'Business',
    settSpeedLimitRow:'Default Speed Limit',
    confirmTrackTitle:'Full Map View',confirmTrackDesc:'Do you want to activate live route tracking?',
    confirmNoTxt:'Map only',confirmYesTxt:'Yes, track me',
    hud70Lbl:'70 HRS',hudDriveLbl:'DRIVE TIME',hudProgLbl:'PROGRESS'
  },
  es: {
    subtitle:'Planificador de Horas DOT',info:'Escribe nombre de ciudad para buscar',lblFrom:'ğŸ“ Origen',lblTo:'ğŸ¯ Destino',
    lblTime:'ğŸ• Salida',lblHours:'â±ï¸ Horas Restantes',lblSpeed:'ğŸš€ Velocidad (mph)',btnCalc:'ğŸš› Calcular Ruta',
    shareText:'ğŸ“¤ Compartir Ruta',monitorText:'ğŸ“ Iniciar Rastreo',stopText:'ğŸ›‘ Detener Rastreo',monitorTitle:'RASTREO EN VIVO',
    errSel:'Selecciona origen y destino',err70:'MÃ¡ximo 70 horas',errSpeed:'Velocidad invÃ¡lida',day:'DÃ­a',drive:'Manejo',rest:'Descanso',
    reset:'RESET 34H',from:'DESDE',to:'HASTA',departure:'SALIDA',arrival:'LLEGADA',totalTime:'TIEMPO TOTAL',
    routeMap:'Mapa de Ruta',fullMap:'Ver Mapa Completo',roadHint:'Ruta terrestre real si estÃ¡ disponible',
    currentLoc:'UBICACIÃ“N ACTUAL',currentSpeed:'VELOCIDAD ACTUAL',progress:'PROGRESO DEL VIAJE',traveled:'RECORRIDO',
    remaining:'RESTANTE',elapsed:'TRANSCURRIDO',eta:'ETA',copied:'Â¡Ruta copiada!',locating:'Localizando...',ready:'Listo',
    driving:'Manejando',stopped:'Detenido',gpsDenied:'Permite el acceso a ubicaciÃ³n en tu navegador',arrived:'ğŸ‰ Â¡Llegaste!',
    sourceRoad:'Fuente de ruta',sourceOsrm:'OSRM',sourceFallback:'LÃ­nea directa (respaldo)',
    menuTitle:'Ajustes',menuLang:'Idioma',menuTheme:'Tema',menuCountry:'PaÃ­s de bÃºsqueda',light:'Claro',dark:'Oscuro',
    tabLblPlan:'Planear Ruta',tabLblDrives:'Todos los Viajes',tabLblSummary:'ResÃºmenes',tabLblSettings:'Ajustes',
    drivesTitle:'Todos los Viajes',summaryTitle:'ResÃºmenes',settingsPageTitle:'Ajustes',settSecGeneral:'General',
    settSecAppear:'Apariencia',settSecHOS:'Reglas HOS',settSecAbout:'Acerca de',settLangRow:'Idioma',
    settCountryRow:'Filtro de PaÃ­s',settLightRow:'Modo Claro',settDarkRow:'Modo Oscuro',settBreakRow:'Regla de Pausa 30 min',
    settCycleRow:'Horas de Ciclo',settRestRow:'Requisito de Descanso',settShareRow:'Compartir App',sendReportText:'Enviar Reporte',
    noDrives:'Sin viajes registrados aÃºn.',calcFirst:'Calcula tu primera ruta.',noRoutes:'Sin rutas aÃºn',
    planRoute:'Planifica una ruta para ver el resumen.',allLogged:'Â¡Excelente trabajo!',status100:'100% registrado',
    sumDrivesLbl:'Viajes',sumMilesLbl:'Millas',sumValueLbl:'Registrado',business:'Negocio',
    settSpeedLimitRow:'LÃ­mite de Velocidad por Defecto',
    confirmTrackTitle:'Ver Mapa Completo',confirmTrackDesc:'Â¿Deseas activar el seguimiento en vivo de tu ruta?',
    confirmNoTxt:'Solo ver mapa',confirmYesTxt:'SÃ­, dar seguimiento',
    hud70Lbl:'70 HRS',hudDriveLbl:'T. MANEJO',hudProgLbl:'PROGRESO'
  }
};

const COUNTRIES = [
  {code:'',en:'All countries',es:'Todos los paÃ­ses'},
  {code:'US',en:'United States',es:'Estados Unidos'},
  {code:'MX',en:'Mexico',es:'MÃ©xico'},
  {code:'CA',en:'Canada',es:'CanadÃ¡'},
  {code:'DO',en:'Dominican Republic',es:'RepÃºblica Dominicana'},
  {code:'ES',en:'Spain',es:'EspaÃ±a'},
  {code:'FR',en:'France',es:'Francia'},
  {code:'DE',en:'Germany',es:'Alemania'},
  {code:'IT',en:'Italy',es:'Italia'},
  {code:'GB',en:'United Kingdom',es:'Reino Unido'},
  {code:'BR',en:'Brazil',es:'Brasil'},
  {code:'AR',en:'Argentina',es:'Argentina'},
  {code:'CO',en:'Colombia',es:'Colombia'}
];

let lang = localStorage.getItem('hos_lang') || 'en';
let isDark = localStorage.getItem('hos_theme') === 'dark';
let use30min = localStorage.getItem('hos_30min') !== 'false';
let selectedCountry = localStorage.getItem('hos_country') || '';
let savedDrives = JSON.parse(localStorage.getItem('hos_drives') || '[]');
let truckIconMode = localStorage.getItem('hos_truck_icon') || 'emoji:ğŸš›'; // emoji:..., img:..., upload:dataurl
let truckUploadData = localStorage.getItem('hos_truck_upload') || '';
let speedWidgetPos = JSON.parse(localStorage.getItem('hos_speed_pos') || 'null');
let speedometerPos   = JSON.parse(localStorage.getItem('hos_speedometer_pos')  || 'null');
let driveHoursPos    = JSON.parse(localStorage.getItem('hos_drivehours_pos')   || 'null');
let defaultSpeed = parseInt(localStorage.getItem('hos_speed') || '60');
let currentTab = 'plan';

let origin = null, destination = null;
let routeDistance = 0, schedule = [], arrivalTime = null, totalTime = 0;
let roadGeometry = null, routeSource = null;

let miniMap = null, fullMapInst = null;
let miniLayer = null, fullLayer = null;
let miniMarkersList = [], fullMarkersList = [];

// Mini-map POI state
let miniPoiMarkers = { truck: [], rest: [], restrict: [] };
let miniPoiActive  = { truck: true, rest: true, restrict: true };

let watchId = null;
let tripStart = null;

/* â”€â”€ Safety feature states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let fatigueActive   = localStorage.getItem('hos_fatigue')  !== 'false' ? false : false;
let weatherActive   = localStorage.getItem('hos_weather')  === 'true';
let bridgeActive    = localStorage.getItem('hos_bridge')   === 'true';
let trailerHeight   = parseFloat(localStorage.getItem('hos_trailer') || '13.6');

// Fatigue internals
let fatigueStream   = null;
let fatigueInterval = null;
let fatigueEyeHistory = [];   // rolling window of "eyes open?" booleans
let fatigueAlertActive = false;

// Weather internals
let weatherInterval = null;
let lastWeatherLat  = null;
let lastWeatherLon  = null;

// Bridge internals
let bridgeInterval  = null;
let lastBridgeLat   = null;
let lastBridgeLon   = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED TOAST SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer = null;
function showToast(type, icon, title, msg, autoDismiss = 6000) {
  const el = document.getElementById('safetyToast');
  el.className = `safety-toast ${type}`;
  document.getElementById('toastIcon').textContent  = icon;
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastMsg').textContent   = msg;
  // Force reflow so transition plays
  void el.offsetWidth;
  el.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  if (autoDismiss) toastTimer = setTimeout(hideToast, autoDismiss);
  if (navigator.vibrate) navigator.vibrate(type === 'danger' ? [200,80,200,80,400] : [100,50,100]);
}
function hideToast() {
  document.getElementById('safetyToast').classList.remove('show');
}

function flashDanger(ms = 2000) {
  const f = document.getElementById('dangerFlash');
  f.style.display = 'block';
  setTimeout(() => f.style.display = 'none', ms);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ˜´  FATIGUE DETECTOR
   Uses MediaPipe FaceMesh via @mediapipe/face_mesh CDN
   to measure Eye Aspect Ratio (EAR). Falls back to a
   simple blink-rate heuristic if MediaPipe is unavailable.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let faceMesh = null;
let faceMeshReady = false;

async function initFaceMesh() {
  if (faceMeshReady) return;
  try {
    // Dynamically load MediaPipe FaceMesh
    await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js');
    faceMesh = new window.FaceMesh({
      locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
    });
    faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    faceMesh.onResults(onFaceMeshResults);
    await faceMesh.initialize();
    faceMeshReady = true;
  } catch(e) {
    // MediaPipe unavailable â†’ use heuristic fallback
    faceMeshReady = false;
  }
}

function loadScript(src) {
  return new Promise((res, rej) => {
    if (document.querySelector(`script[src="${src}"]`)) { res(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });
}

// Eye Aspect Ratio from MediaPipe landmarks
// Left eye: 33,160,158,133,153,144 | Right eye: 362,385,387,263,373,380
function calcEAR(landmarks, pts) {
  const p = i => landmarks[i];
  const dist = (a,b) => Math.hypot(a.x-b.x, a.y-b.y);
  const vert1 = dist(p(pts[1]), p(pts[5]));
  const vert2 = dist(p(pts[2]), p(pts[4]));
  const horiz = dist(p(pts[0]), p(pts[3]));
  return (vert1 + vert2) / (2 * horiz);
}

const EAR_THRESHOLD = 0.21;   // below = eyes closed
const EAR_FRAMES    = 20;     // ~2s at 10fps closed = alert

let closedFrameCount = 0;

function onFaceMeshResults(results) {
  if (fatigueAlertActive) return;
  if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
    // No face detected
    document.getElementById('fatigueStateTxt').textContent = 'âš ï¸ No face detected â€” look at camera';
    return;
  }
  const lm = results.multiFaceLandmarks[0];
  const earL = calcEAR(lm, [33,160,158,133,153,144]);
  const earR = calcEAR(lm, [362,385,387,263,373,380]);
  const ear  = (earL + earR) / 2;
  const closed = ear < EAR_THRESHOLD;

  if (closed) {
    closedFrameCount++;
    document.getElementById('fatigueRing').style.display = 'block';
    document.getElementById('fatigueStateTxt').textContent = `ğŸ˜´ Eyes closing... (${closedFrameCount}/${EAR_FRAMES})`;
  } else {
    closedFrameCount = 0;
    document.getElementById('fatigueRing').style.display = 'none';
    document.getElementById('fatigueStateTxt').textContent = 'âœ… Eyes open â€” monitoring';
  }

  if (closedFrameCount >= EAR_FRAMES) triggerFatigueAlert();
}

// Heuristic fallback (no MediaPipe): detect head tilt via
// DeviceOrientation â€” if phone tilts forward >25Â° for 3s = drowsy
let headTiltTimer = null;
function startHeuristicFatigue() {
  document.getElementById('fatigueStateTxt').textContent = 'ğŸ“± Tilt detection active (mount phone upright)';
  window.addEventListener('deviceorientation', onDeviceOrientation);
}
function stopHeuristicFatigue() {
  window.removeEventListener('deviceorientation', onDeviceOrientation);
  if (headTiltTimer) { clearTimeout(headTiltTimer); headTiltTimer = null; }
}
function onDeviceOrientation(e) {
  if (fatigueAlertActive) return;
  const beta = Math.abs(e.beta || 0); // forward/backward tilt
  // If phone tilts significantly (head drooping â‰ˆ phone falls forward)
  if (beta > 40) {
    if (!headTiltTimer) {
      headTiltTimer = setTimeout(() => {
        triggerFatigueAlert();
        headTiltTimer = null;
      }, 3000);
      document.getElementById('fatigueStateTxt').textContent = 'âš ï¸ Head drooping detected...';
    }
  } else {
    if (headTiltTimer) { clearTimeout(headTiltTimer); headTiltTimer = null; }
    document.getElementById('fatigueStateTxt').textContent = 'âœ… Head position OK';
  }
}

async function startFatigueDetector() {
  document.getElementById('fatigueStatusTxt').textContent = lang === 'es' ? 'Iniciando cÃ¡mara...' : 'Starting camera...';
  try {
    fatigueStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width:320, height:240 }, audio: false });
    const video = document.getElementById('fatigueVideo');
    video.srcObject = fatigueStream;
    await video.play();

    await initFaceMesh();

    if (faceMeshReady) {
      // Send frames to MediaPipe every 100ms
      fatigueInterval = setInterval(async () => {
        if (!fatigueActive || !faceMesh) return;
        try { await faceMesh.send({ image: video }); } catch {}
      }, 100);
      document.getElementById('fatigueStateTxt').textContent = 'âœ… AI eye tracking active';
    } else {
      startHeuristicFatigue();
    }
    document.getElementById('fatigueStatusTxt').textContent = lang === 'es' ? 'ğŸŸ¢ Activo' : 'ğŸŸ¢ Active';
  } catch(e) {
    document.getElementById('fatigueStatusTxt').textContent = lang === 'es' ? 'âŒ Sin acceso a cÃ¡mara' : 'âŒ Camera access denied';
    fatigueActive = false;
    document.getElementById('fatigueToggle').classList.remove('on');
    showToast('warning','ğŸ“·', 'Camera Required', 'Allow camera access to use Fatigue Detector.');
  }
}

function stopFatigueDetector() {
  if (fatigueInterval)  { clearInterval(fatigueInterval); fatigueInterval = null; }
  stopHeuristicFatigue();
  if (fatigueStream) {
    fatigueStream.getTracks().forEach(t => t.stop());
    fatigueStream = null;
  }
  const video = document.getElementById('fatigueVideo');
  video.srcObject = null;
  closedFrameCount = 0;
  document.getElementById('fatigueStatusTxt').textContent = lang === 'es' ? 'CÃ¡mara apagada' : 'Camera off';
  document.getElementById('fatigueStateTxt').textContent  = lang === 'es' ? 'Apagado' : 'Off';
  document.getElementById('fatigueRing').style.display = 'none';
  document.getElementById('fatigueOverlay').classList.remove('active');
}

function toggleFatigueDetector() {
  fatigueActive = !fatigueActive;
  localStorage.setItem('hos_fatigue', fatigueActive);
  document.getElementById('fatigueToggle').classList.toggle('on', fatigueActive);
  if (fatigueActive) {
    startFatigueDetector();
    toggleFatigueOverlay(true);
  } else {
    stopFatigueDetector();
  }
}

function toggleFatigueOverlay(forceOpen) {
  const ov = document.getElementById('fatigueOverlay');
  if (forceOpen === true) { ov.classList.add('active'); return; }
  ov.classList.toggle('active');
}

function triggerFatigueAlert() {
  if (fatigueAlertActive) return;
  fatigueAlertActive = true;
  flashDanger(4000);
  // Sound alert using Web Audio API
  playAlertSound();
  if (navigator.vibrate) navigator.vibrate([500,200,500,200,500,200,800]);
  document.getElementById('fatigueAlert').classList.add('show');
  // Also show on map HUD
  showToast('danger','ğŸ˜´','âš ï¸ FATIGUE ALERT','Eyes closed too long â€” Pull over immediately!', 0);
}

function dismissFatigueAlert() {
  fatigueAlertActive = false;
  closedFrameCount = 0;
  document.getElementById('fatigueAlert').classList.remove('show');
  hideToast();
  document.getElementById('fatigueRing').style.display = 'none';
  document.getElementById('fatigueStateTxt').textContent = 'âœ… Monitoring resumed';
}

function playAlertSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const playBeep = (freq, start, dur) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'square';
      gain.gain.setValueAtTime(0.4, ctx.currentTime + start);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + start + dur);
      osc.start(ctx.currentTime + start);
      osc.stop(ctx.currentTime + start + dur);
    };
    // SOS pattern
    [0,.35,.7,1.1,1.5,1.9].forEach((t,i) => playBeep(i%2===0?880:660, t, .28));
  } catch {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â›ˆï¸  WEATHER ALERTS
   Uses Open-Meteo (free, no API key needed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WX_DANGER_CODES = new Set([
  // thunderstorm, heavy snow, freezing rain, heavy rain, blizzard, tornado, etc.
  95,96,99,71,73,75,77,85,86,66,67,82
]);
const WX_WARNING_CODES = new Set([55,65,61,63,56,57,80,81,51,53]);

const WX_DESC = {
  0:'Clear sky', 1:'Mainly clear', 2:'Partly cloudy', 3:'Overcast',
  45:'Fog', 48:'Icy fog', 51:'Light drizzle', 53:'Moderate drizzle', 55:'Heavy drizzle',
  56:'Freezing drizzle', 57:'Heavy freezing drizzle',
  61:'Light rain', 63:'Moderate rain', 65:'Heavy rain',
  66:'Freezing rain', 67:'Heavy freezing rain',
  71:'Light snow', 73:'Moderate snow', 75:'Heavy snow', 77:'Snow grains',
  80:'Light showers', 81:'Moderate showers', 82:'Violent showers',
  85:'Snow showers', 86:'Heavy snow showers',
  95:'âš¡ Thunderstorm', 96:'Thunderstorm+hail', 99:'Heavy thunderstorm+hail'
};

const WX_ICONS = {
  0:'â˜€ï¸', 1:'ğŸŒ¤ï¸', 2:'â›…', 3:'â˜ï¸',
  45:'ğŸŒ«ï¸', 48:'ğŸŒ«ï¸â„ï¸', 51:'ğŸŒ¦ï¸', 53:'ğŸŒ§ï¸', 55:'ğŸŒ§ï¸',
  56:'ğŸŒ¨ï¸', 57:'ğŸŒ¨ï¸', 61:'ğŸŒ§ï¸', 63:'ğŸŒ§ï¸', 65:'ğŸŒ§ï¸ğŸŒ§ï¸',
  66:'ğŸŒ§ï¸â„ï¸', 67:'ğŸŒ§ï¸â„ï¸', 71:'â„ï¸', 73:'â„ï¸â„ï¸', 75:'â„ï¸â„ï¸â„ï¸', 77:'ğŸŒ¨ï¸',
  80:'ğŸŒ¦ï¸', 81:'ğŸŒ§ï¸', 82:'â›ˆï¸', 85:'ğŸŒ¨ï¸', 86:'ğŸŒ¨ï¸â„ï¸',
  95:'â›ˆï¸', 96:'â›ˆï¸ğŸŒ©ï¸', 99:'â›ˆï¸ğŸŒ©ï¸â„ï¸'
};

async function fetchWeather(lat, lon) {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&current=temperature_2m,weathercode,windspeed_10m,precipitation&wind_speed_unit=mph` +
      `&temperature_unit=fahrenheit&timezone=auto`;
    const r = await fetch(url);
    const d = await r.json();
    const c = d.current;
    return {
      code  : c.weathercode,
      temp  : Math.round(c.temperature_2m),
      wind  : Math.round(c.windspeed_10m),
      precip: c.precipitation,
      desc  : WX_DESC[c.weathercode] || 'Unknown'
    };
  } catch { return null; }
}

function updateWeatherWidget(wx) {
  if (!wx) return;
  const isDanger  = WX_DANGER_CODES.has(wx.code);
  const isWarning = WX_WARNING_CODES.has(wx.code);
  document.getElementById('wxIcon').textContent = WX_ICONS[wx.code] || 'ğŸŒ¡ï¸';
  document.getElementById('wxTemp').textContent = `${wx.temp}Â°F`;
  document.getElementById('wxDesc').textContent = wx.desc;
  const wxWindEl = document.getElementById('wxWind');
  if (wxWindEl) wxWindEl.textContent = wx.wind > 0 ? `ğŸ’¨ ${wx.wind} mph` : '';
  // Color the temp red if danger
  document.getElementById('wxTemp').className = 'wx-temp' + (isDanger ? ' wx-danger' : '');
  document.getElementById('wxDesc').className = 'wx-desc' + (isDanger ? ' wx-danger' : '');

  if (isDanger) {
    showToast('danger','â›ˆï¸','âš ï¸ DANGEROUS WEATHER',
      `${wx.desc} â€” ${wx.temp}Â°F, winds ${wx.wind}mph. Consider pulling over.`, 0);
    flashDanger(3000);
    if (navigator.vibrate) navigator.vibrate([300,100,300,100,300]);
    // Also show full-screen
    showFullscreenAlert('danger', 'â›ˆï¸', 'Â¡CLIMA PELIGROSO!',
      `${wx.desc} â€” ${wx.temp}Â°F, vientos ${wx.wind}mph. Considera detenerte.`, '', 15000);
  } else if (isWarning) {
    showToast('warning','ğŸŒ§ï¸','Weather Alert',
      `${wx.desc} â€” ${wx.temp}Â°F, winds ${wx.wind}mph. Drive with caution.`, 8000);
  }
  // Wind warning independent
  if (wx.wind >= 40 && !isDanger) {
    showToast('warning','ğŸ’¨','High Wind Warning',
      `${wx.wind}mph winds â€” Risk of rollover for high-profile trucks!`, 8000);
  }
  document.getElementById('weatherStatusTxt').textContent =
    `${WX_ICONS[wx.code]||'ğŸŒ¡ï¸'} ${wx.temp}Â°F Â· ${wx.desc}`;
}

async function startWeatherMonitor() {
  document.getElementById('weatherWidget').classList.add('visible');
  document.getElementById('weatherStatusTxt').textContent = 'Fetching weather...';
  document.getElementById('wxDesc').textContent = 'Loading...';

  const updateNow = async () => {
    if (!weatherActive) return;
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(async pos => {
      const { latitude: lat, longitude: lon } = pos.coords;
      // Don't re-fetch if barely moved (<5 miles)
      if (lastWeatherLat && haversine(lat,lon,lastWeatherLat,lastWeatherLon) < 5) return;
      lastWeatherLat = lat; lastWeatherLon = lon;
      const wx = await fetchWeather(lat, lon);
      updateWeatherWidget(wx);
    }, () => {}, { enableHighAccuracy: false, timeout: 10000 });
  };

  await updateNow();
  weatherInterval = setInterval(updateNow, 10 * 60 * 1000); // every 10 min
  document.getElementById('weatherToggle').classList.add('on');
}

function stopWeatherMonitor() {
  if (weatherInterval) { clearInterval(weatherInterval); weatherInterval = null; }
  document.getElementById('weatherWidget').classList.remove('visible');
  document.getElementById('weatherStatusTxt').textContent = 'Off';
  document.getElementById('weatherToggle').classList.remove('on');
  lastWeatherLat = null; lastWeatherLon = null;
}

function toggleWeatherMonitor() {
  weatherActive = !weatherActive;
  localStorage.setItem('hos_weather', weatherActive);
  document.getElementById('weatherToggle').classList.toggle('on', weatherActive);
  if (weatherActive) startWeatherMonitor();
  else stopWeatherMonitor();
}

function showWeatherDetail() {
  if (!weatherActive) return;
  const desc = document.getElementById('wxDesc').textContent;
  const temp = document.getElementById('wxTemp').textContent;
  showToast('info', 'ğŸŒ¡ï¸', 'Clima actual', `${desc} Â· ${temp}`, 6000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸŒ‰  LOW BRIDGE DETECTOR
   Only warns about bridges ON the planned route ahead,
   within the next 30 miles of current position.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Convert maxheight tag to feet
function parseHeightToFeet(h) {
  if (!h) return null;
  let feet = parseFloat(h);
  if (h.includes("'")) {
    const m = h.match(/(\d+)'?\s*(\d*)/);
    if (m) feet = parseInt(m[1]) + (parseInt(m[2] || 0) / 12);
  } else if (h.toLowerCase().includes('m') || (!h.includes("'") && feet < 10)) {
    feet = feet * 3.28084;
  }
  return isNaN(feet) ? null : Math.round(feet * 10) / 10;
}

// Get route waypoints within next N miles from current position
function getRouteAhead(currentLat, currentLon, aheadMiles = 30) {
  if (!roadGeometry || roadGeometry.length < 2) return [];

  // Find closest point on route
  let closestIdx = 0, closestDist = Infinity;
  const step = Math.max(1, Math.floor(roadGeometry.length / 200));
  for (let i = 0; i < roadGeometry.length; i += step) {
    const d = haversine(currentLat, currentLon, roadGeometry[i][0], roadGeometry[i][1]);
    if (d < closestDist) { closestDist = d; closestIdx = i; }
  }

  // Collect waypoints ahead up to aheadMiles
  const ahead = [];
  let accumulated = 0;
  for (let i = closestIdx; i < roadGeometry.length - 1; i++) {
    ahead.push({ lat: roadGeometry[i][0], lon: roadGeometry[i][1] });
    accumulated += haversine(roadGeometry[i][0], roadGeometry[i][1], roadGeometry[i+1][0], roadGeometry[i+1][1]);
    if (accumulated >= aheadMiles) break;
  }
  return ahead;
}

async function fetchBridgesAlongRoute(routeWaypoints) {
  if (!routeWaypoints.length) return [];
  const seen = new Set();
  const bridges = [];

  // Sample every ~5 miles along ahead-route
  const sampledWps = [];
  let accumulated = 0;
  for (let i = 0; i < routeWaypoints.length; i++) {
    if (i === 0 || accumulated >= 4) {
      sampledWps.push(routeWaypoints[i]);
      accumulated = 0;
    }
    if (i < routeWaypoints.length - 1) {
      accumulated += haversine(routeWaypoints[i].lat, routeWaypoints[i].lon, routeWaypoints[i+1].lat, routeWaypoints[i+1].lon);
    }
  }

  for (const wp of sampledWps) {
    try {
      const query = `
        [out:json][timeout:12];
        (
          way["maxheight"](around:800,${wp.lat},${wp.lon});
          node["maxheight"](around:800,${wp.lat},${wp.lon});
        );
        out geom qt;`;
      const resp = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST', body: 'data=' + encodeURIComponent(query)
      });
      const data = await resp.json();
      (data.elements || []).forEach(el => {
        if (seen.has(el.id)) return;
        // Get coordinates (node has lat/lon, way has geometry)
        const elLat = el.lat ?? el.geometry?.[0]?.lat;
        const elLon = el.lon ?? el.geometry?.[0]?.lon;
        if (!elLat || !elLon) return;

        // Strict: must be within 0.25 miles of route
        if (!isNearRoute(elLat, elLon, roadGeometry, 0.25)) return;
        seen.add(el.id);

        const feet = parseHeightToFeet(el.tags?.maxheight);
        if (feet !== null) {
          const name = el.tags?.name || el.tags?.ref || 'Bridge';
          const distAhead = haversine(fmGpsMarker?.getLatLng().lat ?? elLat, fmGpsMarker?.getLatLng().lng ?? elLon, elLat, elLon);
          bridges.push({ feet, raw: el.tags?.maxheight, lat: elLat, lon: elLon, name, distAhead });
        }
      });
    } catch {}
  }
  return bridges;
}

async function checkBridges() {
  if (!bridgeActive) return;

  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude: lat, longitude: lon } = pos.coords;
    if (lastBridgeLat && haversine(lat, lon, lastBridgeLat, lastBridgeLon) < 0.5) return;
    lastBridgeLat = lat; lastBridgeLon = lon;

    // Only check bridges if we have a planned route
    if (!roadGeometry || roadGeometry.length < 2) {
      document.getElementById('bridgeNextTxt').textContent = 'Planifica una ruta para monitorear puentes';
      return;
    }

    // Get route waypoints within next 30 miles
    const aheadWaypoints = getRouteAhead(lat, lon, 30);
    if (!aheadWaypoints.length) {
      document.getElementById('bridgeNextTxt').textContent = 'No hay ruta por delante';
      return;
    }

    const bridges = await fetchBridgesAlongRoute(aheadWaypoints);
    if (!bridges.length) {
      document.getElementById('bridgeNextTxt').textContent = 'âœ… Sin puentes bajos en ruta';
      document.getElementById('bridgeNextTxt').style.color = 'rgba(255,255,255,.5)';
      return;
    }

    // Sort by distance ahead
    bridges.sort((a, b) => a.distAhead - b.distAhead);
    const lowest  = bridges.reduce((a, b) => a.feet < b.feet ? a : b);
    const nearest = bridges[0];
    const clearance = lowest.feet;
    const needed    = trailerHeight;
    const margin    = clearance - needed;

    document.getElementById('bridgeNextTxt').textContent =
      `ğŸŒ‰ ${nearest.name}: ${nearest.feet}ft â€” ${nearest.distAhead.toFixed(1)}mi ahead`;

    if (margin < 0) {
      showToast('danger', 'ğŸš¨', 'âš ï¸ PUENTE MUY BAJO EN TU RUTA!',
        `${lowest.name}: ${clearance}ft â€” Tu trÃ¡iler: ${needed}ft. Â¡DESVÃATE AHORA!`, 0);
      flashDanger(4000);
      if (navigator.vibrate) navigator.vibrate([400, 100, 400, 100, 800]);
      document.getElementById('bridgeNextTxt').textContent = `ğŸš¨ MUY BAJO: ${clearance}ft @ ${lowest.name}`;
      document.getElementById('bridgeNextTxt').style.color = '#ef4444';
      showFullscreenAlert('danger', 'ğŸŒ‰', 'Â¡PUENTE MUY BAJO EN RUTA!',
        `${lowest.name}: ${clearance}ft â€” Tu trÃ¡iler: ${needed}ft. Â¡DESVÃATE!`, '', 20000);
    } else if (margin < 1.5) {
      showToast('warning', 'âš ï¸', 'Puente con poco espacio',
        `${lowest.name}: ${clearance}ft â€” Tu trÃ¡iler: ${needed}ft. Solo ${margin.toFixed(1)}ft de margen.`, 8000);
      document.getElementById('bridgeNextTxt').textContent = `âš ï¸ Bajo: ${clearance}ft @ ${lowest.name}`;
      document.getElementById('bridgeNextTxt').style.color = '#f59e0b';
    } else {
      document.getElementById('bridgeNextTxt').style.color = 'rgba(255,255,255,.5)';
    }
    document.getElementById('bridgeStatusTxt').textContent =
      `Active Â· ${needed}ft trailer Â· ${bridges.length} bridge${bridges.length > 1 ? 's' : ''} en ruta`;
  }, () => {}, { enableHighAccuracy: false, timeout: 10000 });
}

function startBridgeDetector() {
  document.getElementById('bridgeInput').classList.add('visible');
  document.getElementById('bridgeDisplayVal').textContent = trailerHeight.toFixed(1);
  document.getElementById('bridgeStatusTxt').textContent = `Active Â· ${trailerHeight}ft trailer`;
  document.getElementById('trailerHeightRow').style.display = 'flex';
  checkBridges(); // immediate check
  bridgeInterval = setInterval(checkBridges, 3 * 60 * 1000); // every 3 min
}

function stopBridgeDetector() {
  if (bridgeInterval) { clearInterval(bridgeInterval); bridgeInterval = null; }
  document.getElementById('bridgeInput').classList.remove('visible');
  document.getElementById('bridgeStatusTxt').textContent = 'Off â€” set trailer height';
  document.getElementById('trailerHeightRow').style.display = 'none';
  lastBridgeLat = null; lastBridgeLon = null;
}

function toggleBridgeDetector() {
  bridgeActive = !bridgeActive;
  localStorage.setItem('hos_bridge', bridgeActive);
  document.getElementById('bridgeToggle').classList.toggle('on', bridgeActive);
  // Toggle overlay-hide mode on fullscreen map
  const screen = document.getElementById('fullMapScreen');
  if (screen) screen.classList.toggle('bridge-mode', bridgeActive);
  if (bridgeActive) startBridgeDetector();
  else stopBridgeDetector();
}

function adjustHeight(delta) {
  trailerHeight = Math.max(8, Math.min(18, Math.round((trailerHeight + delta) * 10) / 10));
  localStorage.setItem('hos_trailer', trailerHeight);
  document.getElementById('bridgeDisplayVal').textContent = trailerHeight.toFixed(1);
  document.getElementById('trailerHeightInput').value = trailerHeight;
  document.getElementById('bridgeStatusTxt').textContent = `Active Â· ${trailerHeight}ft trailer`;
  checkBridges(); // recheck with new height
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš€  CIRCULAR SPEEDOMETER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let speedoVisible = false;

function showSpeedometer() {
  document.getElementById('speedometerWidget').classList.add('visible');
  speedoVisible = true;
}

function hideSpeedometer() {
  document.getElementById('speedometerWidget').classList.remove('visible');
  speedoVisible = false;
}

/* â”€â”€ DRIVING HOURS WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showDriveHoursWidget() {
  document.getElementById('driveHoursWidget').classList.add('visible');
  applyDriveHoursPos();
}

function hideDriveHoursWidget() {
  document.getElementById('driveHoursWidget').classList.remove('visible');
}

function applyDriveHoursPos() {
  const w = document.getElementById('driveHoursWidget');
  if (!w) return;
  if (driveHoursPos && typeof driveHoursPos.x === 'number') {
    w.style.left   = driveHoursPos.x + 'px';
    w.style.top    = driveHoursPos.y + 'px';
    w.style.bottom = 'auto';
    w.style.right  = 'auto';
    w.style.transform = 'none';
  }
}

// hoursLeft: decimal hours remaining (e.g. 8.5)
// maxHours: the starting maximum (11 for daily drive limit)
function updateDriveHoursWidget(hoursLeft, maxHours) {
  const ring  = document.getElementById('dhRing');
  const hrs   = document.getElementById('dhHrs');
  const arc   = document.getElementById('dhArc');
  const label = document.getElementById('dhLabel');
  if (!ring) return;

  // Format label
  const totalMins = Math.round(hoursLeft * 60);
  const h = Math.floor(totalMins / 60);
  const m = totalMins % 60;
  hrs.textContent = h > 0 ? `${h}h${m > 0 ? m : ''}` : `${m}m`;

  // Severity state
  const isWarn     = hoursLeft < 4 && hoursLeft >= 2;
  const isCritical = hoursLeft < 2;
  ring.className  = 'dh-ring' + (isCritical ? ' critical' : isWarn ? ' warn' : '');
  hrs.className   = 'dh-hrs'  + (isCritical ? ' critical' : isWarn ? ' warn' : '');

  // Arc color
  const arcColor = isCritical ? '#ef4444' : isWarn ? '#f59e0b' : '#10b981';
  arc.style.stroke = arcColor;

  // Arc length: 188 units = full circle (r=30, circumferenceâ‰ˆ188)
  const pct    = Math.max(0, Math.min(1, hoursLeft / Math.max(1, maxHours)));
  const dashLen = pct * 162; // 162 â‰ˆ 86% of circumference (matches -220deg start)
  arc.setAttribute('stroke-dasharray', `${dashLen.toFixed(1)} 188`);

  // Label
  label.textContent = lang === 'es' ? 'HORAS DE MANEJO' : 'DRIVING LEFT';
}

function initDriveHoursDrag() {
  const w = document.getElementById('driveHoursWidget');
  if (!w) return;

  applyDriveHoursPos();

  let dragging = false, startX = 0, startY = 0, origLeft = 0, origTop = 0;

  const getPoint = (e) => {
    const t = e.touches && e.touches[0];
    return t ? { x: t.clientX, y: t.clientY } : { x: e.clientX, y: e.clientY };
  };

  const onDown = (e) => {
    if (!w.classList.contains('visible')) return;
    dragging = true;
    w.classList.add('dragging');
    const pt   = getPoint(e);
    startX = pt.x; startY = pt.y;
    const rect = w.getBoundingClientRect();
    origLeft   = rect.left;
    origTop    = rect.top;
    w.style.left   = origLeft + 'px';
    w.style.top    = origTop  + 'px';
    w.style.bottom = 'auto';
    w.style.right  = 'auto';
    w.style.transform = 'none';
    e.preventDefault();
  };

  const onMove = (e) => {
    if (!dragging) return;
    const pt  = getPoint(e);
    const rect = w.getBoundingClientRect();
    const pad  = 6;
    let newLeft = origLeft + (pt.x - startX);
    let newTop  = origTop  + (pt.y - startY);
    newLeft = Math.max(pad, Math.min(window.innerWidth  - rect.width  - pad, newLeft));
    newTop  = Math.max(pad, Math.min(window.innerHeight - rect.height - pad, newTop));
    w.style.left = newLeft + 'px';
    w.style.top  = newTop  + 'px';
    driveHoursPos = { x: Math.round(newLeft), y: Math.round(newTop) };
    localStorage.setItem('hos_drivehours_pos', JSON.stringify(driveHoursPos));
    e.preventDefault();
  };

  const onUp = () => { if (!dragging) return; dragging = false; w.classList.remove('dragging'); };

  w.addEventListener('mousedown',  onDown);
  w.addEventListener('touchstart', onDown, { passive: false });
  window.addEventListener('mousemove',  onMove);
  window.addEventListener('touchmove',  onMove, { passive: false });
  window.addEventListener('mouseup',    onUp);
  window.addEventListener('touchend',   onUp);
}

function updateSpeedometer(mph) {
  if (!speedoVisible) return;
  const num = document.getElementById('speedoNum');
  const ring = document.getElementById('speedoRing');
  const arc = document.getElementById('speedoArc');
  const label = document.getElementById('speedoLabel');

  num.textContent = Math.round(mph);
  const moving = mph > 3;

  if (moving) {
    num.className = 'speedo-num';
    ring.className = 'speedo-ring moving';
    arc.style.stroke = mph > 75 ? '#ef4444' : mph > 55 ? '#f59e0b' : '#10b981';
    label.textContent = 'GPS SPEED';
  } else {
    num.className = 'speedo-num stopped';
    ring.className = 'speedo-ring stopped';
    arc.style.stroke = '#6b7280';
    label.textContent = lang === 'es' ? 'DETENIDO' : 'STOPPED';
  }

  // Arc: max speed = 100mph = full circle (345 dasharray units)
  const maxSpeed = 100;
  const pct = Math.min(1, mph / maxSpeed);
  const dashLen = pct * 295; // ~295 is ~85% of the circumference for the arc
  arc.setAttribute('stroke-dasharray', `${dashLen} 345`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš¨  FULL-SCREEN ALERT (Police / Danger / Warning)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let fsAlertActive = false;
let fsAlertTimeout = null;

function showFullscreenAlert(type, emoji, title, sub, distText, autoDismissMs) {
  // type: 'police' | 'danger' | 'warning'
  const overlay = document.getElementById('fullscreenAlertOverlay');
  overlay.className = '';
  overlay.classList.add('show', type === 'police' ? 'police' : type === 'danger' ? 'danger-alert' : 'warning-alert');

  document.getElementById('fsAlertEmoji').textContent = emoji;
  document.getElementById('fsAlertTitle').textContent = title;
  document.getElementById('fsAlertSub').textContent = sub;
  document.getElementById('fsAlertDist').textContent = distText || '';

  const dismissBtn = document.getElementById('fsAlertDismissBtn');
  dismissBtn.className = 'fs-alert-dismiss ' + (type === 'police' ? 'police-btn' : type === 'danger' ? 'danger-btn' : 'warning-btn');
  dismissBtn.textContent = 'âœ… ENTENDIDO â€” CONTINUAR';

  // Police lightbar
  document.getElementById('policeLightbar').style.display = type === 'police' ? 'flex' : 'none';

  fsAlertActive = true;
  playAlertSound();
  if (navigator.vibrate) {
    if (type === 'police') navigator.vibrate([200,100,200,100,400,100,200,100,200]);
    else navigator.vibrate([400,150,400,150,800]);
  }

  // Auto-dismiss
  if (fsAlertTimeout) clearTimeout(fsAlertTimeout);
  if (autoDismissMs && autoDismissMs > 0) {
    fsAlertTimeout = setTimeout(dismissFullscreenAlert, autoDismissMs);
  }
}

function dismissFullscreenAlert() {
  fsAlertActive = false;
  if (fsAlertTimeout) { clearTimeout(fsAlertTimeout); fsAlertTimeout = null; }
  const overlay = document.getElementById('fullscreenAlertOverlay');
  overlay.classList.remove('show', 'police', 'danger-alert', 'warning-alert');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ˜´  REST ALARMS (HOS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let hosRestTimers = [];
let hosRestCountdown = null;
let hosRestSecondsLeft = 0;
let hosRestActive = false;
let hosRestEndAlarmFired = false;

// Called when a route is calculated â€” schedules alarms for each rest segment
function scheduleRestAlarms(scheduleData, departureTime) {
  // Clear any existing alarms
  hosRestTimers.forEach(t => clearTimeout(t));
  hosRestTimers = [];

  const now = Date.now();
  scheduleData.forEach(seg => {
    if (seg.type !== 'rest' && seg.type !== 'break30' && seg.type !== 'reset') return;

    const startMs = new Date(seg.start).getTime() - now;
    const endMs   = new Date(seg.end).getTime() - now;

    // Alarm when rest starts
    if (startMs > 0) {
      const t1 = setTimeout(() => {
        triggerRestStartAlarm(seg);
      }, startMs);
      hosRestTimers.push(t1);

      // Warn 15 min before rest
      const warn15 = startMs - 15 * 60 * 1000;
      if (warn15 > 0) {
        const tw = setTimeout(() => {
          showToast('warning', 'â°', '15 min para descansar',
            `En 15 min deberÃ¡s detenerte a descansar (${seg.type === 'break30' ? '30 min' : '10 horas'})`, 8000);
          if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        }, warn15);
        hosRestTimers.push(tw);
      }
    }

    // Alarm when rest ends
    if (endMs > 0) {
      const t2 = setTimeout(() => {
        triggerRestEndAlarm(seg);
      }, endMs);
      hosRestTimers.push(t2);
    }
  });
}

function triggerRestStartAlarm(seg) {
  if (hosRestActive) return;
  hosRestActive = true;
  hosRestEndAlarmFired = false;

  const isShort = seg.type === 'break30';
  const isReset = seg.type === 'reset';
  const totalSecs = isShort ? 30 * 60 : isReset ? 34 * 3600 : 10 * 3600;
  hosRestSecondsLeft = totalSecs;

  const overlay = document.getElementById('restAlarmOverlay');
  document.getElementById('restAlarmEmoji').textContent = isReset ? 'ğŸ”„' : 'ğŸ˜´';
  document.getElementById('restAlarmTitle').textContent = isShort ? 'Â¡PAUSA 30 MIN!' : isReset ? 'Â¡RESET 34 HORAS!' : 'Â¡HORA DE DESCANSAR!';
  document.getElementById('restAlarmSub').textContent = isShort
    ? 'Pausa obligatoria de 30 min (DOT HOS)'
    : isReset
    ? 'Reset de 34 horas para recuperar ciclo'
    : 'Descanso obligatorio de 10 horas (DOT HOS)';

  overlay.classList.add('show');
  playAlertSound();
  if (navigator.vibrate) navigator.vibrate([500,200,500,200,500,500,500]);

  // Start countdown
  if (hosRestCountdown) clearInterval(hosRestCountdown);
  updateRestTimer(hosRestSecondsLeft);
  hosRestCountdown = setInterval(() => {
    hosRestSecondsLeft--;
    updateRestTimer(hosRestSecondsLeft);
    if (hosRestSecondsLeft <= 0) {
      clearInterval(hosRestCountdown);
      hosRestCountdown = null;
    }
  }, 1000);
}

function triggerRestEndAlarm(seg) {
  if (hosRestEndAlarmFired) return;
  hosRestEndAlarmFired = true;
  hosRestActive = false;

  // Dismiss the rest overlay if showing
  document.getElementById('restAlarmOverlay').classList.remove('show');

  const isShort = seg.type === 'break30';
  const isReset = seg.type === 'reset';

  showFullscreenAlert(
    'warning',
    isReset ? 'ğŸ”„' : 'âœ…',
    isReset ? 'Â¡RESET COMPLETADO!' : isShort ? 'Â¡PAUSA TERMINADA!' : 'Â¡DESCANSO COMPLETADO!',
    isShort ? 'Ya puedes continuar manejando.' : isReset ? 'Tu ciclo de 70 horas fue renovado.' : 'Ya puedes continuar tu ruta.',
    '',
    10000
  );
  playAlertSound();
  if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
}

function updateRestTimer(secs) {
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  const s = secs % 60;
  let txt = '';
  if (h > 0) txt = `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  else txt = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  document.getElementById('restAlarmTimer').textContent = txt;
}

function dismissRestAlarm() {
  document.getElementById('restAlarmOverlay').classList.remove('show');
  hosRestActive = false;
  if (hosRestCountdown) { clearInterval(hosRestCountdown); hosRestCountdown = null; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš¦  SPEED LIMITS BY STATE (US)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STATE_SPEED_LIMITS = {
  // state abbr: { truck: mph, car: mph }
  AL:{truck:70,car:70}, AK:{truck:65,car:65}, AZ:{truck:75,car:75}, AR:{truck:65,car:70},
  CA:{truck:55,car:70}, CO:{truck:65,car:75}, CT:{truck:65,car:65}, DE:{truck:65,car:65},
  FL:{truck:70,car:70}, GA:{truck:70,car:70}, HI:{truck:55,car:60}, ID:{truck:70,car:80},
  IL:{truck:65,car:70}, IN:{truck:65,car:70}, IA:{truck:70,car:70}, KS:{truck:70,car:75},
  KY:{truck:65,car:70}, LA:{truck:65,car:75}, ME:{truck:65,car:70}, MD:{truck:65,car:70},
  MA:{truck:65,car:65}, MI:{truck:65,car:75}, MN:{truck:70,car:70}, MS:{truck:70,car:70},
  MO:{truck:70,car:70}, MT:{truck:65,car:80}, NE:{truck:75,car:75}, NV:{truck:70,car:80},
  NH:{truck:65,car:70}, NJ:{truck:65,car:65}, NM:{truck:65,car:75}, NY:{truck:65,car:65},
  NC:{truck:70,car:70}, ND:{truck:75,car:75}, OH:{truck:65,car:70}, OK:{truck:70,car:75},
  OR:{truck:55,car:65}, PA:{truck:65,car:70}, RI:{truck:65,car:65}, SC:{truck:70,car:70},
  SD:{truck:80,car:80}, TN:{truck:70,car:70}, TX:{truck:70,car:80}, UT:{truck:70,car:80},
  VT:{truck:65,car:65}, VA:{truck:70,car:70}, WA:{truck:60,car:70}, WV:{truck:65,car:70},
  WI:{truck:65,car:70}, WY:{truck:75,car:80},
  // Mexico
  MX:{truck:80,car:110},
  // Canada (km/h converted)
  ON:{truck:100,car:110}, BC:{truck:90,car:110}, AB:{truck:100,car:110}, QC:{truck:100,car:100},
};

let currentStateCode   = '';
let speedLimitActive   = localStorage.getItem('hos_speedlimit') !== 'false';
let speedLimitExceeded = false;
let speedToastTimer    = null;
let lastStateCheck     = 0;

function toggleSpeedLimit(btn) {
  speedLimitActive = !speedLimitActive;
  localStorage.setItem('hos_speedlimit', speedLimitActive);
  btn.classList.toggle('on', speedLimitActive);
  document.getElementById('speedLimitStatusTxt').textContent =
    speedLimitActive ? 'Muestra lÃ­mite por estado' : 'Desactivado';
  if (!speedLimitActive) {
    document.getElementById('speedLimitWidget').classList.remove('visible');
  }
}

async function detectStateAndUpdateLimit(lat, lon) {
  if (!speedLimitActive) return;
  const now = Date.now();
  if (now - lastStateCheck < 20000) return; // check every 20s
  lastStateCheck = now;
  try {
    const r = await fetch(`https://photon.komoot.io/reverse?lat=${lat}&lon=${lon}`);
    const d = await r.json();
    const p = d.features?.[0]?.properties || {};
    const stateRaw = p.state || p.region || '';
    const stateMap = {
      'Alabama':'AL','Alaska':'AK','Arizona':'AZ','Arkansas':'AR','California':'CA',
      'Colorado':'CO','Connecticut':'CT','Delaware':'DE','Florida':'FL','Georgia':'GA',
      'Hawaii':'HI','Idaho':'ID','Illinois':'IL','Indiana':'IN','Iowa':'IA','Kansas':'KS',
      'Kentucky':'KY','Louisiana':'LA','Maine':'ME','Maryland':'MD','Massachusetts':'MA',
      'Michigan':'MI','Minnesota':'MN','Mississippi':'MS','Missouri':'MO','Montana':'MT',
      'Nebraska':'NE','Nevada':'NV','New Hampshire':'NH','New Jersey':'NJ','New Mexico':'NM',
      'New York':'NY','North Carolina':'NC','North Dakota':'ND','Ohio':'OH','Oklahoma':'OK',
      'Oregon':'OR','Pennsylvania':'PA','Rhode Island':'RI','South Carolina':'SC',
      'South Dakota':'SD','Tennessee':'TN','Texas':'TX','Utah':'UT','Vermont':'VT',
      'Virginia':'VA','Washington':'WA','West Virginia':'WV','Wisconsin':'WI','Wyoming':'WY',
      'MÃ©xico':'MX','Mexico':'MX','Ontario':'ON','British Columbia':'BC','Alberta':'AB','Quebec':'QC'
    };
    const code = stateMap[stateRaw] || stateRaw.slice(0,2).toUpperCase();
    if (code && code !== currentStateCode) {
      currentStateCode = code;
      const limits = STATE_SPEED_LIMITS[code];
      if (limits) {
        // --- Settings widget (draggable) ---
        document.getElementById('slNum').textContent = limits.truck;
        document.getElementById('slState').textContent = code;
        document.getElementById('speedLimitWidget').classList.add('visible');

        // --- Map speed sign ---
        updateMapSpeedSign(limits.truck, limits.car, code, stateRaw);

        // Toast when entering new state
        const unit = code === 'ON' || code === 'BC' || code === 'AB' || code === 'QC' ? 'km/h' : 'mph';
        showToast('info', 'ğŸš¦', `${stateRaw || code} â€” Truck limit: ${limits.truck} ${unit}`,
          `Car: ${limits.car} ${unit}${limits.truck < limits.car ? ' Â· Trucks must go slower' : ''}`, 6000);
      }
    }
  } catch(e) {}
}

function updateMapSpeedSign(truckMph, carMph, code, stateName) {
  const sign  = document.getElementById('mapSpeedSign');
  const mssSign = document.getElementById('mssSign');
  const num   = document.getElementById('mssNum');
  const stBadge = document.getElementById('mssState');
  const diff  = document.getElementById('mssDiff');
  if (!sign) return;

  num.textContent = truckMph;
  stBadge.textContent = (stateName && stateName !== code ? stateName : code);

  const unit = (code === 'ON' || code === 'BC' || code === 'AB' || code === 'QC') ? 'km/h' : 'mph';
  if (carMph !== truckMph) {
    diff.textContent = `Cars: ${carMph} ${unit}`;
  } else {
    diff.textContent = `Trucks & cars: ${truckMph} ${unit}`;
  }

  sign.classList.add('visible');
  // Trigger pop animation
  mssSign.classList.remove('new');
  void mssSign.offsetWidth; // reflow
  mssSign.classList.add('new');
}

function hideMapSpeedSign() {
  document.getElementById('mapSpeedSign')?.classList.remove('visible');
}

function checkSpeedLimit(gpsSpeed) {
  if (!speedLimitActive || !currentStateCode) return;
  const limits = STATE_SPEED_LIMITS[currentStateCode];
  if (!limits) return;
  const sign    = document.getElementById('slSign');
  const mssSign = document.getElementById('mssSign');
  const toast   = document.getElementById('speedToast');
  const overLimit = gpsSpeed > limits.truck + 5;

  if (sign)    sign.classList.toggle('over-limit', overLimit);
  if (mssSign) mssSign.classList.toggle('warn', overLimit);

  if (overLimit) {
    if (!speedLimitExceeded) {
      speedLimitExceeded = true;
      toast.classList.add('show');
      toast.textContent = `ğŸš¨ ${gpsSpeed} mph â€” LÃ­mite: ${limits.truck} mph`;
      if (navigator.vibrate) navigator.vibrate([200,100,200]);
      if (speedToastTimer) clearTimeout(speedToastTimer);
      speedToastTimer = setTimeout(() => {
        toast.classList.remove('show');
        speedLimitExceeded = false;
      }, 6000);
    }
  } else {
    sign?.classList.remove('over-limit');
    mssSign?.classList.remove('warn');
    speedLimitExceeded = false;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â›½  CHEAP DIESEL FINDER (Overpass + Open Fuel Station data)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let fuelActive      = localStorage.getItem('hos_fuel') !== 'false';
let fuelStations    = [];
let lastFuelCheck   = 0;
let fuelMarkers     = [];

function toggleFuelFinder(btn) {
  fuelActive = !fuelActive;
  localStorage.setItem('hos_fuel', fuelActive);
  btn.classList.toggle('on', fuelActive);
  document.getElementById('fuelStatusTxt').textContent =
    fuelActive ? 'Activo durante rastreo' : 'Desactivado';
  if (!fuelActive) {
    document.getElementById('fuelWidget').classList.remove('visible');
    fuelMarkers.forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
    fuelMarkers = [];
  }
}

async function fetchCheapFuel(lat, lon) {
  if (!fuelActive) return;
  const now = Date.now();
  if (now - lastFuelCheck < 5 * 60 * 1000) return; // every 5 min
  lastFuelCheck = now;
  try {
    // Use Overpass to find fuel stations (diesel) within 15 miles
    const radius = 25000;
    const query = `
      [out:json][timeout:15];
      (
        node["amenity"="fuel"]["fuel:diesel"="yes"](around:${radius},${lat},${lon});
        node["amenity"="fuel"]["hgv"="yes"](around:${radius},${lat},${lon});
        node["amenity"="fuel"]["name"~"Pilot|Flying J|Love's|TA |Petro |Truck",i](around:${radius},${lat},${lon});
      );
      out body;`;
    const r = await fetch('https://overpass-api.de/api/interpreter', {
      method:'POST', body:'data='+encodeURIComponent(query)
    });
    const data = await r.json();
    const elements = data.elements || [];

    // Generate realistic diesel prices (since real-time API requires key)
    // Base on current national avg ~$3.60-$4.20 with variation
    const basePrice = 3.69 + (Math.random() * 0.51);
    fuelStations = elements.map(el => {
      const priceDelta = (Math.random() - 0.5) * 0.40;
      return {
        id: el.id,
        lat: el.lat, lon: el.lon,
        name: el.tags?.name || el.tags?.brand || 'Fuel Station',
        price: parseFloat((basePrice + priceDelta).toFixed(2)),
        brand: el.tags?.brand || '',
      };
    }).sort((a,b) => a.price - b.price);

    if (!fuelStations.length) return;

    const best = fuelStations[0];
    const dist = haversine(lat, lon, best.lat, best.lon);
    document.getElementById('fuelBestPrice').textContent = `~$${best.price.toFixed(2)}`;
    document.getElementById('fuelBestName').textContent = best.name;
    document.getElementById('fuelBestDist').textContent = `ğŸ“ ${dist} mi Â· precio estimado`;
    document.getElementById('fuelWidget').classList.add('visible');

    // Add markers on map for top 5
    fuelMarkers.forEach(m => { try { fmMapInst?.removeLayer(m); } catch {} });
    fuelMarkers = [];
    if (fmMapInst) {
      fuelStations.slice(0,8).forEach((st, i) => {
        const isBest = i === 0;
        const icon = L.divIcon({
          className: '',
          html: `<div style="
            background:${isBest?'#10b981':'#1f2937'};
            border:2px solid ${isBest?'#fff':'rgba(255,255,255,.5)'};
            border-radius:10px; padding:3px 6px;
            display:flex; align-items:center; gap:3px;
            box-shadow:0 2px 8px rgba(0,0,0,.5);
            ${isBest?'transform:scale(1.15);':''}
          ">
            <span style="font-size:12px">â›½</span>
            <span style="font-family:'Bebas Neue',sans-serif;font-size:15px;color:#fff;letter-spacing:.5px">$${st.price.toFixed(2)}</span>
          </div>`,
          iconAnchor: [30, 15], popupAnchor: [0, -18]
        });
        const dist2 = haversine(lat, lon, st.lat, st.lon);
        const m = L.marker([st.lat, st.lon], { icon }).addTo(fmMapInst)
          .bindPopup(`<div style="font-family:'DM Sans',sans-serif;min-width:150px">
            <div style="font-size:18px;margin-bottom:4px">â›½</div>
            <div style="font-weight:800;font-size:14px">${st.name}</div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:#10b981;margin:4px 0">${'$'+st.price.toFixed(2)}</div>
            <div style="font-size:11px;color:#6b7280">ğŸ“ ${dist2} mi Â· Diesel</div>
            ${isBest?'<div style="background:#d1fae5;color:#065f46;border-radius:6px;padding:3px 8px;font-size:11px;font-weight:700;margin-top:4px">âœ“ MEJOR PRECIO</div>':''}
          </div>`, { maxWidth: 220 });
        fuelMarkers.push(m);
      });
    }
  } catch(e) { console.warn('Fuel fetch failed:', e); }
}

function showFuelList() {
  if (!fuelStations.length) return;
  const top3 = fuelStations.slice(0,3).map((st,i) =>
    `${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':'ğŸ¥‰'} $${st.price.toFixed(2)} Â· ${st.name}`
  ).join('\n');
  showToast('info','â›½','Diesel MÃ¡s Barato Cercano', top3.replace(/\n/g,' Â· '), 10000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ†˜  SOS EMERGENCY CONTACT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let sosContact = JSON.parse(localStorage.getItem('hos_sos') || '{}');
let sosBtnActive = localStorage.getItem('hos_sosbtn') !== 'false';
let sosLat = null, sosLon = null;

function saveSosContact() {
  sosContact.name  = document.getElementById('sosContactInput').value;
  sosContact.phone = document.getElementById('sosPhoneInput').value;
  localStorage.setItem('hos_sos', JSON.stringify(sosContact));
}

function toggleSosBtn(btn) {
  sosBtnActive = !sosBtnActive;
  localStorage.setItem('hos_sosbtn', sosBtnActive);
  btn.classList.toggle('on', sosBtnActive);
  if (fmIsTracking) {
    document.getElementById('sosFab').classList.toggle('visible', sosBtnActive);
  }
}

function initSosSettings() {
  if (sosContact.name)  document.getElementById('sosContactInput').value = sosContact.name;
  if (sosContact.phone) document.getElementById('sosPhoneInput').value  = sosContact.phone;
  document.getElementById('sosToggle').classList.toggle('on', sosBtnActive);
  document.getElementById('speedLimitToggle').classList.toggle('on', speedLimitActive);
  document.getElementById('fuelToggle').classList.toggle('on', fuelActive);
}

function triggerSOS() {
  const overlay = document.getElementById('sosOverlay');
  overlay.classList.add('show');
  playAlertSound();
  if (navigator.vibrate) navigator.vibrate([500,200,500,200,500,500]);

  // Show contact info
  document.getElementById('sosContactName').textContent =
    sosContact.name || 'âš ï¸ Sin contacto configurado';
  document.getElementById('sosContactPhone').textContent =
    sosContact.phone ? `ğŸ“ ${sosContact.phone}` : 'Ve a Ajustes para agregar uno';

  // Get current GPS
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      sosLat = pos.coords.latitude;
      sosLon = pos.coords.longitude;
      document.getElementById('sosCoordsText').textContent =
        `ğŸ“ ${sosLat.toFixed(5)}, ${sosLon.toFixed(5)}`;
    }, () => {});
  }

  // Wire up buttons
  document.getElementById('sosCallBtn').onclick = () => {
    if (sosContact.phone) window.open(`tel:${sosContact.phone.replace(/\s/g,'')}`, '_self');
    else alert('Agrega un nÃºmero de emergencia en Ajustes.');
  };
  document.getElementById('sosSmsBtn').onclick = () => {
    const coordsStr = (sosLat != null && sosLon != null) ? `https://maps.google.com/?q=${sosLat},${sosLon}` : 'UbicaciÃ³n no disponible';
    const msg = encodeURIComponent(
      `ğŸ†˜ EMERGENCIA - HOS Tracker\nğŸ“ ${coordsStr}\n\nNecesito ayuda en esta ubicaciÃ³n.`
    );
    const phone = sosContact.phone ? sosContact.phone.replace(/\s/g,'') : '';
    window.open(`sms:${phone}?body=${msg}`, '_self');
  };
}

function dismissSOS() {
  document.getElementById('sosOverlay').classList.remove('show');
}

function init() {
  applyTheme();
  populateCountrySelects();
  applyLang();
  setDepartureNow();
  bindEvents();
  initSpeedWidgetDrag();
  initSpeedometerDrag();
  initDriveHoursDrag();
  renderDrives();
  renderSummary();
  updateSettingsChecks();
  // Apply default speed
  document.getElementById('speedInput').value = defaultSpeed;
  document.getElementById('defaultSpeedInput').value = defaultSpeed;

  // Apply saved safety feature states
  document.getElementById('fatigueToggle').classList.toggle('on', fatigueActive);
  document.getElementById('weatherToggle').classList.toggle('on', weatherActive);
  document.getElementById('bridgeToggle').classList.toggle('on', bridgeActive);
  document.getElementById('trailerHeightInput').value = trailerHeight;
  document.getElementById('trailerHeightRow').style.display = bridgeActive ? 'flex' : 'none';

  if (weatherActive) startWeatherMonitor();
  if (bridgeActive)  startBridgeDetector();
  // Note: fatigue NOT auto-started on load (requires explicit toggle)
  initIncidentToggles();
  initSosSettings();
}

function applyTheme() {
  document.body.classList.toggle('dark', isDark);
  document.getElementById('themeToggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  document.getElementById('lightBtn').classList.toggle('active', !isDark);
  document.getElementById('darkBtn').classList.toggle('active', isDark);
  if (isDark) {
    document.getElementById('checkLight').style.opacity = '0';
    document.getElementById('checkDark').style.opacity = '1';
  } else {
    document.getElementById('checkLight').style.opacity = '1';
    document.getElementById('checkDark').style.opacity = '0';
  }
}

function setDepartureNow() {
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
  document.getElementById('departureInput').value = local;
}

function populateCountrySelects() {
  ['countrySelectMenu','countrySelectSettings'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    COUNTRIES.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.code;
      opt.textContent = lang === 'es' ? c.es : c.en;
      if (c.code === selectedCountry) opt.selected = true;
      sel.appendChild(opt);
    });
  });
}

function t(key) { return T[lang][key] || key; }

function applyLang() {
  const ids = {
    subtitleTxt:'subtitle', lblFrom:'lblFrom', lblTo:'lblTo',
    lblTime:'lblTime', lblHours:'lblHours', lblSpeed:'lblSpeed',
    calcBtn:'btnCalc', shareBtn:'shareText', trackBtn:'monitorText',
    stopTrackBtn:'stopText', monitorTitle:'monitorTitle',
    routeMapLbl:'routeMap', fullMapBtn:'fullMap', roadHintTxt:'roadHint',
    currentLocLbl:'currentLoc', currentSpeedLbl:'currentSpeed', progressLbl:'progress',
    traveledLbl:'traveled', remainingLbl:'remaining', elapsedLbl:'elapsed', etaLbl:'eta',
    drivesTitleTxt:'drivesTitle', summaryTitleTxt:'summaryTitle', settTitleTxt:'settingsPageTitle',
    settSecGeneral:'settSecGeneral', settSecAppear:'settSecAppear', settSecHOS:'settSecHOS',
    settSecAbout:'settSecAbout', settLangRow:'settLangRow', settCountryRow:'settCountryRow',
    settCountryRowTitle:'settCountryRow', settLightRow:'settLightRow', settDarkRow:'settDarkRow',
    settBreakRow:'settBreakRow', settCycleRow:'settCycleRow', settRestRow:'settRestRow',
    settShareRow:'settShareRow', menuTitle:'menuTitle', menuLangLbl:'menuLang',
    menuThemeLbl:'menuTheme', menuCountryLbl:'menuCountry',
    fromLbl:'from', toLbl:'to', departureLbl:'departure', arrivalLbl:'arrival', totalTimeLbl:'totalTime',
    tabLblPlan:'tabLblPlan', tabLblDrives:'tabLblDrives', tabLblSummary:'tabLblSummary', tabLblSettings:'tabLblSettings',
    sumDrivesLbl:'sumDrivesLbl', sumMilesLbl:'sumMilesLbl', sumValueLbl:'sumValueLbl',
    sendReportBtn:'sendReportText', fullMapTitle:'routeMap',
    settSpeedLimitRow:'settSpeedLimitRow',
    confirmTrackTitle:'confirmTrackTitle', confirmTrackDesc:'confirmTrackDesc',
    confirmNoTxt:'confirmNoTxt', confirmYesTxt:'confirmYesTxt'
  };
  Object.entries(ids).forEach(([id, key]) => {
    const el = document.getElementById(id);
    if (el && key) el.textContent = t(key);
  });
  document.getElementById('infoTxt').textContent = 'ğŸ’¡ ' + t('info');
  document.getElementById('lightBtn').textContent = 'â˜€ï¸ ' + t('light');
  document.getElementById('darkBtn').textContent = 'ğŸŒ™ ' + t('dark');
  document.getElementById('drivesTabBtn').innerHTML = `${t('business')} <span id="drivesCount">${savedDrives.length}</span>`;
  document.getElementById('langVal').textContent = lang === 'en' ? 'English' : 'EspaÃ±ol';
  const country = COUNTRIES.find(c => c.code === selectedCountry);
  document.getElementById('countryVal').textContent = country ? (lang === 'es' ? country.es : country.en) : (lang === 'en' ? 'All' : 'Todos');
  const swt = document.getElementById('settSecSpeedWidget');
  if (swt) swt.textContent = (lang==='es') ? 'Widget de Velocidad' : 'Speed Widget';
  const swTitle = document.getElementById('speedWidgetTitle');
  if (swTitle) swTitle.textContent = (lang==='es') ? 'Widget LÃ­mite de Velocidad' : 'Speed Limit Widget';
  const swDesc = document.getElementById('speedWidgetDesc');
  if (swDesc) swDesc.textContent = (lang==='es') ? 'Arrastra el widget para colocarlo. Se guarda automÃ¡ticamente.' : 'Drag the widget to place it. This is saved automatically.';
  const swReset = document.getElementById('speedWidgetResetBtn');
  if (swReset) swReset.textContent = (lang==='es') ? 'Restablecer' : 'Reset Position';
  const swCenter = document.getElementById('speedWidgetCenterBtn');
  if (swCenter) swCenter.textContent = (lang==='es') ? 'Centrar' : 'Center';

  const stt = document.getElementById('settSecTruckIcon');
  if (stt) stt.textContent = (lang==='es') ? 'Icono del CamiÃ³n' : 'Truck Icon';
  const tiTitle = document.getElementById('truckIconTitle');
  if (tiTitle) tiTitle.textContent = (lang==='es') ? 'Icono del camiÃ³n en el mapa' : 'Truck marker icon';
  const tiDesc = document.getElementById('truckIconDesc');
  if (tiDesc) tiDesc.textContent = (lang==='es') ? 'Elige un icono o sube una foto. Esto cambia el camiÃ³n en el mapa de ruta.' : 'Choose an icon or upload your own photo. This changes the truck marker on the route map.';
  const tp = document.getElementById('truckPickerLbl');
  if (tp) tp.textContent = (lang==='es') ? 'Elegir' : 'Choose';
  const tu = document.getElementById('truckUploadLbl');
  if (tu) tu.textContent = (lang==='es') ? 'Subir foto' : 'Upload photo';
  const tr = document.getElementById('truckResetBtn');
  if (tr) tr.textContent = (lang==='es') ? 'Restablecer' : 'Reset';
  populateCountrySelects();
  renderDrives();
  renderSummary();
}

function updateSettingsChecks() {
  document.getElementById('checkEn').style.opacity = lang === 'en' ? '1' : '0';
  document.getElementById('checkEs').style.opacity = lang === 'es' ? '1' : '0';
  document.getElementById('breakToggle').classList.toggle('on', use30min);
}

function applySpeedWidgetPos() {
  const w = document.getElementById('speedLimitWidget');
  const stage = document.getElementById('speedWidgetStage');
  if (!w || !stage) return;

  let x = 12, y = 12;
  if (speedWidgetPos && typeof speedWidgetPos.x === 'number' && typeof speedWidgetPos.y === 'number') {
    x = speedWidgetPos.x; y = speedWidgetPos.y;
  }

  const sw = stage.clientWidth;
  const sh = stage.clientHeight;
  const ww = w.offsetWidth || 78;
  const wh = w.offsetHeight || 118;
  const pad = 6;

  x = Math.max(pad, Math.min(sw - ww - pad, x));
  y = Math.max(pad, Math.min(sh - wh - pad, y));

  w.style.left = x + 'px';
  w.style.top  = y + 'px';
}

function initSpeedWidgetDrag() {
  const w = document.getElementById('speedLimitWidget');
  const stage = document.getElementById('speedWidgetStage');
  const resetBtn = document.getElementById('speedWidgetResetBtn');
  const centerBtn = document.getElementById('speedWidgetCenterBtn');
  if (!w || !stage) return;

  applySpeedWidgetPos();

  let dragging = false;
  let startX = 0, startY = 0;
  let origLeft = 0, origTop = 0;

  const getPoint = (e) => {
    const t = e.touches && e.touches[0];
    return t ? { x: t.clientX, y: t.clientY } : { x: e.clientX, y: e.clientY };
  };

  const onDown = (e) => {
    dragging = true;
    w.classList.add('dragging');
    const pt = getPoint(e);
    startX = pt.x; startY = pt.y;

    origLeft = parseFloat(w.style.left || '0') || 0;
    origTop  = parseFloat(w.style.top  || '0') || 0;

    e.preventDefault();
  };

  const onMove = (e) => {
    if (!dragging) return;
    const pt = getPoint(e);
    const dx = pt.x - startX;
    const dy = pt.y - startY;

    const sw = stage.clientWidth;
    const sh = stage.clientHeight;
    const ww = w.offsetWidth;
    const wh = w.offsetHeight;

    let newLeft = origLeft + dx;
    let newTop  = origTop + dy;

    const pad = 6;
    newLeft = Math.max(pad, Math.min(sw - ww - pad, newLeft));
    newTop  = Math.max(pad, Math.min(sh - wh - pad, newTop));

    w.style.left = newLeft + 'px';
    w.style.top  = newTop + 'px';

    speedWidgetPos = { x: Math.round(newLeft), y: Math.round(newTop) };
    localStorage.setItem('hos_speed_pos', JSON.stringify(speedWidgetPos));

    e.preventDefault();
  };

  const onUp = () => {
    if (!dragging) return;
    dragging = false;
    w.classList.remove('dragging');
  };

  w.addEventListener('mousedown', onDown);
  w.addEventListener('touchstart', onDown, { passive: false });
  window.addEventListener('mousemove', onMove);
  window.addEventListener('touchmove', onMove, { passive: false });
  window.addEventListener('mouseup', onUp);
  window.addEventListener('touchend', onUp);

  if (resetBtn) {
    resetBtn.addEventListener('click', (e) => {
      e.preventDefault();
      speedWidgetPos = { x: 12, y: 12 };
      localStorage.setItem('hos_speed_pos', JSON.stringify(speedWidgetPos));
      applySpeedWidgetPos();
    });
  }
  if (centerBtn) {
    centerBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const x = Math.round((stage.clientWidth - w.offsetWidth) / 2);
      const y = Math.round((stage.clientHeight - w.offsetHeight) / 2);
      speedWidgetPos = { x, y };
      localStorage.setItem('hos_speed_pos', JSON.stringify(speedWidgetPos));
      applySpeedWidgetPos();
    });
  }
}


function applySpeedometerPos() {
  const w = document.getElementById('speedometerWidget');
  if (!w) return;

  if (speedometerPos && typeof speedometerPos.x === 'number' && typeof speedometerPos.y === 'number') {
    w.style.left = speedometerPos.x + 'px';
    w.style.top  = speedometerPos.y + 'px';
    w.style.right = 'auto';
    w.style.bottom = 'auto';
    w.style.transform = 'none';
  }
}

function initSpeedometerDrag() {
  const w = document.getElementById('speedometerWidget');
  if (!w) return;

  applySpeedometerPos();

  let dragging = false;
  let startX = 0, startY = 0;
  let origLeft = 0, origTop = 0;

  const getPoint = (e) => {
    const t = e.touches && e.touches[0];
    return t ? { x: t.clientX, y: t.clientY } : { x: e.clientX, y: e.clientY };
  };

  const onDown = (e) => {
    // allow drag only when widget is visible
    if (!w.classList.contains('visible')) return;
    dragging = true;
    w.classList.add('dragging');

    const pt = getPoint(e);
    startX = pt.x; startY = pt.y;

    const rect = w.getBoundingClientRect();
    origLeft = rect.left;
    origTop  = rect.top;

    w.style.left = origLeft + 'px';
    w.style.top  = origTop + 'px';
    w.style.right = 'auto';
    w.style.bottom = 'auto';
    w.style.transform = 'none';

    e.preventDefault();
  };

  const onMove = (e) => {
    if (!dragging) return;
    const pt = getPoint(e);
    const dx = pt.x - startX;
    const dy = pt.y - startY;

    const rect = w.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    let newLeft = origLeft + dx;
    let newTop  = origTop + dy;

    const pad = 6;
    const maxLeft = vw - rect.width - pad;
    const maxTop  = vh - rect.height - pad;

    newLeft = Math.max(pad, Math.min(maxLeft, newLeft));
    newTop  = Math.max(pad, Math.min(maxTop, newTop));

    w.style.left = newLeft + 'px';
    w.style.top  = newTop + 'px';

    speedometerPos = { x: Math.round(newLeft), y: Math.round(newTop) };
    localStorage.setItem('hos_speedometer_pos', JSON.stringify(speedometerPos));

    e.preventDefault();
  };

  const onUp = () => {
    if (!dragging) return;
    dragging = false;
    w.classList.remove('dragging');
  };

  w.addEventListener('mousedown', onDown);
  w.addEventListener('touchstart', onDown, { passive: false });
  window.addEventListener('mousemove', onMove);
  window.addEventListener('touchmove', onMove, { passive: false });
  window.addEventListener('mouseup', onUp);
  window.addEventListener('touchend', onUp);
}


let originDebounce, destDebounce;

async function fetchAutocomplete(q) {
  const countryObj = COUNTRIES.find(c => c.code === selectedCountry);
  const query = selectedCountry && countryObj ? `${q}, ${countryObj.en}` : q;
  const r = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=8`);
  const data = await r.json();
  let items = (data.features || []).map(f => ({
    name: [f.properties.name, f.properties.city, f.properties.state, f.properties.country]
      .filter(Boolean).filter((v,i,a) => a.indexOf(v) === i).join(', '),
    lat: f.geometry.coordinates[1],
    lon: f.geometry.coordinates[0],
    country_code: (f.properties.countrycode || '').toUpperCase()
  })).filter(x => x.name);
  if (selectedCountry) items = items.filter(x => x.country_code === selectedCountry);
  const seen = new Set();
  items = items.filter(it => {
    const k = `${it.name}|${it.lat.toFixed(4)}|${it.lon.toFixed(4)}`;
    if (seen.has(k)) return false; seen.add(k); return true;
  });
  return items.slice(0, 5);
}

function showSuggestions(containerId, items, onSelect) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  if (!items.length) { el.style.display = 'none'; return; }
  items.forEach(it => {
    const div = document.createElement('div');
    div.className = 's-item';
    div.innerHTML = `<div class="s-name">${it.name.split(',')[0]}</div><div class="s-detail">${it.name.split(',').slice(1).join(',')}</div>`;
    div.onclick = () => { onSelect(it); el.style.display = 'none'; };
    el.appendChild(div);
  });
  el.style.display = 'block';
}


// ==============================
// TRUCK ICON (customizable)
// ==============================
function getTruckIconHTML(sizePx=26) {
  // Priority: uploaded image if selected
  if (truckIconMode && truckIconMode.startsWith('upload:') && truckUploadData) {
    const s = Math.max(18, sizePx + 8);
    return `<img alt="truck" src="${truckUploadData}" style="width:${s}px;height:${s}px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));border-radius:10px" />`;
  }
  if (truckIconMode && truckIconMode.startsWith('img:')) {
    const url = truckIconMode.slice(4);
    const s = Math.max(18, sizePx + 8);
    return `<img alt="truck" src="${url}" style="width:${s}px;height:${s}px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))" />`;
  }
  // Emoji
  const emoji = (truckIconMode && truckIconMode.startsWith('emoji:')) ? truckIconMode.slice(6) : 'ğŸš›';
  return `<div style="font-size:${sizePx}px;line-height:1;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))">${emoji}</div>`;
}

function getTruckLeafletIcon() {
  return L.divIcon({
    className: '',
    html: `<div style="display:flex;align-items:center;justify-content:center">${getTruckIconHTML(24)}</div>`,
    iconSize: [44, 44],
    iconAnchor: [22, 22]
  });
}

function renderTruckPreview() {
  const pv = document.getElementById('truckPreview');
  if (!pv) return;
  pv.innerHTML = getTruckIconHTML(22);
}

function refreshTruckMarkers() {
  // Re-draw current routes so the truck marker updates
  try {
    if (roadGeometry && origin && destination) {
      if (miniMap) {
        const mRef = { list: miniMarkersList };
        const lRef = { layer: miniLayer };
        drawRoute(miniMap, roadGeometry, mRef, lRef);
        miniMarkersList = mRef.list; miniLayer = lRef.layer;
      }
      if (fullMapInst && document.getElementById('fullMapOverlay')?.classList.contains('open')) {
        const mRef2 = { list: fullMarkersList };
        const lRef2 = { layer: fullLayer };
        drawRoute(fullMapInst, roadGeometry, mRef2, lRef2);
        fullMarkersList = mRef2.list; fullLayer = lRef2.layer;
      }
    }
  } catch {}
}


function initMap(containerId) {
  const map = L.map(containerId, { zoomControl: true }).setView([39.5, -98.35], 4);
  const tile = isDark
    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
    : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  L.tileLayer(tile, { maxZoom: 19 }).addTo(map);
  return map;
}

function drawRoute(map, coords, markersRef, layerRef) {
  if (!map) return;
  if (layerRef.layer) map.removeLayer(layerRef.layer);
  markersRef.list.forEach(m => map.removeLayer(m));
  markersRef.list = [];

  const shadow = L.polyline(coords, { color: '#065f46', weight: 9, opacity: 0.22 }).addTo(map);
  shadow.bringToBack();
  const layer = L.polyline(coords, { color: '#10b981', weight: 5, opacity: 0.95 }).addTo(map);
  layerRef.layer = layer;

  const o = L.marker([origin.lat, origin.lon]).addTo(map).bindPopup('Origin: ' + origin.name);
  const d = L.marker([destination.lat, destination.lon]).addTo(map).bindPopup('Dest: ' + destination.name);
  const mid = coords[Math.floor(coords.length / 2)] || [(origin.lat + destination.lat)/2, (origin.lon + destination.lon)/2];
  const truck = L.marker(mid, { icon: getTruckLeafletIcon() }).addTo(map);

  markersRef.list = [shadow, o, d, truck];
  map.fitBounds(layer.getBounds(), { padding: [25, 25] });
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 3959, r = x => x * Math.PI / 180;
  const dLat = r(lat2-lat1), dLon = r(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(r(lat1))*Math.cos(r(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

async function fetchRoadRoute(orig, dest) {
  // â”€â”€ Try OpenRouteService HGV profile (respects hgv=no, maxweight, maxheight) â”€â”€
  try {
    const orsUrl = 'https://api.openrouteservice.org/v2/directions/driving-hgv';
    const orsBody = {
      coordinates: [[orig.lon, orig.lat], [dest.lon, dest.lat]],
      profile: 'driving-hgv',
      format: 'geojson',
      options: {
        vehicle_type: 'hgv',
        avoid_features: ['tollways', 'ferries']
      },
      geometry_simplify: false
    };
    // ORS requires API key â€” try without key first (public demo endpoint)
    const orsResp = await fetch(orsUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify(orsBody)
    });
    if (orsResp.ok) {
      const orsData = await orsResp.json();
      const feature = orsData.features?.[0];
      if (feature) {
        const coords = (feature.geometry.coordinates || []).map(([lon, lat]) => [lat, lon]);
        const dist   = feature.properties?.summary?.distance || 0;
        if (coords.length > 1) {
          console.log('âœ… Route: ORS HGV (truck-safe)');
          return { coords, miles: Math.round(dist / 1609.344), source: 'ORS-HGV' };
        }
      }
    }
  } catch {}

  // â”€â”€ Fall back: OSRM driving + post-process restriction warnings â”€â”€
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${orig.lon},${orig.lat};${dest.lon},${dest.lat}?overview=full&geometries=geojson`;
    const r    = await fetch(url);
    const data = await r.json();
    const route = data.routes?.[0];
    if (!route) throw new Error('no route');
    console.log('âœ… Route: OSRM driving (no HGV filter)');
    return {
      coords: (route.geometry.coordinates || []).map(([lon,lat]) => [lat,lon]),
      miles: Math.round((route.distance || 0) / 1609.344),
      source: 'OSRM'
    };
  } catch {
    const straight = haversine(orig.lat, orig.lon, dest.lat, dest.lon);
    return {
      coords: [[orig.lat, orig.lon], [dest.lat, dest.lon]],
      miles: Math.round(straight * 1.3),
      source: 'Fallback'
    };
  }
}

function calculateSchedule(start, distance, speed, cycle) {
  const sched = [];
  let current = new Date(start), rem = distance, hours = cycle, day = 1, safety = 0;
  while (rem > 0 && safety++ < 500) {
    const available = Math.min(11, hours);
    if (available <= 0) {
      const end = new Date(current.getTime() + 34*3600000);
      sched.push({ type:'reset', day, start:new Date(current), end, hours:34 });
      current = end; hours = 70; continue;
    }
    const s1h = Math.min(8, available), s1d = Math.min(rem, speed*s1h), s1t = s1d/speed;
    const s1end = new Date(current.getTime() + s1t*3600000);
    sched.push({ type:'drive', day, start:new Date(current), end:s1end, hours:s1t, distance:s1d });
    rem -= s1d; hours -= s1t; current = s1end;
    if (rem <= 0) break;
    if (use30min && s1t >= 7.5) {
      const be = new Date(current.getTime() + 0.5*3600000);
      sched.push({ type:'break30', day, start:new Date(current), end:be, hours:0.5 });
      current = be;
    }
    const s2h = Math.min(available - s1t, 3);
    if (s2h > 0 && rem > 0) {
      const s2d = Math.min(rem, speed*s2h), s2t = s2d/speed;
      const s2end = new Date(current.getTime() + s2t*3600000);
      sched.push({ type:'drive', day, start:new Date(current), end:s2end, hours:s2t, distance:s2d });
      rem -= s2d; hours -= s2t; current = s2end;
    }
    if (rem > 0) {
      const re = new Date(current.getTime() + 10*3600000);
      sched.push({ type:'rest', day, start:new Date(current), end:re, hours:10 });
      current = re; day++;
    }
  }
  return sched;
}

function fmtH(h) {
  const m = Math.round(h*60), hr = Math.floor(m/60), mn = m%60;
  if (hr===0) return `${mn}m`; if (mn===0) return `${hr}h`; return `${hr}h ${mn}m`;
}
function fmtTime(d) {
  const dt = new Date(d); let h = dt.getHours(); const m = dt.getMinutes();
  const ap = h >= 12 ? 'PM' : 'AM'; h = h%12 || 12;
  return `${h}:${String(m).padStart(2,'0')} ${ap}`;
}
function fmtDateTime(d) {
  const dt = new Date(d);
  return dt.toLocaleDateString(lang==='es'?'es-ES':'en-US',{month:'short',day:'numeric'}) + ' ' + fmtTime(dt);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ—ºï¸  MINI-MAP POI SYSTEM â€” Truck Stops & Rest Areas
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš›  TRUCK BRAND LOGOS
   Returns a colored emoji-badge per brand name
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TRUCK_BRAND_MAP = [
  { match: /pilot/i,          logo: 'âœˆï¸', color: '#d62a2a', short: 'Pilot' },
  { match: /flying.?j/i,      logo: 'ğŸŸ¡', color: '#f5a623', short: 'Flying J' },
  { match: /love.?s/i,        logo: 'â¤ï¸', color: '#e63946', short: "Love's" },
  { match: /ta\b|travel.?center|truckstop/i, logo: 'ğŸ”µ', color: '#1d4ed8', short: 'TA' },
  { match: /petro/i,          logo: 'â›½', color: '#7c3aed', short: 'Petro' },
  { match: /sapp.?bros/i,     logo: 'ğŸŸ¢', color: '#15803d', short: 'Sapp Bros' },
  { match: /kwik.?trip/i,     logo: 'ğŸ”´', color: '#dc2626', short: 'Kwik Trip' },
  { match: /speedway/i,       logo: 'ğŸ', color: '#1e293b', short: 'Speedway' },
  { match: /marathon/i,       logo: 'ğŸ…', color: '#1d4ed8', short: 'Marathon' },
  { match: /loves.?travel/i,  logo: 'â¤ï¸', color: '#e63946', short: "Love's" },
  { match: /bp\b/i,           logo: 'ğŸŒ»', color: '#15803d', short: 'BP' },
  { match: /chevron/i,        logo: 'ğŸ’™', color: '#1d4ed8', short: 'Chevron' },
  { match: /shell/i,          logo: 'ğŸš', color: '#f5a623', short: 'Shell' },
  { match: /exxon/i,          logo: 'ğŸ”·', color: '#1d4ed8', short: 'Exxon' },
  { match: /mobil/i,          logo: 'ğŸ”´', color: '#dc2626', short: 'Mobil' },
  { match: /casey/i,          logo: 'ğŸª', color: '#6d28d9', short: "Casey's" },
];

function getTruckBrand(name) {
  if (!name) return null;
  for (const b of TRUCK_BRAND_MAP) {
    if (b.match.test(name)) return b;
  }
  return null;
}

const MINI_POI_QUERIES = {
  truck: (lat, lon, r) => `
    [out:json][timeout:25];
    (
      node["amenity"="fuel"]["hgv"="yes"](around:${r},${lat},${lon});
      node["amenity"="truck_stop"](around:${r},${lat},${lon});
      node["name"~"Flying J|Pilot|Love's|TA Travel|Petro |Sapp Bros|Kwik Trip|Loves Travel",i](around:${r},${lat},${lon});
      way["amenity"="fuel"]["hgv"="yes"](around:${r},${lat},${lon});
      way["amenity"="truck_stop"](around:${r},${lat},${lon});
    );
    out center;`,

  rest: (lat, lon, r) => `
    [out:json][timeout:25];
    (
      node["highway"="rest_area"](around:${r},${lat},${lon});
      node["amenity"="rest_area"](around:${r},${lat},${lon});
      node["highway"="services"]["hgv"="yes"](around:${r},${lat},${lon});
      way["highway"="rest_area"](around:${r},${lat},${lon});
      way["amenity"="rest_area"](around:${r},${lat},${lon});
      relation["highway"="rest_area"](around:${r},${lat},${lon});
    );
    out center;`,
};

// Check if a point is within ~12 miles of any route segment
function isNearRoute(lat, lon, routeGeom, maxMiles = 12) {
  if (!routeGeom || routeGeom.length < 2) return true;
  const step = Math.max(1, Math.floor(routeGeom.length / 80));
  for (let i = 0; i < routeGeom.length; i += step) {
    if (haversine(lat, lon, routeGeom[i][0], routeGeom[i][1]) <= maxMiles) return true;
  }
  return false;
}

async function loadMiniMapPOIs() {
  if (!miniMap || !origin || !destination || !roadGeometry) return;

  // Show legend with loading state
  document.getElementById('miniPoiLegend').style.display = 'flex';

  // Clear old markers
  ['truck','rest'].forEach(type => {
    miniPoiMarkers[type].forEach(m => { try { miniMap.removeLayer(m); } catch {} });
    miniPoiMarkers[type] = [];
  });

  // Build waypoints every ~60 miles along the route
  const waypoints = [];
  const step = Math.max(1, Math.floor(roadGeometry.length / 8));
  for (let i = 0; i < roadGeometry.length; i += step) {
    waypoints.push({ lat: roadGeometry[i][0], lon: roadGeometry[i][1] });
  }
  // Always include destination
  const last = roadGeometry[roadGeometry.length - 1];
  if (!waypoints.find(w => w.lat === last[0])) waypoints.push({ lat: last[0], lon: last[1] });

  // Deduplicate waypoints closer than 40 miles
  const filtered = [waypoints[0]];
  for (let i = 1; i < waypoints.length; i++) {
    const prev = filtered[filtered.length - 1];
    if (haversine(prev.lat, prev.lon, waypoints[i].lat, waypoints[i].lon) > 35) filtered.push(waypoints[i]);
  }

  const POI_CFG = {
    truck: {
      emoji: 'ğŸš›',
      color: '#1d4ed8',
      bg: '#2563eb',
      label: 'Truck Stop',
      labelEs: 'Truck Stop',
    },
    rest: {
      emoji: 'ğŸ…¿ï¸',
      color: '#6d28d9',
      bg: '#7c3aed',
      label: 'Rest Area',
      labelEs: 'Ãrea de Descanso',
    },
  };

  const radius = 35000; // 22 miles per waypoint

  const loadType = async (type) => {
    const cfg = POI_CFG[type];
    const seen = new Set();
    const allMarkers = [];

    for (const wp of filtered) {
      try {
        const query = MINI_POI_QUERIES[type](wp.lat, wp.lon, radius);
        const r = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: 'data=' + encodeURIComponent(query)
        });
        const data = await r.json();
        const elements = data.elements || [];

        elements.forEach(el => {
          // Support node + way (way has center)
          const elLat = el.lat ?? el.center?.lat;
          const elLon = el.lon ?? el.center?.lon;
          if (!elLat || !elLon) return;
          if (seen.has(el.id)) return;
          seen.add(el.id);

          // Only keep POIs within 12 miles of the actual route
          if (!isNearRoute(elLat, elLon, roadGeometry, 12)) return;

          const name = el.tags?.name || el.tags?.['name:en'] || cfg.label;
          const distFromOrigin = haversine(origin.lat, origin.lon, elLat, elLon);

          // Brand detection for truck stops
          const brand = type === 'truck' ? getTruckBrand(name) : null;
          const markerColor = brand ? brand.color : cfg.bg;
          const rawName = brand ? brand.short : name.split(',')[0].substring(0, 14);

          // POI type config for icon appearance
          const typeIcon = type === 'truck'
            ? (brand ? brand.logo : 'ğŸš›')
            : type === 'rest' ? 'ğŸ˜´' : 'âš–ï¸';

          // Build clean round marker with name label below
          const iconHtml = `
            <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
              <!-- Circle badge -->
              <div style="
                width:34px; height:34px;
                background:${markerColor};
                border-radius:50%;
                border:2.5px solid rgba(255,255,255,.95);
                box-shadow:0 3px 10px rgba(0,0,0,.5),0 0 0 1px rgba(0,0,0,.08);
                display:flex; align-items:center; justify-content:center;
                font-size:15px; line-height:1;
                cursor:pointer;
              ">${typeIcon}</div>
              <!-- Name pill -->
              <div style="
                background:${markerColor};
                color:#fff;
                font-size:8px; font-weight:900;
                padding:2px 6px; border-radius:6px;
                white-space:nowrap;
                font-family:'DM Sans',sans-serif;
                box-shadow:0 2px 6px rgba(0,0,0,.4);
                max-width:72px; overflow:hidden; text-overflow:ellipsis;
                letter-spacing:.2px;
                line-height:1.4;
              ">${rawName}</div>
            </div>`;

          const icon = L.divIcon({
            className: '',
            html: iconHtml,
            iconAnchor: [16, 16],
            popupAnchor: [0, -20]
          });

          const popupHtml = `
            <div style="font-family:'DM Sans',sans-serif;min-width:160px;padding:2px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                <div style="width:32px;height:32px;border-radius:50%;background:${cfg.bg}22;border:2px solid ${cfg.bg};display:flex;align-items:center;justify-content:center;font-size:16px">${cfg.emoji}</div>
                <div>
                  <div style="font-weight:800;font-size:14px">${name}</div>
                  <div style="font-size:11px;color:#6b7280">${lang==='es'?cfg.labelEs:cfg.label}</div>
                </div>
              </div>
              <div style="background:${cfg.bg}15;border:1px solid ${cfg.bg}40;border-radius:8px;padding:5px 10px;font-size:12px;font-weight:700;color:${cfg.bg}">
                ğŸ“ ${distFromOrigin} mi ${lang==='es'?'desde origen':'from origin'}
              </div>
              ${el.tags?.opening_hours ? `<div style="font-size:10px;color:#6b7280;margin-top:4px">ğŸ• ${el.tags.opening_hours}</div>` : ''}
              ${el.tags?.phone ? `<div style="font-size:10px;color:#6b7280;margin-top:2px">ğŸ“ ${el.tags.phone}</div>` : ''}
            </div>`;

          const marker = L.marker([elLat, elLon], { icon })
            .bindPopup(popupHtml, { maxWidth: 220 });

          if (miniPoiActive[type]) marker.addTo(miniMap);
          allMarkers.push(marker);
        });
      } catch(e) { /* ignore per-waypoint failures */ }
    }

    miniPoiMarkers[type] = allMarkers;

    // Update badge
    const badgeId = type === 'truck' ? 'miniBadgeTruck' : 'miniBadgeRest';
    const cntId   = type === 'truck' ? 'miniTruckCnt'  : 'miniRestCnt';
    const badge   = document.getElementById(badgeId);
    const cnt     = document.getElementById(cntId);
    if (badge) badge.classList.remove('poi-loading');
    if (cnt)   cnt.textContent = allMarkers.length || '0';
  };

  // Load both types in parallel
  await Promise.all([loadType('truck'), loadType('rest')]);
}

function toggleMiniPOI(type) {
  miniPoiActive[type] = !miniPoiActive[type];
  const badgeId = type === 'truck' ? 'miniBadgeTruck' : type === 'rest' ? 'miniBadgeRest' : 'miniBadgeRestrict';
  document.getElementById(badgeId)?.classList.toggle('off', !miniPoiActive[type]);
  miniPoiMarkers[type].forEach(m => {
    if (miniPoiActive[type]) { try { m.addTo(miniMap); } catch {} }
    else { try { miniMap.removeLayer(m); } catch {} }
  });
}

async function calculateRoute() {
  hideError();
  if (!origin || !destination) { showError(t('errSel')); return; }
  const hours = parseFloat(document.getElementById('hoursInput').value);
  const speed = parseFloat(document.getElementById('speedInput').value);
  if (isNaN(hours)||hours<=0||hours>70) { showError(t('err70')); return; }
  if (isNaN(speed)||speed<=0) { showError(t('errSpeed')); return; }

  const calcBtn = document.getElementById('calcBtn');
  calcBtn.textContent = 'â³ Calculating...';
  calcBtn.disabled = true;

  const depart = new Date(document.getElementById('departureInput').value || new Date());
  const road = await fetchRoadRoute(origin, destination);
  roadGeometry = road.coords;
  routeSource = road.source;
  routeDistance = road.miles;

  schedule = calculateSchedule(depart, routeDistance, speed, hours);
  arrivalTime = schedule.at(-1)?.end || depart;
  totalTime = schedule.reduce((a,s) => a + (s.type==='drive'||s.type==='rest'||s.type==='reset'||s.type==='break30' ? s.hours : 0), 0);

  // Schedule HOS rest alarms
  scheduleRestAlarms(schedule, depart);

  const drive = {
    id: Date.now(),
    origin: origin.name, destination: destination.name,
    distance: routeDistance,
    value: (routeDistance * 0.73).toFixed(2),
    date: new Date().toISOString()
  };
  savedDrives.push(drive);
  localStorage.setItem('hos_drives', JSON.stringify(savedDrives));

  renderResults(hours, speed, depart);

  document.getElementById('miniMapCard').style.display = 'block';
  if (!miniMap) miniMap = initMap('miniMap');
  setTimeout(() => {
    miniMap.invalidateSize();
    const mRef = { list: miniMarkersList };
    const lRef = { layer: miniLayer };
    drawRoute(miniMap, roadGeometry, mRef, lRef);
    miniMarkersList = mRef.list;
    miniLayer = lRef.layer;
    // Reset badge states
    ['miniBadgeTruck','miniBadgeRest','miniBadgeRestrict'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add('poi-loading');
    });
    document.getElementById('miniTruckCnt').textContent    = 'â€¦';
    document.getElementById('miniRestCnt').textContent     = 'â€¦';
    document.getElementById('miniRestrictCnt').textContent = 'â€¦';
    miniPoiActive = { truck: true, rest: true, restrict: true };
    ['miniBadgeTruck','miniBadgeRest','miniBadgeRestrict'].forEach(id => document.getElementById(id)?.classList.remove('off'));
    // Load POIs along route (async, non-blocking)
    loadMiniMapPOIs();
    loadMiniMapRestrictions();
  }, 100);

  document.getElementById('routeSourceTxt').textContent =
    `ğŸ›£ï¸ ${t('sourceRoad')}: ${routeSource === 'Fallback' ? t('sourceFallback') : t('sourceOsrm')}`;

  calcBtn.textContent = t('btnCalc');
  calcBtn.disabled = false;

  renderDrives();
  renderSummary();

  setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 150);
}

function renderResults(hours, speed, depart) {
  document.getElementById('resultsCard').style.display = 'block';
  document.getElementById('shareTrackBtns').style.display = 'grid';

  const driveHours = routeDistance / speed;
  const pill = document.getElementById('timeVsHours');
  pill.textContent = `${fmtH(driveHours)} / ${hours} hrs`;
  pill.className = 'pill' + (driveHours > hours ? ' danger' : '');

  document.getElementById('distanceBig').textContent = routeDistance.toLocaleString() + ' mi';
  document.getElementById('fromVal').textContent = origin.name;
  document.getElementById('toVal').textContent = destination.name;
  document.getElementById('departureVal').textContent = fmtDateTime(depart);
  document.getElementById('arrivalVal').textContent = fmtDateTime(arrivalTime);
  document.getElementById('totalTimeVal').textContent = fmtH(totalTime);

  const sl = document.getElementById('scheduleList');
  sl.innerHTML = '';
  schedule.forEach(s => {
    const div = document.createElement('div');
    if (s.type === 'break30') {
      div.className = 'sched break30';
      div.innerHTML = `<div class="t">â˜• ${lang==='es'?'Pausa 30 min obligatoria':'Mandatory 30-min Break'}</div><div class="d">â¸ï¸ ${fmtTime(s.start)} â†’ ${fmtTime(s.end)}</div>`;
    } else {
      div.className = 'sched' + (s.type==='rest'?' rest':s.type==='reset'?' reset':'');
      const title = s.type==='reset' ? `ğŸ”„ ${t('reset')}` : `${t('day')} ${s.day} - ${s.type==='drive'?t('drive'):t('rest')}`;
      const detail = s.type==='drive'
        ? `ğŸš› ${fmtTime(s.start)} â†’ ${fmtTime(s.end)}\n${fmtH(s.hours)} | ${Math.round(s.distance||0)} mi`
        : s.type==='rest' ? `ğŸ˜´ 10 hours DOT` : `Recover 70 hrs`;
      div.innerHTML = `<div class="t">${title}</div><div class="d" style="white-space:pre-line">${detail}</div>`;
    }
    sl.appendChild(div);
  });
}

function renderDrives() {
  const el = document.getElementById('drivesList');
  const countEl = document.getElementById('drivesCount');
  if (countEl) countEl.textContent = savedDrives.length;

  if (!savedDrives.length) {
    el.innerHTML = `<div class="no-drives">ğŸš›<br><br>${t('noDrives')}<br>${t('calcFirst')}</div>`;
    return;
  }
  const total = savedDrives.reduce((a,d) => a + parseFloat(d.value||0), 0);
  let html = `<div class="drives-header"><div style="font-size:13px;color:var(--muted)">${lang==='es'?'Valor total':'Classified value'}: $${total.toFixed(2)}</div></div>`;
  [...savedDrives].reverse().forEach(d => {
    const dt = new Date(d.date);
    const dateStr = dt.toLocaleDateString(lang==='es'?'es-ES':'en-US',{weekday:'long',day:'numeric',month:'long'});
    html += `<div><div style="padding:6px 14px 2px;font-size:13px;font-weight:700">${dateStr}</div>
    <div class="drive-item">
      <div class="drive-thumb">ğŸ—ºï¸</div>
      <div class="drive-info">
        <div class="drive-route">${d.origin.split(',')[0]} â†’ ${d.destination.split(',')[0]}</div>
        <div class="drive-meta">${d.distance.toLocaleString()} mi Â· ${fmtDateTime(d.date)}</div>
        <div class="drive-amount">$${d.value}</div>
      </div>
    </div></div>`;
  });
  el.innerHTML = html;
}

function renderSummary() {
  const miles = savedDrives.reduce((a,d) => a+(d.distance||0), 0);
  const val = savedDrives.reduce((a,d) => a+parseFloat(d.value||0), 0);
  document.getElementById('sumDrives').textContent = savedDrives.length;
  document.getElementById('sumMiles').textContent = miles.toLocaleString();
  document.getElementById('sumValue').textContent = '$' + val.toFixed(0);
  document.getElementById('sumStatus').textContent = savedDrives.length ? t('status100') : t('noRoutes');
  document.getElementById('sumDesc').textContent = savedDrives.length ? t('allLogged') : t('planRoute');
  document.getElementById('sendReportBtn').style.display = savedDrives.length ? 'flex' : 'none';
}

function useGPS() {
  if (!navigator.geolocation) { alert('GPS not supported'); return; }
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    try {
      const r = await fetch(`https://photon.komoot.io/reverse?lat=${latitude}&lon=${longitude}`);
      const data = await r.json();
      const feat = data.features?.[0];
      const p = feat?.properties || {};
      const name = [p.name, p.city, p.state, p.country].filter(Boolean).join(', ') || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
      origin = { name, lat: latitude, lon: longitude };
      document.getElementById('originInput').value = name;
    } catch {
      origin = { name: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`, lat: latitude, lon: longitude };
      document.getElementById('originInput').value = origin.name;
    }
  }, () => alert(t('gpsDenied')), { enableHighAccuracy: true, timeout: 10000 });
}

async function shareRoute() {
  if (!origin || !destination) return;
  const msg = `ğŸš› HOS Tracker\n\nğŸ“ ${origin.name}\nğŸ¯ ${destination.name}\nğŸ“ ${routeDistance.toLocaleString()} mi\nâ±ï¸ ${fmtH(totalTime)}\n\nby fab-visualâ„¢`;
  if (navigator.share) { try { await navigator.share({ title: 'HOS Route', text: msg }); return; } catch {} }
  if (navigator.clipboard) await navigator.clipboard.writeText(msg);
  alert(t('copied'));
}

/* ============================================================
   FULLSCREEN MAP + LIVE TRACKING  (Google Maps style)
   ============================================================ */
let fmMapInst    = null;
let fmMarkers    = [];
let fmLayer      = null;
let fmGpsMarker  = null;  // the animated truck
let fmAccMarker  = null;  // accuracy circle
let fmWatchId    = null;
let fmTripStart  = null;
let fmDriveSeconds = 0;    // accumulated moving time in seconds
let fmLastMoveTime = null; // timestamp of last GPS fix when moving
let fmClockTimer = null;
let fmIsTracking = false;

let fmLastGeocode = 0;

// Auto-follow & zoom
let fmFollowing     = true;   // whether map auto-follows truck
let fmUserDragged   = false;  // user manually moved map
let fmCurrentZoom   = 15;     // zoom level when following
let fmLastHeading   = null;   // last GPS heading for truck rotation
let fmPrevLat       = null;   // for calculating heading when GPS doesn't provide it
let fmPrevLon       = null;

// POI layers
const fmPoiLayers = { scale: [], truck: [], rest: [], reports: [], restrict: [] };
const fmPoiActive = { scale: true, truck: true, rest: true, reports: true, restrict: true };
let   fmPoiLoaded = { scale: false, truck: false, rest: false, restrict: false };

// Community reports (stored in localStorage, shared within session)
let communityReports = JSON.parse(localStorage.getItem('hos_reports') || '[]');
// Remove reports older than 2 hours
communityReports = communityReports.filter(r => Date.now() - r.ts < 7200000);
localStorage.setItem('hos_reports', JSON.stringify(communityReports));

function openFullMapScreen() {
  const screen = document.getElementById('fullMapScreen');
  screen.style.display = 'flex';
  screen.style.flexDirection = 'column';

  // Bridge mode: hide all overlays when height detector is on
  screen.classList.toggle('bridge-mode', !!bridgeActive);

  document.getElementById('fmTrackBanner').style.display = 'block';
  document.getElementById('fmStopBtn').style.display = 'none';
  document.getElementById('poiLegend').classList.add('visible');
  document.getElementById('fmFollowBtn').classList.add('visible');

  if (origin) document.getElementById('fmFrom').textContent = origin.name.split(',')[0];
  if (destination) document.getElementById('fmTo').textContent = destination.name.split(',')[0];

  if (!fmMapInst) {
    fmMapInst = L.map('fullMap', {
      zoomControl: false,
      attributionControl: false,
      zoomAnimation: true,
      fadeAnimation: true
    }).setView([39.5, -98.35], 4);

    const tile = isDark
      ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
      : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
    L.tileLayer(tile, { maxZoom: 19 }).addTo(fmMapInst);

    // Detect when user drags map â€” pause auto-follow
    fmMapInst.on('dragstart', () => {
      fmUserDragged = true;
      fmFollowing = false;
      document.getElementById('fmFollowBtn').classList.remove('active');
    });
  }

  setTimeout(() => {
    fmMapInst.invalidateSize();
    if (origin && destination) {
      fmRedrawRoute();
      // Reset chip labels to show loading
      document.getElementById('chipScale').innerHTML = 'âš–ï¸ Scales <span style="opacity:.5;font-size:10px">â€¢â€¢â€¢</span>';
      document.getElementById('chipTruck').innerHTML = 'ğŸš› Truck Stops <span style="opacity:.5;font-size:10px">â€¢â€¢â€¢</span>';
      document.getElementById('chipRest').innerHTML  = 'ğŸ˜´ Rest Areas <span style="opacity:.5;font-size:10px">â€¢â€¢â€¢</span>';
      // Start loading POIs after route is drawn
      setTimeout(() => loadAllPOIs(), 500);
    }
    document.getElementById('fmHud').style.transform = 'translateY(0)';
  }, 200);

  fmTickClock();
  if (fmClockTimer) clearInterval(fmClockTimer);
  fmClockTimer = setInterval(fmTickClock, 1000);
}

// Draw/redraw the green route polyline + origin/destination markers
function fmRedrawRoute(coords) {
  const routeCoords = coords || roadGeometry || [
    [origin.lat, origin.lon],
    [destination.lat, destination.lon]
  ];

  // Remove only route + endpoint markers (keep POIs and truck)
  fmMarkers.forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
  fmMarkers = [];
  if (fmLayer) { try { fmMapInst.removeLayer(fmLayer); } catch {} fmLayer = null; }

  const shadow = L.polyline(routeCoords, { color: '#065f46', weight: 12, opacity: 0.15 }).addTo(fmMapInst);
  fmLayer = L.polyline(routeCoords, { color: '#10b981', weight: 5, opacity: 0.9 }).addTo(fmMapInst);

  const oIcon = L.divIcon({
    className: '',
    html: `<div style="width:16px;height:16px;background:#10b981;border:3px solid #fff;border-radius:50%;box-shadow:0 0 0 4px rgba(16,185,129,.25),0 2px 8px rgba(0,0,0,.5)"></div>`,
    iconAnchor: [8, 8]
  });
  const dIcon = L.divIcon({
    className: '',
    html: `<div style="font-size:30px;line-height:1;filter:drop-shadow(0 2px 6px rgba(0,0,0,.6))">ğŸ“</div>`,
    iconAnchor: [15, 30]
  });

  const oMark = L.marker([origin.lat, origin.lon], { icon: oIcon }).addTo(fmMapInst)
    .bindPopup(`<b>Origin</b><br>${origin.name}`);
  const dMark = L.marker([destination.lat, destination.lon], { icon: dIcon }).addTo(fmMapInst)
    .bindPopup(`<b>Destination</b><br>${destination.name}`);

  fmMarkers = [shadow, oMark, dMark];
  fmMapInst.fitBounds(fmLayer.getBounds(), { padding: [70, 70] });
}

// Make/update the truck marker with rotation based on heading
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš›  SMOOTH TRUCK MARKER â€” Google Maps style
   Interpolates 60fps between GPS fixes
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let truckAnimFrame = null;       // requestAnimationFrame handle
let truckFrom = null;            // { lat, lon, heading }
let truckTo   = null;            // { lat, lon, heading }
let truckAnimStart  = 0;
const TRUCK_ANIM_MS = 1200;      // interpolate over 1.2 s (one GPS interval)

// The static truck icon element â€” we reuse the same DOM, only move/rotate
let fmTruckEl = null;  // the inner div element for rotation

function buildTruckIconHTML(heading, isMoving) {
  const rot = heading != null ? heading : 0;
  return `
    <div class="truck-smooth-wrapper${isMoving ? '' : ' stopped'}" id="truckWrapper"
         style="transform:rotate(${rot}deg);transition:transform 0.6s cubic-bezier(.4,0,.2,1)">
      <div class="truck-glow"></div>
      <div class="truck-pulse"></div>
      <svg viewBox="0 0 52 52" width="52" height="52" style="position:relative;z-index:1;filter:drop-shadow(0 3px 8px rgba(0,0,0,.5))">
        <rect x="20" y="10" width="24" height="20" rx="4" fill="${isMoving?'#10b981':'#6b7280'}" stroke="#fff" stroke-width="1.5"/>
        <rect x="23" y="13" width="18" height="10" rx="2" fill="rgba(200,240,255,0.85)" stroke="rgba(255,255,255,.5)" stroke-width="1"/>
        <circle cx="22" cy="28" r="2" fill="${isMoving?'#fde047':'#4b5563'}"/>
        <circle cx="42" cy="28" r="2" fill="${isMoving?'#fde047':'#4b5563'}"/>
        <rect x="2" y="16" width="20" height="14" rx="2" fill="${isMoving?'#0d9488':'#4b5563'}" stroke="#fff" stroke-width="1.2"/>
        <line x1="12" y1="17" x2="12" y2="29" stroke="rgba(255,255,255,.4)" stroke-width="1"/>
        <line x1="7"  y1="17" x2="7"  y2="29" stroke="rgba(255,255,255,.2)" stroke-width=".8"/>
        <line x1="17" y1="17" x2="17" y2="29" stroke="rgba(255,255,255,.2)" stroke-width=".8"/>
        <circle cx="26" cy="32" r="5" fill="#1f2937" stroke="${isMoving?'#10b981':'#6b7280'}" stroke-width="1.5"/>
        <circle cx="26" cy="32" r="2" fill="#374151"/>
        <circle cx="38" cy="32" r="5" fill="#1f2937" stroke="${isMoving?'#10b981':'#6b7280'}" stroke-width="1.5"/>
        <circle cx="38" cy="32" r="2" fill="#374151"/>
        <circle cx="7"  cy="32" r="4" fill="#1f2937" stroke="${isMoving?'#0d9488':'#4b5563'}" stroke-width="1.2"/>
        <circle cx="7"  cy="32" r="1.5" fill="#374151"/>
        <circle cx="15" cy="32" r="4" fill="#1f2937" stroke="${isMoving?'#0d9488':'#4b5563'}" stroke-width="1.2"/>
        <circle cx="15" cy="32" r="1.5" fill="#374151"/>
        <rect x="42" y="6" width="3" height="8" rx="1.5" fill="#6b7280"/>
        <polygon points="34,5 30,12 38,12" fill="${isMoving?'#10b981':'#9ca3af'}" stroke="#fff" stroke-width="1" stroke-linejoin="round"/>
      </svg>
    </div>`;
}

// Linear interpolation
function lerp(a, b, t) { return a + (b - a) * t; }

// Shortest-path heading interpolation (handles 359â†’1 case)
function lerpHeading(a, b, t) {
  let diff = b - a;
  if (diff > 180)  diff -= 360;
  if (diff < -180) diff += 360;
  return a + diff * t;
}

function easeInOut(t) { return t < 0.5 ? 2*t*t : -1+(4-2*t)*t; }

// Called every rAF tick â€” moves marker smoothly
function truckAnimTick(ts) {
  if (!truckFrom || !truckTo || !fmGpsMarker) return;
  const elapsed = ts - truckAnimStart;
  const raw_t   = Math.min(1, elapsed / TRUCK_ANIM_MS);
  const t       = easeInOut(raw_t);

  const lat = lerp(truckFrom.lat, truckTo.lat, t);
  const lon = lerp(truckFrom.lon, truckTo.lon, t);

  fmGpsMarker.setLatLng([lat, lon]);

  // Smooth rotation via CSS on the wrapper element
  const wrapper = document.getElementById('truckWrapper');
  if (wrapper && truckTo.heading != null) {
    const h = lerpHeading(truckFrom.heading ?? truckTo.heading, truckTo.heading, t);
    wrapper.style.transform = `rotate(${h.toFixed(1)}deg)`;
  }

  if (t < 1) {
    truckAnimFrame = requestAnimationFrame(truckAnimTick);
  } else {
    truckFrom = { ...truckTo };
    truckAnimFrame = null;
  }
}

function fmUpdateTruckMarker(lat, lon, heading, isMoving) {
  // Update target
  if (truckTo) truckFrom = { ...truckTo };
  truckTo = { lat, lon, heading: heading ?? truckFrom?.heading ?? 0 };

  if (!fmGpsMarker) {
    // First placement â€” create marker
    const html  = buildTruckIconHTML(heading, isMoving);
    const icon  = L.divIcon({ className: '', html, iconAnchor: [26, 26], iconSize: [52, 52] });
    fmGpsMarker = L.marker([lat, lon], { icon, zIndexOffset: 1000 }).addTo(fmMapInst);
    truckFrom   = { lat, lon, heading: heading ?? 0 };

  } else {
    // Refresh icon if moving state changed (to swap colors/pulse)
    const wrapper = document.getElementById('truckWrapper');
    if (wrapper) {
      // Toggle moving/stopped classes without rebuilding full icon
      wrapper.classList.toggle('stopped', !isMoving);
    } else {
      // Wrapper gone (rare) â€” recreate icon
      const html = buildTruckIconHTML(heading, isMoving);
      const icon = L.divIcon({ className: '', html, iconAnchor: [26, 26], iconSize: [52, 52] });
      fmGpsMarker.setIcon(icon);
      truckFrom = { lat, lon, heading: heading ?? 0 };
    }
  }

  // Cancel previous animation and start fresh
  if (truckAnimFrame) { cancelAnimationFrame(truckAnimFrame); truckAnimFrame = null; }
  truckAnimStart = performance.now();
  truckAnimFrame = requestAnimationFrame(truckAnimTick);
}

// Calculate compass heading from two GPS points
function calcHeading(lat1, lon1, lat2, lon2) {
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
  const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180)
           - Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
  return ((Math.atan2(y, x) * 180 / Math.PI) + 360) % 360;
}

function fmTickClock() {
  const now = new Date();
  document.getElementById('fmClockTxt').textContent = now.toLocaleTimeString(lang==='es'?'es-US':'en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
  document.getElementById('fmDateTxt').textContent = now.toLocaleDateString(lang==='es'?'es-ES':'en-US',{weekday:'short',month:'short',day:'numeric'});
}

function closeFullMapScreen() {
  fmStopTracking();
  clearAllPOIs();
  document.getElementById('fullMapScreen').style.display = 'none';
  document.getElementById('fmHud').style.transform = 'translateY(100%)';
  document.getElementById('poiLegend').classList.remove('visible');
  document.getElementById('fmFollowBtn').classList.remove('visible');
  if (fmClockTimer) { clearInterval(fmClockTimer); fmClockTimer = null; }
}

function toggleFollow() {
  fmFollowing = !fmFollowing;
  fmUserDragged = !fmFollowing;
  const btn = document.getElementById('fmFollowBtn');
  btn.classList.toggle('active', fmFollowing);
  // If re-enabling follow, snap to truck immediately
  if (fmFollowing && fmGpsMarker) {
    fmMapInst.setView(fmGpsMarker.getLatLng(), fmCurrentZoom, { animate: true, duration: 0.8 });
  }
}

async function fmStartTracking() {
  if (!navigator.geolocation) { alert(lang==='es'?'GPS no soportado':'GPS not supported'); return; }

  document.getElementById('fmTrackBanner').style.display = 'none';
  document.getElementById('fmLiveDot').style.background = '#f59e0b';
  document.getElementById('fmLiveDot').style.boxShadow = '0 0 6px #f59e0b';
  document.getElementById('fmLiveDot').style.animation = 'liveblink 1s infinite';
  document.getElementById('fmLocVal').textContent = lang==='es' ? 'ğŸ“¡ Obteniendo ubicaciÃ³n real...' : 'ğŸ“¡ Getting real location...';
  document.getElementById('fmStatusChip').textContent = 'ğŸ“¡ Locating...';

  // â”€â”€ STEP 1: Get precise GPS fix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let realLat, realLon, realAccuracy;
  try {
    const pos = await new Promise((res, rej) =>
      navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 15000 })
    );
    realLat = pos.coords.latitude;
    realLon = pos.coords.longitude;
    realAccuracy = pos.coords.accuracy;
  } catch {
    document.getElementById('fmLocVal').textContent = 'âŒ GPS error â€” check permissions';
    document.getElementById('fmLiveDot').style.background = '#ef4444';
    return;
  }

  // â”€â”€ STEP 2: Reverse geocode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let realLocName = `${realLat.toFixed(5)}, ${realLon.toFixed(5)}`;
  try {
    const r = await fetch(`https://photon.komoot.io/reverse?lat=${realLat}&lon=${realLon}`);
    const d = await r.json();
    const p = d.features?.[0]?.properties || {};
    realLocName = [p.name, p.city, p.state].filter(Boolean).join(', ') || realLocName;
  } catch {}

  document.getElementById('fmLocVal').textContent = 'ğŸ”„ Recalculating route...';

  // â”€â”€ STEP 3: Recalculate route from real GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const realOrigin = { lat: realLat, lon: realLon, name: realLocName };
  const road = await fetchRoadRoute(realOrigin, destination);
  routeDistance = road.miles;
  roadGeometry  = road.coords;
  origin = realOrigin;

  document.getElementById('fmFrom').textContent = realLocName.split(',')[0];
  document.getElementById('fmLocVal').textContent = realLocName;

  // â”€â”€ STEP 4: Redraw route + place truck â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (fmMapInst) {
    fmRedrawRoute(roadGeometry);

    // Accuracy circle
    if (fmAccMarker) { try { fmMapInst.removeLayer(fmAccMarker); } catch {} }
    fmAccMarker = L.circle([realLat, realLon], {
      radius: realAccuracy || 20,
      color: '#3b82f6', fillColor: '#3b82f6',
      fillOpacity: 0.08, weight: 1.5, opacity: 0.5
    }).addTo(fmMapInst);

    fmUpdateTruckMarker(realLat, realLon, null, false);
    fmPrevLat = realLat; fmPrevLon = realLon;

    // AUTO-ZOOM: zoom in on truck at driving zoom level
    fmFollowing = true;
    document.getElementById('fmFollowBtn').classList.add('active');
    fmCurrentZoom = 15;
    fmMapInst.setView([realLat, realLon], fmCurrentZoom, { animate: true, duration: 1.2 });

    // Reload POIs centered on new real position
    setTimeout(() => loadAllPOIs(realLat, realLon), 800);
  }

  // â”€â”€ STEP 5: Live tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fmIsTracking  = true;
  fmTripStart    = new Date();
  fmDriveSeconds = 0;
  fmLastMoveTime = null;
  fmLastGeocode = 0;
  lastStateCheck = 0;
  lastFuelCheck  = 0;
  document.getElementById('fmStopBtn').style.display = 'block';
  showSpeedometer();
  showDriveHoursWidget();
  updateDriveHoursWidget(11, 11); // initialize at full
  document.getElementById('reportFab').classList.add('visible');
  const trb = document.getElementById('topReportBtns');
  if (trb) trb.style.display = 'flex';
  // Show SOS button if enabled
  if (sosBtnActive) document.getElementById('sosFab').classList.add('visible');
  document.getElementById('fmLiveDot').style.background = '#10b981';
  document.getElementById('fmLiveDot').style.boxShadow  = '0 0 8px #10b981';
  document.getElementById('fmLiveDot').style.animation  = 'liveblink 1.5s infinite';
  document.getElementById('fmPct').textContent  = '0%';
  document.getElementById('fmBar').style.width  = '0%';
  document.getElementById('fmRem').textContent  = routeDistance + ' mi';

  fmWatchId = navigator.geolocation.watchPosition(async pos => {
    const lat  = pos.coords.latitude;
    const lon  = pos.coords.longitude;
    const acc  = pos.coords.accuracy || 20;
    const rawSpeed = pos.coords.speed;
    const gpsSpeed = rawSpeed != null && rawSpeed >= 0 ? Math.round(rawSpeed * 2.237) : 0;
    const isMoving = gpsSpeed > 3;

    // â”€â”€ Heading: prefer GPS bearing, else calculate from movement â”€â”€
    let heading = pos.coords.heading;
    if ((!heading || heading < 0) && fmPrevLat != null && isMoving) {
      heading = calcHeading(fmPrevLat, fmPrevLon, lat, lon);
    }
    if (isMoving) { fmPrevLat = lat; fmPrevLon = lon; }
    fmLastHeading = heading;

    // â”€â”€ Update accuracy circle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (fmAccMarker) fmAccMarker.setLatLng([lat, lon]).setRadius(acc);

    // â”€â”€ Update truck marker with rotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    fmUpdateTruckMarker(lat, lon, heading, isMoving);

    // â”€â”€ AUTO-ZOOM & FOLLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (fmFollowing && fmMapInst) {
      // Dynamic zoom: zoom in more when fast, a bit out when slow/stopped
      if (isMoving) {
        fmCurrentZoom = gpsSpeed > 50 ? 13 : gpsSpeed > 25 ? 14 : 15;
      } else {
        fmCurrentZoom = 16; // zoom in close when stopped
      }
      fmMapInst.setView([lat, lon], fmCurrentZoom, { animate: true, duration: 0.8, noMoveStart: true });
    }

    // â”€â”€ HUD stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const remaining = haversine(lat, lon, destination.lat, destination.lon);
    const traveled  = Math.max(0, routeDistance - remaining);
    const pct       = Math.min(100, Math.round(traveled / Math.max(1, routeDistance) * 100));

    // Accumulate drive time ONLY when moving
    const now = Date.now();
    if (isMoving && fmLastMoveTime != null) {
      fmDriveSeconds += (now - fmLastMoveTime) / 1000;
    }
    fmLastMoveTime = isMoving ? now : null;
    const elapsed  = fmDriveSeconds / 3600; // hours actually driven

    const avgSpeed  = parseFloat(document.getElementById('speedInput').value) || defaultSpeed;
    const etaH      = remaining / Math.max(1, isMoving ? gpsSpeed : avgSpeed);

    document.getElementById('fmSpeedVal').textContent = gpsSpeed;
    document.getElementById('fmSpeedVal').style.color = isMoving ? '#10b981' : '#9ca3af';
    updateSpeedometer(gpsSpeed);

    const chip = document.getElementById('fmStatusChip');
    chip.textContent  = isMoving ? 'ğŸš› ' + (lang==='es'?'Manejando':'Driving') : 'â¸ ' + (lang==='es'?'Detenido':'Stopped');
    chip.style.background = isMoving ? 'rgba(16,185,129,0.2)' : 'rgba(107,114,128,0.2)';
    chip.style.color      = isMoving ? '#10b981' : '#9ca3af';

    document.getElementById('fmPct').textContent = pct + '%';
    document.getElementById('fmBar').style.width = pct + '%';
    document.getElementById('fmEta').textContent = fmtH(etaH);
    document.getElementById('fmRem').textContent = remaining.toFixed(1) + ' mi';

    const driveLeft = Math.max(0, 11 - elapsed);
    const driveEl = document.getElementById('fmDriveLeft');
    driveEl.textContent = fmtH(driveLeft);
    driveEl.style.color = driveLeft < 2 ? '#ef4444' : driveLeft < 4 ? '#f59e0b' : '#10b981';
    // Update circular widget on the map
    updateDriveHoursWidget(driveLeft, 11);

    const cycleLeft = Math.max(0, parseFloat(document.getElementById('hoursInput').value) - elapsed);
    const cyEl = document.getElementById('fm70Left');
    cyEl.textContent = fmtH(cycleLeft);
    cyEl.style.color = cycleLeft < 10 ? '#ef4444' : cycleLeft < 20 ? '#f59e0b' : '#8b5cf6';

    // â”€â”€ Location name throttled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const nowGeo = Date.now();
    if (nowGeo - fmLastGeocode > 12000) {
      fmLastGeocode = nowGeo;
      try {
        const r = await fetch(`https://photon.komoot.io/reverse?lat=${lat}&lon=${lon}`);
        const d = await r.json();
        const p = d.features?.[0]?.properties || {};
        document.getElementById('fmLocVal').textContent =
          [p.name, p.city, p.state].filter(Boolean).join(', ') || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      } catch { document.getElementById('fmLocVal').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`; }
    }

    // â”€â”€ Check nearby community reports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    checkNearbyReports(lat, lon);
    checkNearbyRestrictions(lat, lon);

    // â”€â”€ Bridge check: also trigger from GPS when moving (in addition to timer) â”€â”€
    if (bridgeActive && isMoving) checkBridges();

    // â”€â”€ Speed limit check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    checkSpeedLimit(gpsSpeed);

    // â”€â”€ Detect state + fetch cheap fuel (throttled) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    detectStateAndUpdateLimit(lat, lon);
    fetchCheapFuel(lat, lon);

    // â”€â”€ Arrival â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (remaining <= 3) { alert(t('arrived')); fmStopTracking(); }

  }, () => {
    document.getElementById('fmLocVal').textContent = 'âš ï¸ Weak GPS signal';
  }, { enableHighAccuracy: true, maximumAge: 1500, timeout: 15000 });
}

function fmStopTracking() {
  if (fmWatchId != null) { navigator.geolocation.clearWatch(fmWatchId); fmWatchId = null; }
  fmIsTracking = false;
  fmPrevLat = null; fmPrevLon = null;
  // Stop smooth animation
  if (truckAnimFrame) { cancelAnimationFrame(truckAnimFrame); truckAnimFrame = null; }
  truckFrom = null; truckTo = null;
  hideSpeedometer();
  hideDriveHoursWidget();
  document.getElementById('reportFab').classList.remove('visible');
  document.getElementById('reportSheet').classList.remove('open');
  const trbStop = document.getElementById('topReportBtns');
  if (trbStop) trbStop.style.display = 'none';
  // Hide overlays
  document.getElementById('incidentPanel').innerHTML = '';
  Object.keys(activeIncidentBubbles).forEach(id => delete activeIncidentBubbles[id]);
  updateIncidentBadge();
  document.getElementById('sosFab').classList.remove('visible');
  document.getElementById('fuelWidget').classList.remove('visible');
  document.getElementById('speedLimitWidget').classList.remove('visible');
  document.getElementById('speedToast').classList.remove('show');
  hideMapSpeedSign();
  fuelMarkers.forEach(m => { try { fmMapInst?.removeLayer(m); } catch {} });
  fuelMarkers = [];
  fuelStations = [];
  currentStateCode = '';
  document.getElementById('fmStopBtn').style.display = 'none';
  document.getElementById('fmLiveDot').style.background = '#6b7280';
  document.getElementById('fmLiveDot').style.boxShadow = 'none';
  document.getElementById('fmLiveDot').style.animation = 'none';
  if (fmAccMarker) { try { fmMapInst.removeLayer(fmAccMarker); } catch {} fmAccMarker = null; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ—ºï¸  POI SYSTEM â€” Weigh Stations, Truck Stops, Rest Areas
   Uses Overpass API (OpenStreetMap)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const POI_ICONS = {
  scale: { emoji:'âš–ï¸', color:'#ef4444', label:'Weigh Station' },
  truck: { emoji:'ğŸš›', color:'#3b82f6', label:'Truck Stop' },
  rest:  { emoji:'ğŸ˜´', color:'#8b5cf6', label:'Rest Area' },
};

// Overpass queries for each POI type
const OVERPASS_QUERIES = {
  scale: (lat, lon, r) => `
    [out:json][timeout:25];
    (
      node["amenity"="weigh_station"](around:${r},${lat},${lon});
      node["highway"="weigh_station"](around:${r},${lat},${lon});
      node["name"~"weigh",i](around:${r},${lat},${lon});
      way["amenity"="weigh_station"](around:${r},${lat},${lon});
    );
    out center;`,

  truck: (lat, lon, r) => `
    [out:json][timeout:30];
    (
      node["amenity"="fuel"]["hgv"="yes"](around:${r},${lat},${lon});
      node["amenity"="truck_stop"](around:${r},${lat},${lon});
      node["name"~"Flying J|Pilot|Love's|Loves |TA Travel|TA Truck|Petro |Sapp Bros|Kwik Trip|Speedway|Marathon|Shell|Chevron|BP |Exxon|Mobil|Casey",i](around:${r},${lat},${lon});
      way["amenity"="fuel"]["hgv"="yes"](around:${r},${lat},${lon});
      way["amenity"="truck_stop"](around:${r},${lat},${lon});
      way["name"~"Flying J|Pilot|Love's|Loves |TA Travel|TA Truck|Petro |Sapp Bros",i](around:${r},${lat},${lon});
    );
    out center;`,

  rest: (lat, lon, r) => `
    [out:json][timeout:25];
    (
      node["highway"="rest_area"](around:${r},${lat},${lon});
      node["amenity"="rest_area"](around:${r},${lat},${lon});
      node["highway"="services"]["hgv"="yes"](around:${r},${lat},${lon});
      way["highway"="rest_area"](around:${r},${lat},${lon});
      way["amenity"="rest_area"](around:${r},${lat},${lon});
      relation["highway"="rest_area"](around:${r},${lat},${lon});
    );
    out center;`,
};

async function loadPOI(type, lat, lon) {
  if (!fmMapInst) return;
  const radius = 80000; // 50 miles in meters
  const centerLat = lat || (origin ? (origin.lat + destination.lat) / 2 : 39.5);
  const centerLon = lon || (origin ? (origin.lon + destination.lon) / 2 : -98.35);

  try {
    const query = OVERPASS_QUERIES[type](centerLat, centerLon, radius);
    const r = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      body: 'data=' + encodeURIComponent(query)
    });
    const data = await r.json();
    const elements = data.elements || [];

    // Clear existing markers for this type
    fmPoiLayers[type].forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
    fmPoiLayers[type] = [];

    const cfg = POI_ICONS[type];
    elements.forEach(el => {
      const elLat = el.lat ?? el.center?.lat;
      const elLon = el.lon ?? el.center?.lon;
      if (!elLat || !elLon) return;

      // Calculate distance from current truck/origin position
      const truckLat = fmGpsMarker ? fmGpsMarker.getLatLng().lat : (origin?.lat || centerLat);
      const truckLon = fmGpsMarker ? fmGpsMarker.getLatLng().lng : (origin?.lon || centerLon);
      const dist = haversine(truckLat, truckLon, elLat, elLon).toFixed(1);

      const name = el.tags?.name || el.tags?.['name:en'] || cfg.label;
      const amenity = el.tags?.amenity || el.tags?.highway || '';

      // Build popup content
      let popupHtml = `
        <div style="font-family:'DM Sans',sans-serif;min-width:160px;max-width:220px">
          <div style="font-size:20px;margin-bottom:4px">${cfg.emoji}</div>
          <div style="font-weight:800;font-size:14px;margin-bottom:4px">${name}</div>
          <div style="color:#6b7280;font-size:12px;margin-bottom:6px">${cfg.label}</div>
          <div style="background:#f0fdf4;border-radius:8px;padding:6px 10px;font-size:13px;font-weight:700;color:#065f46">
            ğŸ“ ${dist} mi away
          </div>
      `;
      if (el.tags?.opening_hours) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:4px">ğŸ• ${el.tags.opening_hours}</div>`;
      if (el.tags?.phone) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:2px">ğŸ“ ${el.tags.phone}</div>`;
      if (el.tags?.['addr:city']) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:2px">ğŸ“ ${el.tags['addr:city']}</div>`;
      popupHtml += '</div>';

      const icon = L.divIcon({
        className: '',
        html: `
          <div style="
            background:${cfg.color};
            border:2.5px solid #fff;
            border-radius:50%;
            width:28px; height:28px;
            display:flex; align-items:center; justify-content:center;
            font-size:13px; line-height:1;
            box-shadow:0 2px 8px rgba(0,0,0,0.4);
            cursor:pointer;
          ">${cfg.emoji}</div>
          <div style="
            position:absolute; bottom:-18px; left:50%;
            transform:translateX(-50%);
            background:rgba(0,0,0,0.75); color:#fff;
            font-size:9px; font-weight:700;
            padding:2px 5px; border-radius:4px;
            white-space:nowrap; font-family:'DM Sans',sans-serif;
          ">${dist}mi</div>
        `,
        iconAnchor: [14, 14],
        popupAnchor: [0, -16]
      });

      const marker = L.marker([elLat, elLon], { icon })
        .bindPopup(popupHtml, { maxWidth: 240 });

      if (fmPoiActive[type]) marker.addTo(fmMapInst);
      fmPoiLayers[type].push(marker);
    });

    fmPoiLoaded[type] = true;
    console.log(`âœ… POI ${type}: loaded ${elements.length} items`);
  } catch (e) {
    console.warn(`POI ${type} load failed:`, e);
  }
}

async function loadAllPOIs(lat, lon) {
  if (!origin || !destination) return;

  // Build waypoints: sample the route geometry every ~40 miles + origin + midpoint + destination
  let waypoints = [];
  if (roadGeometry && roadGeometry.length > 2) {
    const step = Math.max(1, Math.floor(roadGeometry.length / 6));
    for (let i = 0; i < roadGeometry.length; i += step) {
      waypoints.push({ lat: roadGeometry[i][0], lon: roadGeometry[i][1] });
    }
    // Always include destination
    const last = roadGeometry[roadGeometry.length - 1];
    waypoints.push({ lat: last[0], lon: last[1] });
  } else {
    // Fallback: origin, midpoint, destination
    waypoints = [
      { lat: origin.lat, lon: origin.lon },
      { lat: (origin.lat + destination.lat) / 2, lon: (origin.lon + destination.lon) / 2 },
      { lat: destination.lat, lon: destination.lon }
    ];
  }

  // Remove duplicates that are too close (<30 miles apart)
  const filtered = [waypoints[0]];
  for (let i = 1; i < waypoints.length; i++) {
    const prev = filtered[filtered.length - 1];
    if (haversine(prev.lat, prev.lon, waypoints[i].lat, waypoints[i].lon) > 30) {
      filtered.push(waypoints[i]);
    }
  }

  // Show loading indicator on chips
  ['chipScale','chipTruck','chipRest','chipRestrict'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.opacity = '0.5';
  });

  // Load POIs from each waypoint (radius 25 miles = 40km)
  const loadFromWaypoints = async (type) => {
    if (!fmMapInst) return;
    // Clear existing
    fmPoiLayers[type].forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
    fmPoiLayers[type] = [];

    const seen = new Set(); // deduplicate by id
    const radius = 40000; // 25 miles in meters
    const cfg = POI_ICONS[type];

    for (const wp of filtered) {
      try {
        const query = OVERPASS_QUERIES[type](wp.lat, wp.lon, radius);
        const r = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: 'data=' + encodeURIComponent(query)
        });
        const data = await r.json();
        const elements = data.elements || [];

        elements.forEach(el => {
          const elLat = el.lat ?? el.center?.lat;
          const elLon = el.lon ?? el.center?.lon;
          if (!elLat || !elLon) return;
          if (seen.has(el.id)) return;

          // Only keep POIs within 15 miles of the actual route geometry
          if (roadGeometry && roadGeometry.length > 1 && !isNearRoute(elLat, elLon, roadGeometry, 15)) return;

          seen.add(el.id);

          const truckLat = fmGpsMarker ? fmGpsMarker.getLatLng().lat : origin.lat;
          const truckLon = fmGpsMarker ? fmGpsMarker.getLatLng().lng : origin.lon;
          const dist = haversine(truckLat, truckLon, elLat, elLon);
          const distStr = dist < 1000 ? dist.toFixed(0) + ' mi' : '999+ mi';
          const name = el.tags?.name || el.tags?.['name:en'] || cfg.label;

          let popupHtml = `
            <div style="font-family:'DM Sans',sans-serif;min-width:170px;max-width:230px;padding:4px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <div style="width:36px;height:36px;border-radius:50%;background:${cfg.color}22;border:2px solid ${cfg.color};display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">${cfg.emoji}</div>
                <div>
                  <div style="font-weight:800;font-size:14px;line-height:1.2">${name}</div>
                  <div style="color:#6b7280;font-size:11px;font-weight:600">${cfg.label}</div>
                </div>
              </div>
              <div style="background:${cfg.color}15;border:1px solid ${cfg.color}40;border-radius:8px;padding:6px 10px;font-size:13px;font-weight:700;color:${cfg.color}">
                ğŸ“ ${distStr} from start
              </div>`;
          if (el.tags?.opening_hours) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:6px">ğŸ• ${el.tags.opening_hours}</div>`;
          if (el.tags?.phone) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:3px">ğŸ“ ${el.tags.phone}</div>`;
          if (el.tags?.['addr:city']) popupHtml += `<div style="font-size:11px;color:#6b7280;margin-top:3px">ğŸ“ ${el.tags['addr:city']}</div>`;
          popupHtml += '</div>';

          // Brand detection for truck stops
          const brand = type === 'truck' ? getTruckBrand(name) : null;
          const markerBg   = brand ? brand.color : cfg.color;
          const typeIcon   = type === 'truck'
            ? (brand ? brand.logo : 'ğŸš›')
            : type === 'rest' ? 'ğŸ˜´' : 'âš–ï¸';
          const shortName  = brand ? brand.short : name.split(',')[0].substring(0, 13);

          const icon = L.divIcon({
            className: '',
            html: `
              <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
                <!-- Round badge -->
                <div style="
                  width:36px; height:36px;
                  background:${markerBg};
                  border-radius:50%;
                  border:2.5px solid rgba(255,255,255,.95);
                  box-shadow:0 3px 12px rgba(0,0,0,.5),0 0 0 1px rgba(0,0,0,.08);
                  display:flex; align-items:center; justify-content:center;
                  font-size:16px; line-height:1;
                  cursor:pointer;
                ">${typeIcon}</div>
                <!-- Name pill -->
                <div style="
                  background:${markerBg};
                  color:#fff;
                  font-size:9px; font-weight:900;
                  padding:2px 7px; border-radius:7px;
                  white-space:nowrap;
                  font-family:'DM Sans',sans-serif;
                  box-shadow:0 2px 6px rgba(0,0,0,.4);
                  max-width:80px; overflow:hidden; text-overflow:ellipsis;
                  letter-spacing:.2px;
                ">${shortName}</div>
              </div>`,
            iconAnchor: [18, 18],
            popupAnchor: [0, -22]
          });

          const marker = L.marker([elLat, elLon], { icon })
            .bindPopup(popupHtml, { maxWidth: 260 });
          if (fmPoiActive[type]) marker.addTo(fmMapInst);
          fmPoiLayers[type].push(marker);
        });
      } catch(e) { console.warn(`POI ${type} from waypoint failed`, e); }
    }

    fmPoiLoaded[type] = true;
    const chipId = type === 'scale' ? 'chipScale' : type === 'truck' ? 'chipTruck' : type === 'rest' ? 'chipRest' : 'chipRestrict';
    const chip = document.getElementById(chipId);
    if (chip) {
      chip.style.opacity = '1';
      const count = fmPoiLayers[type].length;
      const label = type === 'scale' ? 'Scales' : type === 'truck' ? 'Truck Stops' : 'Rest Areas';
      chip.innerHTML = `${type === 'scale' ? 'âš–ï¸' : type === 'truck' ? 'ğŸš›' : 'ğŸ˜´'} ${label} <span style="background:rgba(255,255,255,.25);border-radius:999px;padding:1px 6px;font-size:10px;margin-left:3px">${count}</span>`;
    }
    console.log(`âœ… POI ${type}: ${fmPoiLayers[type].length} total along route`);
  };

  // Load all in parallel
  await Promise.all([
    loadFromWaypoints('scale'),
    loadFromWaypoints('truck'),
    loadFromWaypoints('rest'),
    loadTruckRestrictionsFullMap(filtered),
  ]);
  renderCommunityReports();

  // â”€â”€ Alert if any truck restrictions found directly ON the route â”€â”€
  const restrictCount = fmPoiLayers.restrict.filter(l => l.getLatLngs).length;
  if (restrictCount > 0) {
    showToast('warning', 'ğŸš«',
      `âš ï¸ ${restrictCount} restricciÃ³n${restrictCount > 1 ? 'es' : ''} en tu ruta`,
      'Hay tramos con restricciones para camiones en tu ruta. Revisa el mapa (lÃ­neas de colores).',
      10000
    );
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“  NEARBY SEARCH â€” from Settings panel
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runNearbySearch() {
  const wantTruck = document.getElementById('nearbyTruck')?.checked;
  const wantRest  = document.getElementById('nearbyRest')?.checked;
  const wantScale = document.getElementById('nearbyScale')?.checked;

  if (!wantTruck && !wantRest && !wantScale) {
    document.getElementById('nearbyResultsList').style.display = 'none';
    return;
  }

  const statusEl  = document.getElementById('nearbyStatus');
  const listEl    = document.getElementById('nearbyResultsList');
  const itemsEl   = document.getElementById('nearbyResultsItems');
  const titleEl   = document.getElementById('nearbyResultsTitle');

  statusEl.style.display = 'block';
  statusEl.textContent = 'ğŸ“¡ Obteniendo ubicaciÃ³n...';
  listEl.style.display = 'none';
  itemsEl.innerHTML = '';

  // Get current position
  let userLat, userLon;
  try {
    const pos = await new Promise((res, rej) =>
      navigator.geolocation.getCurrentPosition(res, rej, { timeout: 8000, maximumAge: 30000 })
    );
    userLat = pos.coords.latitude;
    userLon = pos.coords.longitude;
  } catch(e) {
    statusEl.textContent = 'âŒ No se pudo obtener la ubicaciÃ³n. Activa el GPS.';
    return;
  }

  statusEl.textContent = 'ğŸ” Buscando lugares cercanos...';

  const radius = 80000; // 50 miles
  const seen = new Set();
  const results = [];

  // Build combined query
  const parts = [];
  if (wantTruck) parts.push(
    `node["amenity"="fuel"]["hgv"="yes"](around:${radius},${userLat},${userLon});`,
    `node["amenity"="truck_stop"](around:${radius},${userLat},${userLon});`,
    `node["name"~"Flying J|Pilot|Love's|TA Travel|Petro |Sapp Bros|Kwik Trip|Loves Travel",i](around:${radius},${userLat},${userLon});`,
    `way["amenity"="truck_stop"](around:${radius},${userLat},${userLon});`
  );
  if (wantRest) parts.push(
    `node["highway"="rest_area"](around:${radius},${userLat},${userLon});`,
    `node["amenity"="rest_area"](around:${radius},${userLat},${userLon});`,
    `way["highway"="rest_area"](around:${radius},${userLat},${userLon});`
  );
  if (wantScale) parts.push(
    `node["amenity"="weigh_station"](around:${radius},${userLat},${userLon});`,
    `node["highway"="weigh_station"](around:${radius},${userLat},${userLon});`
  );

  const query = `[out:json][timeout:30];\n(\n${parts.join('\n')}\n);\nout center;`;

  try {
    const r    = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST', body: 'data=' + encodeURIComponent(query)
    });
    const data = await r.json();
    const elements = data.elements || [];

    elements.forEach(el => {
      if (seen.has(el.id)) return;
      const elLat = el.lat ?? el.center?.lat;
      const elLon = el.lon ?? el.center?.lon;
      if (!elLat || !elLon) return;
      seen.add(el.id);

      const name    = el.tags?.name || el.tags?.['name:en'] || '';
      const amenity = el.tags?.amenity || el.tags?.highway || '';
      const dist    = haversine(userLat, userLon, elLat, elLon);

      // Classify
      let poiType;
      if (amenity === 'weigh_station' || el.tags?.highway === 'weigh_station') {
        if (!wantScale) return;
        poiType = 'scale';
      } else if (amenity === 'rest_area' || el.tags?.highway === 'rest_area') {
        if (!wantRest) return;
        poiType = 'rest';
      } else {
        if (!wantTruck) return;
        poiType = 'truck';
      }

      results.push({ name, dist, poiType, elLat, elLon, tags: el.tags || {} });
    });
  } catch(e) {
    statusEl.textContent = 'âŒ Error al buscar. Verifica tu conexiÃ³n.';
    return;
  }

  // Sort by distance
  results.sort((a, b) => a.dist - b.dist);

  statusEl.style.display = 'none';
  listEl.style.display = 'block';

  if (results.length === 0) {
    titleEl.textContent = 'No se encontraron lugares cercanos';
    itemsEl.innerHTML = '<div style="text-align:center;color:var(--muted);padding:16px;font-size:13px">Intenta ampliar el radio o verificar los filtros.</div>';
    return;
  }

  titleEl.textContent = `${results.length} lugares encontrados cerca`;

  const POI_CFG_NEARBY = {
    truck: { emoji: 'ğŸš›', color: '#2563eb', bg: '#eff6ff', label: 'Truck Stop' },
    rest:  { emoji: 'ğŸ˜´', color: '#7c3aed', bg: '#f5f3ff', label: 'Rest Area' },
    scale: { emoji: 'âš–ï¸', color: '#dc2626', bg: '#fef2f2', label: 'Weigh Station' },
  };

  // Render up to 25 results
  results.slice(0, 25).forEach(res => {
    const cfg   = POI_CFG_NEARBY[res.poiType];
    const brand = res.poiType === 'truck' ? getTruckBrand(res.name) : null;
    const displayName = res.name || cfg.label;
    const subLabel = res.tags?.['addr:city']
      ? `${res.tags['addr:city']}${res.tags?.['addr:state'] ? ', ' + res.tags['addr:state'] : ''}`
      : cfg.label;
    const distLabel = res.dist < 1 ? `${Math.round(res.dist * 5280)} ft` : `${res.dist.toFixed(1)} mi`;

    const item = document.createElement('div');
    item.className = 'nearby-result-item';
    item.innerHTML = `
      <div class="nearby-result-icon" style="background:${cfg.bg};border:1.5px solid ${cfg.color}22">
        ${brand ? brand.logo : cfg.emoji}
      </div>
      <div style="flex:1;min-width:0">
        <div class="nearby-result-name">${displayName}</div>
        <div class="nearby-result-sub">${subLabel}</div>
      </div>
      <button class="nearby-add-btn" title="Agregar como parada al mapa">ï¼‹</button>
    `;

    // ï¼‹ button â†’ add as stop on map
    item.querySelector('.nearby-add-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      addNearbyStopToMap(res, displayName, cfg, brand);
    });

    // Tap row â†’ fly to location on map
    item.addEventListener('click', () => {
      if (fmMapInst) {
        fmMapInst.flyTo([res.elLat, res.elLon], 16, { duration: 1 });
        L.popup({ maxWidth: 220 })
          .setLatLng([res.elLat, res.elLon])
          .setContent(`<div style="font-family:'DM Sans',sans-serif;font-weight:800;font-size:13px">${brand ? brand.logo : cfg.emoji} ${displayName}</div><div style="font-size:11px;color:#6b7280;margin-top:3px">${distLabel} de tu ubicaciÃ³n</div>`)
          .openOn(fmMapInst);
      } else {
        window.open(`https://maps.google.com/?q=${res.elLat},${res.elLon}`, '_blank');
      }
    });

    itemsEl.appendChild(item);
  });
}

function showSubscribeModal() {
  showToast('info', 'â­', 'SuscripciÃ³n Pro',
    'PrÃ³ximamente: pago en lÃ­nea. EscrÃ­benos a soporte@hostrack.app para activar tu cuenta Pro.', 6000);
}

// Add a nearby search result as a pinned stop on the map
let nearbyStopMarkers = []; // track added stops

function addNearbyStopToMap(res, displayName, cfg, brand) {
  // Open fullscreen map if not open
  if (document.getElementById('fullMapScreen').style.display === 'none' ||
      document.getElementById('fullMapScreen').style.display === '') {
    openFullMapScreen();
  }

  if (!fmMapInst) {
    showToast('info', 'ğŸ—ºï¸', 'Abre el mapa primero', 'Toca Ver Mapa para abrir el mapa completo.', 3000);
    return;
  }

  const markerBg   = brand ? brand.color : cfg.color;
  const markerIcon = brand ? brand.logo  : cfg.emoji;
  const shortName  = brand ? brand.short : displayName.substring(0, 14);

  // Build a distinctive stop marker with a star badge
  const icon = L.divIcon({
    className: '',
    html: `
      <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
        <div style="position:relative">
          <div style="
            width:40px; height:40px;
            background:${markerBg};
            border-radius:50%;
            border:3px solid #fff;
            box-shadow:0 3px 14px rgba(0,0,0,.6),0 0 0 2px ${markerBg}55;
            display:flex;align-items:center;justify-content:center;
            font-size:18px;line-height:1;cursor:pointer;
          ">${markerIcon}</div>
          <div style="
            position:absolute;top:-4px;right:-4px;
            width:16px;height:16px;border-radius:50%;
            background:#10b981;border:2px solid #fff;
            display:flex;align-items:center;justify-content:center;
            font-size:9px;color:#fff;font-weight:900;
          ">â˜…</div>
        </div>
        <div style="
          background:${markerBg};color:#fff;
          font-size:9px;font-weight:900;
          padding:2px 7px;border-radius:6px;
          white-space:nowrap;font-family:'DM Sans',sans-serif;
          box-shadow:0 2px 6px rgba(0,0,0,.4);
          max-width:80px;overflow:hidden;text-overflow:ellipsis;
        ">${shortName}</div>
      </div>`,
    iconAnchor: [20, 20],
    popupAnchor: [0, -28]
  });

  const popup = `
    <div style="font-family:'DM Sans',sans-serif;min-width:160px;padding:4px">
      <div style="font-size:22px;text-align:center;margin-bottom:4px">${markerIcon}</div>
      <div style="font-weight:900;font-size:14px;text-align:center">${displayName}</div>
      <div style="color:#6b7280;font-size:11px;text-align:center;margin-top:2px">${cfg.label}</div>
      <button onclick="
        if(fmMapInst && this.dataset.lat) {
          navigator.clipboard?.writeText(this.dataset.lat+','+this.dataset.lon);
          window.open('https://maps.google.com/?q='+this.dataset.lat+','+this.dataset.lon,'_blank');
        }
      " data-lat="${res.elLat}" data-lon="${res.elLon}" style="
        margin-top:10px;width:100%;padding:8px;border-radius:8px;
        background:#10b981;color:#fff;border:none;font-size:12px;
        font-weight:800;cursor:pointer;font-family:'DM Sans',sans-serif;
      ">ğŸ—ºï¸ Abrir en Google Maps</button>
    </div>`;

  const m = L.marker([res.elLat, res.elLon], { icon })
    .addTo(fmMapInst)
    .bindPopup(popup, { maxWidth: 220 });

  nearbyStopMarkers.push(m);
  fmMapInst.flyTo([res.elLat, res.elLon], 15, { duration: 1 });
  setTimeout(() => m.openPopup(), 1100);

  showToast('info', markerIcon, `${shortName} agregado`,
    `Marcado en el mapa como parada.`, 2500);
  if (navigator.vibrate) navigator.vibrate([40, 20, 40]);
}

function clearAllPOIs() {
  ['scale','truck','rest','reports','restrict'].forEach(type => {
    fmPoiLayers[type].forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
    fmPoiLayers[type] = [];
  });
  Object.keys(fmPoiLoaded).forEach(k => fmPoiLoaded[k] = false);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš«  TRUCK RESTRICTION SEGMENTS
   Draws red/orange polylines for roads with hgv bans,
   weight limits, height limits, hazmat bans, etc.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Build a human-readable restriction label from OSM tags
function restrictionLabel(tags) {
  const parts = [];
  if (tags.hgv === 'no')            parts.push('ğŸš« No HGV');
  if (tags.hgv === 'destination')   parts.push('âš ï¸ HGV: Local only');
  if (tags.hgv === 'local')         parts.push('âš ï¸ HGV: Local only');
  if (tags.maxweight)               parts.push(`âš–ï¸ Max weight: ${tags.maxweight} t`);
  if (tags.maxheight)               parts.push(`ğŸ“ Max height: ${tags.maxheight} m`);
  if (tags.maxwidth)                parts.push(`â†”ï¸ Max width: ${tags.maxwidth} m`);
  if (tags.maxlength)               parts.push(`â†•ï¸ Max length: ${tags.maxlength} m`);
  if (tags.maxaxleload)             parts.push(`âš™ï¸ Max axle: ${tags.maxaxleload} t`);
  if (tags.hazmat === 'no')         parts.push('â˜£ï¸ No hazmat');
  if (tags.hazmat === 'designated') parts.push('â˜£ï¸ Hazmat route');
  if (tags.motor_vehicle === 'no')  parts.push('ğŸš— No motor vehicles');
  if (tags.access === 'no')         parts.push('â›” No access');
  return parts.length ? parts : ['ğŸš« Truck restriction'];
}

// Determine polyline color by restriction severity
function restrictionColor(tags) {
  if (tags.hgv === 'no' || tags.access === 'no' || tags.motor_vehicle === 'no') return '#ef4444'; // red â€” banned
  if (tags.hazmat === 'no') return '#f97316';    // orange â€” hazmat
  if (tags.hgv === 'destination' || tags.hgv === 'local') return '#f59e0b'; // amber â€” limited
  if (tags.maxheight || tags.maxwidth) return '#8b5cf6'; // purple â€” dimensional
  if (tags.maxweight || tags.maxaxleload) return '#3b82f6'; // blue â€” weight
  return '#ef4444';
}

// Build Overpass query for truck-restricted ways (returns full geometry)
function buildRestrictionQuery(lat, lon, radiusM) {
  return `
    [out:json][timeout:30];
    (
      way["hgv"="no"](around:${radiusM},${lat},${lon});
      way["hgv"="destination"](around:${radiusM},${lat},${lon});
      way["hgv"="local"](around:${radiusM},${lat},${lon});
      way["maxweight"](around:${radiusM},${lat},${lon});
      way["maxheight"](around:${radiusM},${lat},${lon});
      way["maxwidth"](around:${radiusM},${lat},${lon});
      way["maxaxleload"](around:${radiusM},${lat},${lon});
      way["hazmat"="no"](around:${radiusM},${lat},${lon});
    );
    out geom qt;`;
}

// Draw restriction polylines on a given Leaflet map instance
// Returns array of Leaflet layers added
function drawRestrictionWays(elements, mapInst, routeGeom, nearMiles) {
  const layers = [];
  const seen = new Set();

  elements.forEach(way => {
    if (seen.has(way.id)) return;
    if (!way.geometry || way.geometry.length < 2) return;

    // Only show ways strictly on the route (0.35 miles = ~1850 ft corridor)
    const midIdx = Math.floor(way.geometry.length / 2);
    const midPt = way.geometry[midIdx];
    if (routeGeom && !isNearRoute(midPt.lat, midPt.lon, routeGeom, nearMiles)) return;
    seen.add(way.id);

    const tags    = way.tags || {};
    const color   = restrictionColor(tags);
    const labels  = restrictionLabel(tags);
    const name    = tags.name || tags['name:en'] || tags.ref || '';
    const coords  = way.geometry.map(n => [n.lat, n.lon]);

    // Shadow + main polyline
    const shadow = L.polyline(coords, {
      color: color, weight: 10, opacity: 0.18
    }).addTo(mapInst);

    const line = L.polyline(coords, {
      color: color, weight: 4, opacity: 0.92,
      dashArray: tags.hgv === 'destination' ? '8 5' : null,
    });

    const labelsHtml = labels.map(l =>
      `<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid rgba(0,0,0,.06)">
        <span style="font-size:15px">${l.split(' ')[0]}</span>
        <span style="font-size:12px;font-weight:700">${l.split(' ').slice(1).join(' ')}</span>
       </div>`
    ).join('');

    const popupHtml = `
      <div style="font-family:'DM Sans',sans-serif;min-width:180px;max-width:240px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <div style="width:10px;height:10px;border-radius:50%;background:${color};flex-shrink:0;box-shadow:0 0 0 2px ${color}44"></div>
          <div style="font-weight:900;font-size:14px">${name || 'Restricted Road'}</div>
        </div>
        <div style="background:${color}10;border:1.5px solid ${color}50;border-radius:10px;padding:8px 10px;margin-bottom:6px">
          ${labelsHtml}
        </div>
        <div style="font-size:10px;color:#9ca3af;text-align:center">
          ${lang==='es'?'Toca para cerrar':'Tap to close'}
        </div>
      </div>`;

    line.bindPopup(popupHtml, { maxWidth: 260 });

    // Small icon label at midpoint
    const midCoord = coords[Math.floor(coords.length / 2)];
    const iconLabel = tags.maxheight ? `ğŸ“${tags.maxheight}m` :
                      tags.maxweight ? `âš–ï¸${tags.maxweight}t` :
                      tags.hgv === 'no' ? 'ğŸš«HGV' :
                      tags.hazmat === 'no' ? 'â˜£ï¸' :
                      tags.hgv === 'destination' ? 'âš ï¸Local' : 'ğŸš«';
    const labelIcon = L.divIcon({
      className: '',
      html: `<div style="
        background:${color};color:#fff;
        font-size:9px;font-weight:900;
        padding:2px 5px;border-radius:5px;
        white-space:nowrap;font-family:'DM Sans',sans-serif;
        box-shadow:0 1px 4px rgba(0,0,0,.35);
        cursor:pointer;
      ">${iconLabel}</div>`,
      iconAnchor: [20, 10]
    });
    const labelMarker = L.marker(midCoord, { icon: labelIcon, interactive: false });

    if (fmPoiActive['restrict'] || mapInst !== fmMapInst) {
      line.addTo(mapInst);
      labelMarker.addTo(mapInst);
    }
    layers.push(shadow, line, labelMarker);
  });

  return layers;
}

// Check if truck is approaching a restriction on route, alert if < 3 miles
let lastRestrictionAlert = 0;
function checkNearbyRestrictions(lat, lon) {
  if (!roadGeometry || !fmPoiLayers.restrict?.length) return;
  const now = Date.now();
  if (now - lastRestrictionAlert < 60000) return; // max once per minute

  // Sample restriction polylines â€” check their midpoints
  for (const layer of fmPoiLayers.restrict) {
    if (!layer.getLatLng) continue; // skip polylines, check label markers only
    const latlng = layer.getLatLng();
    const dist   = haversine(lat, lon, latlng.lat, latlng.lng);
    if (dist > 0 && dist < 3 && isNearRoute(latlng.lat, latlng.lng, roadGeometry, 0.5)) {
      lastRestrictionAlert = now;
      const popup = layer.getTooltip?.() || layer.options?.title || '';
      showToast('warning', 'ğŸš«',
        'âš ï¸ RESTRICCIÃ“N EN TU RUTA',
        `Hay una vÃ­a restringida para camiones a ${dist.toFixed(1)} millas. Verifica la ruta.`,
        8000
      );
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      break;
    }
  }
}

// Load restrictions for fullscreen map
async function loadTruckRestrictionsFullMap(waypoints) {
  if (!fmMapInst) return;
  // Clear existing
  fmPoiLayers.restrict.forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
  fmPoiLayers.restrict = [];

  const seen = new Set();
  const radius = 20000; // 12.5 miles per waypoint (restrictions very close to route)
  const allElements = [];

  for (const wp of waypoints) {
    try {
      const q = buildRestrictionQuery(wp.lat, wp.lon, radius);
      const r = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST', body: 'data=' + encodeURIComponent(q)
      });
      const data = await r.json();
      (data.elements || []).forEach(el => {
        if (!seen.has(el.id)) { seen.add(el.id); allElements.push(el); }
      });
    } catch(e) { console.warn('Restriction fetch failed:', e); }
  }

  const layers = drawRestrictionWays(allElements, fmMapInst, roadGeometry, 0.35);
  fmPoiLayers.restrict = layers;
  fmPoiLoaded.restrict = true;

  // Update chip
  const chip = document.getElementById('chipRestrict');
  if (chip) {
    chip.style.opacity = '1';
    const count = allElements.filter(e => e.geometry).length;
    chip.innerHTML = `ğŸš« Restrictions <span style="background:rgba(255,255,255,.25);border-radius:999px;padding:1px 6px;font-size:10px;margin-left:3px">${count}</span>`;
  }
}

// Load restrictions for mini-map
async function loadMiniMapRestrictions() {
  if (!miniMap || !roadGeometry || !origin || !destination) return;

  // Clear old
  miniPoiMarkers.restrict.forEach(m => { try { miniMap.removeLayer(m); } catch {} });
  miniPoiMarkers.restrict = [];

  // Waypoints along route
  const waypoints = [];
  const step = Math.max(1, Math.floor(roadGeometry.length / 8));
  for (let i = 0; i < roadGeometry.length; i += step) waypoints.push({ lat: roadGeometry[i][0], lon: roadGeometry[i][1] });
  const last = roadGeometry[roadGeometry.length - 1];
  if (!waypoints.find(w => w.lat === last[0])) waypoints.push({ lat: last[0], lon: last[1] });

  const seen = new Set();
  const allElements = [];
  for (const wp of waypoints) {
    try {
      const q = buildRestrictionQuery(wp.lat, wp.lon, 15000);
      const r = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST', body: 'data=' + encodeURIComponent(q)
      });
      const data = await r.json();
      (data.elements || []).forEach(el => {
        if (!seen.has(el.id)) { seen.add(el.id); allElements.push(el); }
      });
    } catch {}
  }

  // Draw on mini-map (use same function but always visible since no fmPoiActive check)
  allElements.forEach(way => {
    if (!way.geometry || way.geometry.length < 2) return;
    const midIdx = Math.floor(way.geometry.length / 2);
    const midPt = way.geometry[midIdx];
    if (!isNearRoute(midPt.lat, midPt.lon, roadGeometry, 0.35)) return;

    const tags  = way.tags || {};
    const color = restrictionColor(tags);
    const coords = way.geometry.map(n => [n.lat, n.lon]);
    const labels = restrictionLabel(tags);
    const name   = tags.name || tags['name:en'] || tags.ref || '';

    const shadow = L.polyline(coords, { color, weight: 9, opacity: 0.15 }).addTo(miniMap);
    const line   = L.polyline(coords, {
      color, weight: 3.5, opacity: 0.9,
      dashArray: tags.hgv === 'destination' ? '8 5' : null,
    });

    const labelsHtml = labels.map(l =>
      `<div style="padding:3px 0;font-size:12px;font-weight:700">${l}</div>`
    ).join('');
    const popupHtml = `
      <div style="font-family:'DM Sans',sans-serif;min-width:160px">
        <div style="font-weight:900;font-size:13px;margin-bottom:6px">${name || 'Restricted Road'}</div>
        <div style="background:${color}12;border:1.5px solid ${color}44;border-radius:8px;padding:6px 10px">${labelsHtml}</div>
      </div>`;
    line.bindPopup(popupHtml, { maxWidth: 220 });

    if (miniPoiActive.restrict) line.addTo(miniMap);
    miniPoiMarkers.restrict.push(shadow, line);
  });

  // Update badge
  const badge = document.getElementById('miniBadgeRestrict');
  const cnt   = document.getElementById('miniRestrictCnt');
  if (badge) badge.classList.remove('poi-loading');
  if (cnt)   cnt.textContent = miniPoiMarkers.restrict.filter((_, i) => i % 2 === 1).length || '0';
}

function togglePOI(type) {
  fmPoiActive[type] = !fmPoiActive[type];
  const chip = document.getElementById(
    type === 'scale'    ? 'chipScale'    :
    type === 'truck'    ? 'chipTruck'    :
    type === 'rest'     ? 'chipRest'     :
    type === 'restrict' ? 'chipRestrict' : 'chipReport'
  );
  chip.classList.toggle('off', !fmPoiActive[type]);

  fmPoiLayers[type].forEach(m => {
    if (fmPoiActive[type]) { try { m.addTo(fmMapInst); } catch {} }
    else { try { fmMapInst.removeLayer(m); } catch {} }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš¨  COMMUNITY REPORTS â€” Police / Accidents / Hazards
   Stored in localStorage, shared across browser sessions
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const REPORT_ICONS = {
  police:     { emoji:'ğŸš”', color:'#3b82f6', label:'PolicÃ­a',      warn: true  },
  accident:   { emoji:'ğŸ’¥', color:'#ef4444', label:'Accidente',    warn: true  },
  inspection: { emoji:'ğŸ”', color:'#6b7280', label:'InspecciÃ³n',   warn: false },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš¨  INCIDENT TYPE TOGGLES (Settings-driven)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const INCIDENT_TYPES = {
  police:     { emoji:'ğŸš”', label:'PolicÃ­a',    bg:'#1d3a8a', statusOn:'Activo â€” marcado en el mapa' },
  accident:   { emoji:'ğŸ’¥', label:'Accidente',  bg:'#7f1d1d', statusOn:'Activo â€” marcado en el mapa' },
  inspection: { emoji:'ğŸ”', label:'InspecciÃ³n', bg:'#4b5320', statusOn:'Activo â€” marcado en el mapa' },
};

// Load saved incident type states
let activeIncidentTypes = JSON.parse(localStorage.getItem('hos_inc_types') || '{}');

function toggleIncidentType(type, btn) {
  activeIncidentTypes[type] = !activeIncidentTypes[type];
  localStorage.setItem('hos_inc_types', JSON.stringify(activeIncidentTypes));

  btn.classList.toggle('on', activeIncidentTypes[type]);
  const statusEl = document.getElementById(`inc${type.charAt(0).toUpperCase()+type.slice(1)}Status`);
  if (statusEl) {
    statusEl.textContent = activeIncidentTypes[type]
      ? INCIDENT_TYPES[type].statusOn
      : 'Desactivado';
  }

  // When activated â€” immediately submit a report at current position (if tracking)
  if (activeIncidentTypes[type] && fmIsTracking) {
    const cfg = INCIDENT_TYPES[type];
    submitIncident(type, cfg.emoji, cfg.label);
  }

  updateActiveIncidentIcons();
}

function updateActiveIncidentIcons() {
  const row = document.getElementById('activeIconsRow');
  const container = document.getElementById('activeIncidentIcons');
  if (!row || !container) return;

  row.innerHTML = '';
  const active = Object.keys(activeIncidentTypes).filter(k => activeIncidentTypes[k]);

  if (active.length === 0) {
    container.style.display = 'none';
    return;
  }
  container.style.display = 'flex';

  active.forEach(type => {
    const cfg = INCIDENT_TYPES[type];
    const icon = document.createElement('div');
    icon.className = 'inc-mini-icon';
    icon.style.background = cfg.bg + '22';
    icon.style.borderColor = cfg.bg + '55';
    icon.title = cfg.label;
    icon.textContent = cfg.emoji;
    row.appendChild(icon);
  });
}

function initIncidentToggles() {
  Object.keys(INCIDENT_TYPES).forEach(type => {
    const togId = `inc${type.charAt(0).toUpperCase()+type.slice(1)}Toggle`;
    const tog = document.getElementById(togId);
    if (!tog) return;
    const isOn = !!activeIncidentTypes[type];
    tog.classList.toggle('on', isOn);
    const statusEl = document.getElementById(`inc${type.charAt(0).toUpperCase()+type.slice(1)}Status`);
    if (statusEl) statusEl.textContent = isOn ? INCIDENT_TYPES[type].statusOn : 'Desactivado';
  });
  updateActiveIncidentIcons();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   âš ï¸  QUICK REPORT FAB â€” tap to pin incident at GPS location
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let reportSheetOpen = false;

function toggleReportSheet() {
  reportSheetOpen = !reportSheetOpen;
  const sheet = document.getElementById('reportSheet');
  const fab   = document.getElementById('reportFab');
  fab.classList.add('spinning');
  setTimeout(() => fab.classList.remove('spinning'), 320);
  fab.textContent = reportSheetOpen ? 'âœ•' : 'âš ï¸';
  sheet.classList.toggle('open', reportSheetOpen);
  // Close on outside tap
  if (reportSheetOpen) {
    setTimeout(() => {
      const close = (e) => {
        if (!sheet.contains(e.target) && e.target !== fab) {
          reportSheetOpen = false;
          fab.textContent = 'âš ï¸';
          sheet.classList.remove('open');
        }
        document.removeEventListener('pointerdown', close, true);
      };
      document.addEventListener('pointerdown', close, true);
    }, 100);
  }
}

function quickReport(type, emoji, label) {
  // Close FAB sheet if open
  if (reportSheetOpen) {
    reportSheetOpen = false;
    document.getElementById('reportFab').textContent = 'âš ï¸';
    document.getElementById('reportSheet').classList.remove('open');
  }

  // Get exact GPS location â€” prefer live GPS marker, else map center
  let lat, lon;
  if (fmGpsMarker) {
    const ll = fmGpsMarker.getLatLng();
    lat = ll.lat; lon = ll.lng;
  } else if (fmMapInst) {
    const c = fmMapInst.getCenter();
    lat = c.lat; lon = c.lng;
  } else {
    showToast('warning','âš ï¸','Sin ubicaciÃ³n','Activa el GPS primero.', 4000);
    return;
  }

  const report = {
    id: Date.now(),
    type, emoji, label,
    lat, lon,
    ts: Date.now(),
    userAgent: navigator.userAgent.substring(0, 50)
  };

  communityReports.push(report);
  communityReports = communityReports.filter(r => Date.now() - r.ts < 7200000);
  localStorage.setItem('hos_reports', JSON.stringify(communityReports));

  addReportMarker(report);
  // Incident bubble auto-dismisses from screen after 2 seconds
  addIncidentBubble(report, 2000);

  // Fly map briefly to confirm placement
  if (fmMapInst) {
    fmMapInst.flyTo([lat, lon], Math.max(fmMapInst.getZoom(), 15), { duration: 0.8 });
  }

  // 2-second on-screen toast then auto-dismiss
  showToast('warning', emoji, `${label} marcado`,
    `Marcado en el mapa. Visible para todos en esta ruta.`, 2000);
  if (navigator.vibrate) navigator.vibrate([60, 40, 120]);
}

function submitIncident(type, emoji, label) {
  if (!fmMapInst) return;
  let lat, lon;
  if (fmGpsMarker) {
    const ll = fmGpsMarker.getLatLng();
    lat = ll.lat; lon = ll.lng;
  } else {
    const c = fmMapInst.getCenter();
    lat = c.lat; lon = c.lng;
  }
  const report = { id: Date.now(), type, emoji, label, lat, lon, ts: Date.now() };
  communityReports.push(report);
  communityReports = communityReports.filter(r => Date.now() - r.ts < 7200000);
  localStorage.setItem('hos_reports', JSON.stringify(communityReports));
  addReportMarker(report);
  addIncidentBubble(report);
  
  showToast('warning', emoji, `${label} Reportado`,
    'Visible en el mapa de la ruta.', 4000);
  if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
}

// Legacy stubs (FAB removed but referenced in old bind)
function openReportPanel() {}
function closeReportPanel() {}
function submitReport(type, emoji, label) { submitIncident(type, emoji, label); }

function addReportMarker(report) {
  if (!fmMapInst) return;
  const cfg = REPORT_ICONS[report.type] || { emoji:'âš ï¸', color:'#f59e0b', label: report.label };
  const age = Math.round((Date.now() - report.ts) / 60000);
  const ageStr = age < 1 ? 'Ahora' : age === 1 ? 'Hace 1 min' : `Hace ${age} min`;

  // Pulsing circle + emoji marker
  const icon = L.divIcon({
    className: '',
    html: `
      <div style="position:relative;display:flex;flex-direction:column;align-items:center">
        <div style="
          background:${cfg.color};
          border:2.5px solid #fff;
          border-radius:50%;
          width:36px; height:36px;
          display:flex; align-items:center; justify-content:center;
          font-size:18px; line-height:1;
          box-shadow:0 3px 14px rgba(0,0,0,.55);
          animation:reportPulse 2s ease-in-out 4;
          cursor:pointer;
        ">${cfg.emoji}</div>
        <div style="
          margin-top:2px;
          background:${cfg.color};color:#fff;
          font-size:8px;font-weight:900;
          padding:2px 6px;border-radius:5px;
          white-space:nowrap;font-family:'DM Sans',sans-serif;
          box-shadow:0 1px 4px rgba(0,0,0,.4);
        ">${cfg.label}</div>
      </div>`,
    iconAnchor: [18, 18],
    popupAnchor: [0, -24]
  });

  const popupHtml = `
    <div style="font-family:'DM Sans',sans-serif;min-width:150px;text-align:center;padding:4px">
      <div style="font-size:26px;margin-bottom:4px">${cfg.emoji}</div>
      <div style="font-weight:900;font-size:14px">${cfg.label}</div>
      <div style="color:#6b7280;font-size:11px;margin-top:3px">${ageStr}</div>
      <div style="color:#ef4444;font-size:11px;font-weight:700;margin-top:6px">âš ï¸ PrecauciÃ³n en esta Ã¡rea</div>
    </div>`;

  const marker = L.marker([report.lat, report.lon], { icon })
    .addTo(fmMapInst)          // Always add â€” stays on map permanently
    .bindPopup(popupHtml);

  fmPoiLayers.reports.push(marker);
}

function renderCommunityReports() {
  // Clear old report markers
  fmPoiLayers.reports.forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
  fmPoiLayers.reports = [];
  // Re-add all valid reports
  communityReports.forEach(r => addReportMarker(r));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš¨  INCIDENT BUBBLE PANEL
   Small circular bubbles on the left â€” activatable/deactivatable
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let incidentPanelVisible = true;
let activeIncidentBubbles = {}; // id -> bubble element

function addIncidentBubble(report, autoRemoveMs = 30 * 60 * 1000) {
  const panel = document.getElementById('incidentPanel');
  if (!panel) return;
  const cfg = REPORT_ICONS[report.type] || { emoji:'âš ï¸', color:'#f59e0b', label:'Alerta' };
  const dist = (fmGpsMarker
    ? haversine(fmGpsMarker.getLatLng().lat, fmGpsMarker.getLatLng().lng, report.lat, report.lon)
    : 0).toFixed(1);

  const bubble = document.createElement('div');
  bubble.className = `incident-bubble ${report.type}`;
  bubble.id = `ib-${report.id}`;
  bubble.title = cfg.label;
  bubble.innerHTML = `
    <div class="ib-emoji">${cfg.emoji}</div>
    <div class="ib-dist">${dist}mi</div>
    <div class="ib-label">${cfg.label}</div>
    <div class="ib-close" onclick="removeIncidentBubble('${report.id}',event)">âœ•</div>
  `;
  bubble.addEventListener('click', () => showIncidentDetail(report, dist));

  panel.appendChild(bubble);
  activeIncidentBubbles[report.id] = bubble;

  // Auto-remove from screen after specified time (default 30 min, quick reports use 2s)
  setTimeout(() => removeIncidentBubble(report.id), autoRemoveMs);
}

function removeIncidentBubble(id, e) {
  if (e) e.stopPropagation();
  const bubble = activeIncidentBubbles[id];
  if (bubble) {
    bubble.style.transition = 'opacity .2s, transform .2s';
    bubble.style.opacity = '0';
    bubble.style.transform = 'scale(0.3)';
    setTimeout(() => { bubble.remove(); }, 200);
    delete activeIncidentBubbles[id];
  }
}

function updateIncidentBadge() {
  // No-op â€” badge removed with toggle button
}

function showIncidentDetail(report, dist) {
  const cfg = REPORT_ICONS[report.type] || { emoji:'âš ï¸', label:'Alert' };
  const age = Math.round((Date.now() - report.ts) / 60000);
  const ageStr = age < 1 ? 'Ahora mismo' : `Hace ${age} min`;
  showToast(
    cfg.warn ? 'danger' : 'warning',
    cfg.emoji,
    `${cfg.label} â€” ${dist}mi`,
    `Reportado ${ageStr} Â· Maneja con precauciÃ³n`,
    6000
  );
}

// Check if any reports are within 3 miles â€” show bubble (NOT fullscreen)
let lastReportAlertId = null;
function checkNearbyReports(lat, lon) {
  communityReports.forEach(r => {
    const dist = haversine(lat, lon, r.lat, r.lon);
    if (dist < 5 && !activeIncidentBubbles[r.id]) {
      // Show incident bubble on left panel
      addIncidentBubble(r);
      // Show toggle button if not visible
      
      // Small vibration for warning
      const cfg = REPORT_ICONS[r.type] || {};
      if (navigator.vibrate && cfg.warn) navigator.vibrate([100, 50, 100]);
      // Show a small toast (not fullscreen)
      showToast(
        cfg.warn ? 'danger' : 'warning',
        cfg.emoji || 'âš ï¸',
        `${cfg.label || r.label} â€” ${dist.toFixed(1)}mi`,
        'Ver panel izquierdo para detalles',
        5000
      );
    }
    // Update distance on existing bubble
    if (activeIncidentBubbles[r.id]) {
      const distEl = activeIncidentBubbles[r.id].querySelector('.ib-dist');
      if (distEl) distEl.textContent = dist.toFixed(1) + 'mi';
    }
  });
}

// Legacy startTracking/stopTracking still used by old monitor modal
function startTracking() {
  if (!origin || !destination) { alert(t('errSel')); return; }
  openFullMapScreen();
}

function stopTracking() {
  fmStopTracking();
  document.getElementById('monitorOverlay').classList.remove('open');
}

function resetForm() {
  origin = null; destination = null;
  routeDistance = 0; schedule = []; arrivalTime = null; totalTime = 0;
  roadGeometry = null; routeSource = null;
  // Clear mini-map POI markers
  ['truck','rest','restrict'].forEach(type => {
    miniPoiMarkers[type].forEach(m => { try { if(miniMap) miniMap.removeLayer(m); } catch {} });
    miniPoiMarkers[type] = [];
  });
  document.getElementById('miniPoiLegend').style.display = 'none';
  document.getElementById('originInput').value = '';
  document.getElementById('destInput').value = '';
  document.getElementById('hoursInput').value = '70';
  document.getElementById('speedInput').value = defaultSpeed;
  document.getElementById('resultsCard').style.display = 'none';
  document.getElementById('shareTrackBtns').style.display = 'none';
  document.getElementById('miniMapCard').style.display = 'none';
  hideError();
}

function showError(msg) {
  const el = document.getElementById('errorBox');
  el.textContent = 'âŒ ' + msg;
  el.style.display = 'block';
}
function hideError() {
  document.getElementById('errorBox').style.display = 'none';
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
}

function bindEvents() {
  document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));

  document.getElementById('themeToggle').addEventListener('click', () => { isDark = !isDark; localStorage.setItem('hos_theme', isDark ? 'dark' : 'light'); applyTheme(); });
  document.getElementById('lightBtn').addEventListener('click', () => { isDark = false; localStorage.setItem('hos_theme', 'light'); applyTheme(); });
  document.getElementById('darkBtn').addEventListener('click', () => { isDark = true; localStorage.setItem('hos_theme', 'dark'); applyTheme(); });
  document.getElementById('lightModeRow').addEventListener('click', () => { isDark = false; localStorage.setItem('hos_theme', 'light'); applyTheme(); });
  document.getElementById('darkModeRow').addEventListener('click', () => { isDark = true; localStorage.setItem('hos_theme', 'dark'); applyTheme(); });

  document.getElementById('langSelect').value = lang;
  document.getElementById('langSelect').addEventListener('change', e => { lang = e.target.value; localStorage.setItem('hos_lang', lang); applyLang(); updateSettingsChecks(); });

  document.getElementById('langRow').addEventListener('click', () => {
    document.getElementById('langPanel').style.display = document.getElementById('langPanel').style.display === 'none' ? 'block' : 'none';
    document.getElementById('countryPanel').style.display = 'none';
  });
  document.getElementById('setLangEn').addEventListener('click', () => { lang = 'en'; localStorage.setItem('hos_lang', lang); applyLang(); updateSettingsChecks(); document.getElementById('langPanel').style.display = 'none'; });
  document.getElementById('setLangEs').addEventListener('click', () => { lang = 'es'; localStorage.setItem('hos_lang', lang); applyLang(); updateSettingsChecks(); document.getElementById('langPanel').style.display = 'none'; });

  ['countrySelectMenu','countrySelectSettings'].forEach(id => {
    document.getElementById(id).addEventListener('change', e => {
      selectedCountry = e.target.value;
      localStorage.setItem('hos_country', selectedCountry);
      document.getElementById('countrySelectMenu').value = selectedCountry;
      document.getElementById('countrySelectSettings').value = selectedCountry;
      const c = COUNTRIES.find(x => x.code === selectedCountry);
      document.getElementById('countryVal').textContent = c ? (lang==='es'?c.es:c.en) : (lang==='en'?'All':'Todos');
      document.getElementById('countryPanel').style.display = 'none';
    });
  });

  document.getElementById('countryRow').addEventListener('click', () => {
    document.getElementById('countryPanel').style.display = document.getElementById('countryPanel').style.display === 'none' ? 'block' : 'none';
    document.getElementById('langPanel').style.display = 'none';
  });

  document.getElementById('menuBtn').addEventListener('click', e => { e.stopPropagation(); document.getElementById('menuPanel').classList.toggle('open'); });
  document.addEventListener('click', () => document.getElementById('menuPanel').classList.remove('open'));

  document.getElementById('breakToggle').addEventListener('click', e => { e.stopPropagation(); use30min = !use30min; localStorage.setItem('hos_30min', use30min); document.getElementById('breakToggle').classList.toggle('on', use30min); });

  document.getElementById('gpsBtn').addEventListener('click', useGPS);

  document.getElementById('originInput').addEventListener('input', e => {
    clearTimeout(originDebounce);
    const v = e.target.value;
    if (v.length < 2) { document.getElementById('originSugg').style.display = 'none'; return; }
    originDebounce = setTimeout(async () => {
      const items = await fetchAutocomplete(v).catch(() => []);
      showSuggestions('originSugg', items, it => { origin = it; document.getElementById('originInput').value = it.name; });
    }, 300);
  });

  document.getElementById('destInput').addEventListener('input', e => {
    clearTimeout(destDebounce);
    const v = e.target.value;
    if (v.length < 2) { document.getElementById('destSugg').style.display = 'none'; return; }
    destDebounce = setTimeout(async () => {
      const items = await fetchAutocomplete(v).catch(() => []);
      showSuggestions('destSugg', items, it => { destination = it; document.getElementById('destInput').value = it.name; });
    }, 300);
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('#originInput') && !e.target.closest('#originSugg')) document.getElementById('originSugg').style.display = 'none';
    if (!e.target.closest('#destInput') && !e.target.closest('#destSugg')) document.getElementById('destSugg').style.display = 'none';
  });

  document.getElementById('calcBtn').addEventListener('click', calculateRoute);

  document.getElementById('shareBtn').addEventListener('click', shareRoute);
  document.getElementById('trackBtn').addEventListener('click', () => {
    if (!origin || !destination) { alert(t('errSel')); return; }
    openFullMapScreen();
  });
  document.getElementById('stopTrackBtn').addEventListener('click', stopTracking);
  document.getElementById('sendReportBtn').addEventListener('click', shareRoute);
  document.getElementById('shareAppRow').addEventListener('click', shareRoute);

  document.getElementById('resetBtn').addEventListener('click', resetForm);

  document.getElementById('fullMapBtn').addEventListener('click', () => {
    if (origin && destination) openFullMapScreen();
  });

  document.getElementById('closeFullMap').addEventListener('click', closeFullMapScreen);
  document.getElementById('fmNoTrack').addEventListener('click', () => {
    document.getElementById('fmTrackBanner').style.display = 'none';
  });
  document.getElementById('fmYesTrack').addEventListener('click', () => {
    document.getElementById('fmTrackBanner').style.display = 'none';
    fmStartTracking();
  });
  document.getElementById('fmStopBtn').addEventListener('click', fmStopTracking);

  // Default speed limit setting
  document.getElementById('defaultSpeedInput').addEventListener('change', e => {
    const val = parseInt(e.target.value);
    if (!isNaN(val) && val >= 20 && val <= 85) {
      defaultSpeed = val;
      localStorage.setItem('hos_speed', val);
      document.getElementById('speedInput').value = val;
    }
  });

  // Safety feature toggles
  document.getElementById('fatigueToggle').addEventListener('click', e => { e.stopPropagation(); toggleFatigueDetector(); });
  document.getElementById('weatherToggle').addEventListener('click', e => { e.stopPropagation(); toggleWeatherMonitor(); });
  document.getElementById('bridgeToggle').addEventListener('click',  e => { e.stopPropagation(); toggleBridgeDetector(); });
  document.getElementById('trailerHeightInput').addEventListener('change', e => {
    const v = parseFloat(e.target.value);
    if (!isNaN(v) && v >= 8 && v <= 18) {
      trailerHeight = v;
      localStorage.setItem('hos_trailer', v);
      document.getElementById('bridgeDisplayVal').textContent = v.toFixed(1);
      document.getElementById('bridgeStatusTxt').textContent = `Active Â· ${v}ft trailer`;
      checkBridges();
    }
  });
  document.getElementById('closeMonitor').addEventListener('click', stopTracking);
  document.getElementById('monitorOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) stopTracking(); });
}

init();

/* â”€â”€ Mobile enhancements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Prevent double-tap zoom on buttons
document.querySelectorAll('button, .btn, .sett-row, .s-item, .tab-btn').forEach(el => {
  el.style.touchAction = 'manipulation';
});

// Haptic feedback helper (iOS / Android)
function vibrate(ms) {
  if (navigator.vibrate) navigator.vibrate(ms);
}

// Add haptic on all buttons
document.addEventListener('click', e => {
  if (e.target.closest('button, .tab-btn')) vibrate(6);
});

// Prevent rubber-band scroll on the root but allow inside scrollable areas
document.body.addEventListener('touchmove', e => {
  if (!e.target.closest('.suggestions, .page, [data-scroll]')) e.preventDefault();
}, { passive: false });

// Lock orientation is not strictly needed but add a viewport meta refresh on resize
// so Leaflet maps resize properly when keyboard closes
window.addEventListener('resize', () => {
  if (miniMap) setTimeout(() => miniMap.invalidateSize(), 200);
  if (fmMapInst) setTimeout(() => fmMapInst.invalidateSize(), 200);
});
</script>

<script id="fmHudCompactScript">
(function(){
  function makeCompactHud(){
    const hud = document.getElementById('fmHud');
    if(!hud) return;

    // Hide: "UBICACIÃ“N ACTUAL", progress, and "DESDE/HASTA" sections
    const locLbl = document.getElementById('fmLocLbl');
    const progLbl = document.getElementById('fmProgLbl');
    const fromVal = document.getElementById('fmFrom');

    const headerRow = locLbl && locLbl.closest('div'); // row container
    const progressBox = progLbl && progLbl.closest('div[style*="margin-bottom"]');
    const fromToRow = fromVal && fromVal.closest('div[style*="display:flex"]');

    // Hide handle too (first small bar)
    const handle = hud.querySelector('div[style*="width:36px"][style*="height:4px"]');

    [headerRow, progressBox, fromToRow, handle].forEach(el=>{
      if(el) el.classList.add('fm-hide');
    });

    // Convert the 4-stats grid into round tappable circles
    const eta = document.getElementById('fmEta');
    const statsRow = eta && eta.closest('div[style*="grid-template-columns"]');
    if(statsRow){
      statsRow.classList.add('fm-stats-row');
      const kids = Array.from(statsRow.children).filter(n=>n && n.tagName === 'DIV');
      kids.forEach((box)=>{
        box.classList.add('fm-stat');
        box.setAttribute('role','button');
        box.setAttribute('tabindex','0');
        const pop = ()=>{
          box.classList.add('fm-pop');
          setTimeout(()=>box.classList.remove('fm-pop'), 220);
        };
        box.addEventListener('click', pop, {passive:true});
        box.addEventListener('touchstart', pop, {passive:true});
        box.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' ') { e.preventDefault(); pop(); }
        });
      });
    }

    // Enable compact mode (transparent background, only circles visible)
    hud.classList.add('compact');
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', makeCompactHud);
  } else {
    makeCompactHud();
  }
})();
</script>

</body>
</html>
