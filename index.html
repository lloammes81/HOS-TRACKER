<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HOS Tracker ğŸš›</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #f4f3ef;
    --surface: #ffffff;
    --text: #111111;
    --muted: #6b7280;
    --accent: #10b981;
    --accent2: #059669;
    --danger: #ef4444;
    --blue: #3b82f6;
    --purple: #8b5cf6;
    --border: #e5e7eb;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);
    --radius: 16px;
    --tab-h: 64px;
  }
  body.dark {
    --bg: #0f172a;
    --surface: #1e293b;
    --text: #f1f5f9;
    --muted: #94a3b8;
    --border: #334155;
    --shadow: 0 2px 16px rgba(0,0,0,0.4);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: "DM Sans", sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    transition: background .3s, color .3s;
  }
  .bg-icons {
    position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden;
  }
  .bg-icons span { position: absolute; user-select: none; }
  .App { position: relative; z-index: 1; padding-bottom: calc(var(--tab-h) + 10px); }

  /* TAB BAR */
  .tab-bar {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    height: var(--tab-h);
    box-shadow: 0 -2px 20px rgba(0,0,0,0.08);
  }
  .tab-btn {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 4px; border: none; background: none; color: var(--muted);
    font-family: "DM Sans", sans-serif; font-size: 10px; font-weight: 600;
    cursor: pointer; transition: color .2s; padding: 0;
  }
  .tab-btn svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; }
  .tab-btn.active { color: var(--accent); }

  /* PAGES */
  .page { display: none; }
  .page.active { display: block; }
  .container { max-width: 480px; margin: 0 auto; padding: 0 14px 20px; }

  /* HEADER */
  .header { padding: 18px 0 10px; }
  .logo { font-family: "Bebas Neue", sans-serif; font-size: 26px; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
  .subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; font-weight: 500; letter-spacing: .5px; text-transform: uppercase; }
  .row { display: flex; align-items: center; gap: 8px; }
  .row.between { justify-content: space-between; }

  /* CARDS */
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 14px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  /* INPUTS */
  label { display: block; font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 4px; margin-top: 12px; text-transform: uppercase; letter-spacing: .5px; }
  label:first-child { margin-top: 0; }
  input, select {
    width: 100%; padding: 11px 14px; border: 1.5px solid var(--border);
    border-radius: 10px; font-family: "DM Sans", sans-serif; font-size: 15px;
    background: var(--bg); color: var(--text); outline: none; transition: border .2s;
  }
  input:focus, select:focus { border-color: var(--accent); }
  .inputwrap { position: relative; }
  .suggestions {
    position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: 10px; box-shadow: var(--shadow); max-height: 220px; overflow-y: auto; margin-top: 2px;
  }
  .s-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background .15s; }
  .s-item:last-child { border-bottom: none; }
  .s-item:hover { background: var(--bg); }
  .s-name { font-weight: 700; font-size: 14px; }
  .s-detail { font-size: 12px; color: var(--muted); margin-top: 1px; }

  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
  .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .grid3 label { margin-top: 0; }

  /* BUTTONS */
  .btn {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 13px; border-radius: 12px; border: none;
    font-family: "DM Sans", sans-serif; font-size: 15px; font-weight: 800;
    cursor: pointer; transition: transform .15s, opacity .15s; letter-spacing: .3px;
  }
  .btn:active { transform: scale(.97); }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-blue { background: var(--blue); color: #fff; }
  .btn-purple { background: var(--purple); color: #fff; }
  .btn-red { background: var(--danger); color: #fff; margin-top: 14px; }
  .iconbtn {
    width: 36px; height: 36px; border-radius: 50%; border: 1.5px solid var(--border);
    background: var(--surface); cursor: pointer; font-size: 16px; display: flex;
    align-items: center; justify-content: center; transition: background .2s;
  }
  .iconbtn:hover { background: var(--bg); }
  .smallbtn {
    font-size: 12px; font-weight: 700; padding: 5px 10px; border-radius: 8px;
    border: 1.5px solid var(--accent); color: var(--accent); background: none; cursor: pointer;
    font-family: "DM Sans", sans-serif;
  }

  /* INFO / ERROR */
  .info { background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 8px; padding: 8px 12px; font-size: 12px; color: #065f46; margin-bottom: 12px; font-weight: 600; }
  body.dark .info { background: #064e3b; border-color: #065f46; color: #a7f3d0; }
  .error { background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 8px 12px; font-size: 13px; color: var(--danger); margin-top: 8px; font-weight: 600; }
  .hint { font-size: 11px; color: var(--muted); margin-top: 4px; }

  /* RESULTS */
  .pill {
    display: inline-block; background: #ecfdf5; color: var(--accent); border-radius: 999px;
    padding: 4px 14px; font-size: 13px; font-weight: 800; margin-bottom: 8px; border: 1.5px solid #a7f3d0;
  }
  .pill.danger { background: #fef2f2; color: var(--danger); border-color: #fecaca; }
  .big { font-family: "Bebas Neue", sans-serif; font-size: 52px; line-height: 1; margin: 4px 0 12px; }
  .kv { margin-bottom: 8px; }
  .k { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
  .v { font-size: 15px; font-weight: 700; margin-top: 1px; }

  /* SCHEDULE */
  .schedule { margin-top: 14px; }
  .sched { border-left: 4px solid var(--accent); padding: 10px 12px; margin-bottom: 8px; border-radius: 0 10px 10px 0; background: var(--bg); }
  .sched.rest { border-color: var(--blue); }
  .sched.reset { border-color: var(--purple); }
  .sched.break30 { border-color: #f59e0b; }
  .sched .t { font-size: 13px; font-weight: 800; }
  .sched .d { font-size: 12px; color: var(--muted); margin-top: 2px; }

  /* MAP */
  .mapbox { height: 200px; border-radius: 12px; overflow: hidden; margin-top: 10px; }
  .fullmap { height: 70vh; border-radius: 0; }

  /* MODAL OVERLAY */
  .fullmap-overlay, .monitor-overlay {
    display: none; position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    align-items: flex-end; justify-content: center;
  }
  .fullmap-overlay.open, .monitor-overlay.open { display: flex; }
  .fullmap-card, .monitor-card {
    background: var(--surface); border-radius: 20px 20px 0 0; width: 100%;
    max-width: 480px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;
    animation: slideUp .3s ease;
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-head {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 18px; border-bottom: 1px solid var(--border);
    font-weight: 800; font-size: 16px;
  }
  .modal-close {
    width: 30px; height: 30px; border-radius: 50%; border: none;
    background: var(--border); font-size: 18px; cursor: pointer; color: var(--text);
    display: flex; align-items: center; justify-content: center; font-family: "DM Sans", sans-serif;
  }

  /* MONITOR */
  .stack { display: flex; flex-direction: column; gap: 12px; }
  .bar { height: 8px; background: var(--border); border-radius: 999px; overflow: hidden; margin: 4px 0; }
  .bar > div { height: 100%; background: var(--accent); border-radius: 999px; transition: width .5s; }
  .muted { font-size: 12px; color: var(--muted); }

  /* DRIVES */
  .drives-tabs { display: flex; gap: 8px; margin-bottom: 12px; }
  .drives-tab {
    padding: 6px 14px; border-radius: 999px; border: 1.5px solid var(--accent);
    background: var(--accent); color: #fff; font-family: "DM Sans", sans-serif;
    font-size: 13px; font-weight: 700; cursor: pointer;
  }
  .drives-tab span { background: rgba(255,255,255,.25); border-radius: 999px; padding: 1px 6px; margin-left: 4px; font-size: 11px; }
  .drives-header { padding: 4px 0 8px; }
  .drive-item { display: flex; gap: 12px; padding: 12px 14px; background: var(--surface); border-radius: 12px; margin-bottom: 8px; box-shadow: var(--shadow); border: 1px solid var(--border); }
  .drive-thumb { font-size: 28px; display: flex; align-items: center; }
  .drive-info { flex: 1; }
  .drive-route { font-weight: 800; font-size: 15px; }
  .drive-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .drive-amount { font-size: 16px; font-weight: 900; color: var(--accent); margin-top: 4px; }
  .no-drives { text-align: center; padding: 48px 20px; color: var(--muted); font-size: 15px; line-height: 1.8; }

  /* SETTINGS */
  .sett-section { margin-bottom: 20px; }
  .sett-section-title { font-size: 11px; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; padding: 0 4px; margin-bottom: 8px; }
  .sett-group { background: var(--surface); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border); }
  .sett-row { display: flex; align-items: center; gap: 12px; padding: 13px 16px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background .15s; }
  .sett-row:last-child { border-bottom: none; }
  .sett-row:hover { background: var(--bg); }
  .sett-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
  .sett-label { flex: 1; font-weight: 600; font-size: 15px; }
  .sett-value { font-size: 13px; color: var(--muted); font-weight: 500; }
  .sett-arrow { font-size: 20px; color: var(--muted); font-weight: 300; }
  .sett-check { font-size: 18px; color: var(--accent); font-weight: 900; }
  .sett-toggle {
    width: 46px; height: 26px; border-radius: 999px; border: none;
    background: var(--border); cursor: pointer; position: relative; transition: background .25s; flex-shrink: 0;
  }
  .sett-toggle::after {
    content: ""; position: absolute; top: 3px; left: 3px;
    width: 20px; height: 20px; border-radius: 50%; background: #fff;
    transition: left .25s; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .sett-toggle.on { background: var(--accent); }
  .sett-toggle.on::after { left: 23px; }

  /* MENU PANEL */
  .menu-wrap { position: relative; }
  .menu-panel {
    display: none; position: absolute; top: 44px; right: 0; width: 230px;
    background: var(--surface); border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    border: 1px solid var(--border); z-index: 99; padding: 12px;
  }
  .menu-panel.open { display: block; }
  .menu-title { font-weight: 800; font-size: 14px; margin-bottom: 10px; }
  .menu-group { margin-bottom: 10px; }
  .menu-label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 4px; display: block; }
  .menu-select { width: 100%; padding: 7px 10px; border-radius: 8px; border: 1.5px solid var(--border); font-family: "DM Sans", sans-serif; font-size: 13px; background: var(--bg); color: var(--text); }
  .menu-row { display: flex; gap: 6px; }
  .chip-btn { flex: 1; padding: 6px; border-radius: 8px; border: 1.5px solid var(--border); font-family: "DM Sans", sans-serif; font-size: 12px; font-weight: 600; background: var(--bg); color: var(--text); cursor: pointer; transition: all .2s; }
  .chip-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  @media (max-width: 360px) {
    .big { font-size: 40px; }
    .grid3 { grid-template-columns: 1fr; }
  }
</style>
</head>

<body>
<div class="bg-icons" aria-hidden="true">
  <span style="top:4%;left:3%;font-size:58px;opacity:.10">ğŸš›</span>
  <span style="top:12%;right:8%;font-size:44px;opacity:.08">â°</span>
  <span style="top:24%;left:10%;font-size:36px;opacity:.08">ğŸ•</span>
  <span style="top:28%;right:14%;font-size:62px;opacity:.07">ğŸšš</span>
  <span style="top:42%;left:4%;font-size:46px;opacity:.07">â±ï¸</span>
  <span style="top:54%;right:4%;font-size:64px;opacity:.08">ğŸš›</span>
  <span style="top:66%;left:14%;font-size:42px;opacity:.07">ğŸ•’</span>
  <span style="top:78%;right:12%;font-size:38px;opacity:.08">â°</span>
  <span style="top:84%;left:6%;font-size:60px;opacity:.09">ğŸšš</span>
  <span style="top:88%;right:24%;font-size:34px;opacity:.07">ğŸ•™</span>
</div>

<div class="App">
  <!-- TAB BAR -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="plan">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span id="tabLblPlan">Plan Route</span>
    </button>
    <button class="tab-btn" data-tab="drives">
      <svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13" rx="2"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
      <span id="tabLblDrives">All Drives</span>
    </button>
    <button class="tab-btn" data-tab="summary">
      <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      <span id="tabLblSummary">Summaries</span>
    </button>
    <button class="tab-btn" data-tab="settings">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      <span id="tabLblSettings">Settings</span>
    </button>
  </div>

  <!-- PLAN PAGE -->
  <div class="page active" id="page-plan">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">ğŸš› <span>HOS Tracker</span></div>
          <div class="row">
            <button class="iconbtn" id="themeToggle" title="Theme">ğŸŒ™</button>
            <button class="iconbtn" id="gpsBtn" title="GPS" style="font-size:16px">ğŸ“</button>
            <div class="menu-wrap">
              <button class="iconbtn" id="menuBtn">âš™ï¸</button>
              <div class="menu-panel" id="menuPanel">
                <div class="menu-title" id="menuTitle">Settings</div>
                <div class="menu-group">
                  <label class="menu-label" id="menuLangLbl">Language</label>
                  <select class="menu-select" id="langSelect">
                    <option value="en">English</option>
                    <option value="es">EspaÃ±ol</option>
                  </select>
                </div>
                <div class="menu-group">
                  <label class="menu-label" id="menuThemeLbl">Theme</label>
                  <div class="menu-row">
                    <button class="chip-btn active" id="lightBtn">â˜€ï¸ Light</button>
                    <button class="chip-btn" id="darkBtn">ğŸŒ™ Dark</button>
                  </div>
                </div>
                <div class="menu-group">
                  <label class="menu-label" id="menuCountryLbl">Country</label>
                  <select class="menu-select" id="countrySelectMenu"></select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="subtitle" id="subtitleTxt">DOT Hours of Service Planner</div>
      </div>

      <!-- MINI MAP -->
      <div class="card" id="miniMapCard" style="display:none">
        <div class="row between">
          <div style="font-weight:800">ğŸ—ºï¸ <span id="routeMapLbl">Route Map</span></div>
          <button class="smallbtn" id="fullMapBtn">View Full Map</button>
        </div>
        <div class="hint" id="roadHintTxt">Real road route when available</div>
        <div class="hint" id="routeSourceTxt"></div>
        <div class="mapbox" id="miniMap"></div>
      </div>

      <!-- FORM -->
      <div class="card">
        <div class="info" id="infoTxt">ğŸ’¡ Type city name to search globally</div>

        <label id="lblFrom">ğŸ“ Origin</label>
        <div class="inputwrap">
          <input id="originInput" placeholder="Miami, FL" autocomplete="off" />
          <div class="suggestions" id="originSugg" style="display:none"></div>
        </div>

        <label id="lblTo">ğŸ¯ Destination</label>
        <div class="inputwrap">
          <input id="destInput" placeholder="Dallas, TX" autocomplete="off" />
          <div class="suggestions" id="destSugg" style="display:none"></div>
        </div>

        <div class="grid3" style="margin-top:10px">
          <div>
            <label id="lblTime">ğŸ• Departure</label>
            <input type="datetime-local" id="departureInput" />
          </div>
          <div>
            <label id="lblHours">â±ï¸ Hours Left</label>
            <input type="number" id="hoursInput" min="1" max="70" value="70" />
          </div>
          <div>
            <label id="lblSpeed">ğŸš€ Speed (mph)</label>
            <input type="number" id="speedInput" min="1" value="60" />
          </div>
        </div>

        <div class="error" id="errorBox" style="display:none"></div>

        <button class="btn btn-primary" id="calcBtn" style="margin-top:12px">ğŸš› Calculate Route</button>

        <div class="grid2" id="shareTrackBtns" style="display:none;margin-top:10px">
          <button class="btn btn-blue" id="shareBtn">ğŸ“¤ Share Route</button>
          <button class="btn btn-purple" id="trackBtn">ğŸ“ Start Live Tracking</button>
        </div>
      </div>

      <!-- RESULTS -->
      <div class="card results" id="resultsCard" style="display:none">
        <div class="pill" id="timeVsHours"></div>
        <div class="big" id="distanceBig"></div>
        <div class="grid2">
          <div class="kv"><div class="k" id="fromLbl">FROM</div><div class="v" id="fromVal"></div></div>
          <div class="kv"><div class="k" id="toLbl">TO</div><div class="v" id="toVal"></div></div>
        </div>
        <div class="grid2">
          <div class="kv"><div class="k" id="departureLbl">DEPARTURE</div><div class="v" id="departureVal"></div></div>
          <div class="kv"><div class="k" id="arrivalLbl">ARRIVAL</div><div class="v" id="arrivalVal"></div></div>
        </div>
        <div class="kv"><div class="k" id="totalTimeLbl">TOTAL TIME</div><div class="v" id="totalTimeVal"></div></div>
        <div class="schedule" id="scheduleList"></div>
        <button class="btn btn-red" id="resetBtn">ğŸ”„ New Route</button>
      </div>
    </div>
  </div>

  <!-- DRIVES PAGE -->
  <div class="page" id="page-drives">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">ğŸš› <span id="drivesTitleTxt">All Drives</span></div>
        </div>
      </div>
      <div class="drives-tabs">
        <button class="drives-tab" id="drivesTabBtn">Business <span id="drivesCount">0</span></button>
      </div>
      <div id="drivesList"></div>
    </div>
  </div>

  <!-- SUMMARY PAGE -->
  <div class="page" id="page-summary">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">ğŸš› <span id="summaryTitleTxt">Summaries</span></div>
        </div>
      </div>
      <div class="card" style="text-align:center">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px">
          <div>
            <div style="font-size:28px;font-weight:900" id="sumDrives">0</div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="sumDrivesLbl">Drives</div>
          </div>
          <div>
            <div style="font-size:28px;font-weight:900;color:var(--muted)" id="sumMiles">0</div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="sumMilesLbl">Miles</div>
          </div>
          <div>
            <div style="font-size:28px;font-weight:900;color:var(--accent)" id="sumValue">$0</div>
            <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px" id="sumValueLbl">Logged</div>
          </div>
        </div>
        <div style="font-size:48px;margin:16px 0">ğŸš›</div>
        <div style="font-size:16px;font-weight:700;margin-bottom:8px" id="sumStatus">No routes yet</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:16px" id="sumDesc">Plan a route to see your summary here.</div>
        <button class="btn btn-primary" id="sendReportBtn" style="display:none">ğŸ“¤ Send Report</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS PAGE -->
  <div class="page" id="page-settings">
    <div class="container">
      <div class="header">
        <div class="row between">
          <div class="logo">âš™ï¸ <span id="settTitleTxt">Settings</span></div>
        </div>
      </div>

      <div class="sett-section">
        <div class="sett-section-title" id="settSecGeneral">General</div>
        <div class="sett-group">
          <div class="sett-row" id="langRow">
            <div class="sett-icon" style="background:#dbeafe">ğŸ—£ï¸</div>
            <div class="sett-label" id="settLangRow">Language</div>
            <div class="sett-value" id="langVal">English</div>
            <span class="sett-arrow">â€º</span>
          </div>
          <div class="sett-row" id="countryRow">
            <div class="sett-icon" style="background:#d1fae5">ğŸŒ</div>
            <div class="sett-label" id="settCountryRow">Country Filter</div>
            <div class="sett-value" id="countryVal">All</div>
            <span class="sett-arrow">â€º</span>
          </div>
        </div>
      </div>

      <div class="sett-section" id="langPanel" style="display:none">
        <div class="sett-section-title">Language / Idioma</div>
        <div class="sett-group">
          <div class="sett-row" id="setLangEn">
            <div class="sett-icon">ğŸ‡ºğŸ‡¸</div>
            <div class="sett-label">English</div>
            <span class="sett-check" id="checkEn">âœ“</span>
          </div>
          <div class="sett-row" id="setLangEs">
            <div class="sett-icon">ğŸ‡ªğŸ‡¸</div>
            <div class="sett-label">EspaÃ±ol</div>
            <span class="sett-check" id="checkEs" style="opacity:0">âœ“</span>
          </div>
        </div>
      </div>

      <div class="sett-section" id="countryPanel" style="display:none">
        <div class="sett-section-title" id="settCountryRowTitle">Country Filter</div>
        <div class="sett-group" style="margin:0 14px">
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#d1fae5">ğŸŒ</div>
            <select id="countrySelectSettings" style="flex:1;border:none;background:transparent;font-size:15px;color:var(--text);outline:none;cursor:pointer;padding:4px 0;font-family:'DM Sans',sans-serif"></select>
          </div>
        </div>
      </div>

      <div class="sett-section">
        <div class="sett-section-title" id="settSecAppear">Appearance</div>
        <div class="sett-group">
          <div class="sett-row" id="lightModeRow">
            <div class="sett-icon" style="background:#fef9c3">â˜€ï¸</div>
            <div class="sett-label" id="settLightRow">Light Mode</div>
            <span class="sett-check" id="checkLight">âœ“</span>
          </div>
          <div class="sett-row" id="darkModeRow">
            <div class="sett-icon" style="background:#1e293b">ğŸŒ™</div>
            <div class="sett-label" id="settDarkRow">Dark Mode</div>
            <span class="sett-check" id="checkDark" style="opacity:0">âœ“</span>
          </div>
        </div>
      </div>

      <div class="sett-section">
        <div class="sett-section-title" id="settSecHOS">HOS Rules</div>
        <div class="sett-group">
          <div class="sett-row" style="cursor:default">
            <div class="sett-icon" style="background:#fee2e2">ğŸš¦</div>
            <div class="sett-label" id="settSpeedLimitRow">Default Speed Limit</div>
            <div style="display:flex;align-items:center;gap:6px">
              <input type="number" id="defaultSpeedInput" min="20" max="85" value="60" style="width:64px;padding:5px 8px;font-size:14px;font-weight:700;text-align:center;border-radius:8px;border:1.5px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif" />
              <span style="font-size:12px;color:var(--muted);font-weight:600">mph</span>
            </div>
          </div>
          <div class="sett-row">
            <div class="sett-icon" style="background:#fef3c7">â˜•</div>
            <div class="sett-label" id="settBreakRow">30-min Break Rule</div>
            <button class="sett-toggle on" id="breakToggle"></button>
          </div>
          <div class="sett-row">
            <div class="sett-icon" style="background:#d1fae5">â±ï¸</div>
            <div class="sett-label" id="settCycleRow">Cycle Hours</div>
            <div class="sett-value">70 hrs DOT</div>
          </div>
          <div class="sett-row">
            <div class="sett-icon" style="background:#dbeafe">ğŸ˜´</div>
            <div class="sett-label" id="settRestRow">Rest Requirement</div>
            <div class="sett-value">10 hrs DOT</div>
          </div>
        </div>
      </div>

      <div class="sett-section">
        <div class="sett-section-title" id="settSecAbout">About</div>
        <div class="sett-group">
          <div class="sett-row">
            <div class="sett-icon" style="background:#d1fae5">ğŸš›</div>
            <div class="sett-label">HOS Tracker</div>
            <div class="sett-value">v6.0</div>
          </div>
          <div class="sett-row" id="shareAppRow">
            <div class="sett-icon" style="background:#dbeafe">ğŸ“¤</div>
            <div class="sett-label" id="settShareRow">Share App</div>
            <span class="sett-arrow">â€º</span>
          </div>
        </div>
      </div>
      <div style="height:20px"></div>
    </div>
  </div>
</div>

<!-- ============================================================
     FULLSCREEN MAP VIEW  (Google Maps style)
     ============================================================ -->
<div id="fullMapScreen" style="
  display:none; position:fixed; inset:0; z-index:500;
  background:#000; flex-direction:column;
">
  <!-- MAP fills entire screen -->
  <div id="fullMap" style="position:absolute;inset:0;z-index:1"></div>

  <!-- TOP BAR: close + live dot -->
  <div style="
    position:absolute;top:0;left:0;right:0;z-index:10;
    display:flex;align-items:center;justify-content:space-between;
    padding:14px 14px 0;
    pointer-events:none;
  ">
    <!-- Left: close btn -->
    <button id="closeFullMap" style="
      pointer-events:all;
      width:40px;height:40px;border-radius:50%;border:none;
      background:rgba(15,23,42,0.85);backdrop-filter:blur(8px);
      color:#fff;font-size:20px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 2px 12px rgba(0,0,0,0.4);
    ">â†</button>

    <!-- Center: date/time pill -->
    <div style="
      pointer-events:none;
      background:rgba(15,23,42,0.85);backdrop-filter:blur(8px);
      border-radius:999px;padding:6px 14px;
      display:flex;align-items:center;gap:8px;
      box-shadow:0 2px 12px rgba(0,0,0,0.3);
    ">
      <div id="fmLiveDot" style="width:7px;height:7px;border-radius:50%;background:#6b7280;flex-shrink:0"></div>
      <span id="fmClockTxt" style="font-size:13px;font-weight:700;color:#f1f5f9;white-space:nowrap">--:-- --</span>
      <span style="color:rgba(255,255,255,0.3)">Â·</span>
      <span id="fmDateTxt" style="font-size:11px;color:rgba(255,255,255,0.6);white-space:nowrap">---</span>
    </div>

    <!-- Right: speed badge -->
    <div style="
      pointer-events:none;
      background:rgba(15,23,42,0.85);backdrop-filter:blur(8px);
      border-radius:12px;padding:6px 12px;text-align:center;
      box-shadow:0 2px 12px rgba(0,0,0,0.3);min-width:56px;
    ">
      <div id="fmSpeedVal" style="font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1;color:#10b981">0</div>
      <div style="font-size:9px;color:rgba(255,255,255,0.5);font-weight:700;letter-spacing:.5px">MPH</div>
    </div>
  </div>

  <!-- CONFIRM TRACKING BANNER (shows when map opens, before tracking starts) -->
  <div id="fmTrackBanner" style="
    position:absolute;top:74px;left:14px;right:14px;z-index:10;
    background:rgba(15,23,42,0.92);backdrop-filter:blur(12px);
    border-radius:16px;padding:14px 16px;
    border:1px solid rgba(16,185,129,0.3);
    box-shadow:0 4px 20px rgba(0,0,0,0.5);
  ">
    <div style="font-size:13px;color:rgba(255,255,255,0.8);font-weight:600;margin-bottom:10px;text-align:center" id="fmBannerDesc">
      ğŸ“¡ Â¿Activar seguimiento GPS en vivo?
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button id="fmNoTrack" style="
        padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);
        background:rgba(255,255,255,0.08);color:#f1f5f9;font-family:'DM Sans',sans-serif;
        font-size:13px;font-weight:700;cursor:pointer;
      ">ğŸ—ºï¸ Solo mapa</button>
      <button id="fmYesTrack" style="
        padding:10px;border-radius:10px;border:none;
        background:#10b981;color:#fff;font-family:'DM Sans',sans-serif;
        font-size:13px;font-weight:800;cursor:pointer;
      ">ğŸ“¡ Dar seguimiento</button>
    </div>
  </div>

  <!-- BOTTOM HUD PANEL -->
  <div id="fmHud" style="
    position:absolute;bottom:0;left:0;right:0;z-index:10;
    background:rgba(10,16,30,0.92);
    backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border-radius:20px 20px 0 0;
    border-top:1px solid rgba(255,255,255,0.08);
    padding:14px 16px 24px;
    color:#f1f5f9;
    box-shadow:0 -4px 30px rgba(0,0,0,0.5);
    transform:translateY(100%);
    transition:transform .4s cubic-bezier(.16,1,.3,1);
  ">
    <!-- Handle -->
    <div style="width:36px;height:4px;background:rgba(255,255,255,0.2);border-radius:999px;margin:0 auto 14px"></div>

    <!-- Route header -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div style="flex:1;min-width:0">
        <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px" id="fmLocLbl">UBICACIÃ“N ACTUAL</div>
        <div style="font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="fmLocVal">Localizando...</div>
      </div>
      <div id="fmStatusChip" style="
        margin-left:10px;padding:4px 10px;border-radius:999px;flex-shrink:0;
        font-size:11px;font-weight:800;
        background:rgba(107,114,128,0.25);color:#9ca3af;
      ">â¸ Detenido</div>
    </div>

    <!-- Progress bar + pct -->
    <div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.4px" id="fmProgLbl">PROGRESO DE RUTA</span>
        <span style="font-size:11px;font-weight:800;color:#10b981" id="fmPct">0%</span>
      </div>
      <div style="height:6px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden">
        <div id="fmBar" style="height:100%;background:linear-gradient(90deg,#10b981,#3b82f6);border-radius:999px;width:0%;transition:width .6s ease"></div>
      </div>
    </div>

    <!-- 4 stats -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:12px">
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fmEtaLbl">LLEGADA</div>
        <div style="font-size:15px;font-weight:900;color:#f59e0b;line-height:1" id="fmEta">--</div>
      </div>
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fmRemLbl">RESTANTE</div>
        <div style="font-size:15px;font-weight:900;color:#3b82f6;line-height:1" id="fmRem">--</div>
      </div>
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fmDriveLbl">MANEJO</div>
        <div style="font-size:15px;font-weight:900;color:#10b981;line-height:1" id="fmDriveLeft">11h</div>
      </div>
      <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:8px 4px;text-align:center">
        <div style="font-size:8px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px" id="fm70Lbl">70 HRS</div>
        <div style="font-size:15px;font-weight:900;color:#8b5cf6;line-height:1" id="fm70Left">70h</div>
      </div>
    </div>

    <!-- Route from â†’ to -->
    <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:12px">
      <div style="flex:1;min-width:0">
        <div style="font-size:9px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:.4px">DESDE</div>
        <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="fmFrom">--</div>
      </div>
      <div style="font-size:18px;color:rgba(255,255,255,0.25);flex-shrink:0">â†’</div>
      <div style="flex:1;min-width:0;text-align:right">
        <div style="font-size:9px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:.4px">HASTA</div>
        <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;direction:rtl" id="fmTo">--</div>
      </div>
    </div>

    <!-- Stop button (only when tracking) -->
    <button id="fmStopBtn" style="
      display:none;width:100%;margin-top:12px;padding:12px;
      background:#ef4444;color:#fff;border:none;border-radius:12px;
      font-family:'DM Sans',sans-serif;font-size:15px;font-weight:800;cursor:pointer;
    ">ğŸ›‘ Detener Seguimiento</button>
  </div>
</div>

<style>
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }
@keyframes liveblink { 0%,100%{opacity:1} 50%{opacity:.3} }
</style>


<div class="monitor-overlay" id="monitorOverlay">
  <div class="monitor-card">
    <div class="modal-head">
      <div>ğŸ“ <span id="monitorTitle">LIVE TRACKING</span></div>
      <button class="modal-close" id="closeMonitor">Ã—</button>
    </div>
    <div style="padding:12px;overflow:auto" class="stack">
      <div class="kv"><div class="k" id="currentLocLbl">CURRENT LOCATION</div><div class="v" id="currentLocVal">-</div></div>
      <div class="kv">
        <div class="k" id="currentSpeedLbl">CURRENT SPEED</div>
        <div class="v"><span style="font-size:40px;font-weight:900" id="speedVal">0</span> <span class="muted">mph</span></div>
        <div class="muted" id="statusVal">Ready</div>
      </div>
      <div class="kv">
        <div class="k" id="progressLbl">TRIP PROGRESS</div>
        <div class="bar"><div id="progressBar" style="width:0%"></div></div>
        <div class="v" id="progressPct">0%</div>
      </div>
      <div class="grid2">
        <div class="kv"><div class="k" id="traveledLbl">TRAVELED</div><div class="v" id="traveledVal">0 mi</div></div>
        <div class="kv"><div class="k" id="remainingLbl">REMAINING</div><div class="v" id="remainingVal">0 mi</div></div>
      </div>
      <div class="grid2">
        <div class="kv"><div class="k" id="elapsedLbl">ELAPSED</div><div class="v" id="elapsedVal">0h</div></div>
        <div class="kv"><div class="k" id="etaLbl">ETA</div><div class="v" id="etaVal">0h</div></div>
      </div>
      <button class="btn btn-red" id="stopTrackBtn">ğŸ›‘ Stop Tracking</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const T = {
  en: {
    subtitle:'DOT Hours of Service Planner',info:'Type city name to search globally',lblFrom:'ğŸ“ Origin',lblTo:'ğŸ¯ Destination',
    lblTime:'ğŸ• Departure',lblHours:'â±ï¸ Hours Left',lblSpeed:'ğŸš€ Speed (mph)',btnCalc:'ğŸš› Calculate Route',
    shareText:'ğŸ“¤ Share Route',monitorText:'ğŸ“ Start Live Tracking',stopText:'ğŸ›‘ Stop Tracking',monitorTitle:'LIVE TRACKING',
    errSel:'Select origin and destination',err70:'Max 70 hours',errSpeed:'Invalid speed',day:'Day',drive:'Driving',rest:'Rest',
    reset:'34H RESET',from:'FROM',to:'TO',departure:'DEPARTURE',arrival:'ARRIVAL',totalTime:'TOTAL TIME',
    routeMap:'Route Map',fullMap:'View Full Map',roadHint:'Real road route when available',
    currentLoc:'CURRENT LOCATION',currentSpeed:'CURRENT SPEED',progress:'TRIP PROGRESS',traveled:'TRAVELED',
    remaining:'REMAINING',elapsed:'ELAPSED',eta:'ETA',copied:'Route copied!',locating:'Locating...',ready:'Ready',
    driving:'Driving',stopped:'Stopped',gpsDenied:'Allow location access in your browser',arrived:'ğŸ‰ Arrived!',
    sourceRoad:'Road route source',sourceOsrm:'OSRM',sourceFallback:'Direct line fallback',
    menuTitle:'Settings',menuLang:'Language',menuTheme:'Theme',menuCountry:'Country search',light:'Light',dark:'Dark',
    tabLblPlan:'Plan Route',tabLblDrives:'All Drives',tabLblSummary:'Summaries',tabLblSettings:'Settings',
    drivesTitle:'All Drives',summaryTitle:'Summaries',settingsPageTitle:'Settings',settSecGeneral:'General',
    settSecAppear:'Appearance',settSecHOS:'HOS Rules',settSecAbout:'About',settLangRow:'Language',
    settCountryRow:'Country Filter',settLightRow:'Light Mode',settDarkRow:'Dark Mode',settBreakRow:'30-min Break Rule',
    settCycleRow:'Cycle Hours',settRestRow:'Rest Requirement',settShareRow:'Share App',sendReportText:'Send Report',
    noDrives:'No drives recorded yet.',calcFirst:'Calculate your first route.',noRoutes:'No routes yet',
    planRoute:'Plan a route to see your summary here.',allLogged:'Great job, all routes logged!',status100:'100% logged',
    sumDrivesLbl:'Drives',sumMilesLbl:'Miles',sumValueLbl:'Logged',business:'Business',
    settSpeedLimitRow:'Default Speed Limit',
    confirmTrackTitle:'Full Map View',confirmTrackDesc:'Do you want to activate live route tracking?',
    confirmNoTxt:'Map only',confirmYesTxt:'Yes, track me',
    hud70Lbl:'70 HRS',hudDriveLbl:'DRIVE TIME',hudProgLbl:'PROGRESS'
  },
  es: {
    subtitle:'Planificador de Horas DOT',info:'Escribe nombre de ciudad para buscar',lblFrom:'ğŸ“ Origen',lblTo:'ğŸ¯ Destino',
    lblTime:'ğŸ• Salida',lblHours:'â±ï¸ Horas Restantes',lblSpeed:'ğŸš€ Velocidad (mph)',btnCalc:'ğŸš› Calcular Ruta',
    shareText:'ğŸ“¤ Compartir Ruta',monitorText:'ğŸ“ Iniciar Rastreo',stopText:'ğŸ›‘ Detener Rastreo',monitorTitle:'RASTREO EN VIVO',
    errSel:'Selecciona origen y destino',err70:'MÃ¡ximo 70 horas',errSpeed:'Velocidad invÃ¡lida',day:'DÃ­a',drive:'Manejo',rest:'Descanso',
    reset:'RESET 34H',from:'DESDE',to:'HASTA',departure:'SALIDA',arrival:'LLEGADA',totalTime:'TIEMPO TOTAL',
    routeMap:'Mapa de Ruta',fullMap:'Ver Mapa Completo',roadHint:'Ruta terrestre real si estÃ¡ disponible',
    currentLoc:'UBICACIÃ“N ACTUAL',currentSpeed:'VELOCIDAD ACTUAL',progress:'PROGRESO DEL VIAJE',traveled:'RECORRIDO',
    remaining:'RESTANTE',elapsed:'TRANSCURRIDO',eta:'ETA',copied:'Â¡Ruta copiada!',locating:'Localizando...',ready:'Listo',
    driving:'Manejando',stopped:'Detenido',gpsDenied:'Permite el acceso a ubicaciÃ³n en tu navegador',arrived:'ğŸ‰ Â¡Llegaste!',
    sourceRoad:'Fuente de ruta',sourceOsrm:'OSRM',sourceFallback:'LÃ­nea directa (respaldo)',
    menuTitle:'Ajustes',menuLang:'Idioma',menuTheme:'Tema',menuCountry:'PaÃ­s de bÃºsqueda',light:'Claro',dark:'Oscuro',
    tabLblPlan:'Planear Ruta',tabLblDrives:'Todos los Viajes',tabLblSummary:'ResÃºmenes',tabLblSettings:'Ajustes',
    drivesTitle:'Todos los Viajes',summaryTitle:'ResÃºmenes',settingsPageTitle:'Ajustes',settSecGeneral:'General',
    settSecAppear:'Apariencia',settSecHOS:'Reglas HOS',settSecAbout:'Acerca de',settLangRow:'Idioma',
    settCountryRow:'Filtro de PaÃ­s',settLightRow:'Modo Claro',settDarkRow:'Modo Oscuro',settBreakRow:'Regla de Pausa 30 min',
    settCycleRow:'Horas de Ciclo',settRestRow:'Requisito de Descanso',settShareRow:'Compartir App',sendReportText:'Enviar Reporte',
    noDrives:'Sin viajes registrados aÃºn.',calcFirst:'Calcula tu primera ruta.',noRoutes:'Sin rutas aÃºn',
    planRoute:'Planifica una ruta para ver el resumen.',allLogged:'Â¡Excelente trabajo!',status100:'100% registrado',
    sumDrivesLbl:'Viajes',sumMilesLbl:'Millas',sumValueLbl:'Registrado',business:'Negocio',
    settSpeedLimitRow:'LÃ­mite de Velocidad por Defecto',
    confirmTrackTitle:'Ver Mapa Completo',confirmTrackDesc:'Â¿Deseas activar el seguimiento en vivo de tu ruta?',
    confirmNoTxt:'Solo ver mapa',confirmYesTxt:'SÃ­, dar seguimiento',
    hud70Lbl:'70 HRS',hudDriveLbl:'T. MANEJO',hudProgLbl:'PROGRESO'
  }
};

const COUNTRIES = [
  {code:'',en:'All countries',es:'Todos los paÃ­ses'},
  {code:'US',en:'United States',es:'Estados Unidos'},
  {code:'MX',en:'Mexico',es:'MÃ©xico'},
  {code:'CA',en:'Canada',es:'CanadÃ¡'},
  {code:'DO',en:'Dominican Republic',es:'RepÃºblica Dominicana'},
  {code:'ES',en:'Spain',es:'EspaÃ±a'},
  {code:'FR',en:'France',es:'Francia'},
  {code:'DE',en:'Germany',es:'Alemania'},
  {code:'IT',en:'Italy',es:'Italia'},
  {code:'GB',en:'United Kingdom',es:'Reino Unido'},
  {code:'BR',en:'Brazil',es:'Brasil'},
  {code:'AR',en:'Argentina',es:'Argentina'},
  {code:'CO',en:'Colombia',es:'Colombia'}
];

let lang = localStorage.getItem('hos_lang') || 'en';
let isDark = localStorage.getItem('hos_theme') === 'dark';
let use30min = localStorage.getItem('hos_30min') !== 'false';
let selectedCountry = localStorage.getItem('hos_country') || '';
let savedDrives = JSON.parse(localStorage.getItem('hos_drives') || '[]');
let defaultSpeed = parseInt(localStorage.getItem('hos_speed') || '60');
let currentTab = 'plan';

let origin = null, destination = null;
let routeDistance = 0, schedule = [], arrivalTime = null, totalTime = 0;
let roadGeometry = null, routeSource = null;

let miniMap = null, fullMapInst = null;
let miniLayer = null, fullLayer = null;
let miniMarkersList = [], fullMarkersList = [];

let watchId = null;
let tripStart = null;

function init() {
  applyTheme();
  populateCountrySelects();
  applyLang();
  setDepartureNow();
  bindEvents();
  renderDrives();
  renderSummary();
  updateSettingsChecks();
  // Apply default speed
  document.getElementById('speedInput').value = defaultSpeed;
  document.getElementById('defaultSpeedInput').value = defaultSpeed;
}

function applyTheme() {
  document.body.classList.toggle('dark', isDark);
  document.getElementById('themeToggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  document.getElementById('lightBtn').classList.toggle('active', !isDark);
  document.getElementById('darkBtn').classList.toggle('active', isDark);
  if (isDark) {
    document.getElementById('checkLight').style.opacity = '0';
    document.getElementById('checkDark').style.opacity = '1';
  } else {
    document.getElementById('checkLight').style.opacity = '1';
    document.getElementById('checkDark').style.opacity = '0';
  }
}

function setDepartureNow() {
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
  document.getElementById('departureInput').value = local;
}

function populateCountrySelects() {
  ['countrySelectMenu','countrySelectSettings'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    COUNTRIES.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.code;
      opt.textContent = lang === 'es' ? c.es : c.en;
      if (c.code === selectedCountry) opt.selected = true;
      sel.appendChild(opt);
    });
  });
}

function t(key) { return T[lang][key] || key; }

function applyLang() {
  const ids = {
    subtitleTxt:'subtitle', lblFrom:'lblFrom', lblTo:'lblTo',
    lblTime:'lblTime', lblHours:'lblHours', lblSpeed:'lblSpeed',
    calcBtn:'btnCalc', shareBtn:'shareText', trackBtn:'monitorText',
    stopTrackBtn:'stopText', monitorTitle:'monitorTitle',
    routeMapLbl:'routeMap', fullMapBtn:'fullMap', roadHintTxt:'roadHint',
    currentLocLbl:'currentLoc', currentSpeedLbl:'currentSpeed', progressLbl:'progress',
    traveledLbl:'traveled', remainingLbl:'remaining', elapsedLbl:'elapsed', etaLbl:'eta',
    drivesTitleTxt:'drivesTitle', summaryTitleTxt:'summaryTitle', settTitleTxt:'settingsPageTitle',
    settSecGeneral:'settSecGeneral', settSecAppear:'settSecAppear', settSecHOS:'settSecHOS',
    settSecAbout:'settSecAbout', settLangRow:'settLangRow', settCountryRow:'settCountryRow',
    settCountryRowTitle:'settCountryRow', settLightRow:'settLightRow', settDarkRow:'settDarkRow',
    settBreakRow:'settBreakRow', settCycleRow:'settCycleRow', settRestRow:'settRestRow',
    settShareRow:'settShareRow', menuTitle:'menuTitle', menuLangLbl:'menuLang',
    menuThemeLbl:'menuTheme', menuCountryLbl:'menuCountry',
    fromLbl:'from', toLbl:'to', departureLbl:'departure', arrivalLbl:'arrival', totalTimeLbl:'totalTime',
    tabLblPlan:'tabLblPlan', tabLblDrives:'tabLblDrives', tabLblSummary:'tabLblSummary', tabLblSettings:'tabLblSettings',
    sumDrivesLbl:'sumDrivesLbl', sumMilesLbl:'sumMilesLbl', sumValueLbl:'sumValueLbl',
    sendReportBtn:'sendReportText', fullMapTitle:'routeMap',
    settSpeedLimitRow:'settSpeedLimitRow',
    confirmTrackTitle:'confirmTrackTitle', confirmTrackDesc:'confirmTrackDesc',
    confirmNoTxt:'confirmNoTxt', confirmYesTxt:'confirmYesTxt'
  };
  Object.entries(ids).forEach(([id, key]) => {
    const el = document.getElementById(id);
    if (el && key) el.textContent = t(key);
  });
  document.getElementById('infoTxt').textContent = 'ğŸ’¡ ' + t('info');
  document.getElementById('lightBtn').textContent = 'â˜€ï¸ ' + t('light');
  document.getElementById('darkBtn').textContent = 'ğŸŒ™ ' + t('dark');
  document.getElementById('drivesTabBtn').innerHTML = `${t('business')} <span id="drivesCount">${savedDrives.length}</span>`;
  document.getElementById('langVal').textContent = lang === 'en' ? 'English' : 'EspaÃ±ol';
  const country = COUNTRIES.find(c => c.code === selectedCountry);
  document.getElementById('countryVal').textContent = country ? (lang === 'es' ? country.es : country.en) : (lang === 'en' ? 'All' : 'Todos');
  populateCountrySelects();
  renderDrives();
  renderSummary();
}

function updateSettingsChecks() {
  document.getElementById('checkEn').style.opacity = lang === 'en' ? '1' : '0';
  document.getElementById('checkEs').style.opacity = lang === 'es' ? '1' : '0';
  document.getElementById('breakToggle').classList.toggle('on', use30min);
}

let originDebounce, destDebounce;

async function fetchAutocomplete(q) {
  const countryObj = COUNTRIES.find(c => c.code === selectedCountry);
  const query = selectedCountry && countryObj ? `${q}, ${countryObj.en}` : q;
  const r = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=8`);
  const data = await r.json();
  let items = (data.features || []).map(f => ({
    name: [f.properties.name, f.properties.city, f.properties.state, f.properties.country]
      .filter(Boolean).filter((v,i,a) => a.indexOf(v) === i).join(', '),
    lat: f.geometry.coordinates[1],
    lon: f.geometry.coordinates[0],
    country_code: (f.properties.countrycode || '').toUpperCase()
  })).filter(x => x.name);
  if (selectedCountry) items = items.filter(x => x.country_code === selectedCountry);
  const seen = new Set();
  items = items.filter(it => {
    const k = `${it.name}|${it.lat.toFixed(4)}|${it.lon.toFixed(4)}`;
    if (seen.has(k)) return false; seen.add(k); return true;
  });
  return items.slice(0, 5);
}

function showSuggestions(containerId, items, onSelect) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  if (!items.length) { el.style.display = 'none'; return; }
  items.forEach(it => {
    const div = document.createElement('div');
    div.className = 's-item';
    div.innerHTML = `<div class="s-name">${it.name.split(',')[0]}</div><div class="s-detail">${it.name.split(',').slice(1).join(',')}</div>`;
    div.onclick = () => { onSelect(it); el.style.display = 'none'; };
    el.appendChild(div);
  });
  el.style.display = 'block';
}

function initMap(containerId) {
  const map = L.map(containerId, { zoomControl: true }).setView([39.5, -98.35], 4);
  const tile = isDark
    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
    : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  L.tileLayer(tile, { maxZoom: 19 }).addTo(map);
  return map;
}

function drawRoute(map, coords, markersRef, layerRef) {
  if (!map) return;
  if (layerRef.layer) map.removeLayer(layerRef.layer);
  markersRef.list.forEach(m => map.removeLayer(m));
  markersRef.list = [];

  const shadow = L.polyline(coords, { color: '#065f46', weight: 9, opacity: 0.22 }).addTo(map);
  shadow.bringToBack();
  const layer = L.polyline(coords, { color: '#10b981', weight: 5, opacity: 0.95 }).addTo(map);
  layerRef.layer = layer;

  const o = L.marker([origin.lat, origin.lon]).addTo(map).bindPopup('Origin: ' + origin.name);
  const d = L.marker([destination.lat, destination.lon]).addTo(map).bindPopup('Dest: ' + destination.name);
  const mid = coords[Math.floor(coords.length / 2)] || [(origin.lat + destination.lat)/2, (origin.lon + destination.lon)/2];
  const truck = L.marker(mid, { icon: L.divIcon({ className: '', html: '<div style="font-size:24px">ğŸš›</div>' }) }).addTo(map);

  markersRef.list = [shadow, o, d, truck];
  map.fitBounds(layer.getBounds(), { padding: [25, 25] });
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 3959, r = x => x * Math.PI / 180;
  const dLat = r(lat2-lat1), dLon = r(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(r(lat1))*Math.cos(r(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

async function fetchRoadRoute(orig, dest) {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${orig.lon},${orig.lat};${dest.lon},${dest.lat}?overview=full&geometries=geojson`;
    const r = await fetch(url);
    const data = await r.json();
    const route = data.routes?.[0];
    if (!route) throw new Error('no route');
    return {
      coords: (route.geometry.coordinates || []).map(([lon,lat]) => [lat,lon]),
      miles: Math.round((route.distance || 0) / 1609.344),
      source: 'OSRM'
    };
  } catch {
    const straight = haversine(orig.lat, orig.lon, dest.lat, dest.lon);
    return {
      coords: [[orig.lat, orig.lon], [dest.lat, dest.lon]],
      miles: Math.round(straight * 1.3),
      source: 'Fallback'
    };
  }
}

function calculateSchedule(start, distance, speed, cycle) {
  const sched = [];
  let current = new Date(start), rem = distance, hours = cycle, day = 1, safety = 0;
  while (rem > 0 && safety++ < 500) {
    const available = Math.min(11, hours);
    if (available <= 0) {
      const end = new Date(current.getTime() + 34*3600000);
      sched.push({ type:'reset', day, start:new Date(current), end, hours:34 });
      current = end; hours = 70; continue;
    }
    const s1h = Math.min(8, available), s1d = Math.min(rem, speed*s1h), s1t = s1d/speed;
    const s1end = new Date(current.getTime() + s1t*3600000);
    sched.push({ type:'drive', day, start:new Date(current), end:s1end, hours:s1t, distance:s1d });
    rem -= s1d; hours -= s1t; current = s1end;
    if (rem <= 0) break;
    if (use30min && s1t >= 7.5) {
      const be = new Date(current.getTime() + 0.5*3600000);
      sched.push({ type:'break30', day, start:new Date(current), end:be, hours:0.5 });
      current = be;
    }
    const s2h = Math.min(available - s1t, 3);
    if (s2h > 0 && rem > 0) {
      const s2d = Math.min(rem, speed*s2h), s2t = s2d/speed;
      const s2end = new Date(current.getTime() + s2t*3600000);
      sched.push({ type:'drive', day, start:new Date(current), end:s2end, hours:s2t, distance:s2d });
      rem -= s2d; hours -= s2t; current = s2end;
    }
    if (rem > 0) {
      const re = new Date(current.getTime() + 10*3600000);
      sched.push({ type:'rest', day, start:new Date(current), end:re, hours:10 });
      current = re; day++;
    }
  }
  return sched;
}

function fmtH(h) {
  const m = Math.round(h*60), hr = Math.floor(m/60), mn = m%60;
  if (hr===0) return `${mn}m`; if (mn===0) return `${hr}h`; return `${hr}h ${mn}m`;
}
function fmtTime(d) {
  const dt = new Date(d); let h = dt.getHours(); const m = dt.getMinutes();
  const ap = h >= 12 ? 'PM' : 'AM'; h = h%12 || 12;
  return `${h}:${String(m).padStart(2,'0')} ${ap}`;
}
function fmtDateTime(d) {
  const dt = new Date(d);
  return dt.toLocaleDateString(lang==='es'?'es-ES':'en-US',{month:'short',day:'numeric'}) + ' ' + fmtTime(dt);
}

async function calculateRoute() {
  hideError();
  if (!origin || !destination) { showError(t('errSel')); return; }
  const hours = parseFloat(document.getElementById('hoursInput').value);
  const speed = parseFloat(document.getElementById('speedInput').value);
  if (isNaN(hours)||hours<=0||hours>70) { showError(t('err70')); return; }
  if (isNaN(speed)||speed<=0) { showError(t('errSpeed')); return; }

  const calcBtn = document.getElementById('calcBtn');
  calcBtn.textContent = 'â³ Calculating...';
  calcBtn.disabled = true;

  const depart = new Date(document.getElementById('departureInput').value || new Date());
  const road = await fetchRoadRoute(origin, destination);
  roadGeometry = road.coords;
  routeSource = road.source;
  routeDistance = road.miles;

  schedule = calculateSchedule(depart, routeDistance, speed, hours);
  arrivalTime = schedule.at(-1)?.end || depart;
  totalTime = schedule.reduce((a,s) => a + (s.type==='drive'||s.type==='rest' ? s.hours : 0), 0);

  const drive = {
    id: Date.now(),
    origin: origin.name, destination: destination.name,
    distance: routeDistance,
    value: (routeDistance * 0.73).toFixed(2),
    date: new Date().toISOString()
  };
  savedDrives.push(drive);
  localStorage.setItem('hos_drives', JSON.stringify(savedDrives));

  renderResults(hours, speed, depart);

  document.getElementById('miniMapCard').style.display = 'block';
  if (!miniMap) miniMap = initMap('miniMap');
  setTimeout(() => {
    miniMap.invalidateSize();
    const mRef = { list: miniMarkersList };
    const lRef = { layer: miniLayer };
    drawRoute(miniMap, roadGeometry, mRef, lRef);
    miniMarkersList = mRef.list;
    miniLayer = lRef.layer;
  }, 100);

  document.getElementById('routeSourceTxt').textContent =
    `ğŸ›£ï¸ ${t('sourceRoad')}: ${routeSource === 'Fallback' ? t('sourceFallback') : t('sourceOsrm')}`;

  calcBtn.textContent = t('btnCalc');
  calcBtn.disabled = false;

  renderDrives();
  renderSummary();

  setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 150);
}

function renderResults(hours, speed, depart) {
  document.getElementById('resultsCard').style.display = 'block';
  document.getElementById('shareTrackBtns').style.display = 'grid';

  const driveHours = routeDistance / speed;
  const pill = document.getElementById('timeVsHours');
  pill.textContent = `${fmtH(driveHours)} / ${hours} hrs`;
  pill.className = 'pill' + (driveHours > hours ? ' danger' : '');

  document.getElementById('distanceBig').textContent = routeDistance.toLocaleString() + ' mi';
  document.getElementById('fromVal').textContent = origin.name;
  document.getElementById('toVal').textContent = destination.name;
  document.getElementById('departureVal').textContent = fmtDateTime(depart);
  document.getElementById('arrivalVal').textContent = fmtDateTime(arrivalTime);
  document.getElementById('totalTimeVal').textContent = fmtH(totalTime);

  const sl = document.getElementById('scheduleList');
  sl.innerHTML = '';
  schedule.forEach(s => {
    const div = document.createElement('div');
    if (s.type === 'break30') {
      div.className = 'sched break30';
      div.innerHTML = `<div class="t">â˜• ${lang==='es'?'Pausa 30 min obligatoria':'Mandatory 30-min Break'}</div><div class="d">â¸ï¸ ${fmtTime(s.start)} â†’ ${fmtTime(s.end)}</div>`;
    } else {
      div.className = 'sched' + (s.type==='rest'?' rest':s.type==='reset'?' reset':'');
      const title = s.type==='reset' ? `ğŸ”„ ${t('reset')}` : `${t('day')} ${s.day} - ${s.type==='drive'?t('drive'):t('rest')}`;
      const detail = s.type==='drive'
        ? `ğŸš› ${fmtTime(s.start)} â†’ ${fmtTime(s.end)}\n${fmtH(s.hours)} | ${Math.round(s.distance||0)} mi`
        : s.type==='rest' ? `ğŸ˜´ 10 hours DOT` : `Recover 70 hrs`;
      div.innerHTML = `<div class="t">${title}</div><div class="d" style="white-space:pre-line">${detail}</div>`;
    }
    sl.appendChild(div);
  });
}

function renderDrives() {
  const el = document.getElementById('drivesList');
  const countEl = document.getElementById('drivesCount');
  if (countEl) countEl.textContent = savedDrives.length;

  if (!savedDrives.length) {
    el.innerHTML = `<div class="no-drives">ğŸš›<br><br>${t('noDrives')}<br>${t('calcFirst')}</div>`;
    return;
  }
  const total = savedDrives.reduce((a,d) => a + parseFloat(d.value||0), 0);
  let html = `<div class="drives-header"><div style="font-size:13px;color:var(--muted)">${lang==='es'?'Valor total':'Classified value'}: $${total.toFixed(2)}</div></div>`;
  [...savedDrives].reverse().forEach(d => {
    const dt = new Date(d.date);
    const dateStr = dt.toLocaleDateString(lang==='es'?'es-ES':'en-US',{weekday:'long',day:'numeric',month:'long'});
    html += `<div><div style="padding:6px 14px 2px;font-size:13px;font-weight:700">${dateStr}</div>
    <div class="drive-item">
      <div class="drive-thumb">ğŸ—ºï¸</div>
      <div class="drive-info">
        <div class="drive-route">${d.origin.split(',')[0]} â†’ ${d.destination.split(',')[0]}</div>
        <div class="drive-meta">${d.distance.toLocaleString()} mi Â· ${fmtDateTime(d.date)}</div>
        <div class="drive-amount">$${d.value}</div>
      </div>
    </div></div>`;
  });
  el.innerHTML = html;
}

function renderSummary() {
  const miles = savedDrives.reduce((a,d) => a+(d.distance||0), 0);
  const val = savedDrives.reduce((a,d) => a+parseFloat(d.value||0), 0);
  document.getElementById('sumDrives').textContent = savedDrives.length;
  document.getElementById('sumMiles').textContent = miles.toLocaleString();
  document.getElementById('sumValue').textContent = '$' + val.toFixed(0);
  document.getElementById('sumStatus').textContent = savedDrives.length ? t('status100') : t('noRoutes');
  document.getElementById('sumDesc').textContent = savedDrives.length ? t('allLogged') : t('planRoute');
  document.getElementById('sendReportBtn').style.display = savedDrives.length ? 'flex' : 'none';
}

function useGPS() {
  if (!navigator.geolocation) { alert('GPS not supported'); return; }
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    try {
      const r = await fetch(`https://photon.komoot.io/reverse?lat=${latitude}&lon=${longitude}`);
      const data = await r.json();
      const feat = data.features?.[0];
      const p = feat?.properties || {};
      const name = [p.name, p.city, p.state, p.country].filter(Boolean).join(', ') || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
      origin = { name, lat: latitude, lon: longitude };
      document.getElementById('originInput').value = name;
    } catch {
      origin = { name: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`, lat: latitude, lon: longitude };
      document.getElementById('originInput').value = origin.name;
    }
  }, () => alert(t('gpsDenied')), { enableHighAccuracy: true, timeout: 10000 });
}

async function shareRoute() {
  if (!origin || !destination) return;
  const msg = `ğŸš› HOS Tracker\n\nğŸ“ ${origin.name}\nğŸ¯ ${destination.name}\nğŸ“ ${routeDistance.toLocaleString()} mi\nâ±ï¸ ${fmtH(totalTime)}`;
  if (navigator.share) { try { await navigator.share({ title: 'HOS Route', text: msg }); return; } catch {} }
  if (navigator.clipboard) await navigator.clipboard.writeText(msg);
  alert(t('copied'));
}

/* ============================================================
   FULLSCREEN MAP + LIVE TRACKING  (Google Maps style)
   ============================================================ */
let fmMapInst = null;
let fmMarkers = [];
let fmLayer = null;
let fmGpsMarker = null;
let fmWatchId = null;
let fmTripStart = null;
let fmClockTimer = null;
let fmIsTracking = false;

function openFullMapScreen() {
  const screen = document.getElementById('fullMapScreen');
  screen.style.display = 'flex';
  screen.style.flexDirection = 'column';

  // Show banner asking about tracking
  document.getElementById('fmTrackBanner').style.display = 'block';
  document.getElementById('fmStopBtn').style.display = 'none';

  // Fill route labels
  if (origin) document.getElementById('fmFrom').textContent = origin.name.split(',')[0];
  if (destination) document.getElementById('fmTo').textContent = destination.name.split(',')[0];

  // Init map if needed
  if (!fmMapInst) {
    fmMapInst = L.map('fullMap', { zoomControl: false, attributionControl: false }).setView([39.5, -98.35], 4);
    const tile = isDark
      ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
      : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
    L.tileLayer(tile, { maxZoom: 19 }).addTo(fmMapInst);
    L.control.zoom({ position: 'topright' }).addTo(fmMapInst);
  }

  setTimeout(() => {
    fmMapInst.invalidateSize();
    if (origin && destination) {
      const coords = roadGeometry || [[origin.lat, origin.lon], [destination.lat, destination.lon]];
      // Clear old layers
      fmMarkers.forEach(m => fmMapInst.removeLayer(m));
      fmMarkers = [];
      if (fmLayer) fmMapInst.removeLayer(fmLayer);

      const shadow = L.polyline(coords, { color: '#065f46', weight: 10, opacity: 0.18 }).addTo(fmMapInst);
      fmLayer = L.polyline(coords, { color: '#10b981', weight: 5, opacity: 0.95 }).addTo(fmMapInst);

      const oIcon = L.divIcon({ className:'', html:'<div style="width:14px;height:14px;background:#10b981;border:3px solid #fff;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.4)"></div>', iconAnchor:[7,7] });
      const dIcon = L.divIcon({ className:'', html:'<div style="font-size:26px;line-height:1;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5))">ğŸ“</div>', iconAnchor:[13,26] });
      const truckIcon = L.divIcon({ className:'', html:'<div style="font-size:28px;line-height:1;filter:drop-shadow(0 2px 6px rgba(0,0,0,.5))">ğŸš›</div>', iconAnchor:[14,14] });

      const oMark = L.marker([origin.lat, origin.lon], { icon: oIcon }).addTo(fmMapInst);
      const dMark = L.marker([destination.lat, destination.lon], { icon: dIcon }).addTo(fmMapInst);
      const mid = coords[Math.floor(coords.length / 2)] || [(origin.lat+destination.lat)/2,(origin.lon+destination.lon)/2];
      fmGpsMarker = L.marker(mid, { icon: truckIcon }).addTo(fmMapInst);

      fmMarkers = [shadow, oMark, dMark, fmGpsMarker];
      fmMapInst.fitBounds(fmLayer.getBounds(), { padding: [60, 60] });
    }
    // Slide HUD up
    document.getElementById('fmHud').style.transform = 'translateY(0)';
  }, 200);

  // Start clock
  fmTickClock();
  fmClockTimer = setInterval(fmTickClock, 1000);
}

function fmTickClock() {
  const now = new Date();
  document.getElementById('fmClockTxt').textContent = now.toLocaleTimeString(lang==='es'?'es-US':'en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
  document.getElementById('fmDateTxt').textContent = now.toLocaleDateString(lang==='es'?'es-ES':'en-US',{weekday:'short',month:'short',day:'numeric'});
}

function closeFullMapScreen() {
  fmStopTracking();
  document.getElementById('fullMapScreen').style.display = 'none';
  document.getElementById('fmHud').style.transform = 'translateY(100%)';
  if (fmClockTimer) { clearInterval(fmClockTimer); fmClockTimer = null; }
}

async function fmStartTracking() {
  if (!navigator.geolocation) { alert(lang==='es'?'GPS no soportado':'GPS not supported'); return; }

  // Update UI â€” show locating state immediately
  document.getElementById('fmTrackBanner').style.display = 'none';
  document.getElementById('fmLiveDot').style.background = '#f59e0b';
  document.getElementById('fmLiveDot').style.boxShadow = '0 0 6px #f59e0b';
  document.getElementById('fmLiveDot').style.animation = 'liveblink 1s infinite';
  document.getElementById('fmLocVal').textContent = lang==='es' ? 'ğŸ“¡ Obteniendo ubicaciÃ³n real...' : 'ğŸ“¡ Getting your real location...';
  document.getElementById('fmStatusChip').textContent = lang==='es' ? 'ğŸ“¡ Localizando...' : 'ğŸ“¡ Locating...';

  // â”€â”€ STEP 1: Get real GPS position â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let realLat, realLon;
  try {
    const pos = await new Promise((res, rej) =>
      navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 15000 })
    );
    realLat = pos.coords.latitude;
    realLon = pos.coords.longitude;
  } catch (e) {
    document.getElementById('fmLocVal').textContent = lang==='es' ? 'âŒ Error de GPS â€” revisa permisos' : 'âŒ GPS error â€” check permissions';
    document.getElementById('fmLiveDot').style.background = '#ef4444';
    return;
  }

  // â”€â”€ STEP 2: Reverse-geocode real position â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let realLocName = `${realLat.toFixed(4)}, ${realLon.toFixed(4)}`;
  try {
    const r = await fetch(`https://photon.komoot.io/reverse?lat=${realLat}&lon=${realLon}`);
    const data = await r.json();
    const p = data.features?.[0]?.properties || {};
    realLocName = [p.name, p.city, p.state].filter(Boolean).join(', ') || realLocName;
  } catch {}

  document.getElementById('fmLocVal').textContent = (lang==='es'?'ğŸ”„ Recalculando ruta desde ':'ğŸ”„ Recalculating route from ') + realLocName + '...';

  // â”€â”€ STEP 3: Recalculate road route from real GPS â†’ destination â”€â”€
  const realOrigin = { lat: realLat, lon: realLon, name: realLocName };
  const road = await fetchRoadRoute(realOrigin, destination);
  routeDistance = road.miles;
  roadGeometry = road.coords;

  // Update origin globally so all HOS calcs use real start
  origin = realOrigin;
  document.getElementById('fmFrom').textContent = realLocName.split(',')[0];
  document.getElementById('fmLocVal').textContent = realLocName;

  // â”€â”€ STEP 4: Redraw route on map from real location â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (fmMapInst) {
    // Remove old route layers & markers
    fmMarkers.forEach(m => { try { fmMapInst.removeLayer(m); } catch {} });
    fmMarkers = [];
    if (fmLayer) { try { fmMapInst.removeLayer(fmLayer); } catch {} fmLayer = null; }

    const coords = roadGeometry;
    const shadow = L.polyline(coords, { color: '#065f46', weight: 10, opacity: 0.18 }).addTo(fmMapInst);
    fmLayer = L.polyline(coords, { color: '#10b981', weight: 5, opacity: 0.95 }).addTo(fmMapInst);

    // Real position dot (green circle)
    const posIcon = L.divIcon({
      className: '',
      html: `<div style="width:18px;height:18px;background:#10b981;border:3px solid #fff;border-radius:50%;box-shadow:0 0 0 4px rgba(16,185,129,.3),0 2px 8px rgba(0,0,0,.4)"></div>`,
      iconAnchor: [9, 9]
    });
    // Destination pin
    const dIcon = L.divIcon({
      className: '',
      html: `<div style="font-size:28px;line-height:1;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5))">ğŸ“</div>`,
      iconAnchor: [14, 28]
    });
    // Truck marker (will move with GPS)
    const truckIcon = L.divIcon({
      className: '',
      html: `<div style="font-size:30px;line-height:1;filter:drop-shadow(0 2px 8px rgba(0,0,0,.6))">ğŸš›</div>`,
      iconAnchor: [15, 15]
    });

    const posMark = L.marker([realLat, realLon], { icon: posIcon }).addTo(fmMapInst)
      .bindPopup(realLocName);
    const dMark = L.marker([destination.lat, destination.lon], { icon: dIcon }).addTo(fmMapInst)
      .bindPopup(destination.name);
    fmGpsMarker = L.marker([realLat, realLon], { icon: truckIcon }).addTo(fmMapInst);

    fmMarkers = [shadow, posMark, dMark, fmGpsMarker];

    // Fit map to new route and center on truck
    fmMapInst.fitBounds(fmLayer.getBounds(), { padding: [70, 70] });
    setTimeout(() => fmMapInst.panTo([realLat, realLon], { animate: true, duration: 1 }), 800);
  }

  // â”€â”€ STEP 5: Start live watch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fmIsTracking = true;
  fmTripStart = new Date();
  document.getElementById('fmStopBtn').style.display = 'block';
  document.getElementById('fmLiveDot').style.background = '#10b981';
  document.getElementById('fmLiveDot').style.boxShadow = '0 0 8px #10b981';
  document.getElementById('fmLiveDot').style.animation = 'liveblink 1.5s infinite';

  // Init progress display
  document.getElementById('fmPct').textContent = '0%';
  document.getElementById('fmBar').style.width = '0%';
  document.getElementById('fmRem').textContent = routeDistance + ' mi';
  document.getElementById('fm70Left').textContent = fmtH(parseFloat(document.getElementById('hoursInput').value));
  document.getElementById('fmDriveLeft').textContent = '11h';

  fmWatchId = navigator.geolocation.watchPosition(async pos => {
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    const gpsSpeed = pos.coords.speed != null && pos.coords.speed >= 0 ? Math.round(pos.coords.speed * 2.237) : 0;
    const remaining = haversine(lat, lon, destination.lat, destination.lon);
    const traveled = Math.max(0, routeDistance - remaining);
    const pct = Math.min(100, Math.round(traveled / Math.max(1, routeDistance) * 100));
    const elapsed = (Date.now() - fmTripStart.getTime()) / 3600000;
    const speed = parseFloat(document.getElementById('speedInput').value) || defaultSpeed;
    const etaH = remaining / Math.max(1, gpsSpeed > 5 ? gpsSpeed : speed);
    const isMoving = gpsSpeed > 5;

    // â”€â”€ Speed badge â”€â”€
    document.getElementById('fmSpeedVal').textContent = gpsSpeed;
    document.getElementById('fmSpeedVal').style.color = isMoving ? '#10b981' : '#9ca3af';

    // â”€â”€ Status chip â”€â”€
    const chip = document.getElementById('fmStatusChip');
    chip.textContent = isMoving
      ? 'ğŸš› ' + (lang==='es'?'Manejando':'Driving')
      : 'â¸ ' + (lang==='es'?'Detenido':'Stopped');
    chip.style.background = isMoving ? 'rgba(16,185,129,0.2)' : 'rgba(107,114,128,0.2)';
    chip.style.color = isMoving ? '#10b981' : '#9ca3af';

    // â”€â”€ Progress â”€â”€
    document.getElementById('fmPct').textContent = pct + '%';
    document.getElementById('fmBar').style.width = pct + '%';

    // â”€â”€ ETA & remaining â”€â”€
    document.getElementById('fmEta').textContent = fmtH(etaH);
    document.getElementById('fmRem').textContent = remaining + ' mi';

    // â”€â”€ Drive time left (11h shift) â”€â”€
    const driveLeft = Math.max(0, 11 - elapsed);
    const driveEl = document.getElementById('fmDriveLeft');
    driveEl.textContent = fmtH(driveLeft);
    driveEl.style.color = driveLeft < 2 ? '#ef4444' : driveLeft < 4 ? '#f59e0b' : '#10b981';

    // â”€â”€ 70-hr cycle left â”€â”€
    const cycleLeft = Math.max(0, parseFloat(document.getElementById('hoursInput').value) - elapsed);
    const cyEl = document.getElementById('fm70Left');
    cyEl.textContent = fmtH(cycleLeft);
    cyEl.style.color = cycleLeft < 10 ? '#ef4444' : cycleLeft < 20 ? '#f59e0b' : '#8b5cf6';

    // â”€â”€ Move truck on map & follow â”€â”€
    if (fmGpsMarker) {
      fmGpsMarker.setLatLng([lat, lon]);
      if (isMoving) fmMapInst.panTo([lat, lon], { animate: true, duration: 1.5 });
    }

    // â”€â”€ Location name (throttled: only update every ~10s to avoid rate limit) â”€â”€
    const now = Date.now();
    if (!fmLastGeocode || now - fmLastGeocode > 10000) {
      fmLastGeocode = now;
      try {
        const r = await fetch(`https://photon.komoot.io/reverse?lat=${lat}&lon=${lon}`);
        const data = await r.json();
        const p = data.features?.[0]?.properties || {};
        const locName = [p.name, p.city, p.state].filter(Boolean).join(', ') || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        document.getElementById('fmLocVal').textContent = locName;
      } catch { document.getElementById('fmLocVal').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`; }
    }

    if (remaining <= 3) { alert(t('arrived')); fmStopTracking(); }
  }, err => {
    document.getElementById('fmLocVal').textContent = lang==='es' ? 'âš ï¸ SeÃ±al GPS dÃ©bil' : 'âš ï¸ Weak GPS signal';
  }, { enableHighAccuracy: true, maximumAge: 2000, timeout: 15000 });
}

let fmLastGeocode = 0;

function fmStopTracking() {
  if (fmWatchId != null) { navigator.geolocation.clearWatch(fmWatchId); fmWatchId = null; }
  fmIsTracking = false;
  document.getElementById('fmStopBtn').style.display = 'none';
  document.getElementById('fmLiveDot').style.background = '#6b7280';
  document.getElementById('fmLiveDot').style.boxShadow = 'none';
  document.getElementById('fmLiveDot').style.animation = 'none';
}

// Legacy startTracking/stopTracking still used by old monitor modal
function startTracking() {
  if (!origin || !destination) { alert(t('errSel')); return; }
  openFullMapScreen();
}

function stopTracking() {
  fmStopTracking();
  document.getElementById('monitorOverlay').classList.remove('open');
}

function resetForm() {
  origin = null; destination = null;
  routeDistance = 0; schedule = []; arrivalTime = null; totalTime = 0;
  roadGeometry = null; routeSource = null;
  document.getElementById('originInput').value = '';
  document.getElementById('destInput').value = '';
  document.getElementById('hoursInput').value = '70';
  document.getElementById('speedInput').value = defaultSpeed;
  document.getElementById('resultsCard').style.display = 'none';
  document.getElementById('shareTrackBtns').style.display = 'none';
  document.getElementById('miniMapCard').style.display = 'none';
  hideError();
}

function showError(msg) {
  const el = document.getElementById('errorBox');
  el.textContent = 'âŒ ' + msg;
  el.style.display = 'block';
}
function hideError() {
  document.getElementById('errorBox').style.display = 'none';
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
}

function bindEvents() {
  document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));

  document.getElementById('themeToggle').addEventListener('click', () => { isDark = !isDark; localStorage.setItem('hos_theme', isDark ? 'dark' : 'light'); applyTheme(); });
  document.getElementById('lightBtn').addEventListener('click', () => { isDark = false; localStorage.setItem('hos_theme', 'light'); applyTheme(); });
  document.getElementById('darkBtn').addEventListener('click', () => { isDark = true; localStorage.setItem('hos_theme', 'dark'); applyTheme(); });
  document.getElementById('lightModeRow').addEventListener('click', () => { isDark = false; localStorage.setItem('hos_theme', 'light'); applyTheme(); });
  document.getElementById('darkModeRow').addEventListener('click', () => { isDark = true; localStorage.setItem('hos_theme', 'dark'); applyTheme(); });

  document.getElementById('langSelect').value = lang;
  document.getElementById('langSelect').addEventListener('change', e => { lang = e.target.value; localStorage.setItem('hos_lang', lang); applyLang(); updateSettingsChecks(); });

  document.getElementById('langRow').addEventListener('click', () => {
    document.getElementById('langPanel').style.display = document.getElementById('langPanel').style.display === 'none' ? 'block' : 'none';
    document.getElementById('countryPanel').style.display = 'none';
  });
  document.getElementById('setLangEn').addEventListener('click', () => { lang = 'en'; localStorage.setItem('hos_lang', lang); applyLang(); updateSettingsChecks(); document.getElementById('langPanel').style.display = 'none'; });
  document.getElementById('setLangEs').addEventListener('click', () => { lang = 'es'; localStorage.setItem('hos_lang', lang); applyLang(); updateSettingsChecks(); document.getElementById('langPanel').style.display = 'none'; });

  ['countrySelectMenu','countrySelectSettings'].forEach(id => {
    document.getElementById(id).addEventListener('change', e => {
      selectedCountry = e.target.value;
      localStorage.setItem('hos_country', selectedCountry);
      document.getElementById('countrySelectMenu').value = selectedCountry;
      document.getElementById('countrySelectSettings').value = selectedCountry;
      const c = COUNTRIES.find(x => x.code === selectedCountry);
      document.getElementById('countryVal').textContent = c ? (lang==='es'?c.es:c.en) : (lang==='en'?'All':'Todos');
      document.getElementById('countryPanel').style.display = 'none';
    });
  });

  document.getElementById('countryRow').addEventListener('click', () => {
    document.getElementById('countryPanel').style.display = document.getElementById('countryPanel').style.display === 'none' ? 'block' : 'none';
    document.getElementById('langPanel').style.display = 'none';
  });

  document.getElementById('menuBtn').addEventListener('click', e => { e.stopPropagation(); document.getElementById('menuPanel').classList.toggle('open'); });
  document.addEventListener('click', () => document.getElementById('menuPanel').classList.remove('open'));

  document.getElementById('breakToggle').addEventListener('click', e => { e.stopPropagation(); use30min = !use30min; localStorage.setItem('hos_30min', use30min); document.getElementById('breakToggle').classList.toggle('on', use30min); });

  document.getElementById('gpsBtn').addEventListener('click', useGPS);

  document.getElementById('originInput').addEventListener('input', e => {
    clearTimeout(originDebounce);
    const v = e.target.value;
    if (v.length < 2) { document.getElementById('originSugg').style.display = 'none'; return; }
    originDebounce = setTimeout(async () => {
      const items = await fetchAutocomplete(v).catch(() => []);
      showSuggestions('originSugg', items, it => { origin = it; document.getElementById('originInput').value = it.name; });
    }, 300);
  });

  document.getElementById('destInput').addEventListener('input', e => {
    clearTimeout(destDebounce);
    const v = e.target.value;
    if (v.length < 2) { document.getElementById('destSugg').style.display = 'none'; return; }
    destDebounce = setTimeout(async () => {
      const items = await fetchAutocomplete(v).catch(() => []);
      showSuggestions('destSugg', items, it => { destination = it; document.getElementById('destInput').value = it.name; });
    }, 300);
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('#originInput') && !e.target.closest('#originSugg')) document.getElementById('originSugg').style.display = 'none';
    if (!e.target.closest('#destInput') && !e.target.closest('#destSugg')) document.getElementById('destSugg').style.display = 'none';
  });

  document.getElementById('calcBtn').addEventListener('click', calculateRoute);

  document.getElementById('shareBtn').addEventListener('click', shareRoute);
  document.getElementById('trackBtn').addEventListener('click', () => {
    if (!origin || !destination) { alert(t('errSel')); return; }
    openFullMapScreen();
  });
  document.getElementById('stopTrackBtn').addEventListener('click', stopTracking);
  document.getElementById('sendReportBtn').addEventListener('click', shareRoute);
  document.getElementById('shareAppRow').addEventListener('click', shareRoute);

  document.getElementById('resetBtn').addEventListener('click', resetForm);

  document.getElementById('fullMapBtn').addEventListener('click', () => {
    if (origin && destination) openFullMapScreen();
  });

  document.getElementById('closeFullMap').addEventListener('click', closeFullMapScreen);
  document.getElementById('fmNoTrack').addEventListener('click', () => {
    document.getElementById('fmTrackBanner').style.display = 'none';
  });
  document.getElementById('fmYesTrack').addEventListener('click', () => {
    document.getElementById('fmTrackBanner').style.display = 'none';
    fmStartTracking();
  });
  document.getElementById('fmStopBtn').addEventListener('click', fmStopTracking);

  // Default speed limit setting
  document.getElementById('defaultSpeedInput').addEventListener('change', e => {
    const val = parseInt(e.target.value);
    if (!isNaN(val) && val >= 20 && val <= 85) {
      defaultSpeed = val;
      localStorage.setItem('hos_speed', val);
      document.getElementById('speedInput').value = val;
    }
  });
  document.getElementById('closeMonitor').addEventListener('click', stopTracking);
  document.getElementById('monitorOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) stopTracking(); });
}

init();
</script>
</body>
</html>
