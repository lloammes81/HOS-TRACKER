<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>HOS Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#064e3b; --bg2:#065f46; --card:rgba(255,255,255,.97); --text:#111827; --muted:#6b7280;
      --accent:#10b981; --accent2:#3b82f6; --danger:#ef4444; --warning:#f59e0b; --line:#d1fae5;
      --soft:#f0fdf4; --header:rgba(255,255,255,.95);
    }
    body.dark{
      --bg:#0f172a; --bg2:#1e293b; --card:rgba(30,41,59,.97); --text:#e2e8f0; --muted:#94a3b8;
      --accent:#10b981; --accent2:#60a5fa; --danger:#ef4444; --warning:#f59e0b; --line:#334155;
      --soft:#334155; --header:rgba(30,41,59,.95);
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      min-height:100vh; position:relative; overflow-x:hidden;
      background:
        radial-gradient(circle at 10% 10%, rgba(16,185,129,.18), transparent 35%),
        radial-gradient(circle at 90% 15%, rgba(59,130,246,.14), transparent 35%),
        radial-gradient(circle at 20% 85%, rgba(245,158,11,.08), transparent 30%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:
        linear-gradient(rgba(255,255,255,.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.03) 1px, transparent 1px);
      background-size:28px 28px;
      opacity:.35;
    }
    .bg-icons{
      position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden;
    }
    .bg-icons span{
      position:absolute; filter: blur(.2px);
      text-shadow: 0 3px 8px rgba(0,0,0,.2);
      user-select:none;
    }

    .container{max-width:980px;margin:0 auto;padding:14px; position:relative; z-index:1}
    .header{position:sticky;top:0;z-index:20;background:var(--header);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);border-radius:0 0 14px 14px;padding:12px 14px}
    .row{display:flex;gap:10px;align-items:center}
    .between{justify-content:space-between}
    .logo{font-weight:800;font-size:18px;display:flex;align-items:center;gap:8px;color:var(--accent2)}
    .subtitle{font-size:12px;color:var(--muted);text-align:center;margin-top:4px}
    .iconbtn{border:none;background:rgba(16,185,129,.12);color:var(--text);width:38px;height:38px;border-radius:999px;cursor:pointer;font-size:18px}
    body.dark .iconbtn{background:rgba(59,130,246,.18)}
    .card{background:var(--card);border-radius:15px;padding:16px;margin-top:14px;box-shadow:0 8px 22px rgba(0,0,0,.08)}
    .info{background:rgba(16,185,129,.12);border-left:4px solid var(--accent);padding:10px;border-radius:8px;margin-bottom:12px;color:var(--text);font-size:13px}
    label{display:block;font-size:13px;font-weight:700;margin:10px 0 7px}
    .inputwrap{position:relative}
    input{width:100%;padding:14px;border:2px solid var(--line);border-radius:12px;background:#fff;color:#111827;font-size:15px}
    body.dark input{background:#334155;color:#e2e8f0;border-color:#475569}
    .btn{border:none;border-radius:12px;padding:14px 14px;font-weight:700;color:#fff;cursor:pointer;width:100%;display:flex;align-items:center;justify-content:center;gap:8px}
    .btn:disabled{opacity:.7;cursor:not-allowed}
    .btn-primary{background:var(--accent)}
    .btn-blue{background:#3b82f6}
    .btn-purple{background:#8b5cf6}
    .btn-red{background:#ef4444}
    .smallbtn{padding:8px 12px;border-radius:999px;font-size:12px;border:none;color:#fff;background:var(--accent);cursor:pointer}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1.2fr .8fr .8fr;gap:10px}
    .error{background:rgba(239,68,68,.12);border-left:4px solid var(--danger);padding:10px;border-radius:8px;color:var(--danger);margin-top:10px}
    .suggestions{position:absolute;top:100%;left:0;right:0;background:var(--card);border:2px solid var(--line);border-top:none;border-radius:0 0 12px 12px;overflow:hidden;z-index:30}
    .s-item{padding:12px;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer}
    .s-item:hover{background:rgba(16,185,129,.08)}
    body.dark .s-item:hover{background:rgba(96,165,250,.10)}
    .s-name{font-weight:700}
    .s-detail{font-size:12px;color:var(--muted)}
    .mapbox{height:240px;border-radius:12px;overflow:hidden;margin-top:8px;border:1px solid var(--line)}
    .fullmap-overlay,.monitor-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:60}
    .fullmap-overlay.open,.monitor-overlay.open{display:block}
    .fullmap-card,.monitor-card{position:absolute;inset:12px;background:var(--card);border-radius:16px;display:flex;flex-direction:column;overflow:hidden}
    .modal-head{padding:10px 12px;background:var(--bg2);color:#fff;display:flex;justify-content:space-between;align-items:center}
    .modal-close{background:var(--danger);border:none;color:#fff;border-radius:999px;width:34px;height:34px;font-size:20px;cursor:pointer}
    .fullmap{flex:1}
    .results .big{font-size:42px;font-weight:900;color:var(--accent2);text-align:center}
    .pill{padding:10px;border-radius:10px;border-left:4px solid var(--accent);background:rgba(16,185,129,.10);font-weight:800}
    .pill.danger{border-left-color:var(--danger);background:rgba(239,68,68,.10);color:var(--danger)}
    .kv{background:var(--soft);padding:12px;border-radius:12px;margin-top:10px}
    .k{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:700}
    .v{font-size:15px;font-weight:700;margin-top:4px}
    .schedule{margin-top:12px}
    .sched{padding:10px;border-left:4px solid var(--accent);background:var(--soft);border-radius:10px;margin-bottom:8px}
    .sched.rest{border-left-color:var(--warning)}
    .sched.reset{border-left-color:var(--danger)}
    .sched .t{font-weight:800}
    .sched .d{color:var(--muted);font-size:13px;white-space:pre-line}
    .bar{height:12px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden}
    .bar > div{height:100%;background:var(--accent);width:0%}
    .muted{color:var(--muted)}
    .stack{display:flex;flex-direction:column;gap:10px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    @media (max-width: 720px){
      .grid2,.grid3{grid-template-columns:1fr}
      .container{padding:10px}
      .results .big{font-size:34px}
    }
  </style>
</head>
<body>
  <div class="bg-icons" aria-hidden="true">
    <span style="top:4%;left:3%;font-size:58px;opacity:.10">ğŸš›</span>
    <span style="top:12%;right:8%;font-size:44px;opacity:.08">â°</span>
    <span style="top:24%;left:10%;font-size:36px;opacity:.08">ğŸ•</span>
    <span style="top:28%;right:14%;font-size:62px;opacity:.07">ğŸšš</span>
    <span style="top:42%;left:4%;font-size:46px;opacity:.07">â±ï¸</span>
    <span style="top:54%;right:4%;font-size:64px;opacity:.08">ğŸš›</span>
    <span style="top:66%;left:14%;font-size:42px;opacity:.07">ğŸ•’</span>
    <span style="top:78%;right:12%;font-size:38px;opacity:.08">â°</span>
    <span style="top:84%;left:6%;font-size:60px;opacity:.09">ğŸšš</span>
    <span style="top:88%;right:24%;font-size:34px;opacity:.07">ğŸ•™</span>
  </div>

  <div class="container">
    <div class="header">
      <div class="row between">
        <div class="logo">ğŸš› <span>HOS Tracker</span></div>
        <div class="row">
          <button class="iconbtn" id="themeBtn" title="Tema">ğŸŒ™</button>
          <button class="iconbtn" id="langBtn" title="Idioma">ğŸ‡ªğŸ‡¸</button>
        </div>
      </div>
      <div class="subtitle" id="subtitle">DOT Hours of Service Planner</div>
    </div>

    <div class="card" id="mapPreviewCard" style="display:none">
      <div class="row between">
        <div style="font-weight:800">ğŸ—ºï¸ <span id="routeMapLabel">Route Map</span></div>
        <button class="smallbtn" id="openFullMap">Ver mapa completo</button>
      </div>
      <div class="hint" id="roadRouteHint">Ruta terrestre real (carretera) si estÃ¡ disponible. Si el servicio falla, usa lÃ­nea directa temporal.</div>
      <div class="hint" id="routeSourceHint" style="margin-top:2px"></div>
      <div class="mapbox" id="miniMap"></div>
    </div>

    <div class="card">
      <div class="info" id="infoText">ğŸ’¡ Type city name to search globally</div>

      <div class="row between" style="align-items:end">
        <label style="margin:0">ğŸ“ <span id="lblFrom">Origin</span></label>
        <button class="smallbtn" id="gpsBtn">GPS</button>
      </div>
      <div class="inputwrap">
        <input id="originInput" placeholder="Miami, FL" autocomplete="off" />
        <div class="suggestions" id="originSuggestions" style="display:none"></div>
      </div>

      <label>ğŸ¯ <span id="lblTo">Destination</span></label>
      <div class="inputwrap">
        <input id="destInput" placeholder="Dallas, TX" autocomplete="off" />
        <div class="suggestions" id="destSuggestions" style="display:none"></div>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div>
          <label>ğŸ• <span id="lblTime">Departure</span></label>
          <input id="departureInput" type="datetime-local" />
        </div>
        <div>
          <label>â±ï¸ <span id="lblHours">Hours Left</span></label>
          <input id="hoursInput" type="number" min="1" max="70" value="70" />
        </div>
        <div>
          <label>ğŸš€ <span id="lblSpeed">Speed (mph)</span></label>
          <input id="speedInput" type="number" min="1" value="60" />
        </div>
      </div>

      <div id="errorBox" class="error" style="display:none"></div>

      <button class="btn btn-primary" id="calcBtn" style="margin-top:12px">ğŸš› <span id="btnCalc">Calculate Route</span></button>
      <div class="grid2" id="resultButtons" style="display:none;margin-top:10px">
        <button class="btn btn-blue" id="shareBtn">ğŸ“¤ <span id="shareText">Share Route</span></button>
        <button class="btn btn-purple" id="trackBtn">ğŸ“ <span id="monitorText">Start Live Tracking</span></button>
      </div>
    </div>

    <div class="card results" id="resultsCard" style="display:none">
      <div class="pill" id="statusPill"></div>
      <div class="big" id="distanceBig">0 mi</div>

      <div class="grid2">
        <div class="kv"><div class="k" id="fromKey">FROM</div><div class="v" id="fromVal">-</div></div>
        <div class="kv"><div class="k" id="toKey">TO</div><div class="v" id="toVal">-</div></div>
      </div>
      <div class="grid2">
        <div class="kv"><div class="k" id="depKey">DEPARTURE</div><div class="v" id="depVal">-</div></div>
        <div class="kv"><div class="k" id="arrKey">ARRIVAL</div><div class="v" id="arrVal">-</div></div>
      </div>
      <div class="kv"><div class="k" id="totKey">TOTAL TIME</div><div class="v" id="totVal">-</div></div>

      <div class="schedule" id="scheduleList"></div>

      <button class="btn btn-red" id="resetBtn">ğŸ”„ New Route</button>
    </div>
  </div>

  <div class="fullmap-overlay" id="fullMapOverlay">
    <div class="fullmap-card">
      <div class="modal-head">
        <div>ğŸ—ºï¸ <span id="fullMapTitle">Route Map</span></div>
        <button class="modal-close" id="closeFullMap">Ã—</button>
      </div>
      <div class="fullmap" id="fullMap"></div>
    </div>
  </div>

  <div class="monitor-overlay" id="monitorOverlay">
    <div class="monitor-card">
      <div class="modal-head">
        <div>ğŸ“ <span id="monitorTitle">LIVE TRACKING</span></div>
        <button class="modal-close" id="closeMonitor">Ã—</button>
      </div>
      <div style="padding:12px; overflow:auto" class="stack">
        <div class="kv"><div class="k" id="currentLocKey">CURRENT LOCATION</div><div class="v" id="currentLocVal">-</div></div>
        <div class="kv">
          <div class="k" id="currentSpeedKey">CURRENT SPEED</div>
          <div class="v"><span id="speedVal" style="font-size:40px;font-weight:900">0</span> <span class="muted">mph</span></div>
          <div id="trackStatus" class="muted">Ready</div>
        </div>
        <div class="kv">
          <div class="k" id="progressKey">TRIP PROGRESS</div>
          <div class="bar"><div id="progressFill"></div></div>
          <div class="v" id="progressText">0%</div>
        </div>
        <div class="grid2">
          <div class="kv"><div class="k" id="traveledKey">TRAVELED</div><div class="v" id="traveledVal">0 mi</div></div>
          <div class="kv"><div class="k" id="remainingKey">REMAINING</div><div class="v" id="remainingVal">0 mi</div></div>
        </div>
        <div class="grid2">
          <div class="kv"><div class="k" id="elapsedKey">ELAPSED</div><div class="v" id="elapsedVal">0m</div></div>
          <div class="kv"><div class="k" id="etaKey">ETA</div><div class="v" id="etaVal">0m</div></div>
        </div>
        <button class="btn btn-red" id="stopTrackBtn">ğŸ›‘ <span id="stopText">Stop Tracking</span></button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const BACKEND_URL = ''; // si tienes backend propio, ponlo aquÃ­
    let lang = localStorage.getItem('hos_lang') || 'en';
    let isDark = localStorage.getItem('hos_theme') === 'dark';

    const T = {
      en: {
        subtitle:'DOT Hours of Service Planner', info:'Type city name to search globally',
        lblFrom:'Origin', lblTo:'Destination', lblTime:'Departure', lblHours:'Hours Left', lblSpeed:'Speed (mph)',
        btnCalc:'Calculate Route', shareText:'Share Route', monitorText:'Start Live Tracking', stopText:'Stop Tracking',
        monitorTitle:'LIVE TRACKING', errSel:'Select origin and destination', err70:'Max 70 hours', errSpeed:'Invalid speed',
        day:'Day', drive:'Driving', rest:'Rest', reset:'34H RESET', from:'FROM', to:'TO', departure:'DEPARTURE', arrival:'ARRIVAL',
        totalTime:'TOTAL TIME', routeMap:'Route Map', fullMap:'View Full Map', roadHint:'Real road route when available',
        currentLoc:'CURRENT LOCATION', currentSpeed:'CURRENT SPEED', progress:'TRIP PROGRESS', traveled:'TRAVELED', remaining:'REMAINING',
        elapsed:'ELAPSED', eta:'ETA', copied:'Route copied!', locating:'Locating...', ready:'Ready', driving:'Driving', stopped:'Stopped',
        gpsDenied:'Allow location access in your browser', arrived:'ğŸ‰ Arrived!', sourceRoad:'Road route source', sourceOsrm:'OSRM', sourceFallback:'Direct line fallback'
      },
      es: {
        subtitle:'Planificador de Horas DOT', info:'Escribe nombre de ciudad para buscar',
        lblFrom:'Origen', lblTo:'Destino', lblTime:'Salida', lblHours:'Horas Restantes', lblSpeed:'Velocidad (mph)',
        btnCalc:'Calcular Ruta', shareText:'Compartir Ruta', monitorText:'Iniciar Rastreo', stopText:'Detener Rastreo',
        monitorTitle:'RASTREO EN VIVO', errSel:'Selecciona origen y destino', err70:'MÃ¡ximo 70 horas', errSpeed:'Velocidad invÃ¡lida',
        day:'DÃ­a', drive:'Manejo', rest:'Descanso', reset:'RESET 34H', from:'DESDE', to:'HASTA', departure:'SALIDA', arrival:'LLEGADA',
        totalTime:'TIEMPO TOTAL', routeMap:'Mapa de Ruta', fullMap:'Ver Mapa Completo', roadHint:'Ruta terrestre real (carretera) si estÃ¡ disponible',
        currentLoc:'UBICACIÃ“N ACTUAL', currentSpeed:'VELOCIDAD ACTUAL', progress:'PROGRESO DEL VIAJE', traveled:'RECORRIDO', remaining:'RESTANTE',
        elapsed:'TRANSCURRIDO', eta:'ETA', copied:'Â¡Ruta copiada!', locating:'Localizando...', ready:'Listo', driving:'Manejando', stopped:'Detenido',
        gpsDenied:'Permite el acceso a ubicaciÃ³n en tu navegador', arrived:'ğŸ‰ Â¡Llegaste!', sourceRoad:'Fuente de ruta', sourceOsrm:'OSRM', sourceFallback:'LÃ­nea directa (respaldo)'
      }
    };

    let state = {
      origin:null, destination:null, routeDistance:0, totalTime:0, arrival:null, schedule:[],
      tripStart:null, watchId:null, tracking:false,
      roadGeometry:null, // array [ [lat,lon], ... ]
      routeSource:null
    };

    let miniMap=null, fullMap=null;
    let miniRouteLayer=null, fullRouteLayer=null;
    let miniMarkers=[], fullMarkers=[];

    const qs = s => document.querySelector(s);

    function applyI18n(){
      const t=T[lang];
      qs('#subtitle').textContent=t.subtitle;
      qs('#infoText').textContent='ğŸ’¡ '+t.info;
      qs('#lblFrom').textContent=t.lblFrom; qs('#lblTo').textContent=t.lblTo; qs('#lblTime').textContent=t.lblTime;
      qs('#lblHours').textContent=t.lblHours; qs('#lblSpeed').textContent=t.lblSpeed;
      qs('#btnCalc').textContent=t.btnCalc; qs('#shareText').textContent=t.shareText; qs('#monitorText').textContent=t.monitorText;
      qs('#stopText').textContent=t.stopText; qs('#monitorTitle').textContent=t.monitorTitle;
      qs('#routeMapLabel').textContent=t.routeMap; qs('#fullMapTitle').textContent=t.routeMap; qs('#openFullMap').textContent=t.fullMap;
      qs('#roadRouteHint').textContent=t.roadHint;
      qs('#fromKey').textContent=t.from; qs('#toKey').textContent=t.to; qs('#depKey').textContent=t.departure; qs('#arrKey').textContent=t.arrival; qs('#totKey').textContent=t.totalTime;
      qs('#currentLocKey').textContent=t.currentLoc; qs('#currentSpeedKey').textContent=t.currentSpeed;
      qs('#progressKey').textContent=t.progress; qs('#traveledKey').textContent=t.traveled; qs('#remainingKey').textContent=t.remaining;
      qs('#elapsedKey').textContent=t.elapsed; qs('#etaKey').textContent=t.eta;
      const srcLabel = state && state.routeSource ? (state.routeSource==='Fallback' ? t.sourceFallback : t.sourceOsrm) : '';
      const srcEl = qs('#routeSourceHint'); if (srcEl) srcEl.textContent = srcLabel ? `ğŸ›£ï¸ ${t.sourceRoad}: ${srcLabel}` : '';
      qs('#langBtn').textContent = lang==='en' ? 'ğŸ‡ªğŸ‡¸' : 'ğŸ‡ºğŸ‡¸';
    }

    function applyTheme(){
      document.body.classList.toggle('dark', isDark);
      qs('#themeBtn').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    function showError(msg){ const el=qs('#errorBox'); el.style.display='block'; el.textContent='âŒ '+msg; }
    function hideError(){ qs('#errorBox').style.display='none'; }

    function formatHours(h){
      const m=Math.round(h*60), hr=Math.floor(m/60), mn=m%60;
      if(hr===0) return `${mn}m`; if(mn===0) return `${hr}h`; return `${hr}h ${mn}m`;
    }
    function formatTime(d){
      const dt = new Date(d); let h=dt.getHours(), m=dt.getMinutes(); const ap=h>=12?'PM':'AM'; const hh=h%12||12;
      return `${hh}:${String(m).padStart(2,'0')} ${ap}`;
    }
    function formatDateTime(d){
      const dt = new Date(d);
      return dt.toLocaleDateString(lang==='es'?'es-ES':'en-US',{month:'short',day:'numeric'})+' '+formatTime(dt);
    }
    function haversine(lat1,lon1,lat2,lon2){
      const R=3959, toRad=(x)=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
    }
    function calculateSchedule(start,distance,speed,cycle){
      const schedule=[]; let current=new Date(start), rem=distance, hours=cycle, day=1;
      while(rem>0){
        const available = Math.min(11,hours);
        if(available<=0){
          const end = new Date(current.getTime()+34*3600000);
          schedule.push({type:'reset',day,start:new Date(current),end,hours:34});
          current=end; hours=70; continue;
        }
        const driveDist = Math.min(rem, speed*available);
        const driveTime = driveDist/speed;
        const driveEnd = new Date(current.getTime()+driveTime*3600000);
        schedule.push({type:'drive',day,start:new Date(current),end:driveEnd,hours:driveTime,distance:driveDist});
        rem -= driveDist; hours -= driveTime; current = driveEnd;
        if(rem>0){
          const restEnd = new Date(current.getTime()+10*3600000);
          schedule.push({type:'rest',day,start:new Date(current),end:restEnd,hours:10});
          current = restEnd; day++;
        }
      }
      return schedule;
    }

    async function fetchAutocomplete(q){
      if (BACKEND_URL){
        const r=await fetch(`${BACKEND_URL}/api/autocomplete?q=${encodeURIComponent(q)}&limit=5`);
        if(!r.ok) throw new Error('autocomplete');
        return await r.json();
      }
      const r=await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&limit=5`);
      const data=await r.json();
      return (data.features||[]).map(f=>({
        name:[f.properties.name,f.properties.city,f.properties.state,f.properties.country].filter(Boolean).filter((v,i,a)=>a.indexOf(v)===i).join(', '),
        lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0]
      })).filter(x=>x.name);
    }

    async function reverseGeocode(lat,lon){
      if (BACKEND_URL){
        const r=await fetch(`${BACKEND_URL}/api/reverse-geocode?lat=${lat}&lon=${lon}`);
        if(r.ok) return await r.json();
      }
      const r=await fetch(`https://photon.komoot.io/reverse?lat=${lat}&lon=${lon}`);
      const data=await r.json();
      const feat = data.features?.[0];
      if(!feat) return { full_address: `${lat.toFixed(4)}, ${lon.toFixed(4)}` };
      const p=feat.properties||{};
      return { full_address: [p.name,p.city,p.state,p.country].filter(Boolean).join(', ') };
    }

    // Ruta terrestre real con mÃºltiples servicios (fallback)
    async function fetchRoadRoute(origin, destination){
      const services = [
        {
          name: 'OSRM',
          url: `https://router.project-osrm.org/route/v1/driving/${origin.lon},${origin.lat};${destination.lon},${destination.lat}?overview=full&geometries=geojson`,
          parse: async (r) => {
            const data = await r.json();
            const route = data.routes && data.routes[0];
            if(!route) throw new Error('OSRM no route');
            return {
              coords: (route.geometry.coordinates || []).map(([lon,lat])=>[lat,lon]),
              miles: Math.round((route.distance || 0) / 1609.344),
              source: 'OSRM'
            };
          }
        },
        {
          name: 'Geoapify',
          // API pÃºblica demo limitada (puede fallar por rate limit, por eso es fallback)
          url: `https://api.geoapify.com/v1/routing?waypoints=${origin.lat},${origin.lon}|${destination.lat},${destination.lon}&mode=drive&apiKey=YOUR_GEOAPIFY_KEY`,
          parse: async (r) => {
            const data = await r.json();
            const feat = data.features && data.features[0];
            if(!feat) throw new Error('Geoapify no route');
            return {
              coords: (feat.geometry.coordinates || []).map(([lon,lat])=>[lat,lon]),
              miles: Math.round((feat.properties.distance || 0) / 1609.344),
              source: 'Geoapify'
            };
          },
          skip: true // activado sÃ³lo si agregas API key
        },
        {
          name: 'StraightFallback',
          local: true,
          parse: async () => {
            const straight = haversine(origin.lat,origin.lon,destination.lat,destination.lon);
            return {
              coords: [[origin.lat, origin.lon],[destination.lat, destination.lon]],
              miles: Math.round(straight * 1.3),
              source: 'Fallback'
            };
          }
        }
      ];

      let lastErr = null;
      for (const svc of services) {
        try {
          if (svc.skip) continue;
          if (svc.local) return await svc.parse();
          const r = await fetch(svc.url);
          if (!r.ok) throw new Error(`${svc.name} HTTP ${r.status}`);
          const result = await svc.parse(r);
          return result;
        } catch (e) {
          console.warn(`Routing service failed: ${svc.name}`, e);
          lastErr = e;
        }
      }
      throw lastErr || new Error('No routing service available');
    }

    function bindAutocomplete(inputEl, listEl, assignFn){
      let timer=null;
      inputEl.addEventListener('input', ()=>{
        clearTimeout(timer);
        const q=inputEl.value.trim();
        if(q.length<2){ listEl.style.display='none'; return; }
        timer=setTimeout(async()=>{
          try{
            const items=await fetchAutocomplete(q);
            listEl.innerHTML = items.map((it,idx)=>`
              <div class="s-item" data-i="${idx}">
                <div class="s-name">${(it.name.split(',')[0]||it.name)}</div>
                <div class="s-detail">${it.name.split(',').slice(1).join(',')}</div>
              </div>`).join('');
            listEl.style.display = items.length ? 'block' : 'none';
            [...listEl.children].forEach((node,idx)=>node.onclick=()=>{
              inputEl.value = items[idx].name;
              assignFn(items[idx]);
              listEl.style.display='none';
              updateMapPreview();
            });
          }catch(e){ console.error(e); }
        }, 300);
      });
      inputEl.addEventListener('focus', ()=>{ if(listEl.innerHTML.trim()) listEl.style.display='block'; });
      document.addEventListener('click', (e)=>{ if(!listEl.contains(e.target) && e.target!==inputEl) listEl.style.display='none'; });
    }

    function initMap(targetId){
      const map = L.map(targetId,{zoomControl:true, attributionControl:true}).setView([39.5,-98.35], 4);
      const tile = isDark
        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      L.tileLayer(tile,{maxZoom:19}).addTo(map);
      return map;
    }

    function clearMapLayers(map, routeLayerRefName, markersRefName){
      if(window[routeLayerRefName]){ map.removeLayer(window[routeLayerRefName]); window[routeLayerRefName]=null; }
      (window[markersRefName]||[]).forEach(m=>map.removeLayer(m));
      window[markersRefName]=[];
    }

    function drawRouteOnMap(map, routeCoords, origin, destination, target){
      // target = 'mini' | 'full'
      if(!map) return;
      if(target==='mini'){
        if(miniRouteLayer){ map.removeLayer(miniRouteLayer); miniRouteLayer=null; }
        miniMarkers.forEach(m=>map.removeLayer(m)); miniMarkers=[];
      } else {
        if(fullRouteLayer){ map.removeLayer(fullRouteLayer); fullRouteLayer=null; }
        fullMarkers.forEach(m=>map.removeLayer(m)); fullMarkers=[];
      }

      const coords = routeCoords && routeCoords.length ? routeCoords : [[origin.lat,origin.lon],[destination.lat,destination.lon]];
      const layer = L.polyline(coords, {color:'#10b981', weight:5, opacity:.95}).addTo(map);
      const shadow = L.polyline(coords, {color:'#065f46', weight:9, opacity:.22}).addTo(map);
      shadow.bringToBack();

      const o = L.marker([origin.lat, origin.lon]).addTo(map).bindPopup((lang==='es'?'Origen':'Origin')+': '+origin.name);
      const d = L.marker([destination.lat, destination.lon]).addTo(map).bindPopup((lang==='es'?'Destino':'Destination')+': '+destination.name);
      const mid = coords[Math.floor(coords.length/2)] || [(origin.lat+destination.lat)/2,(origin.lon+destination.lon)/2];
      const truck = L.marker(mid, {icon: L.divIcon({className:'', html:'<div style="font-size:24px">ğŸš›</div>'})}).addTo(map);

      if(target==='mini'){ miniRouteLayer = layer; miniMarkers = [shadow,o,d,truck]; }
      else { fullRouteLayer = layer; fullMarkers = [shadow,o,d,truck]; }

      map.fitBounds(layer.getBounds(), {padding:[25,25]});
    }

    function rebuildMapsForTheme(){
      if(miniMap){
        miniMap.remove(); miniMap = null; miniRouteLayer = null; miniMarkers = [];
      }
      if(fullMap){
        fullMap.remove(); fullMap = null; fullRouteLayer = null; fullMarkers = [];
      }
      if(state.origin && state.destination) updateMapPreview();
    }

    function updateMapPreview(){
      const show = !!(state.origin && state.destination);
      qs('#mapPreviewCard').style.display = show ? 'block' : 'none';
      if(!show) return;
      if(!miniMap){ miniMap = initMap('miniMap'); }
      miniMap.invalidateSize();
      drawRouteOnMap(miniMap, state.roadGeometry, state.origin, state.destination, 'mini');
      setTimeout(()=>{ try{ miniMap.invalidateSize(); drawRouteOnMap(miniMap, state.roadGeometry, state.origin, state.destination, 'mini'); }catch(e){} }, 120);
    }

    async function calculateRoute(){
      hideError();
      if(!state.origin || !state.destination){ showError(T[lang].errSel); return; }
      const hours = parseFloat(qs('#hoursInput').value);
      const speed = parseFloat(qs('#speedInput').value);
      if(isNaN(hours) || hours<=0 || hours>70){ showError(T[lang].err70); return; }
      if(isNaN(speed) || speed<=0){ showError(T[lang].errSpeed); return; }

      const depart = new Date(qs('#departureInput').value || new Date());
      let distanceMiles = 0;
      state.roadGeometry = null;

      // Intenta ruta terrestre real
      try{
        const road = await fetchRoadRoute(state.origin, state.destination);
        state.roadGeometry = road.coords;
        state.routeSource = road.source;
        distanceMiles = road.miles;
      }catch(e){
        console.warn('OSRM route failed, using fallback line', e);
        // fallback si falla el servicio de ruta
        const straight = haversine(state.origin.lat,state.origin.lon,state.destination.lat,state.destination.lon);
        distanceMiles = Math.round(straight * 1.3);
        state.roadGeometry = [[state.origin.lat, state.origin.lon],[state.destination.lat, state.destination.lon]];
        state.routeSource = 'Fallback';
      }

      const schedule = calculateSchedule(depart, distanceMiles, speed, hours);
      const arrival = schedule.at(-1)?.end || depart;
      const total = schedule.reduce((a,s)=>a+(s.type==='drive'||s.type==='rest'?s.hours:0),0);

      state.routeDistance = distanceMiles; state.schedule=schedule; state.arrival=arrival; state.totalTime=total;

      qs('#resultButtons').style.display='grid';
      qs('#resultsCard').style.display='block';

      const driveNeeded = distanceMiles/speed;
      const status = qs('#statusPill');
      status.classList.toggle('danger', driveNeeded > hours);
      status.textContent = `${formatHours(driveNeeded)} / ${hours} hrs`;

      qs('#distanceBig').textContent = distanceMiles.toLocaleString() + ' mi';
      qs('#fromVal').textContent = state.origin.name;
      qs('#toVal').textContent = state.destination.name;
      qs('#depVal').textContent = formatDateTime(depart);
      qs('#arrVal').textContent = formatDateTime(arrival);
      qs('#totVal').textContent = formatHours(total);
      const srcText = state.routeSource === 'Fallback' ? T[lang].sourceFallback : T[lang].sourceOsrm;
      qs('#routeSourceHint').textContent = `ğŸ›£ï¸ ${T[lang].sourceRoad}: ${srcText}`;

      const t=T[lang];
      qs('#scheduleList').innerHTML = schedule.map(s=>{
        const cls = s.type==='rest'?'sched rest':s.type==='reset'?'sched reset':'sched';
        let title = s.type==='reset' ? `ğŸ”„ ${t.reset}` : `${t.day} ${s.day} - ${s.type==='drive'?t.drive:t.rest}`;
        let detail = s.type==='drive'
          ? `ğŸš› ${formatTime(s.start)} â†’ ${formatTime(s.end)}\n${formatHours(s.hours)} | ${Math.round(s.distance||0)} mi`
          : s.type==='rest' ? `ğŸ˜´ 10 hours DOT` : `Recover 70 hrs`;
        return `<div class="${cls}"><div class="t">${title}</div><div class="d">${detail}</div></div>`;
      }).join('');

      updateMapPreview();
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }

    async function useGPS(){
      if(!navigator.geolocation) return alert('GPS not supported');
      qs('#gpsBtn').disabled = true; qs('#gpsBtn').textContent = '...';
      navigator.geolocation.getCurrentPosition(async(pos)=>{
        const {latitude,longitude}=pos.coords;
        const data = await reverseGeocode(latitude,longitude);
        state.origin = {name:data.full_address || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`, lat:latitude, lon:longitude};
        qs('#originInput').value = state.origin.name;
        qs('#gpsBtn').disabled = false; qs('#gpsBtn').textContent = 'GPS';
        updateMapPreview();
      }, ()=>{
        alert(T[lang].gpsDenied);
        qs('#gpsBtn').disabled = false; qs('#gpsBtn').textContent = 'GPS';
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:60000});
    }

    async function shareRoute(){
      if(!state.origin || !state.destination) return;
      const msg = `ğŸš› HOS Tracker\n\nğŸ“ ${state.origin.name}\nğŸ¯ ${state.destination.name}\nğŸ“ ${state.routeDistance.toLocaleString()} mi\nâ±ï¸ ${formatHours(state.totalTime)}`;
      if(navigator.share){ try{ await navigator.share({title:'HOS Route', text:msg}); return; }catch(e){} }
      if(navigator.clipboard) await navigator.clipboard.writeText(msg);
      alert(T[lang].copied);
    }

    function openFullMap(){
      if(!state.origin || !state.destination) return;
      qs('#fullMapOverlay').classList.add('open');
      if(!fullMap){ fullMap = initMap('fullMap'); }
      setTimeout(()=>{ fullMap.invalidateSize(); drawRouteOnMap(fullMap, state.roadGeometry, state.origin, state.destination, 'full'); }, 180);
    }
    function closeFullMap(){ qs('#fullMapOverlay').classList.remove('open'); }

    function startTracking(){
      if(!state.origin || !state.destination) return alert(T[lang].errSel);
      if(!navigator.geolocation) return alert('GPS not supported');

      state.tripStart = new Date(); state.tracking=true;
      qs('#monitorOverlay').classList.add('open');
      qs('#currentLocVal').textContent = T[lang].locating;
      qs('#trackStatus').textContent = T[lang].ready;
      const speedInput = parseFloat(qs('#speedInput').value)||60;

      if(state.watchId != null) navigator.geolocation.clearWatch(state.watchId);
      state.watchId = navigator.geolocation.watchPosition(async(pos)=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        const gpsSpeed = pos.coords.speed != null && pos.coords.speed >= 0 ? Math.round(pos.coords.speed * 2.237) : 0;
        qs('#speedVal').textContent = String(gpsSpeed);
        qs('#trackStatus').textContent = gpsSpeed > 5 ? 'ğŸš› '+T[lang].driving : 'â¸ï¸ '+T[lang].stopped;

        const traveled = haversine(state.origin.lat,state.origin.lon,lat,lon);
        const remaining = haversine(lat,lon,state.destination.lat,state.destination.lon);
        const pct = Math.min(100, Math.round((traveled / Math.max(1,state.routeDistance))*100));
        const elapsed = (Date.now() - state.tripStart.getTime()) / 3600000;

        qs('#progressFill').style.width = pct + '%';
        qs('#progressText').textContent = pct + '%';
        qs('#traveledVal').textContent = traveled.toLocaleString() + ' mi';
        qs('#remainingVal').textContent = remaining.toLocaleString() + ' mi';
        qs('#elapsedVal').textContent = formatHours(elapsed);
        qs('#etaVal').textContent = formatHours(remaining / Math.max(1,speedInput));

        try{
          const data = await reverseGeocode(lat,lon);
          qs('#currentLocVal').textContent = data.full_address || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        }catch{
          qs('#currentLocVal').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        }

        if(remaining <= 5){ alert(T[lang].arrived); stopTracking(); }
      }, ()=>{}, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});
    }

    function stopTracking(){
      if(state.watchId != null){ navigator.geolocation.clearWatch(state.watchId); state.watchId = null; }
      state.tracking=false;
      qs('#monitorOverlay').classList.remove('open');
    }

    function resetForm(){
      state.origin=null; state.destination=null; state.routeDistance=0; state.totalTime=0; state.arrival=null; state.schedule=[]; state.roadGeometry=null; state.routeSource=null;
      qs('#originInput').value=''; qs('#destInput').value=''; qs('#hoursInput').value='70'; qs('#speedInput').value='60';
      hideError();
      qs('#resultsCard').style.display='none';
      qs('#resultButtons').style.display='none';
      qs('#mapPreviewCard').style.display='none';
      qs('#originSuggestions').style.display='none';
      qs('#destSuggestions').style.display='none';
      if (qs('#routeSourceHint')) qs('#routeSourceHint').textContent='';
      if(miniRouteLayer && miniMap){ miniMap.removeLayer(miniRouteLayer); miniRouteLayer=null; }
      miniMarkers.forEach(m=>miniMap && miniMap.removeLayer(m)); miniMarkers=[];
    }

    function setDefaultDeparture(){
      const now = new Date();
      const local = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
      qs('#departureInput').value = local;
    }

    bindAutocomplete(qs('#originInput'), qs('#originSuggestions'), (loc)=> state.origin = loc);
    bindAutocomplete(qs('#destInput'), qs('#destSuggestions'), (loc)=> state.destination = loc);

    qs('#themeBtn').onclick = ()=>{ isDark=!isDark; localStorage.setItem('hos_theme', isDark?'dark':'light'); applyTheme(); rebuildMapsForTheme(); };
    qs('#langBtn').onclick = ()=>{ lang = lang==='en'?'es':'en'; localStorage.setItem('hos_lang', lang); applyI18n(); if(state.routeDistance>0) calculateRoute(); };
    qs('#calcBtn').onclick = calculateRoute;
    qs('#gpsBtn').onclick = useGPS;
    qs('#shareBtn').onclick = shareRoute;
    qs('#trackBtn').onclick = startTracking;
    qs('#stopTrackBtn').onclick = stopTracking;
    qs('#closeMonitor').onclick = stopTracking;
    qs('#resetBtn').onclick = resetForm;
    qs('#openFullMap').onclick = openFullMap;
    qs('#closeFullMap').onclick = closeFullMap;
    qs('#fullMapOverlay').addEventListener('click', (e)=>{ if(e.target.id==='fullMapOverlay') closeFullMap(); });
    qs('#monitorOverlay').addEventListener('click', (e)=>{ if(e.target.id==='monitorOverlay') stopTracking(); });

    applyTheme();
    applyI18n();
    setDefaultDeparture();
  </script>
</body>
</html>
